webpackJsonp([0],{91:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function o(e){var t=function(){var t=new Array(e*e);return t.fill(0,0,e*e).map(function(e){return Math.random()})},i=function(){var e=["Player1","Player2"];return e[Math.floor(Math.random()*e.length)]};return{type:x,payload:i(),value:t()}}function r(){return{type:g,payload:{}}}function a(e){return{type:v,payload:{cell:e,tag:"mark"}}}function n(e){return{type:b,payload:["size",e]}}function d(e){return{type:b,payload:["difficulty",e]}}function l(){return{type:y}}function h(){var e=arguments.length<=0||void 0===arguments[0]?M:arguments[0],t=arguments[1],i=S[t.type];return i?i(e,t):e}Object.defineProperty(t,"__esModule",{value:!0}),t.actions=t.COMP_STATE=t.OPTIONS_STATE=t.BOARD_STATE=t.PLAYER_STATE=t.END_STATE=t.START_STATE=void 0;var u,f=i(176),c=s(f),_=i(128),m=s(_);t.initializeBoard=o,t.clearBoard=r,t.markPiece=a,t.changeBoard=n,t.changeDifficulty=d,t.removePieces=l,t["default"]=h;var p=i(468),x=(i(275),t.START_STATE="START_STATE"),g=t.END_STATE="END_STATE",v=t.PLAYER_STATE="PLAYER_STATE",y=t.BOARD_STATE="BOARD_STATE",b=t.OPTIONS_STATE="OPTIONS_STATE",T=t.COMP_STATE="COMP_STATE",S=(t.actions={initializeBoard:o,clearBoard:r,markPiece:a,removePieces:l,changeBoard:n,changeDifficulty:d},u={},(0,c["default"])(u,x,function(e,t){var i=(0,p.createBoard)(t.value,e.options.size);return(0,m["default"])({},e,{pieces:i.pieces,allMarbles:i.initialMarbles,phase:t.payload+"Move",text:t.payload})}),(0,c["default"])(u,g,function(e,t){return(0,m["default"])({},e,{pieces:[],phase:"end",allMarbles:0,text:"end"})}),(0,c["default"])(u,v,function(e,t){return(0,m["default"])({},e,{pieces:(0,p.updateSelectionState)(e.pieces,t.payload)})}),(0,c["default"])(u,y,function(e,t){return(0,p.evaluateSelection)(e)}),(0,c["default"])(u,T,function(e,t){return(0,m["default"])({},e,{phase:"Player2End",pieces:(0,p.updateSelectionState)(e.pieces,t.payload)})}),(0,c["default"])(u,b,function(e,t){var i=e.options;return i[t.payload[0]]=t.payload[1],(0,m["default"])({},e,{options:i})}),u),M={pieces:[],phase:"end",allMarbles:"0",text:"end",options:{difficulty:"normal",size:5}}},127:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Settings=t.Board3D=t.BoardOld=t.GameInfoOld=t.ButtonsOld=t.Board=t.GameInfo=t.Buttons=void 0;var o=i(439),r=s(o),a=i(442),n=s(a),d=i(436),l=s(d),h=i(437),u=s(h),f=i(440),c=s(f),_=i(443),m=s(_),p=i(438),x=s(p),g=i(445),v=s(g);t.Buttons=r["default"],t.GameInfo=n["default"],t.Board=l["default"],t.ButtonsOld=c["default"],t.GameInfoOld=m["default"],t.BoardOld=x["default"],t.Board3D=u["default"],t.Settings=v["default"]},172:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Board3D=t.BoardOld=t.Board=void 0;var s=i(35),o=i(91),r=i(127),a={markPiece:o.markPiece,removePieces:o.removePieces},n=function(e){return{game:e.game}};t.Board=(0,s.connect)(n,a)(r.Board),t.BoardOld=(0,s.connect)(n,a)(r.BoardOld),t.Board3D=(0,s.connect)(n,a)(r.Board3D)},173:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonsOld=t.Buttons=void 0;var s=i(35),o=i(91),r=i(127),a={initializeBoard:o.initializeBoard,clearBoard:o.clearBoard},n=function(e){return{game:e.game}};t.Buttons=(0,s.connect)(n,a)(r.Buttons),t.ButtonsOld=(0,s.connect)(n,a)(r.ButtonsOld)},174:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameInfoOld=t.GameInfo=void 0;var s=i(35),o=i(127),r=function(e){return{game:e.game}};t.GameInfo=(0,s.connect)(r,null)(o.GameInfo),t.GameInfoOld=(0,s.connect)(r,null)(o.GameInfoOld)},175:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function o(e){return{type:g,payload:e}}function r(e){return{type:v,payload:e}}function a(){return{type:y,payload:{}}}function n(){return{type:b,payload:{}}}function d(e){return{type:T,payload:e}}function l(){return{type:S,payload:{}}}function h(){var e=arguments.length<=0||void 0===arguments[0]?C:arguments[0],t=arguments[1],i=M[t.type];return i?i(e,t):e}Object.defineProperty(t,"__esModule",{value:!0}),t.LEAVE_STATE=t.HOST_STATE=t.CLEAN_STATE=t.LOGOUT_STATE=t.SIGNUP_STATE=t.LOGIN_STATE=void 0;var u,f=i(176),c=s(f),m=i(128),p=s(m);t.logIn=o,t.signUp=r,t.logOut=a,t.cleanForm=n,t.newGame=d,t.leaveGame=l,t["default"]=h;var x=i(477),g=t.LOGIN_STATE="LOGIN_STATE",v=t.SIGNUP_STATE="SIGNUP_STATE",y=t.LOGOUT_STATE="LOGOUT_STATE",b=t.CLEAN_STATE="CLEAN_STATE",T=t.HOST_STATE="HOST_STATE",S=t.LEAVE_STATE="LEAVE_STATE",M=(u={},(0,c["default"])(u,g,function(e,t){var i=e.onlineUsers,s=e.flag,o={fail:"Incorrect username or password"},r=(0,x.validateUser)(t.payload,e.allUsers);return r&&"in"!=e.user.flag&&(i=_.concat(e.onlineUsers,r),s="in",o={}),"in"==e.user.flag&&(s="in",o={fail:"Already logged in!"}),(0,p["default"])({},e,{onlineUsers:i,user:(0,p["default"])({},r,{flag:s,reserved:"no"}),message:o})}),(0,c["default"])(u,y,function(e,t){return(0,p["default"])({},e,{onlineUsers:_.remove(e.onlineUsers,e.user),user:{reserved:"no",flag:"out"},activeGames:_.remove(e.activeGames,function(t){e.user.name===t.user.name})})}),(0,c["default"])(u,v,function(e,t){var i=e.allUsers,s=e.flag,o=e.onlineUsers,r=e.user,a=(0,x.validateCred)(t.payload,e.allUsers);return _.isEmpty(a)&&(i=_.concat(e.allUsers,[(0,p["default"])({},t.payload,{rank:1})]),s="in",r=(0,p["default"])({},t.payload),o=_.concat(e.onlineUsers,r)),(0,p["default"])({},e,{allUsers:i,message:a,onlineUsers:o,user:(0,p["default"])({},r,{flag:s,rank:1,reserved:"no"})})}),(0,c["default"])(u,b,function(e,t){return(0,p["default"])({},e,{message:{}})}),(0,c["default"])(u,T,function(e,t){if("in"!=e.user.flag)return e;var i="yes";return""==t.payload&&(i="no"),(0,p["default"])({},e,{user:(0,p["default"])({},e.user,{reserved:"yes"}),activeGames:_.concat(e.activeGames,[{user:e.user,pwd:t.payload,isProtected:i}])})}),(0,c["default"])(u,S,function(e,t){return(0,p["default"])({},e,{user:(0,p["default"])({},e.user,{reserved:"no"}),activeGames:_.remove(e.activeGames,function(t){e.user.name===t.user.name})})}),u),C={allUsers:[],message:{},onlineUsers:[],activeGames:[],user:{flag:"",reserved:"no"}}},211:function(e,t){e.exports={stage:"Board__stage___Ml45X",board:"Board__board___1J19s",marble:"Board__marble___HrcpX",obstacle:"Board__obstacle___1Plmk",selected:"Board__selected___1ziYF",Player1:"Board__Player1___2RWQx",Player2:"Board__Player2___2sEGZ",empty:"Board__empty___1rO2t",end:"Board__end___8xB3r"}},212:function(e,t,i){e.exports=i.p+"551f82bef9cd84bfc33ee1ed81f3a124.mp3"},213:function(e,t,i){e.exports=i.p+"ab3cb11060eac248dbe89b7950a005dc.mp3"},272:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.styles={board:{textAlign:"center",verticalAlign:"middle"},table:{margin:"auto",textAlign:"center",verticalAlign:"middle",width:"60%"},tile:{border:1,height:100,borderColor:"white",borderStyle:"solid",backgroundColor:"#424242"},marble:{margin:"auto",backgroundColor:"#E0E0E0",height:50,width:50,textAlign:"center",cursor:"pointer"},obstacle:{margin:"auto",backgroundColor:"#A1887F",height:50,width:50,textAlign:"center"},selected:{Player1:{margin:"auto",backgroundColor:"#E55B3C",height:50,width:50,verticalAlign:"top"},Player2:{margin:"auto",backgroundColor:"#6495ED",height:50,width:50,verticalAlign:"top"}}}},274:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.LogInOld=t.MembersOld=t.LogIn=t.Members=void 0;var o=i(457),r=s(o),a=i(455),n=s(a),d=i(458),l=s(d),h=i(456),u=s(h);t.Members=r["default"],t.LogIn=n["default"],t.MembersOld=l["default"],t.LogInOld=u["default"]},276:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Settings=void 0;var s=i(35),o=i(91),r=i(127),a={changeBoard:o.changeBoard,changeDifficulty:o.changeDifficulty,initializeBoard:o.initializeBoard},n=function(e){return{game:e.game}};t.Settings=(0,s.connect)(n,a)(r.Settings)},318:function(e,t){e.exports={Player1:"GameInfo__Player1___IPZE4",Player2:"GameInfo__Player2___1OSp7",end:"GameInfo__end___yRea4",prog:"GameInfo__prog___1-Q8V",start:"GameInfo__start___1-_bZ"}},320:function(e,t){e.exports={login:"LogIn__login___TTq5u",logButton:"LogIn__logButton___2gSBR",loginForm:"LogIn__loginForm___1SiBY","in":"LogIn__in___nK6j3",alertmsg:"LogIn__alertmsg___19o4V"}},321:function(e,t){e.exports={tableFixed:"Members__tableFixed___1wOE-",newGame:"Members__newGame___3T5qF",no:"Members__no___2aOnU",yes:"Members__yes___1oHzO"}},325:function(e,t,i){e.exports=i.p+"0859886874293b3a7807d701de4e69dd.mp3"},326:function(e,t,i){e.exports=i.p+"c64803daa829e66dd81a9364519b83c8.gif"},436:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Board=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(211)),d=s(n),l=i(326),h=s(l),u=i(212),f=s(u),c=i(213),_=s(c),m=i(238),p=i(25),x=s(p),g=i(272),v=!1,y=(0,r["default"])("audio",{id:"clickSound",src:f["default"]}),b=(0,r["default"])("audio",{id:"winSound",src:_["default"]}),T=t.Board=function(e){var t=e.game,i=e.removePieces,s=e.markPiece,o=function(e){e.pause(),e.currentTime=0,e.play()},a=function(){v=!1,i(),"wins!"===t.text.substring(8,13)&&o(document.getElementById("winSound"))},n=function(e,i,r,a){"/Randix-Game/TwoPlayer"!==window.location.pathname&&"Player1"!==t.text.substring(0,7)||"marble"===i.type&&(v=!0,e.preventDefault(),o(document.getElementById("clickSound")),s(r*t.options.size+a))},l=function(e,i,r){"/Randix-Game/TwoPlayer"!==window.location.pathname&&"Player1"!==t.text.substring(0,7)||v&&"marble"===e.type&&(o(document.getElementById("clickSound")),s(i*t.options.size+r))};return(0,r["default"])("div",{className:d["default"].stage},void 0,y,b,(0,r["default"])("img",{className:d["default"][t.phase],alt:"Game Tutorial",src:h["default"]}),(0,r["default"])(m.Table,{className:d["default"][t.phase],bodyStyle:g.styles.table},void 0,(0,r["default"])(m.TableBody,{displayRowCheckbox:!1},void 0,t.pieces.slice(0,t.options.size).map(function(e,i){return(0,r["default"])(m.TableRow,{selectable:!1,onMouseUp:function(){return a()}},void 0,t.pieces.slice(i*t.options.size,i*t.options.size+t.options.size).map(function(e,s){return(0,r["default"])(m.TableRowColumn,{style:g.styles.tile,id:d["default"][t.text],onMouseDown:function(t){return n(t,e,i,s)},onMouseOver:function(){return l(e,i,s)}},void 0,(0,r["default"])(x["default"],{zDepth:5,circle:!("obstacle"===e.type),style:"selected"==e.type?g.styles[e.type][t.text.substring(0,7)]:g.styles[e.type]}))}))}))))};t["default"]=T},437:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Board3D=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(1075)),d=(s(n),i(705)),l=(s(d),i(211)),h=s(l),u=i(326),f=s(u),c=i(212),_=s(c),m=i(213),p=s(m),x=(i(238),i(25)),g=(s(x),i(272),(0,r["default"])("audio",{id:"clickSound",src:_["default"]})),v=(0,r["default"])("audio",{id:"winSound",src:p["default"]}),y=t.Board3D=function(e){var t=e.game;e.removeMarks,e.removePieces,e.markPiece;return(0,r["default"])("div",{className:h["default"].stage},void 0,g,v,(0,r["default"])("img",{className:h["default"][t.phase],alt:"Game Tutorial",src:f["default"]}),(0,r["default"])("div",{id:h["default"][t.phase]},void 0,(0,r["default"])("canvas",{id:h["default"].renderCanvas})))};t["default"]=y},438:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.BoardOld=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(211)),d=s(n),l=i(726),h=s(l),u=i(212),f=s(u),c=i(213),_=s(c),m=!1,p=(0,r["default"])("audio",{id:"clickSound",src:f["default"]}),x=(0,r["default"])("audio",{id:"winSound",src:_["default"]}),g=t.BoardOld=function(e){var t=e.game,i=e.removePieces,s=e.markPiece,o=function(e){e.pause(),e.currentTime=0,e.play()},a=function(){m=!1,i(),"wins!"===t.text.substring(8,13)&&o(document.getElementById("winSound"))},n=function(e,i,r,a){"/Randix-Game/TwoPlayer"!==window.location.pathname&&"Player1"!==t.text.substring(0,7)||"marble"===i.type&&(m=!0,e.preventDefault(),o(document.getElementById("clickSound")),s(r*t.options.size+a))},l=function(e,i,r){"/Randix-Game/TwoPlayer"!==window.location.pathname&&"Player1"!==t.text.substring(0,7)||m&&"marble"===e.type&&(o(document.getElementById("clickSound")),s(i*t.options.size+r))};return(0,r["default"])("div",{className:d["default"].stage},void 0,p,x,(0,r["default"])("img",{className:d["default"][t.phase],alt:"Game Tutorial",src:h["default"]}),(0,r["default"])("table",{className:d["default"].board,onMouseUp:function(){return a()},onTouchEnd:function(){return a()}},void 0,(0,r["default"])("tbody",{},void 0,t.pieces.slice(0,t.options.size).map(function(e,i){return(0,r["default"])("tr",{},void 0,t.pieces.slice(i*t.options.size,i*t.options.size+t.options.size).map(function(e,s){return(0,r["default"])("td",{className:d["default"][e.type],id:d["default"][t.text],onMouseDown:function(t){return n(t,e,i,s)},onTouchStart:function(t){return n(t,e,i,s)},onMouseOver:function(){return l(e,i,s)},onTouchMove:function(){return l(e,i,s)}},void 0)}))}))))};t["default"]=g},439:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Buttons=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(325)),d=s(n),l=i(367),h=s(l),u=i(441),f=function(e){e.pause(),e.currentTime=0,e.play()},c=(0,r["default"])("audio",{id:"buttonSound",src:d["default"]}),_=t.Buttons=function(e){var t=e.game,i=e.initializeBoard,s=e.clearBoard,o=function(){f(document.getElementById("buttonSound")),i(t.options.size)},a=function(){f(document.getElementById("buttonSound")),s()};return(0,r["default"])("div",{},void 0,c,(0,r["default"])(h["default"],{label:"New Game",style:u.styles.start,onClick:o}),(0,r["default"])(h["default"],{label:"Quit",style:"end"==t.phase?u.styles.end:u.styles.start,onClick:a}))};t["default"]=_},440:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonsOld=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(706)),d=s(n),l=i(325),h=s(l),u=function(e){e.pause(),e.currentTime=0,e.play()},f=(0,r["default"])("audio",{id:"buttonSound",src:h["default"]}),c=t.ButtonsOld=function(e){var t=e.game,i=e.initializeBoard,s=e.clearBoard,o=function(){u(document.getElementById("buttonSound")),i(t.options.size)},a=function(){u(document.getElementById("buttonSound")),s()};return(0,r["default"])("div",{className:d["default"].boots},void 0,f,(0,r["default"])("button",{onClick:o},void 0,"New Game"),(0,r["default"])("button",{className:d["default"][t.phase],onClick:a},void 0,"Quit"))};t["default"]=c},441:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.styles={start:{margin:40,width:"30%",height:50,verticalAlign:"middle"},end:{display:"none"}}},442:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.GameInfo=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(318)),d=s(n),l=i(88),h=i(444),u=t.GameInfo=function(e){var t=e.game,i=Math.round(100-(t.pieces.filter(function(e){return"marble"===e.type||"selected"===e.type}).length-1)/(t.allMarbles-1)*100);return(0,r["default"])("div",{className:d["default"][t.phase]},void 0,(0,r["default"])(l.Chip,{style:h.styles[t.text.substring(0,7)]},void 0,t.text),(0,r["default"])(l.LinearProgress,{style:h.styles.prog,mode:"determinate",value:i,color:"#8BC34A"},void 0,i+" %"))};t["default"]=u},443:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.GameInfoOld=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(318)),d=s(n),l=t.GameInfoOld=function(e){var t=e.game,i=Math.round(100-(t.pieces.filter(function(e){return"marble"===e.type||"selected"===e.type}).length-1)/(t.allMarbles-1)*100);return(0,r["default"])("div",{className:d["default"][t.phase]},void 0,(0,r["default"])("span",{className:"label label-default",id:d["default"][t.text.substring(0,7)]},void 0,t.text),(0,r["default"])("div",{className:"progress",id:d["default"].prog},void 0,(0,r["default"])("div",{className:"progress-bar",role:"progressbar",style:{width:i+"%"}},void 0,i+" %")))};t["default"]=l},444:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.styles={prog:{height:60,border:5,width:400,borderColor:"black",backgroundColor:"#E5E4E2",lineHeight:60,display:"inline-block",verticalAlign:"middle",marginBottom:20},Player2:{height:40,width:100,marginRight:20,display:"inline-block",fontFamily:"cursive",verticalAlign:"middle",textAlign:"center",border:0,backgroundColor:"#6495ED"},Player1:{height:40,width:100,marginRight:20,display:"inline-block",fontFamily:"cursive",verticalAlign:"middle",textAlign:"center",border:0,backgroundColor:"#E55B3C"}}},445:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Settings=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(707)),d=s(n),l=i(88),h=i(446),u=(0,r["default"])("span",{}),f=t.Settings=function(e){var t=e.game,i=e.changeDifficulty,s=e.changeBoard,o=e.initializeBoard;return(0,r["default"])("div",{className:d["default"][t.phase]+" "+d["default"].settings},void 0,(0,r["default"])("p",{className:d["default"].label},void 0,"Board:"),(0,r["default"])(l.DropDownMenu,{listStyle:h.styles.menu,labelStyle:h.styles.menuLabel,value:t.options.size},void 0,(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){s(4),o(t.options.size)},value:4,primaryText:"4x4"}),(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){s(5),o(t.options.size)},value:5,primaryText:"5x5"}),(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){s(6),o(t.options.size)},value:6,primaryText:"6x6"})),"/Randix-Game/vsComp"===window.location.pathname?[(0,r["default"])("p",{className:d["default"].label},void 0,"Difficulty:"),(0,r["default"])(l.DropDownMenu,{listStyle:h.styles.menu,labelStyle:h.styles.menuLabel,value:t.options.difficulty},void 0,(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){i("easy"),o(t.options.size)},value:"easy",primaryText:"Easy"}),(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){i("normal"),o(t.options.size)},value:"normal",primaryText:"Normal"}),(0,r["default"])(l.MenuItem,{style:h.styles.menuItem,onClick:function(){i("hard"),o(t.options.size)},value:"hard",primaryText:"Hard"}))]:u)};t["default"]=f},446:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.styles={menu:{backgroundColor:"#30649C"},menuLabel:{backgroundColor:"#30649C",width:100,height:50,verticalAlign:"middle"},menuItem:{backgroundColor:"#30649C",height:50,padding:0}}},455:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.LogIn=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(320)),d=s(n),l=(0,r["default"])("h4",{className:"modal-title"},void 0,"Log In:"),h=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:"name1",placeholder:"Username"})),u=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd1",placeholder:"Password"})),f=(0,r["default"])("div",{className:"checkbox"},void 0,(0,r["default"])("label",{},void 0,(0,r["default"])("input",{type:"checkbox"}),"Remember me")),c=(0,r["default"])("a",{href:"#signup","data-toggle":"collapse"},void 0,"New Member? Register!"),_=(0,r["default"])("label",{htmlFor:"username"},void 0,"Username"),m=(0,r["default"])("input",{type:"text",className:"form-control",id:"name2",placeholder:"Enter Username"}),p=(0,r["default"])("label",{htmlFor:"email"},void 0,"Email"),x=(0,r["default"])("input",{type:"email",className:"form-control",id:"email",placeholder:"Enter Email"}),g=(0,r["default"])("label",{htmlFor:"pwd"},void 0,"Password"),v=(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd2",placeholder:"Enter Password"}),y=t.LogIn=function(e){var t=e.auth,i=e.logIn,s=e.logOut,o=e.signUp,a=e.cleanForm,n=function(){i({name:document.getElementById("name1").value,pwd:document.getElementById("pwd1").value})},y=function(){o({name:document.getElementById("name2").value,email:document.getElementById("email").value,pwd:document.getElementById("pwd2").value})},b=function(){s()};return $(".modal").on("hidden.bs.modal",function(){$(this).find("form")[0].reset(),$(this).find("form")[1].reset()}),(0,r["default"])("div",{className:d["default"].login},void 0,(0,r["default"])("div",{className:d["default"].logButton},void 0,(0,r["default"])("a",{href:".connect",className:"btn btn-lg btn-default access",id:d["default"][t.user.flag],"data-toggle":"modal",onClick:a},void 0,"Log In!"),(0,r["default"])("button",{className:"btn btn-lg btn-default",id:d["default"][t.user.flag],"data-toggle":"modal",onClick:b},void 0,"Sign Out :(")),(0,r["default"])("div",{className:"modal fade connect"},void 0,(0,r["default"])("div",{className:"modal-dialog"},void 0,(0,r["default"])("div",{className:"modal-content"},void 0,(0,r["default"])("div",{className:"modal-header"},void 0,(0,r["default"])("button",{type:"button",className:"close","data-dismiss":"modal","aria-hidden":"true",onClick:a},void 0,"×")),(0,r["default"])("div",{className:"modal-body"},void 0,(0,r["default"])("form",{className:d["default"].loginForm,id:"userForm1"},void 0,l,h,u,f,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.fail),(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:n},void 0,"Log In"))),c,(0,r["default"])("div",{id:"signup",className:"collapse"},void 0,(0,r["default"])("form",{className:d["default"].loginForm,id:"userForm2"},void 0,(0,r["default"])("div",{className:"form-group"},void 0,_,m,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.name)),(0,r["default"])("div",{className:"form-group"},void 0,p,x,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.email)),(0,r["default"])("div",{className:"form-group"},void 0,g,v,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.pwd)),(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:y},void 0,"Sign Up"))),(0,r["default"])("div",{className:"modal-footer"},void 0,(0,r["default"])("button",{type:"button",className:"btn btn-default","data-dismiss":"modal",onClick:a},void 0,"Close"))))))};t["default"]=y},456:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.LogInOld=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(320)),d=s(n),l=(0,r["default"])("h4",{className:"modal-title"},void 0,"Log In:"),h=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:"name1",placeholder:"Username"})),u=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd1",placeholder:"Password"})),f=(0,r["default"])("div",{className:"checkbox"},void 0,(0,r["default"])("label",{},void 0,(0,r["default"])("input",{type:"checkbox"}),"Remember me")),c=(0,r["default"])("a",{href:"#signup","data-toggle":"collapse"},void 0,"New Member? Register!"),_=(0,r["default"])("label",{htmlFor:"username"},void 0,"Username"),m=(0,r["default"])("input",{type:"text",className:"form-control",id:"name2",placeholder:"Enter Username"}),p=(0,r["default"])("label",{htmlFor:"email"},void 0,"Email"),x=(0,r["default"])("input",{type:"email",className:"form-control",id:"email",placeholder:"Enter Email"}),g=(0,r["default"])("label",{htmlFor:"pwd"},void 0,"Password"),v=(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd2",placeholder:"Enter Password"}),y=t.LogInOld=function(e){var t=e.auth,i=e.logIn,s=e.logOut,o=e.signUp,a=e.cleanForm,n=function(){i({name:document.getElementById("name1").value,pwd:document.getElementById("pwd1").value})},y=function(){o({name:document.getElementById("name2").value,email:document.getElementById("email").value,pwd:document.getElementById("pwd2").value})},b=function(){s()};return $(".modal").on("hidden.bs.modal",function(){$(this).find("form")[0].reset(),$(this).find("form")[1].reset()}),(0,r["default"])("div",{className:d["default"].login},void 0,(0,r["default"])("div",{className:d["default"].logButton},void 0,(0,r["default"])("a",{href:".connect",className:"btn btn-lg btn-default access",id:d["default"][t.user.flag],"data-toggle":"modal",onClick:a},void 0,"Log In!"),(0,r["default"])("button",{className:"btn btn-lg btn-default",id:d["default"][t.user.flag],"data-toggle":"modal",onClick:b},void 0,"Sign Out :(")),(0,r["default"])("div",{className:"modal fade connect"},void 0,(0,r["default"])("div",{className:"modal-dialog"},void 0,(0,r["default"])("div",{className:"modal-content"},void 0,(0,r["default"])("div",{className:"modal-header"},void 0,(0,r["default"])("button",{type:"button",className:"close","data-dismiss":"modal","aria-hidden":"true",onClick:a},void 0,"×")),(0,r["default"])("div",{className:"modal-body"},void 0,(0,r["default"])("form",{className:d["default"].loginForm,id:"userForm1"},void 0,l,h,u,f,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.fail),(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:n},void 0,"Log In"))),c,(0,r["default"])("div",{id:"signup",className:"collapse"},void 0,(0,r["default"])("form",{className:d["default"].loginForm,id:"userForm2"},void 0,(0,r["default"])("div",{className:"form-group"},void 0,_,m,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.name)),(0,r["default"])("div",{className:"form-group"},void 0,p,x,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.email)),(0,r["default"])("div",{className:"form-group"},void 0,g,v,(0,r["default"])("p",{className:"alert alert-danger",id:d["default"].alertmsg},void 0,t.message.pwd)),(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:y},void 0,"Sign Up"))),(0,r["default"])("div",{className:"modal-footer"},void 0,(0,r["default"])("button",{type:"button",className:"btn btn-default","data-dismiss":"modal",onClick:a},void 0,"Close"))))))};t["default"]=y},457:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Members=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(321)),d=s(n),l=(0,r["default"])("ul",{className:"nav nav-tabs"},void 0,(0,r["default"])("li",{className:"active"},void 0,(0,r["default"])("a",{"data-toggle":"tab",href:"#home"},void 0,"Play!")),(0,r["default"])("li",{},void 0,(0,r["default"])("a",{"data-toggle":"tab",href:"#menu1"},void 0,"Leaderboard"))),h=(0,r["default"])("div",{className:"panel-heading"},void 0,(0,r["default"])("h4",{},void 0,"Active Games List")),u=(0,r["default"])("thead",{className:"well"},void 0,(0,r["default"])("tr",{},void 0,(0,r["default"])("th",{className:"col-xs-2"},void 0,"Name"),(0,r["default"])("th",{className:"col-xs-6"},void 0,"Level"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Connect"))),f=(0,r["default"])("td",{className:"col-xs-2"},void 0,"ask2"),c=(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"5")),_=(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),m=(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,"tensai"),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"1")),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs"},void 0,"GO!"))),p=(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,"Celestial"),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"4")),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs"},void 0,"GO!"))),x=(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,"madMan"),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"30")),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs"},void 0,"GO!"))),g=(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,"superGirl_24"),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"7")),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs"},void 0,"GO!"))),v=(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,"troll99"),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"99")),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs"},void 0,"GO!"))),y=(0,r["default"])("p",{},void 0,"Leave this field empty if you do not want to restrain access to your game."),b=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("label",{htmlFor:"pwd"},void 0,"Password"),(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd",placeholder:"Enter Password"})),T=(0,r["default"])("div",{className:"panel-heading"},void 0,(0,r["default"])("h4",{},void 0,"Leaderboard")),S=(0,r["default"])("thead",{className:"well"},void 0,(0,r["default"])("tr",{},void 0,(0,r["default"])("th",{className:"col-xs-4"},void 0,"Rank"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Name"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Level"))),M=t.Members=function(e){var t=e.auth,i=e.newGame,s=e.leaveGame,o=function(){"in"!=t.user.flag&&document.getElementsByClassName("access")[0].click()},a=(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs",onClick:o},void 0,"GO!");return(0,r["default"])("div",{},void 0,l,(0,r["default"])("div",{className:"tab-content"},void 0,(0,r["default"])("div",{id:"home",className:"tab-pane fade in active"},void 0,(0,r["default"])("div",{className:"container"},void 0,(0,r["default"])("div",{className:"row"},void 0,(0,r["default"])("div",{className:"panel panel-default"},void 0,h,(0,r["default"])("table",{className:"table",id:d["default"].tableFixed},void 0,u,(0,r["default"])("tbody",{id:"active"},void 0,(0,r["default"])("tr",{},void 0,f,c,(0,r["default"])("td",{className:"col-xs-4"},void 0,_,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs join",onClick:o},void 0,"GO!"))),m,p,x,g,v,t.activeGames.map(function(e,t){return(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,e.user.name),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,e.user.rank)),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:d["default"][e.isProtected],placeholder:"Code"}),a))})))),(0,r["default"])("div",{className:d["default"].newGame},void 0,(0,r["default"])("a",{href:"#newGame","data-toggle":"collapse",id:d["default"][t.user.reserved]
},void 0,"Host New Game"),(0,r["default"])("p",{id:d["default"][t.user.reserved]},void 0,"Waiting other players..."),(0,r["default"])("button",{type:"button",className:"btn btn-default",id:d["default"][t.user.reserved],onClick:s},void 0,"Leave Game"),(0,r["default"])("div",{id:"newGame",className:"collapse"},void 0,(0,r["default"])("form",{id:d["default"][t.user.reserved]},void 0,y,b,(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:function(){o(),i(document.getElementById("pwd").value)}},void 0,"Start!"))))))),(0,r["default"])("div",{id:"menu1",className:"tab-pane fade"},void 0,(0,r["default"])("div",{className:"container"},void 0,(0,r["default"])("div",{className:"row"},void 0,(0,r["default"])("div",{className:"panel panel-default"},void 0,T,(0,r["default"])("table",{className:"table",id:d["default"].tableFixed},void 0,S,(0,r["default"])("tbody",{},void 0,t.allUsers.map(function(e,t){return(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-4"},void 0,t+1),(0,r["default"])("td",{className:"col-xs-4"},void 0,e.name),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("span",{className:"badge"},void 0,e.rank)))})))))))))};t["default"]=M},458:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MembersOld=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(321)),d=s(n),l=(0,r["default"])("ul",{className:"nav nav-tabs"},void 0,(0,r["default"])("li",{className:"active"},void 0,(0,r["default"])("a",{"data-toggle":"tab",href:"#home"},void 0,"Play!")),(0,r["default"])("li",{},void 0,(0,r["default"])("a",{"data-toggle":"tab",href:"#menu1"},void 0,"Leaderboard"))),h=(0,r["default"])("div",{className:"panel-heading"},void 0,(0,r["default"])("h4",{},void 0,"Active Games List")),u=(0,r["default"])("thead",{className:"well"},void 0,(0,r["default"])("tr",{},void 0,(0,r["default"])("th",{className:"col-xs-2"},void 0,"Name"),(0,r["default"])("th",{className:"col-xs-6"},void 0,"Level"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Connect"))),f=(0,r["default"])("td",{className:"col-xs-2"},void 0,"ask2"),c=(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"5")),_=(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),m=(0,r["default"])("td",{className:"col-xs-2"},void 0,"tensai"),p=(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"10")),x=(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),g=(0,r["default"])("td",{className:"col-xs-2"},void 0,"troll99"),v=(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"99")),y=(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),b=(0,r["default"])("td",{className:"col-xs-2"},void 0,"super_girl"),T=(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,"8")),S=(0,r["default"])("input",{type:"text",className:"form-control",id:"code",placeholder:"Code"}),M=(0,r["default"])("p",{},void 0,"Leave this field empty if you do not want to restrain access to your game."),C=(0,r["default"])("div",{className:"form-group"},void 0,(0,r["default"])("label",{htmlFor:"pwd"},void 0,"Password"),(0,r["default"])("input",{type:"password",className:"form-control",id:"pwd",placeholder:"Enter Password"})),F=(0,r["default"])("div",{className:"panel-heading"},void 0,(0,r["default"])("h4",{},void 0,"Leaderboard")),E=(0,r["default"])("thead",{className:"well"},void 0,(0,r["default"])("tr",{},void 0,(0,r["default"])("th",{className:"col-xs-4"},void 0,"Rank"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Name"),(0,r["default"])("th",{className:"col-xs-4"},void 0,"Level"))),w=t.MembersOld=function(e){var t=e.auth,i=e.newGame,s=e.leaveGame,o=function(){"in"!=t.user.flag&&document.getElementsByClassName("access")[0].click()},a=(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs",onClick:o},void 0,"GO!");return(0,r["default"])("div",{},void 0,l,(0,r["default"])("div",{className:"tab-content"},void 0,(0,r["default"])("div",{id:"home",className:"tab-pane fade in active"},void 0,(0,r["default"])("div",{className:"container"},void 0,(0,r["default"])("div",{className:"row"},void 0,(0,r["default"])("div",{className:"panel panel-default"},void 0,h,(0,r["default"])("table",{className:"table",id:d["default"].tableFixed},void 0,u,(0,r["default"])("tbody",{id:"active"},void 0,(0,r["default"])("tr",{},void 0,f,c,(0,r["default"])("td",{className:"col-xs-4"},void 0,_,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs join",onClick:o},void 0,"GO!"))),(0,r["default"])("tr",{},void 0,m,p,(0,r["default"])("td",{className:"col-xs-4"},void 0,x,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs join",onClick:o},void 0,"GO!"))),(0,r["default"])("tr",{},void 0,g,v,(0,r["default"])("td",{className:"col-xs-4"},void 0,y,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs join",onClick:o},void 0,"GO!"))),(0,r["default"])("tr",{},void 0,b,T,(0,r["default"])("td",{className:"col-xs-4"},void 0,S,(0,r["default"])("button",{type:"button",className:"btn btn-success btn-xs join",onClick:o},void 0,"GO!"))),t.activeGames.map(function(e,t){return(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-2"},void 0,e.user.name),(0,r["default"])("td",{className:"col-xs-6"},void 0,(0,r["default"])("span",{className:"badge"},void 0,e.user.rank)),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("input",{type:"text",className:"form-control",id:d["default"][e.isProtected],placeholder:"Code"}),a))})))),(0,r["default"])("div",{className:d["default"].newGame},void 0,(0,r["default"])("a",{href:"#newGame","data-toggle":"collapse",id:d["default"][t.user.reserved]},void 0,"Host New Game"),(0,r["default"])("p",{id:d["default"][t.user.reserved]},void 0,"Waiting other players..."),(0,r["default"])("button",{type:"button",className:"btn btn-default",id:d["default"][t.user.reserved],onClick:s},void 0,"Leave Game"),(0,r["default"])("div",{id:"newGame",className:"collapse"},void 0,(0,r["default"])("form",{id:d["default"][t.user.reserved]},void 0,M,C,(0,r["default"])("button",{type:"button",className:"btn btn-default",onClick:function(){o(),i(document.getElementById("pwd").value)}},void 0,"Start!"))))))),(0,r["default"])("div",{id:"menu1",className:"tab-pane fade"},void 0,(0,r["default"])("div",{className:"container"},void 0,(0,r["default"])("div",{className:"row"},void 0,(0,r["default"])("div",{className:"panel panel-default"},void 0,F,(0,r["default"])("table",{className:"table",id:d["default"].tableFixed},void 0,E,(0,r["default"])("tbody",{},void 0,t.allUsers.map(function(e,t){return(0,r["default"])("tr",{},void 0,(0,r["default"])("td",{className:"col-xs-4"},void 0,t+1),(0,r["default"])("td",{className:"col-xs-4"},void 0,e.name),(0,r["default"])("td",{className:"col-xs-4"},void 0,(0,r["default"])("span",{className:"badge"},void 0,e.rank)))})))))))))};t["default"]=w},464:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(172)),d=i(174),l=i(173),h=i(276),u=(i(88),(0,r["default"])(h.Settings,{})),f=(0,r["default"])(d.GameInfo,{}),c=(0,r["default"])(n.Board,{}),_=(0,r["default"])(l.Buttons,{}),m=(0,r["default"])(h.Settings,{}),p=(0,r["default"])(d.GameInfoOld,{}),x=(0,r["default"])(n.BoardOld,{}),g=(0,r["default"])(l.ButtonsOld,{}),v={material:function(){return[u,f,c,_]},bootstrap:function(){return[m,p,x,g]}},y=t.Game=function(e){var t=e.view;return(0,r["default"])("div",{},void 0,v[t.theme]())};t["default"]=y},465:[1076,464],468:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.evaluateSelection=t.updateSelectionState=t.createBoard=void 0;var o=i(487),r=s(o),a=i(128),n=s(a),d=i(228),l=(t.createBoard=function(e,t){for(var i=[],s=0,o=0;s<t;s++)for(var r=0;r<t;r++)e[o]<=.75?i[o]={x:s,y:r,type:"marble"}:e[o]<=.9?i[o]={x:s,y:r,type:"obstacle"}:i[o]={x:s,y:r,type:"empty"},o++;var a=i.filter(function(e){return"marble"===e.type}).length;return{pieces:i,initialMarbles:a}},t.updateSelectionState=function(e,t){var i=e.slice();if("mark"===t.tag&&(i=i.map(function(e,i){return i==t.cell?(0,n["default"])({},e,{type:"selected"}):e})),"comp"===t.tag&&t.aiMove)for(var s=function(e){i=i.map(function(i){return i.x==t.aiMove[e][0]&&i.y==t.aiMove[e][1]&&"marble"==i.type?(0,n["default"])({},i,{type:"selected"}):i})},o=0;o<t.aiMove.length;o++)s(o);return i},function(e,t,i){return 1===t.length&&!e.filter(function(e){return e.x==t[0]&&i[0]<=e.y&&e.y<i[i.length-1]}).find(function(e){return"obstacle"===e.type||"marble"===e.type})}),h=function(e,t,i){return 1===i.length&&!e.filter(function(e){return e.y==i[0]&&t[0]<=e.x&&e.x<t[t.length-1]}).find(function(e){return"obstacle"===e.type||"marble"===e.type})};t.evaluateSelection=function(e){var t=(0,r["default"])(d.countBy(d.filter(e.pieces,function(e){return"selected"===e.type}),function(e){return e.x})),i=(0,r["default"])(d.countBy(d.filter(e.pieces,function(e){return"selected"===e.type}),function(e){return e.y})),s=e.pieces.map(function(e){return"selected"===e.type?(0,n["default"])({},e,{type:"empty"}):e}),o=0===e.pieces.filter(function(e){return"marble"===e.type}).length,a=l(e.pieces,t,i)||h(e.pieces,t,i),u=1===e.pieces.filter(function(e){return"marble"===e.type}).length,f=[{st:(0,n["default"])({},e,{pieces:e.pieces.map(function(e){return"selected"===e.type?(0,n["default"])({},e,{type:"marble"}):e})}),is:!a||o},{st:(0,n["default"])({},e,{pieces:s,text:e.text+" wins!"}),is:u},{st:(0,n["default"])({},e,{pieces:s,phase:"Player2Move",text:"Player2"}),is:"Player1Move"===e.phase},{st:(0,n["default"])({},e,{pieces:s,phase:"Player1Move",text:"Player1"}),is:"Player2End"===e.phase},{st:(0,n["default"])({},e,{pieces:s,phase:"Player1Move",text:"Player1"}),is:"Player2Move"===e.phase}];return f.find(function(e){return e.is===!0}).st}},472:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(172),i(174),i(173),i(475)),d=i(473),l=i(377),h=(s(l),(0,r["default"])(d.LogIn,{})),u=(0,r["default"])(n.Members,{}),f=(0,r["default"])(d.LogInOld,{}),c=(0,r["default"])(n.MembersOld,{}),_={material:function(){return[h,u]},bootstrap:function(){return[f,c]}},m=(0,r["default"])("p",{},void 0,"Online mode is under development. Material theme is in progress. No database exists and there is no way to play with others yet. You can sign up temporarily until you refresh the page."),p=t.Game=function(e){var t=e.view;return(0,r["default"])("div",{},void 0,m,_[t.theme]())};t["default"]=p},473:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogInOld=t.LogIn=void 0;var s=i(35),o=i(175),r=i(274),a={logIn:o.logIn,logOut:o.logOut,signUp:o.signUp,cleanForm:o.cleanForm},n=function(e){return{auth:e.auth}};t.LogIn=(0,s.connect)(n,a)(r.LogIn),t.LogInOld=(0,s.connect)(n,a)(r.LogInOld)},474:[1076,472],475:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MembersOld=t.Members=void 0;var s=i(35),o=i(175),r=i(274),a={newGame:o.newGame,leaveGame:o.leaveGame},n=function(e){return{auth:e.auth}};t.Members=(0,s.connect)(n,a)(r.Members),t.MembersOld=(0,s.connect)(n,a)(r.MembersOld)},477:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(228);t.validateCred=function(e,t){var i={};return console.log(e),e.name.length>10&&(i.name="Username has to be less than 10 letters."),e.name.length<4&&(i.name="Username has to be more than 4 letters."),e.pwd.length<4&&(i.pwd="Password has to be more than 4 letters."),!s.includes(e.email,"@")&&(i.email="Please enter a valid e-mail."),s.find(t,function(t){return e.name==t.name})&&(i.name="Username already exists."),s.find(t,function(t){return e.email==t.email})&&(i.email="Email already in use."),console.log(i),i},t.validateUser=function(e,t){return s.find(t,function(t){return e.name==t.name&&e.pwd==t.pwd})}},478:function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var o=i(12),r=s(o),a=i(1),n=(s(a),i(172)),d=i(174),l=i(173),h=i(276),u=(i(88),(0,r["default"])(h.Settings,{})),f=(0,r["default"])(d.GameInfo,{}),c=(0,r["default"])(n.Board,{}),_=(0,r["default"])(l.Buttons,{}),m=(0,r["default"])(h.Settings,{}),p=(0,r["default"])(d.GameInfoOld,{}),x=(0,r["default"])(n.BoardOld,{}),g=(0,r["default"])(l.ButtonsOld,{}),v={material:function(){return[u,f,c,_]},bootstrap:function(){return[m,p,x,g]}},y=t.Game=function(e){var t=e.view;return(0,r["default"])("div",{},void 0,v[t.theme]())};t["default"]=y},479:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var s=i(35),o=i(478),r=i(55),a=function(e){return{view:e.view}},n={changeTheme:r.changeTheme};t.Game=(0,s.connect)(a,n)(o.Game)},487:function(e,t,i){e.exports={"default":i(495),__esModule:!0}},495:function(e,t,i){i(518),e.exports=i(56).Object.keys},511:[1115,130,56,92],518:[1116,287,93,511],705:709,706:function(e,t){e.exports={boots:"Buttons__boots___1Pwbg",start:"Buttons__start___1iFZ6",end:"Buttons__end___3PU7B"}},707:function(e,t){e.exports={settings:"Settings__settings___2OMiG",end:"Settings__end___2yC6e",label:"Settings__label___fpXmA"}},726:function(e,t,i){e.exports=i.p+"f6438af940546a3d46285fbf5c5de4d6.gif"},1075:function(module,exports){function defineClass(e,t,i){function s(){}if(e&&(s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t,t.superClass=e),i)for(var o in i)t.prototype[o]=i[o];return t}function array_to_object(e){for(var t={},i=0;i<e.length;i++)t[e[i]]="";return t}function uploadDDSLevels(e,t,i,s){function o(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function r(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var a,n,d,l,h,u,f,c,_,m,p=542327876,x=131072,g=4,v=o("DXT1"),y=o("DXT5"),b=31,T=0,S=1,M=2,C=3,F=4,E=7,w=20,A=21,N=new Int32Array(i,0,b);if(N[T]!=p)return console.error("Invalid magic number in DDS header"),0;if(!N[w]&g)return console.error("Unsupported format, must contain a FourCC code"),0;switch(a=N[A]){case v:n=8,d=t.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case y:n=16,d=t.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return console.error("Unsupported FourCC code:",r(a)),null}for(_=1,N[M]&x&&s!==!1&&(_=Math.max(1,N[E])),l=N[F],h=N[C],f=N[S]+4,m=0;m<_;++m)u=Math.max(4,l)/4*Math.max(4,h)/4*n,c=new Uint8Array(i,f,u),e.compressedTexImage2D(e.TEXTURE_2D,m,d,l,h,0,c),f+=u,l*=.5,h*=.5;return _}function startDashVideo(e,t){var i,s,o,r=function(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,i,s){e[i]=s});return e},a=e;r&&r.hasOwnProperty("url")&&(a=r.url),i=document.querySelector(t),s=new Dash.di.DashContext,o=new MediaPlayer(s),o.startup(),o.attachView(i),o.setAutoPlay(!1),o.attachSource(a)}function setNamespace(e,t,i){t instanceof Element&&void 0!==t.__setAttribute&&(t.hasAttribute("id")?t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("id")):t.hasAttribute("DEF")&&i&&(t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("DEF")),t.id||(t.id=t.__getAttribute("id")))),t.hasChildNodes()&&Array.forEach(t.childNodes,function(t){setNamespace(e,t,i)})}Array.forEach||(Array.forEach=function(e,t,i){for(var s=e.length,o=0;o<s;o++)o in e&&t.call(i,e[o],o,e)}),Array.map||(Array.map=function(e,t,i){for(var s=e.length,o=[],r=0;r<s;r++)r in e&&(o[r]=t.call(i,e[r],r,e));return o}),Array.filter||(Array.filter=function(e,t,i){for(var s=e.length,o=[],r=0;r<s;r++)if(r in e){var a=e[r];t.call(i,a,r,e)&&o.push(a)}return o});var x3dom={canvases:[],x3dNS:"http://www.web3d.org/specifications/x3d-namespace",x3dextNS:"http://philip.html5.org/x3d/ext",xsltNS:"http://www.w3.org/1999/XSL/x3dom.Transform",xhtmlNS:"http://www.w3.org/1999/xhtml"};x3dom.nodeTypes={},x3dom.nodeTypesLC={},x3dom.components={},x3dom.geoCache=[],x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent,RENDERMODE:"HARDWARE"},x3dom.registerNodeType=function(e,t,i){void 0===x3dom.components[t]&&(x3dom.components[t]={}),i._typeName=e,i._compName=t,x3dom.components[t][e]=i,x3dom.nodeTypes[e]=i,x3dom.nodeTypesLC[e.toLowerCase()]=i},x3dom.isX3DElement=function(e){var t=e.nodeType===Node.ELEMENT_NODE&&e.localName?e.localName.toLowerCase():null;return t&&(x3dom.nodeTypes[e.localName]||x3dom.nodeTypesLC[t]||"x3d"==t||"websg"==t||"route"==t)},x3dom.extend=function(e){function t(){}return t.prototype=e.prototype||e,new t},x3dom.getStyle=function(e,t){var i="",s=document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null):null;return s?i=s.getPropertyValue(t):e.currentStyle&&(t=t.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),i=e.currentStyle[t]),i},x3dom.isa=function(e,t){return e instanceof t},x3dom.getGlobal=function(){return function(){return this}.call(null)},x3dom.loadJS=function(src,path_prefix,blocking){if(blocking=blocking!==!1||blocking){var url=path_prefix?path_prefix.trim()+src:src,req=new XMLHttpRequest;req&&(req.open("GET",url,!1),req.send(null),eval(req.responseText))}else{var head=document.getElementsByTagName("HEAD").item(0),script=document.createElement("script"),loadpath=path_prefix?path_prefix.trim()+src:src;head?(x3dom.debug.logError("Trying to load external JS file: "+loadpath),script.type="text/javascript",script.src=loadpath,head.appendChild(script)):alert("No document object found. Can't load components!")}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,16)}}(),x3dom.toggleFullScreen=function(){if(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var e=document.documentElement;e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()}},x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:1e4,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(e){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer(),x3dom.debug.isSetup=!0}},activate:function(e){x3dom.debug.isActive=!0,x3dom.debug.logContainer.style.display=e?"block":"none",x3dom.debug.isAppend||("Microsoft Internet Explorer"==navigator.appName?(x3dom.debug.logContainer.style.marginLeft="8px",document.documentElement.appendChild(x3dom.debug.logContainer)):document.body.appendChild(x3dom.debug.logContainer),x3dom.debug.isAppend=!0)},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div"),x3dom.debug.logContainer.id="x3dom_logdiv",x3dom.debug.logContainer.setAttribute("class","x3dom-logContainer"),x3dom.debug.logContainer.style.clear="both"},doLog:function(e,t){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(e="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var i=document.createElement("p");switch(i.style.margin=0,t){case x3dom.debug.INFO:i.style.color="#00ff00";break;case x3dom.debug.WARNING:i.style.color="#cd853f";break;case x3dom.debug.ERROR:i.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:i.style.color="#ffff00";break;default:i.style.color="#00ff00"}try{i.innerHTML=t+": "+e,x3dom.debug.logContainer.insertBefore(i,x3dom.debug.logContainer.firstChild)}catch(s){void 0!==window.console.firebug&&window.console.warn(e)}if(x3dom.debug.isFirebugAvailable)switch(t){case x3dom.debug.INFO:window.console.info(e);break;case x3dom.debug.WARNING:window.console.warn(e);break;case x3dom.debug.ERROR:window.console.error(e);break;case x3dom.debug.EXCEPTION:window.console.debug(e)}x3dom.debug.numLinesLogged++}},logInfo:function(e){x3dom.debug.doLog(e,x3dom.debug.INFO)},logWarning:function(e){x3dom.debug.doLog(e,x3dom.debug.WARNING)},logError:function(e){x3dom.debug.doLog(e,x3dom.debug.ERROR)},logException:function(e){x3dom.debug.doLog(e,x3dom.debug.EXCEPTION)},assert:function(e,t){e||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+t,x3dom.debug.ERROR)},typeOf:function(e){var t=typeof e;return"object"!==t||e?t:"null"},exists:function(e,t,i){return i=i||"function",(e?this.typeOf(e[t]):"null")===i},dumpFields:function(e){var t="";for(var i in e)t+=i+", ";return t+="\n",x3dom.debug.logInfo(t),t}},x3dom.debug.setup(),x3dom.arc={},x3dom.arc.instance=null,x3dom.arc.Limits=function(e,t,i){this._min=e,this._max=t,this.getValue=function(e){return e=this._min+(this._max-this._min)*e,this._max>=e?this._min<=e?e:this._min:this._max}},x3dom.arc.ARF=function(e,t,i,s,o,r,a,n){this._name=e,this._stateValue=[.5,.5],this._limits=new x3dom.arc.Limits(t,i),this._factorGetterFunc=o,this._factorSetterFunc=r,this._setterFunc=n,this._getterFunc=a,this._dirFac=s,this.getFactor=function(){return this._factorGetterFunc()},this.update=function(e,t){var i=this._stateValue[e]+t*this._dirFac;this._stateValue[e]=0<=i?1>=i?i:1:0,this._setterFunc(this._limits.getValue(this._stateValue[e]))},this.reset=function(){this._stateValue[0]=.5,this._stateValue[1]=.5}},x3dom.arc.AdaptiveRenderControl=defineClass(null,function(e){x3dom.arc.instance=this,this._scene=e,this._targetFrameRate=[],this._targetFrameRate[0]=this._scene._vf.minFrameRate,this._targetFrameRate[1]=this._scene._vf.maxFrameRate,this._currentState=0;var t=this,i=t._scene.getEnvironment();this._arfs=[],this._arfs.push(new x3dom.arc.ARF("smallFeatureCulling",0,10,(-1),function(){return i._vf.smallFeatureFactor},function(e){i._vf.smallFeatureFactor=e},function(){return i._vf.smallFeatureThreshold},function(e){i._vf.smallFeatureThreshold=e})),this._arfs.push(new x3dom.arc.ARF("lowPriorityCulling",0,100,1,function(){return i._vf.lowPriorityFactor},function(e){i._vf.lowPriorityFactor=e},function(){return 100*i._vf.lowPriorityThreshold},function(e){i._vf.lowPriorityThreshold=e/100})),this._arfs.push(new x3dom.arc.ARF("tessellationDetailCulling",1,12,(-1),function(){return i._vf.tessellationErrorFactor},function(e){i._vf.tessellationErrorFactor=e},function(){return i.tessellationErrorThreshold},function(e){i.tessellationErrorThreshold=e})),this._stepWidth=.1},{update:function(e,t){this._currentState=e;var i=t-this._targetFrameRate[e];this._stepWidth=Math.abs(i)>10?.1:.01;var s,o=0,r=[],a=this._arfs.length;for(s=0;s<a;++s)r[s]=this._arfs[s].getFactor(),r[s]>0&&(o+=r[s]);var n=i<0?-1:1;for(s=0;s<a;++s)r[s]>0&&(r[s]/=o,this._arfs[s].update(e,this._stepWidth*r[s]*n))},reset:function(){for(var e=0,t=this._arfs.length;e<t;++e)this._arfs[e].reset()}});var Request=function(e,t,i){this.url=e,this.priority=i,this.xhr=new XMLHttpRequest,this.onloadCallbacks=[t];var s=this;this.xhr.onload=function(){if(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager received data for URL '"+s.url+"'."),--x3dom.DownloadManager.activeDownloads,x3dom.DownloadManager.stallToKeepOrder===!1||x3dom.DownloadManager.resultGetsStalled(s.priority)===!1){var e;for(e=0;e<s.onloadCallbacks.length;++e)s.onloadCallbacks[e](s.xhr.response);x3dom.DownloadManager.removeDownload(s),x3dom.DownloadManager.updateStalledResults()}else x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager stalled downloaded result for URL '"+s.url+"'.");x3dom.DownloadManager.tryNextDownload()}};Request.prototype.send=function(){this.xhr.open("GET",encodeURI(this.url),!0),this.xhr.responseType="arraybuffer",this.xhr.send(null),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager posted XHR for URL '"+this.url+"'.")},x3dom.DownloadManager={requests:[],maxDownloads:6,activeDownloads:0,debugOutput:!1,stallToKeepOrder:!1,toggleDebugOutput:function(e){this.debugOutput=e},toggleStrictReturnOrder:function(e){this.stallToKeepOrder=!1},removeDownload:function(e){var t,i,s=!1;for(t=0;t<this.requests.length&&!s;++t)if(this.requests[t])for(i=0;i<this.requests[t].length;++i)if(this.requests[t][i]===e){this.requests[t].splice(i,1),s=!0;break}},tryNextDownload:function(){var e,t,i;if(this.activeDownloads<this.maxDownloads){for(t=0;t<this.requests.length&&!e;++t)if(this.requests[t])for(i=0;i<this.requests[t].length;++i)if(this.requests[t][i].xhr.readyState===XMLHttpRequest.UNSENT){e=this.requests[t][i];break}e&&(e.send(),++this.activeDownloads)}},resultGetsStalled:function(e){var t;for(t=0;t<e;++t)if(this.requests[t]&&this.requests[t].length)return!0;return!1},updateStalledResults:function(){if(x3dom.DownloadManager.stallToKeepOrder){var e,t,i,s,o=!1;for(e=0;e<this.requests.length&&!o;++e)if(this.requests[e])for(t=0;t<this.requests[e].length;++t)if(s=this.requests[e][t],s.xhr.readyState===XMLHttpRequest.DONE){for(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager releases stalled result for URL '"+s.url+"'."),i=0;i<s.onloadCallbacks.length;++i)s.onloadCallbacks[i](s.xhr.response);this.requests[e].splice(t,1)}else o=!0}},get:function(e,t,i){var s,o,r,a,n,d,l,h=!1;if(e.length!==t.length||e.length!==i.length)return void x3dom.debug.logError("DownloadManager: The number of given urls, onload callbacks and priorities is not equal. Ignoring requests.");for(r=0;r<e.length;++r)if(void 0!==!t[r]&&void 0!==!i[r]){for(n=e[r],d=t[r],l=i[r],s=0;s<this.requests.length&&!h;++s)if(this.requests[s])for(o=0;o<this.requests[s].length;++o)if(this.requests[s][o].url===n){this.requests[s][o].onloadCallbacks.push(d),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager appended onload callback for URL '"+n+"' to a registered request using the same URL."),h=!0;break}h||(a=new Request(n,d,l),this.requests[l]?this.requests[l].push(a):this.requests[l]=[a])}else x3dom.debug.logError('DownloadManager: No onload callback and / or priority specified. Ignoring request for "'+n+'"');for(s=0;s<e.length&&this.activeDownloads<this.maxDownloads;++s)this.tryNextDownload()}},x3dom.MultiMaterial=function(e){this._origAmbientIntensity=e.ambientIntensity,this._origDiffuseColor=e.diffuseColor,this._origEmissiveColor=e.emissiveColor,this._origShininess=e.shininess,this._origSpeclarColor=e.specularColor,this._origTransparency=e.transparency,this._origBackAmbientIntensity=e.backAmbientIntensity,this._origBackDiffuseColor=e.backDiffuseColor,this._origBackEmissiveColor=e.backEmissiveColor,this._origBackShininess=e.backShininess,this._origBackSpecularColor=e.backSpecularColor,this._origBackTransparency=e.backTransparency,this._ambientIntensity=e.ambientIntensity,this._diffuseColor=e.diffuseColor,this._emissiveColor=e.emissiveColor,this._shininess=e.shininess,this._specularColor=e.specularColor,this._transparency=e.transparency,this._backAmbientIntensity=e.backAmbientIntensity,this._backDiffuseColor=e.backDiffuseColor,this._backEmissiveColor=e.backEmissiveColor,this._backShininess=e.backShininess,this._backSpecularColor=e.backSpecularColor,this._backTransparency=e.backTransparency,this._highlighted=!1,this.reset=function(){this._ambientIntensity=this._origAmbientIntensity,this._diffuseColor=this._origDiffuseColor,this._emissiveColor=this._origEmissiveColor,this._shininess=this._origShininess,this._specularColor=this._origSpeclarColor,this._transparency=this._origTransparency,this._backAmbientIntensity=this._origBackAmbientIntensity,this._backDiffuseColor=this._origBackDiffuseColor,this._backEmissiveColor=this._origBackEmissiveColor,this._backShininess=this._origBackShininess,this._backSpecularColor=this._origBackSpecularColor,this._backTransparency=this._origBackTransparency}},x3dom.Parts=function(e,t,i,s,o,r){var a=this;this.multiPart=e,this.ids=t,this.colorMap=i,this.emissiveMap=s,this.specularMap=o,this.visibilityMap=r,this.width=a.colorMap.getWidth(),this.widthTwo=this.width*this.width,this.setDiffuseColor=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=a.colorMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._diffuseColor=e:"back"==i?this.multiPart._materials[o]._backDiffuseColor=e:"both"==i&&(this.multiPart._materials[o]._diffuseColor=e,this.multiPart._materials[o]._backDiffuseColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[n].r=e.r,d[n].g=e.g,d[n].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[n].r=e.r,d[n].g=e.g,d[n].b=e.b));a.colorMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.colorMap.getPixel(l,h),this.multiPart._materials[o]._diffuseColor=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.colorMap.getPixel(u,f),this.multiPart._materials[o]._backDiffuseColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.colorMap.getPixel(l,h),_=a.colorMap.getPixel(u,f),this.multiPart._materials[o]._diffuseColor=e,this.multiPart._materials[o]._backDiffuseColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.r=e.r,c.g=e.g,c.b=e.b,a.colorMap.setPixel(l,h,c)):"back"==i?(_.r=e.r,_.g=e.g,_.b=e.b,a.colorMap.setPixel(u,f,_)):"both"==i&&(c.r=e.r,c.g=e.g,c.b=e.b,_.r=e.r,_.g=e.g,_.b=e.b,a.colorMap.setPixel(l,h,c),a.colorMap.setPixel(u,f,_)))}},this.getDiffuseColor=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._diffuseColor):"back"==e&&o.push(this.multiPart._materials[s]._backDiffuseColor);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._diffuseColor:"back"==e?this.multiPart._materials[s]._backDiffuseColor:void 0},this.setEmissiveColor=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=a.emissiveMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._emissiveColor=e:"back"==i?this.multiPart._materials[o]._backEmissiveColor=e:"both"==i&&(this.multiPart._materials[o]._emissiveColor=e,this.multiPart._materials[o]._backEmissiveColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[n].r=e.r,d[n].g=e.g,d[n].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[n].r=e.r,d[n].g=e.g,d[n].b=e.b));a.emissiveMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.emissiveMap.getPixel(l,h),this.multiPart._materials[o]._emissiveColor=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.emissiveMap.getPixel(u,f),this.multiPart._materials[o]._backEmissiveColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.emissiveMap.getPixel(l,h),_=a.emissiveMap.getPixel(u,f),this.multiPart._materials[o]._emissiveColor=e,this.multiPart._materials[o]._backEmissiveColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.r=e.r,c.g=e.g,c.b=e.b,a.emissiveMap.setPixel(l,h,c)):"back"==i?(_.r=e.r,
_.g=e.g,_.b=e.b,a.emissiveMap.setPixel(u,f,_)):"both"==i&&(c.r=e.r,c.g=e.g,c.b=e.b,_.r=e.r,_.g=e.g,_.b=e.b,a.emissiveMap.setPixel(l,h,c),a.emissiveMap.setPixel(u,f,_)))}},this.getEmissiveColor=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._emissiveColor):"back"==e&&o.push(this.multiPart._materials[s]._backEmissiveColor);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._emissiveColor:"back"==e?this.multiPart._materials[s]._backEmissiveColor:void 0},this.setSpecularColor=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=a.specularMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._specularColor=e:"back"==i?this.multiPart._materials[o]._backSpecularColor=e:"both"==i&&(this.multiPart._materials[o]._specularColor=e,this.multiPart._materials[o]._backSpecularColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[n].r=e.r,d[n].g=e.g,d[n].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[n].r=e.r,d[n].g=e.g,d[n].b=e.b));a.specularMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.specularMap.getPixel(l,h),this.multiPart._materials[o]._specularColor=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.specularMap.getPixel(u,f),this.multiPart._materials[o]._backSpecularColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.specularMap.getPixel(l,h),_=a.specularMap.getPixel(u,f),this.multiPart._materials[o]._specularColor=e,this.multiPart._materials[o]._backSpecularColor=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.r=e.r,c.g=e.g,c.b=e.b,a.specularMap.setPixel(l,h,c)):"back"==i?(_.r=e.r,_.g=e.g,_.b=e.b,a.specularMap.setPixel(u,f,_)):"both"==i&&(c.r=e.r,c.g=e.g,c.b=e.b,_.r=e.r,_.g=e.g,_.b=e.b,a.specularMap.setPixel(l,h,c),a.specularMap.setPixel(u,f,_)))}},this.getSpecularColor=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._specularColor):"back"==e&&o.push(this.multiPart._materials[s]._backSpecularColor);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._specularColor:"back"==e?this.multiPart._materials[s]._backSpecularColor:void 0},this.setTransparency=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=a.colorMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._transparency=e:"back"==i?this.multiPart._materials[o]._backTransparency=e:"both"==i&&(this.multiPart._materials[o]._transparency=e,this.multiPart._materials[o]._backTransparency=e),this.multiPart._materials[o]._highlighted||("front"==i?d[r].a=1-e:"back"==i?d[n].a=1-e:"both"==i&&(d[r].a=1-e,d[n].a=1-e));a.colorMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.colorMap.getPixel(l,h),this.multiPart._materials[o]._transparency=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.colorMap.getPixel(u,f),this.multiPart._materials[o]._backTransparency=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.colorMap.getPixel(l,h),_=a.colorMap.getPixel(u,f),this.multiPart._materials[o]._transparency=e,this.multiPart._materials[o]._backTransparency=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.a=1-e,a.colorMap.setPixel(l,h,c)):"back"==i?(_.a=1-e,a.colorMap.setPixel(u,f,_)):"both"==i&&(c.a=1-e,_.a=1-e,a.colorMap.setPixel(l,h,c),a.colorMap.setPixel(u,f,_)))}},this.getTransparency=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._transparency):"back"==e&&o.push(this.multiPart._materials[s]._backTransparency);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._transparency:"back"==e?this.multiPart._materials[s]._backTransparency:void 0},this.setShininess=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=a.specularMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._shininess=e:"back"==i?this.multiPart._materials[o]._backShininess=e:"both"==i&&(this.multiPart._materials[o]._shininess=e,this.multiPart._materials[o]._backShininess=e),this.multiPart._materials[o]._highlighted||("front"==i?d[r].a=e:"back"==i?d[n].a=e:"both"==i&&(d[r].a=e,d[n].a=e));a.specularMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.specularMap.getPixel(l,h),this.multiPart._materials[o]._shininess=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.specularMap.getPixel(u,f),this.multiPart._materials[o]._backShininess=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.specularMap.getPixel(l,h),_=a.specularMap.getPixel(u,f),this.multiPart._materials[o]._shininess=e,this.multiPart._materials[o]._backShininess=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.a=e,a.specularMap.setPixel(l,h,c)):"back"==i?(_.a=e,a.specularMap.setPixel(u,f,_)):"both"==i&&(c.a=e,_.a=e,a.specularMap.setPixel(l,h,c),a.specularMap.setPixel(u,f,_)))}},this.getShininess=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._shininess):"back"==e&&o.push(this.multiPart._materials[s]._backShininess);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._shininess:"back"==e?this.multiPart._materials[s]._backShininess:void 0},this.setAmbientIntensity=function(e,i){var s,o,r,n;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=a.emissiveMap.getPixels();for(s=0;s<a.ids.length;s++)o=a.ids[s],r=o,n=o+this.widthTwo,"front"==i?this.multiPart._materials[o]._ambientIntensity=e:"back"==i?this.multiPart._materials[o]._backAmbientIntensity=e:"both"==i&&(this.multiPart._materials[o]._ambientIntensity=e,this.multiPart._materials[o]._backAmbientIntensity=e),this.multiPart._materials[o]._highlighted||("front"==i?d[r].a=e:"back"==i?d[n].a=e:"both"==i&&(d[r].a=e,d[n].a=e));a.emissiveMap.setPixels(d)}else{var l,h,u,f,c,_;o=a.ids[0],r=o,n=o+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),c=a.emissiveMap.getPixel(l,h),this.multiPart._materials[o]._ambientIntensity=e):"back"==i?(u=n%this.width,f=Math.floor(n/this.width),_=a.emissiveMap.getPixel(u,f),this.multiPart._materials[o]._backAmbientIntensity=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=n%this.width,f=Math.floor(n/this.width),c=a.emissiveMap.getPixel(l,h),_=a.emissiveMap.getPixel(u,f),this.multiPart._materials[o]._ambientIntensity=e,this.multiPart._materials[o]._backAmbientIntensity=e),this.multiPart._materials[o]._highlighted||("front"==i?(c.a=e,a.emissiveMap.setPixel(l,h,c)):"back"==i?(_.a=e,a.emissiveMap.setPixel(u,f,_)):"both"==i&&(c.a=e,_.a=e,a.emissiveMap.setPixel(l,h,c),a.emissiveMap.setPixel(u,f,_)))}},this.getAmbientIntensity=function(e){var i,s;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var o=[];for(i=0;i<a.ids.length;i++)s=a.ids[i],"front"==e?o.push(this.multiPart._materials[s]._ambientIntensity):"back"==e&&o.push(this.multiPart._materials[s]._backAmbientIntensity);return o}return s=a.ids[0],"front"==e?this.multiPart._materials[s]._ambientIntensity:"back"==e?this.multiPart._materials[s]._backAmbientIntensity:void 0},this.highlight=function(e){var i,s,o,r,n,d,l;if(e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var h=a.colorMap.getPixels(),u=a.emissiveMap.getPixels(),f=a.specularMap.getPixels();for(n=new x3dom.fields.SFColorRGBA(0,0,0,1),d=new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,0),l=new x3dom.fields.SFColorRGBA(0,0,0,0),i=0;i<a.ids.length;i++)s=a.ids[i],o=s,r=s+this.widthTwo,this.multiPart._materials[s]._highlighted||(this.multiPart._materials[s]._highlighted=!0,h[o]=n,u[o]=d,f[o]=l,h[r]=n,u[r]=d,f[r]=l);this.colorMap.setPixels(h,!1),this.emissiveMap.setPixels(u,!1),this.specularMap.setPixels(f,!0)}else{s=a.ids[0],o=s,r=s+this.widthTwo;var c=o%this.width,_=Math.floor(o/this.width),m=r%this.width,p=Math.floor(r/this.width);this.multiPart._materials[s]._highlighted||(this.multiPart._materials[s]._highlighted=!0,n=new x3dom.fields.SFColorRGBA(0,0,0,1),d=new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,0),l=new x3dom.fields.SFColorRGBA(0,0,0,0),this.colorMap.setPixel(c,_,n,!1),this.emissiveMap.setPixel(c,_,d,!1),this.specularMap.setPixel(c,_,l,!1),this.colorMap.setPixel(m,p,n,!1),this.emissiveMap.setPixel(m,p,d,!1),this.specularMap.setPixel(m,p,l,!0))}},this.unhighlight=function(){var e,i,s,o,r,n,d,l,h,u,f;if(t.length&&t.length>1){var c=a.colorMap.getPixels(),_=a.emissiveMap.getPixels(),m=a.specularMap.getPixels();for(e=0;e<a.ids.length;e++)i=a.ids[e],s=i,o=i+this.widthTwo,r=this.multiPart._materials[i],r._highlighted&&(r._highlighted=!1,c[s]=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),_[s]=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),m[s]=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),c[o]=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),_[o]=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),m[o]=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess));this.colorMap.setPixels(c,!1),this.emissiveMap.setPixels(_,!1),this.specularMap.setPixels(m,!0)}else{i=a.ids[0],s=i,o=i+this.widthTwo;var p=s%this.width,x=Math.floor(s/this.width),g=o%this.width,v=Math.floor(o/this.width);r=this.multiPart._materials[i],r._highlighted&&(r._highlighted=!1,n=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),d=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),l=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),h=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),u=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),f=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess),this.colorMap.setPixel(p,x,n,!1),this.emissiveMap.setPixel(p,x,d,!1),this.specularMap.setPixel(p,x,l,!1),this.colorMap.setPixel(g,v,h,!1),this.emissiveMap.setPixel(g,v,u,!1),this.specularMap.setPixel(g,v,f,!0))}},this.toggleHighlight=function(e){for(var t=0;t<a.ids.length;t++)this.multiPart._materials[a.ids[t]]._highlighted?this.unhighlight():this.highlight(e)},this.setColor=function(e,t){this.setDiffuseColor(e,t)},this.getColorRGB=function(){var e=this.getColorRGBA(),t=e.split(" ");return t[0]+" "+t[1]+" "+t[2]},this.getColorRGBA=function(){var e,t,i=this.multiPart._originalColor[a.ids[0]];return this.multiPart._highlightedParts[a.ids[0]]?i=this.multiPart._highlightedParts[a.ids[0]]:(e=a.ids[0]%a.colorMap.getWidth(),t=Math.floor(a.ids[0]/a.colorMap.getWidth()),i=a.colorMap.getPixel(e,t)),i.toString()},this.resetColor=function(){var e,i,s,o,r,n,d,l,h,u,f;if(t.length&&t.length>1){var c=a.colorMap.getPixels(),_=a.emissiveMap.getPixels(),m=a.specularMap.getPixels();for(e=0;e<a.ids.length;e++)i=a.ids[e],s=i,o=i+this.widthTwo,r=this.multiPart._materials[i],r.reset(),r._highlighted||(c[s]=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),_[s]=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),m[s]=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),c[o]=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),_[o]=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),m[o]=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess));this.colorMap.setPixels(c,!1),this.emissiveMap.setPixels(_,!1),this.specularMap.setPixels(m,!0)}else{i=a.ids[0],s=i,o=i+this.widthTwo;var p=s%this.width,x=Math.floor(s/this.width),g=o%this.width,v=Math.floor(o/this.width);r=this.multiPart._materials[i],r.reset(),r._highlighted||(n=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),d=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),l=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),h=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),u=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),f=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess),this.colorMap.setPixel(p,x,n,!1),this.emissiveMap.setPixel(p,x,d,!1),this.specularMap.setPixel(p,x,l,!1),this.colorMap.setPixel(g,v,h,!1),this.emissiveMap.setPixel(g,v,u,!1),this.specularMap.setPixel(g,v,f,!0))}},this.setVisibility=function(e){var i,s,o,r,n,d,l;if(t.length&&t.length>1){var h=a.visibilityMap.getPixels();for(i=0;i<a.ids.length;i++)if(l=e?1:0,h[a.ids[i]].r!=l)for(h[a.ids[i]].r=l,this.multiPart._partVisibility[a.ids[i]]=e,n=this.multiPart._idMap.mapping[a.ids[i]].usage,s=0;s<n.length;s++)d=this.multiPart._visiblePartsPerShape[n[s]],e&&d.val<d.max?d.val++:!e&&d.val>0&&d.val--,d.val?this.multiPart._inlineNamespace.defMap[n[s]]._vf.render=!0:this.multiPart._inlineNamespace.defMap[n[s]]._vf.render=!1;a.visibilityMap.setPixels(h),this.multiPart.invalidateVolume()}else{o=a.ids[0]%a.colorMap.getWidth(),r=Math.floor(a.ids[0]/a.colorMap.getWidth());var u=a.visibilityMap.getPixel(o,r);if(l=e?1:0,u.r!=l)for(u.r=l,this.multiPart._partVisibility[a.ids[0]]=e,n=this.multiPart._idMap.mapping[a.ids[0]].usage,s=0;s<n.length;s++)d=this.multiPart._visiblePartsPerShape[n[s]],e&&d.val<d.max?d.val++:!e&&d.val>0&&d.val--,d.val?this.multiPart._inlineNamespace.defMap[n[s]]._vf.render=!0:this.multiPart._inlineNamespace.defMap[n[s]]._vf.render=!1;a.visibilityMap.setPixel(o,r,u),this.multiPart.invalidateVolume()}},this.getVolume=function(){var e,i=this.multiPart.getCurrentTransform();if(t.length&&t.length>1){e=new x3dom.fields.BoxVolume;for(var s=0;s<a.ids.length;s++)e.extendBounds(this.multiPart._partVolume[a.ids[s]].min,this.multiPart._partVolume[a.ids[s]].max);return e.transform(i),e}return e=x3dom.fields.BoxVolume.copy(this.multiPart._partVolume[a.ids[0]]),e.transform(i),e},this.fit=function(e){var t=this.getVolume();this.multiPart._nameSpace.doc._viewarea.fit(t.min,t.max,e)}},x3dom.Properties=function(){this.properties={}},x3dom.Properties.prototype.setProperty=function(e,t){x3dom.debug.logInfo("Properties: Setting property '"+e+"' to value '"+t+"'"),this.properties[e]=t},x3dom.Properties.prototype.getProperty=function(e,t){return this.properties[e]?this.properties[e]:t},x3dom.Properties.prototype.merge=function(e){for(var t in e.properties)this.properties[t]=e.properties[t]},x3dom.Properties.prototype.toString=function(){var e="";for(var t in this.properties)e+="Name: "+t+" Value: "+this.properties[t]+"\n";return e},x3dom.DoublyLinkedList=function(){this.length=0,this.first=null,this.last=null},x3dom.DoublyLinkedList.ListNode=function(e,t,i,s,o){this.point=e,this.point_index=t,this.normals=i,this.colors=s,this.texCoords=o,this.next=null,this.prev=null},x3dom.DoublyLinkedList.prototype.appendNode=function(e){null===this.first?(e.prev=e,e.next=e,this.first=e,this.last=e):(e.prev=this.last,e.next=this.first,this.first.prev=e,this.last.next=e,this.last=e),this.length++},x3dom.DoublyLinkedList.prototype.insertAfterNode=function(e,t){t.prev=e,t.next=e.next,e.next.prev=t,e.next=t,t.prev==this.last&&(this.last=t),this.length++},x3dom.DoublyLinkedList.prototype.deleteNode=function(e){this.length>1?(e.prev.next=e.next,e.next.prev=e.prev,e==this.first&&(this.first=e.next),e==this.last&&(this.last=e.prev)):(this.first=null,this.last=null),e.prev=null,e.next=null,this.length--},x3dom.DoublyLinkedList.prototype.getNode=function(e){var t=null;if(e>this.length)return t;for(var i=0;i<this.length;i++)if(t=0==i?this.first:t.next,i==e)return t;return null},x3dom.DoublyLinkedList.prototype.invert=function(){for(var e=null,t=this.first,i=0;i<this.length;i++)e=t.prev,t.prev=t.next,t.next=e,t=t.prev;e=this.first,this.first=this.last,this.last=e},x3dom.EarClipping={getIndexes:function(e){var t,i,s,o,r=e.first.next,a=this.identifyPlane(r.prev.point,r.point,r.next.point);for(i=[],point_indexes=[],t=0;t<e.length;t++){switch(r=e.getNode(t),a){case"XY":s=r.point.x,o=r.point.y;break;case"XZ":s=r.point.z,o=r.point.x;break;default:s=r.point.y,o=r.point.z}i.push(o),i.push(s),point_indexes.push(r.point_index)}var n=x3dom.EarCut.triangulate(i,null,2);return n=n.map(function(e){return point_indexes[e]})},getMultiIndexes:function(e){var t=e.first.next,s=this.identifyPlane(t.prev.point,t.point,t.next.point),o={};o.indices=[],o.point=[],o.normals=[],o.colors=[],o.texCoords=[];var r={};for(r.indices=[],r.point=[],r.normals=[],r.colors=[],r.texCoords=[],points=[],i=0;i<e.length;i++){switch(t=e.getNode(i),s){case"XY":x=t.point.x,y=t.point.y;break;case"XZ":x=t.point.z,y=t.point.x;break;default:x=t.point.y,y=t.point.z}points.push(y),points.push(x),r.indices.push(t.point_index),r.point.push(t.point),t.normals&&r.normals.push(t.normals),t.colors&&r.colors.push(t.colors),t.texCoords&&r.texCoords.push(t.texCoords)}var a=x3dom.EarCut.triangulate(points,null,2);return o.indices=a.map(function(e){return r.indices[e]}),o.point=a.map(function(e){return r.point[e]}),t.normals&&(o.normals=a.map(function(e){return r.normals[e]})),t.colors&&(o.colors=a.map(function(e){return r.colors[e]})),t.texCoords&&(o.texCoords=a.map(function(e){return r.texCoords[e]})),o},identifyPlane:function(e,t,i){var s,o,r,a,n,d,l,h,u;s=t.x-e.x,o=t.y-e.y,r=t.z-e.z,a=i.x-e.x,n=i.y-e.y,d=i.z-e.z,l=Math.abs(o*d-r*n),h=Math.abs(r*a-s*d),u=Math.abs(s*n-o*a);var f=Math.max(l,h,u);return f==l?"YZ":f==h?"XZ":f==u?"XY":"XZ"}},x3dom.EarCut={triangulate:function(e,t,s){function o(e,t,i){i=i||2;var s=t&&t.length,o=s?t[0]*i:e.length,n=r(e,0,o,i),l=a(e,0,o,i,!0,n),h=[];if(!l)return h;var u,f,_,m,p,x,g;if(s&&(l=c(e,t,l,i)),e.length>80*i){u=_=e[0],f=m=e[1];for(var v=i;v<o;v+=i)p=e[v],x=e[v+1],p<u&&(u=p),x<f&&(f=x),p>_&&(_=p),x>m&&(m=x);g=Math.max(_-u,m-f)}return d(l,h,i,u,f,g),n===!1&&h.reverse(),h}function r(e,t,s,o){var r=0;for(i=t,j=s-o;i<s;i+=o)r+=(e[j]-e[i])*(e[i+1]+e[j+1]),j=i;return r>0}function a(e,t,i,s,o,r){var a,n;if(o===r)for(a=t;a<i;a+=s)n=N(a,e[a],e[a+1],n);else for(a=i-s;a>=t;a-=s)n=N(a,e[a],e[a+1],n);return n}function n(e,t){if(!e)return e;t||(t=e);var i,s=e;do if(i=!1,s.steiner||!M(s,s.next)&&0!==S(s.prev,s,s.next))s=s.next;else{if(R(s),s=t=s.prev,s===s.next)return null;i=!0}while(i||s!==t);return t}function d(e,t,i,s,o,r,a){if(e){!a&&r&&x(e,s,o,r);for(var c,_,m=e;e.prev!==e.next;)if(c=e.prev,_=e.next,r?h(e,s,o,r):l(e))t.push(c.i/i),t.push(e.i/i),t.push(_.i/i),R(e),e=_.next,m=_.next;else if(e=_,e===m){a?1===a?(e=u(e,t,i),d(e,t,i,s,o,r,2)):2===a&&f(e,t,i,s,o,r):d(n(e),t,i,s,o,r,1);break}}}function l(e){var t=e.prev,i=e,s=e.next;if(S(t,i,s)>=0)return!1;for(var o=e.next.next;o!==e.prev;){if(b(t.x,t.y,i.x,i.y,s.x,s.y,o.x,o.y)&&S(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function h(e,t,i,s){var o=e.prev,r=e,a=e.next;if(S(o,r,a)>=0)return!1;for(var n=o.x<r.x?o.x<a.x?o.x:a.x:r.x<a.x?r.x:a.x,d=o.y<r.y?o.y<a.y?o.y:a.y:r.y<a.y?r.y:a.y,l=o.x>r.x?o.x>a.x?o.x:a.x:r.x>a.x?r.x:a.x,h=o.y>r.y?o.y>a.y?o.y:a.y:r.y>a.y?r.y:a.y,u=v(n,d,t,i,s),f=v(l,h,t,i,s),c=e.nextZ;c&&c.z<=f;){if(c!==e.prev&&c!==e.next&&b(o.x,o.y,r.x,r.y,a.x,a.y,c.x,c.y)&&S(c.prev,c,c.next)>=0)return!1;c=c.nextZ}for(c=e.prevZ;c&&c.z>=u;){if(c!==e.prev&&c!==e.next&&b(o.x,o.y,r.x,r.y,a.x,a.y,c.x,c.y)&&S(c.prev,c,c.next)>=0)return!1;c=c.prevZ}return!0}function u(e,t,i){var s=e;do{var o=s.prev,r=s.next.next;C(o,s,s.next,r)&&E(o,r)&&E(r,o)&&(t.push(o.i/i),t.push(s.i/i),t.push(r.i/i),R(s),R(s.next),s=e=r),s=s.next}while(s!==e);return s}function f(e,t,i,s,o,r){var a=e;do{for(var l=a.next.next;l!==a.prev;){if(a.i!==l.i&&T(a,l)){var h=A(a,l);return a=n(a,a.next),h=n(h,h.next),d(a,t,i,s,o,r),void d(h,t,i,s,o,r)}l=l.next}a=a.next}while(a!==e)}function c(e,t,i,s){var o,r,d,l,h,u=[];for(o=0,r=t.length;o<r;o++)d=t[o]*s,l=o<r-1?t[o+1]*s:e.length,h=a(e,d,l,s,!1),h===h.next&&(h.steiner=!0),u.push(y(h));for(u.sort(_),o=0;o<u.length;o++)m(u[o],i),i=n(i,i.next);return i}function _(e,t){return e.x-t.x}function m(e,t){if(t=p(e,t)){var i=A(t,e);n(i,i.next)}}function p(e,t){var i,s=t,o=e.x,r=e.y,a=-(1/0);do{if(r<=s.y&&r>=s.next.y){var n=s.x+(r-s.y)*(s.next.x-s.x)/(s.next.y-s.y);n<=o&&n>a&&(a=n,i=s.x<s.next.x?s:s.next)}s=s.next}while(s!==t);if(!i)return null;var d,l=i,h=1/0;for(s=i.next;s!==l;)o>=s.x&&s.x>=i.x&&b(r<i.y?o:a,r,i.x,i.y,r<i.y?a:o,r,s.x,s.y)&&(d=Math.abs(r-s.y)/(o-s.x),(d<h||d===h&&s.x>i.x)&&E(s,e)&&(i=s,h=d)),s=s.next;return i}function x(e,t,i,s){var o=e;do null===o.z&&(o.z=v(o.x,o.y,t,i,s)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next;while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,g(o)}function g(e){var t,i,s,o,r,a,n,d,l=1;do{for(i=e,e=null,r=null,a=0;i;){for(a++,s=i,n=0,t=0;t<l&&(n++,s=s.nextZ,s);t++);for(d=l;n>0||d>0&&s;)0===n?(o=s,s=s.nextZ,d--):0!==d&&s?i.z<=s.z?(o=i,i=i.nextZ,n--):(o=s,s=s.nextZ,d--):(o=i,i=i.nextZ,n--),r?r.nextZ=o:e=o,o.prevZ=r,r=o;i=s}r.nextZ=null,l*=2}while(a>1);return e}function v(e,t,i,s,o){return e=32767*(e-i)/o,t=32767*(t-s)/o,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e|t<<1}function y(e){var t=e,i=e;do t.x<i.x&&(i=t),t=t.next;while(t!==e);return i}function b(e,t,i,s,o,r,a,n){return(o-a)*(t-n)-(e-a)*(r-n)>=0&&(e-a)*(s-n)-(i-a)*(t-n)>=0&&(i-a)*(r-n)-(o-a)*(s-n)>=0}function T(e,t){return M(e,t)||e.next.i!==t.i&&e.prev.i!==t.i&&!F(e,t)&&E(e,t)&&E(t,e)&&w(e,t)}function S(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function M(e,t){return e.x===t.x&&e.y===t.y}function C(e,t,i,s){return S(e,t,i)>0!=S(e,t,s)>0&&S(i,s,e)>0!=S(i,s,t)>0}function F(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&C(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function E(e,t){return S(e.prev,e,e.next)<0?S(e,t,e.next)>=0&&S(e,e.prev,t)>=0:S(e,t,e.prev)<0||S(e,e.next,t)<0}function w(e,t){var i=e,s=!1,o=(e.x+t.x)/2,r=(e.y+t.y)/2;do i.y>r!=i.next.y>r&&o<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next;while(i!==e);return s}function A(e,t){var i=new I(e.i,e.x,e.y),s=new I(t.i,t.x,t.y),o=e.next,r=t.prev;return e.next=t,t.prev=e,i.next=o,o.prev=i,s.next=i,i.prev=s,r.next=s,s.prev=r,s}function N(e,t,i,s){var o=new I(e,t,i);return s?(o.next=s.next,o.prev=s,s.next.prev=o,s.next=o):(o.prev=o,o.next=o),o}function R(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function I(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}return o(e,t,s)}},x3dom.Utils={},x3dom.Utils.maxIndexableCoords=65535,x3dom.Utils.needLineWidth=!1,x3dom.Utils.measurements=[],window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}(),x3dom.Utils.startMeasure=function(e){var t=e.toUpperCase();x3dom.Utils.measurements[t]||(performance&&performance.now?x3dom.Utils.measurements[t]=performance.now():x3dom.Utils.measurements[t]=(new Date).getTime())},x3dom.Utils.stopMeasure=function(e){var t=e.toUpperCase();if(x3dom.Utils.measurements[t]){var i=x3dom.Utils.measurements[t];return delete x3dom.Utils.measurements[t],performance&&performance.now?performance.now()-i:(new Date).getTime()-i}return 0},x3dom.Utils.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},x3dom.Utils.createTexture2D=function(e,t,i,s,o,r,a){var n=e.createTexture(),d=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);if(e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,d),a&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),n.ready=!1,null==i||""==i)return n;var l=new Image;switch(o.toLowerCase()){case"anonymous":l.crossOrigin="anonymous";break;case"use-credentials":l.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i)&&(l.crossOrigin="anonymous")}return l.src=i,t.downloadCount++,l.onload=function(){r&&(l=x3dom.Utils.scaleImage(l)),1==s&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,l),a&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),1==s&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),n.width=l.width,n.height=l.height,n.ready=!0,t.downloadCount--,t.needRender=!0},l.onerror=function(r){x3dom.caps.EXTENSIONS.indexOf("WEBGL_compressed_texture_s3tc")!==-1?x3dom.Utils.tryCompressedTexture2D(n,e,t,i,s,o,a,function(e){e||x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.downloadCount--}):(x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.downloadCount--)},n},x3dom.Utils.createCompressedTexture2D=function(e,t,i,s,o,r){var a=e.createTexture(),n=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);if(e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,n),r&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),a.ready=!1,null==i||""==i)return a;ddsXhr=new XMLHttpRequest;var d=e.getExtension("WEBGL_compressed_texture_s3tc");return ddsXhr.open("GET",i,!0),ddsXhr.responseType="arraybuffer",ddsXhr.onload=function(){e.bindTexture(e.TEXTURE_2D,a);var i=uploadDDSLevels(e,d,this.response);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i>1?e.LINEAR_MIPMAP_LINEAR:e.LINEAR),a.ready=!0,t.downloadCount--,t.needRender=!0},t.downloadCount++,ddsXhr.send(null),a},x3dom.Utils.tryCompressedTexture2D=function(e,t,i,s,o,r,a,n){ddsXhr=new XMLHttpRequest;var d=t.getExtension("WEBGL_compressed_texture_s3tc");ddsXhr.open("GET",s,!0),ddsXhr.responseType="arraybuffer",ddsXhr.onload=function(){t.bindTexture(t.TEXTURE_2D,e);var s=uploadDDSLevels(t,d,this.response);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,s>1?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),e.ready=!0,i.needRender=!0,n(!0)},ddsXhr.onerror=function(){n(!1)},ddsXhr.send(null)},x3dom.Utils.createTextureCube=function(e,t,i,s,o,r,a){var n,d=e.createTexture();n=s?[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X]:[e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X],d.ready=!1,d.pendingTextureLoads=-1,d.textureCubeReady=!1;for(var l=0,h=0,u=0;u<n.length;u++){var f=n[u],c=new Image;switch(o.toLowerCase()){case"anonymous":c.crossOrigin="anonymous";break;case"use-credentials":c.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i[u])&&(c.crossOrigin="anonymous")}d.pendingTextureLoads++,t.downloadCount++,c.onload=function(i,s,o,n){return function(){0==l&&0==h?(l=o.width,h=o.height):!r||l==o.width&&h==o.height||(x3dom.debug.logWarning("[Utils|createTextureCube] Rescaling CubeMap images, which are of different size!"),o=x3dom.Utils.rescaleImage(o,l,h)),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n),e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texImage2D(s,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),i.pendingTextureLoads--,t.downloadCount--,i.pendingTextureLoads<0&&(i.width=l,i.height=h,i.textureCubeReady=!0,a&&(e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.generateMipmap(e.TEXTURE_CUBE_MAP),e.bindTexture(e.TEXTURE_CUBE_MAP,null)),x3dom.debug.logInfo("[Utils|createTextureCube] Loading CubeMap finished..."),t.needRender=!0)}}(d,f,c,s),c.onerror=function(){t.downloadCount--,x3dom.debug.logError("[Utils|createTextureCube] Can't load CubeMap!")},c.src=i[u]}return d},x3dom.Utils.initFBO=function(e,t,i,s,o,r,a){var n=e.createTexture();n.width=t,n.height=i,e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,s,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var d,l=null;if(x3dom.caps.DRAW_BUFFERS&&void 0!==a)for(l=[n],d=1;d<a;d++)l[d]=e.createTexture(),l[d].width=t,l[d].height=i,e.bindTexture(e.TEXTURE_2D,l[d]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,s,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var h=e.createFramebuffer(),u=null,f=null;if(r&&(null!==x3dom.caps.DEPTH_TEXTURE?(u=e.createTexture(),e.bindTexture(e.TEXTURE_2D,u),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,t,i,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),u.width=t,u.height=i):(f=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.bindRenderbuffer(e.RENDERBUFFER,null))),e.bindFramebuffer(e.FRAMEBUFFER,h),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),x3dom.caps.DRAW_BUFFERS&&void 0!==a)for(d=1;d<a;d++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+d,e.TEXTURE_2D,l[d],0);r&&null!==x3dom.caps.DEPTH_TEXTURE?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,u,0):e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f);var c=e.checkFramebufferStatus(e.FRAMEBUFFER);return c!=e.FRAMEBUFFER_COMPLETE&&x3dom.debug.logWarning("[Utils|InitFBO] FBO-Status: "+c),e.bindFramebuffer(e.FRAMEBUFFER,null),{fbo:h,dtex:u,rbo:f,tex:n,texTargets:l,width:t,height:i,type:s,mipMap:o}},x3dom.Utils.getFileName=function(e){var t;return t=e.lastIndexOf("/")>-1?e.substr(e.lastIndexOf("/")+1):e.lastIndexOf("\\")>-1?e.substr(e.lastIndexOf("\\")+1):e},x3dom.Utils.findTextureByName=function(e,t){for(var i=0;i<e.length;++i)if(t==e[i].samplerName)return e[i];return!1},x3dom.Utils.rescaleImage=function(e,t,i){var s=document.createElement("canvas");return s.width=t,s.height=i,s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,s.width,s.height),s},x3dom.Utils.scaleImage=function(e){if(!x3dom.Utils.isPowerOfTwo(e.width)||!x3dom.Utils.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=x3dom.Utils.nextHighestPowerOfTwo(e.width),t.height=x3dom.Utils.nextHighestPowerOfTwo(e.height);var i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},x3dom.Utils.isPowerOfTwo=function(e){
return 0===(e&e-1)},x3dom.Utils.nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},x3dom.Utils.nextBestPowerOfTwo=function(e){var t=Math.log(e)/.693147180559945;return Math.pow(2,Math.round(t))},x3dom.Utils.getDataTypeSize=function(e){switch(e){case"Int8":case"Uint8":return 1;case"Int16":case"Uint16":return 2;case"Int32":case"Uint32":case"Float32":return 4;case"Float64":default:return 8}},x3dom.Utils.getOffsetMultiplier=function(e,t){switch(e){case t.UNSIGNED_SHORT:return 1;case t.UNSIGNED_INT:return 2;case t.UNSIGNED_BYTE:return.5;default:return 1}},x3dom.Utils.getByteAwareOffset=function(e,t,i){switch(t){case i.UNSIGNED_SHORT:return 2*e;case i.UNSIGNED_INT:return 4*e;case i.UNSIGNED_BYTE:return e;default:return 2*e}},x3dom.Utils.getVertexAttribType=function(e,t){var i=t.NONE;switch(e){case"Int8":i=t.BYTE;break;case"Uint8":i=t.UNSIGNED_BYTE;break;case"Int16":i=t.SHORT;break;case"Uint16":i=t.UNSIGNED_SHORT;break;case"Int32":i=t.INT;break;case"Uint32":i=t.UNSIGNED_INT;break;case"Float32":i=t.FLOAT;break;case"Float64":default:x3dom.debug.logError("Can't find this.gl data type for "+e+", getting FLOAT..."),i=t.FLOAT}return i},x3dom.Utils.getArrayBufferView=function(e,t){var i=null;switch(e){case"Int8":i=new Int8Array(t);break;case"Uint8":i=new Uint8Array(t);break;case"Int16":i=new Int16Array(t);break;case"Uint16":i=new Uint16Array(t);break;case"Int32":i=new Int32Array(t);break;case"Uint32":i=new Uint32Array(t);break;case"Float32":i=new Float32Array(t);break;case"Float64":i=new Float64Array(t);break;default:x3dom.debug.logError("Can't create typed array view of type "+e+", trying Float32..."),i=new Float32Array(t)}return i},x3dom.Utils.isUnsignedType=function(e){return"Uint8"==e||"Uint16"==e||"Uint16"==e||"Uint32"==e},x3dom.Utils.checkDirtyLighting=function(e){return e.getLights().length+e._scene.getNavigationInfo()._vf.headlight},x3dom.Utils.checkDirtyEnvironment=function(e,t){var i=e._scene.getEnvironment();return t.GAMMACORRECTION!=i._vf.gammaCorrectionDefault},x3dom.Utils.minFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":return e.LINEAR;case"NEAREST_MIPMAP_NEAREST":return e.NEAREST_MIPMAP_NEAREST;case"NEAREST_MIPMAP_LINEAR":return e.NEAREST_MIPMAP_LINEAR;case"LINEAR_MIPMAP_NEAREST":return e.LINEAR_MIPMAP_NEAREST;case"LINEAR_MIPMAP_LINEAR":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL":return e.LINEAR;case"AVG_PIXEL_AVG_MIPMAP":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL_NEAREST_MIPMAP":return e.LINEAR_MIPMAP_NEAREST;case"DEFAULT":return e.LINEAR_MIPMAP_LINEAR;case"FASTEST":return e.NEAREST;case"NEAREST_PIXEL":return e.NEAREST;case"NEAREST_PIXEL_AVG_MIPMAP":return e.NEAREST_MIPMAP_LINEAR;case"NEAREST_PIXEL_NEAREST_MIPMAP":return e.NEAREST_MIPMAP_NEAREST;case"NICEST":return e.LINEAR_MIPMAP_LINEAR;default:return e.LINEAR}},x3dom.Utils.magFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":return e.LINEAR;case"AVG_PIXEL":return e.LINEAR;case"DEFAULT":return e.LINEAR;case"FASTEST":return e.NEAREST;case"NEAREST_PIXEL":return e.NEAREST;case"NICEST":return e.LINEAR;default:return e.LINEAR}},x3dom.Utils.boundaryModesDic=function(e,t){switch(t.toUpperCase()){case"CLAMP":return e.CLAMP_TO_EDGE;case"CLAMP_TO_EDGE":return e.CLAMP_TO_EDGE;case"CLAMP_TO_BOUNDARY":return e.CLAMP_TO_EDGE;case"MIRRORED_REPEAT":return e.MIRRORED_REPEAT;case"REPEAT":return e.REPEAT;default:return e.REPEAT}},x3dom.Utils.primTypeDic=function(e,t){switch(t.toUpperCase()){case"POINTS":return e.POINTS;case"LINES":return e.LINES;case"LINELOOP":return e.LINE_LOOP;case"LINESTRIP":return e.LINE_STRIP;case"TRIANGLES":return e.TRIANGLES;case"TRIANGLESTRIP":return e.TRIANGLE_STRIP;case"TRIANGLEFAN":return e.TRIANGLE_FAN;default:return e.TRIANGLES}},x3dom.Utils.depthFunc=function(e,t){switch(t.toUpperCase()){case"NEVER":return e.NEVER;case"ALWAYS":return e.ALWAYS;case"LESS":return e.LESS;case"EQUAL":return e.EQUAL;case"LEQUAL":return e.LEQUAL;case"GREATER":return e.GREATER;case"GEQUAL":return e.GEQUAL;case"NOTEQUAL":return e.NOTEQUAL;default:return e.LEQUAL}},x3dom.Utils.blendFunc=function(e,t){switch(t.toLowerCase()){case"zero":return e.ZERO;case"one":return e.ONE;case"dst_color":return e.DST_COLOR;case"dst_alpha":return e.DST_ALPHA;case"src_color":return e.SRC_COLOR;case"src_alpha":return e.SRC_ALPHA;case"one_minus_dst_color":return e.ONE_MINUS_DST_COLOR;case"one_minus_dst_alpha":return e.ONE_MINUS_DST_ALPHA;case"one_minus_src_color":return e.ONE_MINUS_SRC_COLOR;case"one_minus_src_alpha":return e.ONE_MINUS_SRC_ALPHA;case"src_alpha_saturate":return e.SRC_ALPHA_SATURATE;case"constant_color":return e.CONSTANT_COLOR;case"constant_alpha":return e.CONSTANT_ALPHA;case"one_minus_constant_color":return e.ONE_MINUS_CONSTANT_COLOR;case"one_minus_constant_alpha":return e.ONE_MINUS_CONSTANT_ALPHA;default:return 0}},x3dom.Utils.blendEquation=function(e,t){switch(t.toLowerCase()){case"func_add":return e.FUNC_ADD;case"func_subtract":return e.FUNC_SUBTRACT;case"func_reverse_subtract":return e.FUNC_REVERSE_SUBTRACT;case"min":return 0;case"max":return 0;case"logic_op":return 0;default:return 0}},x3dom.Utils.gunzip=function(e){var t=new Uint8Array(e);try{e=new Zlib.Gunzip(t).decompress().buffer}catch(i){}return e},x3dom.Utils.generateProperties=function(e,t){var i={},s=t._cf.geometry.node,o=t._cf.appearance.node,r=o?o._cf.texture.node:null,a=o?o._cf.material.node:null,n=e._scene.getEnvironment();return o&&o._shader&&x3dom.isa(o._shader,x3dom.nodeTypes.ComposedShader)?i.CSHADER=o._shader._id:s&&(i.CSHADER=-1,i.SOLID=t.isSolid()?1:0,i.TEXT=x3dom.isa(s,x3dom.nodeTypes.Text)?1:0,i.POPGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.PopGeometry)?1:0,i.IMAGEGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.ImageGeometry)?1:0,i.BINARYGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.BinaryGeometry)?1:0,i.EXTERNALGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.ExternalGeometry)?1:0,i.IG_PRECISION=i.IMAGEGEOMETRY?s.numCoordinateTextures():0,i.IG_INDEXED=i.IMAGEGEOMETRY&&null!=s.getIndexTexture()?1:0,i.POINTLINE2D=s.needLighting()?0:1,i.VERTEXID=(i.BINARYGEOMETRY||i.EXTERNALGEOMETRY)&&s._vf.idsPerVertex?1:0,i.IS_PARTICLE=x3dom.isa(s,x3dom.nodeTypes.ParticleSet)?1:0,i.TWOSIDEDMAT=i.APPMAT&&x3dom.isa(a,x3dom.nodeTypes.TwoSidedMaterial)?1:0,i.SEPARATEBACKMAT=i.TWOSIDEDMAT&&a._vf.separateBackColor?1:0,i.SHADOW=e.getLightsShadow()?1:0,i.FOG=e._scene.getFog()._vf.visibilityRange>0?1:0,i.CSSHADER=o&&o._shader&&x3dom.isa(o._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,i.APPMAT=o&&(a||i.CSSHADER)?1:0,i.LIGHTS=!i.POINTLINE2D&&o&&t.isLit()&&(a||i.CSSHADER)?e.getLights().length+e._scene.getNavigationInfo()._vf.headlight:0,i.TEXTURED=r||i.TEXT||i.CSSHADER&&o._shader.needTexcoords()?1:0,i.CUBEMAP=r&&x3dom.isa(r,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&o._shader.getEnvironmentMap()?1:0,i.PIXELTEX=r&&x3dom.isa(r,x3dom.nodeTypes.PixelTexture)?1:0,i.TEXTRAFO=o&&o._cf.textureTransform.node?1:0,i.DIFFUSEMAP=r&&!x3dom.isa(r,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&o._shader.getDiffuseMap()?1:0,i.NORMALMAP=i.CSSHADER&&o._shader.getNormalMap()?1:0,i.NORMALSPACE=i.NORMALMAP?o._shader._vf.normalSpace.toUpperCase():"",i.SPECMAP=i.CSSHADER&&o._shader.getSpecularMap()?1:0,i.SHINMAP=i.CSSHADER&&o._shader.getShininessMap()?1:0,i.DISPLACEMENTMAP=i.CSSHADER&&o._shader.getDisplacementMap()?1:0,i.DIFFPLACEMENTMAP=i.CSSHADER&&o._shader.getDiffuseDisplacementMap()?1:0,i.MULTIDIFFALPMAP=i.VERTEXID&&i.CSSHADER&&o._shader.getMultiDiffuseAlphaMap()?1:0,i.MULTIEMIAMBMAP=i.VERTEXID&&i.CSSHADER&&o._shader.getMultiEmissiveAmbientMap()?1:0,i.MULTISPECSHINMAP=i.VERTEXID&&i.CSSHADER&&o._shader.getMultiSpecularShininessMap()?1:0,i.MULTIVISMAP=i.VERTEXID&&i.CSSHADER&&o._shader.getMultiVisibilityMap()?1:0,i.BLENDING=i.TEXT||i.CUBEMAP||r&&r._blending?1:0,i.REQUIREBBOX=void 0!==s._vf.coordType&&"Float32"!=s._vf.coordType?1:0,i.REQUIREBBOXNOR=void 0!==s._vf.normalType&&"Float32"!=s._vf.normalType?1:0,i.REQUIREBBOXCOL=void 0!==s._vf.colorType&&"Float32"!=s._vf.colorType?1:0,i.REQUIREBBOXTEX=void 0!==s._vf.texCoordType&&"Float32"!=s._vf.texCoordType?1:0,i.COLCOMPONENTS=s._mesh._numColComponents,i.NORCOMPONENTS=s._mesh._numNormComponents,i.POSCOMPONENTS=s._mesh._numPosComponents,i.SPHEREMAPPING=void 0!==s._cf.texCoord&&null!==s._cf.texCoord.node&&s._cf.texCoord.node._vf.mode&&"sphere"==s._cf.texCoord.node._vf.mode.toLowerCase()?1:0,i.VERTEXCOLOR=s._mesh._colors[0].length>0||i.IMAGEGEOMETRY&&s.getColorTexture()||i.POPGEOMETRY&&s.hasColor()||void 0!==s._vf.color&&s._vf.color.length>0?1:0,i.CLIPPLANES=t._clipPlanes.length,i.ALPHATHRESHOLD=o?o._vf.alphaClipThreshold.toFixed(2):.1,i.GAMMACORRECTION=n._vf.gammaCorrectionDefault),i.toIdentifier=function(){var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=this[t]);return this.id=e,e},i.toString=function(){var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=t+": "+this[t]+", ");return e},i.toIdentifier(),i},x3dom.Utils.wrapProgram=function(e,t,i){var s={shaderID:i,program:t};s.bind=function(){e.useProgram(t)};var o,r,a=null,n=null,d=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(o=0;o<d;++o){try{n=e.getActiveUniform(t,o)}catch(l){if(!n)continue}switch(r=e.getError(),r&&x3dom.debug.logError("GL-Error (on searching uniforms): "+r),a=e.getUniformLocation(t,n.name),n.type){case e.SAMPLER_2D:s.__defineSetter__(n.name,function(t){return function(i){e.uniform1i(t,i)}}(a));break;case e.SAMPLER_CUBE:s.__defineSetter__(n.name,function(t){return function(i){e.uniform1i(t,i)}}(a));break;case e.BOOL:s.__defineSetter__(n.name,function(t){return function(i){e.uniform1i(t,i)}}(a));break;case e.FLOAT:n.name.indexOf("[0]")!=-1?s.__defineSetter__(n.name.substring(0,n.name.length-3),function(t){return function(i){e.uniform1fv(t,new Float32Array(i))}}(a)):s.__defineSetter__(n.name,function(t){return function(i){e.uniform1f(t,i)}}(a));break;case e.FLOAT_VEC2:s.__defineSetter__(n.name,function(t){return function(i){e.uniform2f(t,i[0],i[1])}}(a));break;case e.FLOAT_VEC3:n.name.indexOf("[0]")!=-1?s.__defineSetter__(n.name.substring(0,n.name.length-3),function(t){return function(i){e.uniform3fv(t,new Float32Array(i))}}(a)):s.__defineSetter__(n.name,function(t){return function(i){e.uniform3f(t,i[0],i[1],i[2])}}(a));break;case e.FLOAT_VEC4:s.__defineSetter__(n.name,function(t){return function(i){e.uniform4f(t,i[0],i[1],i[2],i[3])}}(a));break;case e.FLOAT_MAT2:s.__defineSetter__(n.name,function(t){return function(i){e.uniformMatrix2fv(t,!1,new Float32Array(i))}}(a));break;case e.FLOAT_MAT3:s.__defineSetter__(n.name,function(t){return function(i){e.uniformMatrix3fv(t,!1,new Float32Array(i))}}(a));break;case e.FLOAT_MAT4:s.__defineSetter__(n.name,function(t){return function(i){e.uniformMatrix4fv(t,!1,new Float32Array(i))}}(a));break;case e.INT:s.__defineSetter__(n.name,function(t){return function(i){e.uniform1i(t,i)}}(a));break;default:x3dom.debug.logWarning("GLSL program variable "+n.name+" has unknown type "+n.type)}}var h=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(o=0;o<h;++o){try{n=e.getActiveAttrib(t,o)}catch(u){if(!n)continue}r=e.getError(),r&&x3dom.debug.logError("GL-Error (on searching attributes): "+r),a=e.getAttribLocation(t,n.name),s[n.name]=a}return s},x3dom.Utils.forbiddenBySOP=function(e){e=e.toLowerCase();var t,i,s,o,r,a,n,d,l=e.split("//"),h=""===document.location.port?"80":document.location.port;return 2===l.length&&(t=l[0],i=l[1],s=i.split("/")[0].split("?")[0].split("#")[0],o=s.split("@"),r=1===o.length?o[0]:o[1],a=r.split(":"),d=a[0],n=a[1]),n=n||"80",d=d||document.location.host,t=t||document.location.protocol,!(n===h&&d===document.location.host&&t===document.location.protocol)},x3dom.States=function(e){var t=this;this.active=!1,this.viewer=document.createElement("div"),this.viewer.id="x3dom-state-viewer";var i=document.createElement("div");i.className="x3dom-states-head",i.appendChild(document.createTextNode("x3dom"));var s=document.createElement("span");s.className="x3dom-states-head2",s.appendChild(document.createTextNode("stats")),i.appendChild(s),this.renderMode=document.createElement("div"),this.renderMode.className="x3dom-states-rendermode-hardware",this.measureList=document.createElement("ul"),this.measureList.className="x3dom-states-list",this.infoList=document.createElement("ul"),this.infoList.className="x3dom-states-list",this.viewer.appendChild(this.renderMode),this.viewer.appendChild(this.measureList),this.viewer.appendChild(this.infoList),this.disableContextMenu=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},this.thousandSeperator=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.toFixed=function(e){var t=2;return e.toFixed(t)},this.update=function(){if(!e.runtime&&void 0!==this.updateMethodID)return void clearInterval(this.updateMethodID);var t=e.runtime.states.infos,i=e.runtime.states.measurements,s=x3dom.caps.RENDERMODE;"HARDWARE"==s?(this.renderMode.innerHTML="Hardware-Rendering",this.renderMode.className="x3dom-states-rendermode-hardware"):"SOFTWARE"==s&&(this.renderMode.innerHTML="Software-Rendering",this.renderMode.className="x3dom-states-rendermode-software"),this.measureList.innerHTML="";for(var o in i)a=document.createElement("li"),a.className="x3dom-states-item",n=document.createElement("div"),n.className="x3dom-states-item-title",n.appendChild(document.createTextNode(o)),d=document.createElement("div"),d.className="x3dom-states-item-value",d.appendChild(document.createTextNode(this.toFixed(i[o]))),a.appendChild(n),a.appendChild(d),this.measureList.appendChild(a);this.infoList.innerHTML="";for(var r in t){var a=document.createElement("li");a.className="x3dom-states-item";var n=document.createElement("div");n.className="x3dom-states-item-title",n.appendChild(document.createTextNode(r));var d=document.createElement("div");d.className="x3dom-states-item-value",d.appendChild(document.createTextNode(this.thousandSeperator(t[r]))),a.appendChild(n),a.appendChild(d),this.infoList.appendChild(a)}},this.updateMethodID=window.setInterval(function(){t.update()},1e3),this.viewer.addEventListener("contextmenu",t.disableContextMenu)},x3dom.States.prototype.display=function(e){this.active=void 0!==e?e:!this.active,this.viewer.style.display=this.active?"block":"none"},x3dom.StateManager=function(e){this.gl=e,this.states=[],this.initStates()},x3dom.StateManager.prototype.initStates=function(){this.states.shaderID=null,this.states.colorMask={red:null,green:null,blue:null,alpha:null},this.states.depthMask=null,this.states.stencilMask=null,this.states.cullFace=null,this.states.frontFace=null,this.states.lineWidth=null,this.states.blendColor={red:null,green:null,blue:null,alpha:null},this.states.blendEquation=null,this.states.blendEquationSeparate={modeRGB:null,modeAlpha:null},this.states.blendFunc={sfactor:null,dfactor:null},this.states.blendFuncSeparate={srcRGB:null,dstRGB:null,srcAlpha:null,dstAlpha:null},this.states.depthFunc=null,this.states.viewport={x:null,y:null,width:null,height:null},this.states.depthRange={zNear:null,zFar:null}},x3dom.StateManager.prototype.useProgram=function(e){return this.states.shaderID!=e.shaderID&&(this.gl.useProgram(e.program),this.states.shaderID=e.shaderID,!0)},x3dom.StateManager.prototype.unsetProgram=function(){this.states.shaderID=null},x3dom.StateManager.prototype.enable=function(e){this.states[e]!==!0&&(this.gl.enable(e),this.states[e]=!0)},x3dom.StateManager.prototype.disable=function(e){this.states[e]!==!1&&(this.gl.disable(e),this.states[e]=!1)},x3dom.StateManager.prototype.colorMask=function(e,t,i,s){this.states.colorMask.red==e&&this.states.colorMask.green==t&&this.states.colorMask.blue==i&&this.states.colorMask.alpha==s||(this.gl.colorMask(e,t,i,s),this.states.colorMask.red=e,this.states.colorMask.green=t,this.states.colorMask.blue=i,this.states.colorMask.alpha=s)},x3dom.StateManager.prototype.depthMask=function(e){this.states.depthMask!=e&&(this.gl.depthMask(e),this.states.depthMask=e)},x3dom.StateManager.prototype.stencilMask=function(e){this.states.stencilMask!=e&&(this.gl.stencilMask(e),this.states.stencilMask=e)},x3dom.StateManager.prototype.cullFace=function(e){this.states.cullFace!=e&&(this.gl.cullFace(e),this.states.cullFace=e)},x3dom.StateManager.prototype.frontFace=function(e){this.states.frontFace!=e&&(this.gl.frontFace(e),this.states.frontFace=e)},x3dom.StateManager.prototype.lineWidth=function(e){e=e<=1?1:e,this.states.lineWidth!=e&&(this.gl.lineWidth(e),this.states.lineWidth=e)},x3dom.StateManager.prototype.blendColor=function(e,t,i,s){this.states.blendColor.red==e&&this.states.blendColor.green==t&&this.states.blendColor.blue==i&&this.states.blendColor.alpha==s||(this.gl.blendColor(e,t,i,s),this.states.blendColor.red=e,this.states.blendColor.green=t,this.states.blendColor.blue=i,this.states.blendColor.alpha=s)},x3dom.StateManager.prototype.blendEquation=function(e){e&&this.states.blendEquation!=e&&(this.gl.blendEquation(e),this.states.blendEquation=e)},x3dom.StateManager.prototype.blendEquationSeparate=function(e,t){this.states.blendEquationSeparate.modeRGB==e&&this.states.blendEquationSeparate.modeAlpha==t||(this.gl.blendEquationSeparate(e,t),this.states.blendEquationSeparate.modeRGB=e,this.states.blendEquationSeparate.modeAlpha=t)},x3dom.StateManager.prototype.blendFunc=function(e,t){this.states.blendFunc.sfactor==e&&this.states.blendFunc.dfactor==t||(this.gl.blendFunc(e,t),this.states.blendFunc.sfactor=e,this.states.blendFunc.dfactor=t)},x3dom.StateManager.prototype.blendFuncSeparate=function(e,t,i,s){this.states.blendFuncSeparate.srcRGB==e&&this.states.blendFuncSeparate.dstRGB==t&&this.states.blendFuncSeparate.srcAlpha==i&&this.states.blendFuncSeparate.dstAlpha==s||(this.gl.blendFuncSeparate(e,t,i,s),this.states.blendFuncSeparate.srcRGB=e,this.states.blendFuncSeparate.dstRGB=t,this.states.blendFuncSeparate.srcAlpha=i,this.states.blendFuncSeparate.dstAlpha=s)},x3dom.StateManager.prototype.depthFunc=function(e){this.states.depthFunc!=e&&(this.gl.depthFunc(e),this.states.depthFunc=e)},x3dom.StateManager.prototype.depthRange=function(e,t){e<0||t<0||e>t||(e=e>1?1:e,t=t>1?1:t,this.states.depthRange.zNear==e&&this.states.depthRange.zFar==t||(this.gl.depthRange(e,t),this.states.depthRange.zNear=e,this.states.depthRange.zFar=t))},x3dom.StateManager.prototype.viewport=function(e,t,i,s){this.states.viewport.x==e&&this.states.viewport.y==t&&this.states.viewport.width==i&&this.states.viewport.height==s||(this.gl.viewport(e,t,i,s),this.states.viewport.x=e,this.states.viewport.y=t,this.states.viewport.width=i,this.states.viewport.height=s)},x3dom.StateManager.prototype.bindFramebuffer=function(e,t){this.gl.bindFramebuffer(e,t),this.initStates()},x3dom.BinaryContainerLoader={outOfMemory:!1,checkError:function(e){var t=e.getError();t&&(t==e.OUT_OF_MEMORY?(this.outOfMemory=!0,x3dom.debug.logError("GL-Error "+t+" on loading binary container (out of memory)."),console.error("WebGL: OUT_OF_MEMORY")):x3dom.debug.logError("GL-Error "+t+" on loading binary container."))}},x3dom.BinaryContainerLoader.setupBinGeo=function(e,t,i,s,o){if(!this.outOfMemory){var r=(new Date).getTime(),a=this,n=e._cf.geometry.node;e._webgl.binaryGeometry=-1,e._webgl.internalDownloadCount=(n._vf.index.length>0?1:0)+(n._hasStrideOffset&&n._vf.coord.length>0?1:0)+(!n._hasStrideOffset&&n._vf.coord.length>0?1:0)+(!n._hasStrideOffset&&n._vf.normal.length>0?1:0)+(!n._hasStrideOffset&&n._vf.texCoord.length>0?1:0)+(!n._hasStrideOffset&&n._vf.color.length>0?1:0);var d=0==n._vf.normalPerVertex||n._vf.index.length>0&&("Int32"==n._vf.indexType||"Uint32"==n._vf.indexType&&!x3dom.caps.INDEX_UINT);if(e._webgl.makeSeparateTris={index:null,coord:null,normal:null,texCoord:null,color:null,pushBuffer:function(t,i){this[t]=i,0==--e._webgl.internalDownloadCount&&(this.coord&&this.createMesh(),e._nameSpace.doc.needRender=!0),0==--e._nameSpace.doc.downloadCount&&(e._nameSpace.doc.needRender=!0)},createMesh:function(){var r=n;if(r._hasStrideOffset)return void x3dom.debug.logError(r._vf.indexType+" index type and per-face normals not supported for interleaved arrays.");for(var d=0;d<e._webgl.primType.length;d++)if(e._webgl.primType[d]==i.TRIANGLE_STRIP)return void x3dom.debug.logError("makeSeparateTris: triangle strips not yet supported for per-face normals.");var l=r._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(l,i);var h,u,f;e._webgl.coordType!=i.FLOAT?(h=4==r._mesh._numPosComponents&&x3dom.Utils.isUnsignedType(r._vf.coordType)?x3dom.fields.SFVec3f.copy(r.getMin()):x3dom.fields.SFVec3f.copy(r._vf.position),u=x3dom.fields.SFVec3f.copy(r._vf.size),f=r.getPrecisionMax("coordType")):(h=new x3dom.fields.SFVec3f(0,0,0),u=new x3dom.fields.SFVec3f(1,1,1),f=1);var c=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.coordType);c=0==c?3:c,x3dom.debug.logWarning("makeSeparateTris.createMesh called with coord length "+c),this.color&&c!=e._colorStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.colorType)&&(this.color=null,x3dom.debug.logWarning("Color format not supported."));var _=this.texCoord?e._texCoordStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.texCoordType):0;r._vf.normalType="Float32",e._webgl.normalType=i.FLOAT,r._mesh._numNormComponents=3,e._normalStrideOffset=[0,0];var m,p,x,g=[],v=[],y=[],b=[],T=this.index?this.index.length-2:this.coord.length/3-2;for(m=0;m<T;m+=3){p=c*(this.index?this.index[m]:m);var S=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),c>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),c>3&&b.push(this.color[p+3])),this.texCoord&&(x=_*(this.index?this.index[m]:m),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),_>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3]))),p=c*(this.index?this.index[m+1]:m+1);var M=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),c>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),c>3&&b.push(this.color[p+3])),this.texCoord&&(x=_*(this.index?this.index[m+1]:m+1),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),_>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3]))),p=c*(this.index?this.index[m+2]:m+2);var C=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),c>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),c>3&&b.push(this.color[p+3])),this.texCoord&&(x=_*(this.index?this.index[m+2]:m+2),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),_>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3])));var F=S.subtract(M),E=M.subtract(C),w=F.cross(E).normalize();for(p=0;p<3;p++)v.push(w.x),v.push(w.y),v.push(w.z)}var A=i.createBuffer();e._webgl.buffers[1]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.coordType,g),i.STATIC_DRAW),i.vertexAttribPointer(t.position,r._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),A=i.createBuffer(),e._webgl.buffers[2]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,new Float32Array(v),i.STATIC_DRAW),i.vertexAttribPointer(t.normal,r._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal),this.texCoord&&(A=i.createBuffer(),e._webgl.buffers[3]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.texCoordType,y),i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,r._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),this.color&&(A=i.createBuffer(),e._webgl.buffers[4]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.colorType,b),i.STATIC_DRAW),i.vertexAttribPointer(t.color,r._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),r._vf.vertexCount=[],r._vf.vertexCount[0]=g.length/c,r._mesh._numCoords=r._vf.vertexCount[0],r._mesh._numFaces=r._vf.vertexCount[0]/3,e._webgl.primType=[],e._webgl.primType[0]=i.TRIANGLES,g=null,v=null,y=null,b=null,this.index=null,this.coord=null,this.normal=null,this.texCoord=null,this.color=null,a.checkError(i),delete e._webgl.shader,e._webgl.shader=o.cache.getDynamicShader(i,s,e)}},n._vf.index.length>0){e._webgl.binaryGeometry=1;var l=new XMLHttpRequest;l.open("GET",e._nameSpace.getURL(n._vf.index),!0),l.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,l.send(null),l.onload=function(){if(200!=l.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ index load failed with status: "+l.status);if(e._webgl){var t=1==n._vf.compressed?x3dom.Utils.gunzip(l.response):l.response,s=n,o=s._vf.indexType,h=x3dom.Utils.getArrayBufferView(o,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("index",h);var u=i.createBuffer();x3dom.caps.INDEX_UINT&&"Uint32"==o?e._webgl.indexType=i.UNSIGNED_INT:e._webgl.indexType=i.UNSIGNED_SHORT,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,u),i.bufferData(i.ELEMENT_ARRAY_BUFFER,h,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),0==s._vf.vertexCount[0]&&(s._vf.vertexCount[0]=h.length),s._mesh._numFaces=0;for(var f=0;f<s._vf.vertexCount.length;f++)e._webgl.primType[f]==i.TRIANGLE_STRIP?s._mesh._numFaces+=s._vf.vertexCount[f]-2:s._mesh._numFaces+=s._vf.vertexCount[f]/3;h=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var c=(new Date).getTime()-r;x3dom.debug.logInfo("XHR0/ index load time: "+c+" ms"),e._webgl.buffers[0]=u}}}if(n._hasStrideOffset&&n._vf.coord.length>0){var h=new XMLHttpRequest;h.open("GET",e._nameSpace.getURL(n._vf.coord),!0),h.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,h.send(null),h.onload=function(){if(200!=h.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ interleaved array load failed with status: "+h.status);if(e._webgl){var s=1==n._vf.compressed?x3dom.Utils.gunzip(h.response):h.response,o=n,d=o._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(d,i),e._webgl.normalType=e._webgl.coordType,e._webgl.texCoordType=e._webgl.coordType,e._webgl.colorType=e._webgl.coordType;var l=x3dom.Utils.getArrayBufferView(d,s),u=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(d);if(u&&(o._mesh._numCoords=l.length/u),0==o._vf.index.length)for(var f=0;f<o._vf.vertexCount.length;f++)e._webgl.primType[f]==i.TRIANGLE_STRIP?o._mesh._numFaces+=o._vf.vertexCount[f]-2:o._mesh._numFaces+=o._vf.vertexCount[f]/3;var c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.position,o._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),o._vf.normal.length>0&&(e._webgl.buffers[2]=c,i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.normal,o._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),o._vf.texCoord.length>0&&(e._webgl.buffers[3]=c,i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,o._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),o._vf.color.length>0&&(e._webgl.buffers[4]=c,i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.color,o._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),l=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var _=(new Date).getTime()-r;x3dom.debug.logInfo("XHR/ interleaved array load time: "+_+" ms"),e._webgl.buffers[1]=c}}}if(!n._hasStrideOffset&&n._vf.coord.length>0){var u=new XMLHttpRequest;u.open("GET",e._nameSpace.getURL(n._vf.coord),!0),u.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,u.send(null),u.onload=function(){if(200!=u.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ coord load failed with status: "+u.status);if(e._webgl){var s=1==n._vf.compressed?x3dom.Utils.gunzip(u.response):u.response,o=n,l=0,h=o._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(h,i);var f=x3dom.Utils.getArrayBufferView(h,s);if(d)return void e._webgl.makeSeparateTris.pushBuffer("coord",f);i.bindAttribLocation(t.program,0,"position");var c=i.createBuffer();if(i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,f,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o._mesh._numCoords=f.length/o._mesh._numPosComponents,0==o._vf.index.length)for(l=0;l<o._vf.vertexCount.length;l++)e._webgl.primType[l]==i.TRIANGLE_STRIP?o._mesh._numFaces+=o._vf.vertexCount[l]-2:o._mesh._numFaces+=o._vf.vertexCount[l]/3;if("Float32"==h&&(e._vf.bboxSize.x<0||e._vf.bboxSize.y<0||e._vf.bboxSize.z<0)){var _=new x3dom.fields.SFVec3f(f[0],f[1],f[2]),m=new x3dom.fields.SFVec3f(f[0],f[1],f[2]);for(l=3;l<f.length;l+=3)_.x>f[l+0]&&(_.x=f[l+0]),_.y>f[l+1]&&(_.y=f[l+1]),_.z>f[l+2]&&(_.z=f[l+2]),m.x<f[l+0]&&(m.x=f[l+0]),m.y<f[l+1]&&(m.y=f[l+1]),m.z<f[l+2]&&(m.z=f[l+2]);e._vf.bboxCenter.setValues(_.add(m).multiply(.5)),e._vf.bboxSize.setValues(m.subtract(_))}f=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var p=(new Date).getTime()-r;x3dom.debug.logInfo("XHR1/ coord load time: "+p+" ms"),e._webgl.buffers[1]=c}}}if(!n._hasStrideOffset&&n._vf.normal.length>0){var f=new XMLHttpRequest;f.open("GET",e._nameSpace.getURL(n._vf.normal),!0),f.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,f.send(null),f.onload=function(){if(200!=f.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR2/ normal load failed with status: "+f.status);if(e._webgl){var t=1==n._vf.compressed?x3dom.Utils.gunzip(f.response):f.response,s=n._vf.normalType;e._webgl.normalType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("normal",o);var l=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var h=(new Date).getTime()-r;x3dom.debug.logInfo("XHR2/ normal load time: "+h+" ms"),e._webgl.buffers[2]=l}}}if(!n._hasStrideOffset&&n._vf.texCoord.length>0){var c=new XMLHttpRequest;c.open("GET",e._nameSpace.getURL(n._vf.texCoord),!0),c.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,c.send(null),c.onload=function(){var t,s;if(200!=c.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR3/ texcoord load failed with status: "+c.status);if(e._webgl){var o=1==n._vf.compressed?x3dom.Utils.gunzip(c.response):c.response,l=n._vf.texCoordType;e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(l,i);var h=x3dom.Utils.getArrayBufferView(l,o);if(d)return void e._webgl.makeSeparateTris.pushBuffer("texCoord",h);if(n._vf.idsPerVertex){var u=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,u);var f=x3dom.Utils.getArrayBufferView("Float32",h.length/2);for(t=0,s=0;t<h.length;t+=2,s++)f[s]=65536*h[t+1]+h[t];
i.bufferData(i.ARRAY_BUFFER,f,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[5]=u}else{var _=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[3]=_}h=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var m=(new Date).getTime()-r;x3dom.debug.logInfo("XHR3/ texCoord load time: "+m+" ms")}}}if(!n._hasStrideOffset&&n._vf.color.length>0){var _=new XMLHttpRequest;_.open("GET",e._nameSpace.getURL(n._vf.color),!0),_.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,_.send(null),_.onload=function(){if(200!=_.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR4/ color load failed with status: "+_.status);if(e._webgl){var t=1==n._vf.compressed?x3dom.Utils.gunzip(_.response):_.response,s=n._vf.colorType;e._webgl.colorType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("color",o);var l=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),a.checkError(i);var h=(new Date).getTime()-r;x3dom.debug.logInfo("XHR4/ color load time: "+h+" ms"),e._webgl.buffers[4]=l}}}}},x3dom.BinaryContainerLoader.setupPopGeo=function(e,t,i,s,o){if(!this.outOfMemory){var r=e._cf.geometry.node;if(r.hasIndex()){e._webgl.popGeometry=1,e._webgl.buffers[0]=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[0]),i.bufferData(i.ELEMENT_ARRAY_BUFFER,2*r.getTotalNumberOfIndices(),i.STATIC_DRAW),e._webgl.buffers[5]=i.createBuffer();var a=new Float32Array(r._vf.vertexBufferSize);!function(){for(var e=0;e<a.length;++e)a[e]=e}(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[5]),i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW)}else e._webgl.popGeometry=-1;e._webgl.buffers[1]=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[1]),i.bufferData(i.ARRAY_BUFFER,r._vf.attributeStride*r._vf.vertexBufferSize,i.STATIC_DRAW);var n=r._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(n,i),e._coordStrideOffset[0]=r.getAttributeStride(),e._coordStrideOffset[1]=r.getPositionOffset(),i.vertexAttribPointer(t.position,e._cf.geometry.node._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),r.hasNormal()&&(n=r._vf.normalType,e._webgl.normalType=x3dom.Utils.getVertexAttribType(n,i),e._normalStrideOffset[0]=r.getAttributeStride(),e._normalStrideOffset[1]=r.getNormalOffset(),e._webgl.buffers[2]=e._webgl.buffers[1],i.vertexAttribPointer(t.normal,e._cf.geometry.node._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),r.hasTexCoord()&&(n=r._vf.texCoordType,e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(n,i),e._webgl.buffers[3]=e._webgl.buffers[1],e._texCoordStrideOffset[0]=r.getAttributeStride(),e._texCoordStrideOffset[1]=r.getTexCoordOffset(),i.vertexAttribPointer(t.texcoord,e._cf.geometry.node._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),r.hasColor()&&(n=r._vf.colorType,e._webgl.colorType=x3dom.Utils.getVertexAttribType(n,i),e._webgl.buffers[4]=e._webgl.buffers[1],e._colorStrideOffset[0]=r.getAttributeStride(),e._colorStrideOffset[1]=r.getColorOffset(),i.vertexAttribPointer(t.color,e._cf.geometry.node._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),e._webgl.currentNumIndices=0,e._webgl.currentNumVertices=0,e._webgl.numVerticesAtLevel=[],e._webgl.levelsAvailable=0,this.checkError(i),e._webgl.levelLoaded=[],function(){for(var t=0;t<r.getNumLevels();++t)e._webgl.levelLoaded.push(!1)}();var d=function(t,s){if(e._webgl.levelLoaded[s]=!0,e._webgl.numVerticesAtLevel[s]=0,t){var o=0,a=!1;if(r.hasIndex()&&(o=2*r.getNumIndicesByLevel(s),o>0)){a=!0;var n=new Uint8Array(t,0,o);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[0]),function(){for(var e=0,t=0;t<s;++t)e+=r.getNumIndicesByLevel(t);i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,2*e,n)}()}var d=t.byteLength-o;if(d>0){a=!0;var l=new Uint8Array(t,o,d);i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[1]),r.hasIndex()?i.bufferSubData(i.ARRAY_BUFFER,r.getVertexDataBufferOffset(s)*r.getAttributeStride(),l):i.bufferSubData(i.ARRAY_BUFFER,e._webgl.currentNumVertices*r.getAttributeStride(),l),e._webgl.numVerticesAtLevel[s]=d/r.getAttributeStride(),e._webgl.currentNumVertices+=e._webgl.numVerticesAtLevel[s]}!function(){for(var t=0,i=e._webgl.levelsAvailable;i<r.getNumLevels()&&e._webgl.levelLoaded[i]!==!1;++i)t+=r.getNumIndicesByLevel(i),++e._webgl.levelsAvailable;e._webgl.currentNumIndices=t}(),r._mesh._numCoords=e._webgl.currentNumVertices,r._mesh._numFaces=(r.hasIndex()?e._webgl.currentNumIndices:e._webgl.currentNumVertices)/3,r.adaptVertexCount(r.hasIndex()?3*r._mesh._numFaces:r._mesh._numCoords),a&&(e._nameSpace.doc.needRender=!0)}},l=r.getDataURLs(),h=[],u=[];e._webgl.downloadStartTimer=(new Date).getTime();for(var f=0;f<l.length;++f)e._nameSpace.doc.downloadCount+=1,function(t){h.push(function(i){return e._nameSpace.doc.downloadCount-=1,d(i,t)})}(f),u.push(f);x3dom.DownloadManager.get(l,h,u)}},x3dom.BinaryContainerLoader.setupImgGeo=function(e,t,i,s,o){if(!this.outOfMemory){var r=e._cf.geometry.node;r.getIndexTexture()?e._webgl.imageGeometry=1:e._webgl.imageGeometry=-1,r.unsetGeoDirty(),null==o.IG_PositionBuffer&&(o.IG_PositionBuffer=i.createBuffer()),e._webgl.buffers[1]=o.IG_PositionBuffer,i.bindBuffer(i.ARRAY_BUFFER,o.IG_PositionBuffer);var a=new Float32Array(e._webgl.positions[0]);i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,o.IG_PositionBuffer),i.vertexAttribPointer(t.position,r._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),a=null,this.checkError(i)}},x3dom.DrawableCollection=function(e){this.collection=[],this.viewMatrix=e.viewMatrix,this.projMatrix=e.projMatrix,this.sceneMatrix=e.sceneMatrix,this.viewarea=e.viewArea;var t=this.viewarea._scene,i=t.getEnvironment(),s=t.getViewpoint();this.near=s.getNear(),this.pixelHeightAtDistOne=s.getImgPlaneHeightAtDistOne()/this.viewarea._height,this.context=e.context,this.gl=e.gl,this.viewFrustum=this.viewarea.getViewfrustum(this.sceneMatrix),this.worldVol=new x3dom.fields.BoxVolume,this.frustumCulling=e.frustumCulling&&null!=this.viewFrustum,this.smallFeatureThreshold=e.smallFeatureThreshold,this.sortOpaque=this.smallFeatureThreshold>0&&i._lowPriorityThreshold<1,this.sortTrans=e.sortTrans,this.prioLevels=10,this.maxTreshold=100,this.sortBySortKey=!1,this.sortByPriority=!1,this.numberOfNodes=0,this.length=0},x3dom.DrawableCollection.prototype.cull=function(e,t,i,s){var o=t.boundedNode;if(!o||!o._vf.render)return-1;var r=o.getVolume(),a=63;if(this.frustumCulling&&t.needCulling){var n;if(i&&!t.worldVolume.isValid()?(t.worldVolume.transformFrom(e,r),n=t.worldVolume):s<a&&(this.worldVol.transformFrom(e,r),n=this.worldVol),s<a&&(s=this.viewFrustum.intersect(n,s)),s==-1)return-1}else s=a;if(t.coverage=-1,this.smallFeatureThreshold>0||o.forceUpdateCoverage()){var d=this.viewMatrix.mult(e);t.center=d.multMatrixPnt(r.getCenter());var l=d.multMatrixVec(r.getRadialVec()),h=l.length(),u=Math.max(-t.center.z-h,this.near),f=u*this.pixelHeightAtDistOne;if(t.coverage=2*h/f,this.smallFeatureThreshold>0&&t.coverage<this.smallFeatureThreshold&&t.needCulling)return-1}return this.numberOfNodes++,s},x3dom.DrawableCollection.prototype.addShape=function(e,t,i){var s={};s.shape=e,s.transform=t,s.localTransform=i.localMatrix,s.localVolume=i.volume,s.worldVolume=x3dom.fields.BoxVolume.copy(i.worldVolume),s.priority=Math.max(0,i.coverage),s.shaderID=e.getShaderProperties(this.viewarea).id;var o=e._cf.appearance.node;if(s.sortType=o?o._vf.sortType.toLowerCase():"opaque",s.sortKey=o?o._vf.sortKey:0,"transparent"==s.sortType)if(this.smallFeatureThreshold>0)s.zPos=i.center.z;else{var r=t.multMatrixPnt(e.getCenter());r=this.viewMatrix.multMatrixPnt(r),s.zPos=r.z}this.sortBySortKey||0==s.sortKey||(this.sortBySortKey=!0),void 0===this.collection[s.sortType]&&(this.collection[s.sortType]=[]),this.collection[s.sortType].push(s),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,s,this.viewarea)},x3dom.DrawableCollection.prototype.addDrawable=function(e){e.shaderID=e.shape.getShaderProperties(this.viewarea).id;var t=e.shape._cf.appearance.node;if(e.sortType=t?t._vf.sortType.toLowerCase():"opaque",e.sortKey=t?t._vf.sortKey:0,"transparent"==e.sortType){var i=e.transform.multMatrixPnt(e.shape.getCenter());i=this.viewMatrix.multMatrixPnt(i),e.zPos=i.z}this.sortBySortKey||0==e.sortKey||(this.sortBySortKey=!0),void 0===this.collection[e.sortType]&&(this.collection[e.sortType]=[]),this.collection[e.sortType].push(e),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,e,this.viewarea)},x3dom.DrawableCollection.prototype.calculatePriority=function(e){var t=Math.max(0,e.coverage),i=this.prioLevels-1;return t=Math.min(Math.round(t/(this.maxTreshold/i)),i)},x3dom.DrawableCollection.prototype.concat=function(){var e=void 0!==this.collection.opaque?this.collection.opaque:[],t=void 0!==this.collection.transparent?this.collection.transparent:[];this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.get=function(e){return this.collection[e]},x3dom.DrawableCollection.prototype.sort=function(){var e=[],t=[],i=this;void 0!==this.collection.opaque&&(this.sortOpaque&&this.collection.opaque.sort(function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:t.priority-e.priority}),e=this.collection.opaque),void 0!==this.collection.transparent&&(this.sortTrans&&this.collection.transparent.sort(function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:e.priority!=t.priority&&i.sortByPriority?t.priority-e.priority:e.zPos-t.zPos}),t=this.collection.transparent),this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.forEach=function(e,t){t=void 0!==t?Math.min(t,this.prioLevels):this.prioLevels;var i,s,o,r;for(i=0;i<this.collection.opaque.length;++i)if(void 0!==this.collection.opaque[i])for(s=this.collection.opaque[i].length;s>0;--s)if(void 0!==this.collection.opaque[i][s])for(o in this.collection.opaque[i][s])for(r=0;r<this.collection.opaque[i][s][o].length;++r)e(this.collection.opaque[i][s][o][r]);for(i=0;i<this.collection.transparent.length;++i)if(void 0!==this.collection.transparent[i])for(s=this.collection.transparent[i].length;s>0;--s)if(void 0!==this.collection.transparent[i][s])for(var a in this.collection.transparent[i][s])for(this.collection.transparent[i][s][a].sort(function(e,t){return e.zPos-t.zPos}),r=0;r<this.collection.transparent[i][s][a].length;++r)e(this.collection.transparent[i][s][a][r])},x3dom.Moveable=function(e,t,i,s,o){this._x3domRoot=e,this._runtime=e.runtime,this._callback=i,this._gridSize=s?s:0,this._moveable=t,this._drag=!1,this._w=0,this._h=0,this._uPlane=null,this._vPlane=null,this._pPlane=null,this._isect=null,this._translationOffset=null,this._rotationOffset=null,this._scaleOffset=null,this._lastX=0,this._lastY=0,this._buttonState=0,this._mode=o&&o.length?o.toLowerCase():"translation",this._firstRay=null,this._matrixTrafo=null,this._navType="examine",this.attachHandlers()},x3dom.Moveable.prototype.setGridSize=function(e){this._gridSize=e},x3dom.Moveable.prototype.setMode=function(e){this._mode=e.toLowerCase()},x3dom.Moveable.prototype.attachHandlers=function(){this._moveable._iMove=this,this._x3domRoot._iMove||(this._x3domRoot._iMove=[]),this._x3domRoot._iMove.push(this),this._moveable.addEventListener("mousedown",this.start,!1),this._moveable.addEventListener("mouseover",this.over,!1),this._moveable.addEventListener("mouseout",this.out,!1),1==this._x3domRoot._iMove.length&&(this._x3domRoot.addEventListener("mouseup",this.stop,!1),this._x3domRoot.addEventListener("mouseout",this.stop,!1),this._x3domRoot.addEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.addEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.addEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.addEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.addEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.addEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.addEventListener("touchend",this.touchEndHandler,!1)))},x3dom.Moveable.prototype.detachHandlers=function(){var e=this._x3domRoot._iMove;if(e)for(var t=0,i=e.length;t<i;t++)if(e[t]==this){e.splice(t,1);break}this._moveable.removeEventListener("mousedown",this.start,!1),this._moveable.removeEventListener("mouseover",this.over,!1),this._moveable.removeEventListener("mouseout",this.out,!1),0==e.length&&(this._x3domRoot.removeEventListener("mouseup",this.stop,!1),this._x3domRoot.removeEventListener("mouseout",this.stop,!1),this._x3domRoot.removeEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.removeEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.removeEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.removeEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.removeEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.removeEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.removeEventListener("touchend",this.touchEndHandler,!1))),this._moveable._iMove&&delete this._moveable._iMove},x3dom.Moveable.prototype.calcViewPlane=function(e){this._w=this._runtime.getWidth(),this._h=this._runtime.getHeight();var t=this._runtime.getViewingRay(0,this._h-1),i=t.pos.add(t.dir);t=this._runtime.getViewingRay(this._w-1,this._h-1);var s=t.pos.add(t.dir);t=this._runtime.getViewingRay(0,0);var o=t.pos.add(t.dir);this._uPlane=s.subtract(i).normalize(),this._vPlane=o.subtract(i).normalize(),0===arguments.length?this._pPlane=i:this._pPlane=x3dom.fields.SFVec3f.copy(e)},x3dom.Moveable.prototype.det=function(e){return e[0][0]*e[1][1]*e[2][2]+e[0][1]*e[1][2]*e[2][0]+e[0][2]*e[2][1]*e[1][0]-e[2][0]*e[1][1]*e[0][2]-e[0][0]*e[2][1]*e[1][2]-e[1][0]*e[0][1]*e[2][2]},x3dom.Moveable.prototype.translateXY=function(e){for(var t=null,i=[],s=[],o=0;o<3;o++)i[o]=[],s[o]=[],i[o][0]=this._uPlane.at(o),s[o][0]=i[o][0],i[o][1]=this._vPlane.at(o),s[o][1]=i[o][1],i[o][2]=e.pos.subtract(this._pPlane).at(o),s[o][2]=-e.dir.at(o);var r=this.det(s);if(0!==r){var a=this.det(i)/r;t=e.pos.addScaled(e.dir,a)}return t&&(this._isect&&(t=t.subtract(this._isect)),t=t.add(this._translationOffset)),t},x3dom.Moveable.prototype.translateZ=function(e,t){var i=this._runtime.getSceneBBox(),s=t<this._lastY?1:-1,o=s*i.max.subtract(i.min).length()/100;return this._translationOffset=this._translationOffset.addScaled(e.dir,o),this._translationOffset},x3dom.Moveable.prototype.rotate=function(e,t){var i=2*Math.PI,s=(t-this._lastY)*i/this._w,o=(e-this._lastX)*i/this._h,r=x3dom.fields.Quaternion.axisAngle(this._uPlane,s),a=r.toMatrix();this._rotationOffset=a.mult(this._rotationOffset),r=x3dom.fields.Quaternion.axisAngle(this._vPlane,o),a=r.toMatrix(),this._rotationOffset=a.mult(this._rotationOffset);var n=this._rotationOffset.mult(x3dom.fields.SFMatrix4f.scale(this._scaleOffset)),d=new x3dom.fields.Quaternion(0,0,1,0);return d.setValue(n),d},x3dom.Moveable.prototype.over=function(e){var t=this._iMove;t._runtime.getCanvas().style.cursor="crosshair"},x3dom.Moveable.prototype.out=function(e){var t=this._iMove;t._drag||(t._runtime.getCanvas().style.cursor="pointer")},x3dom.Moveable.prototype.start=function(e){var t=this._iMove;switch(t._mode){case"translation":t._buttonState=4==e.button?1:3&e.button;break;case"rotation":t._buttonState=4;break;case"all":default:t._buttonState=e.button}if(!t._drag&&t._buttonState){t._lastX=e.layerX,t._lastY=e.layerY,t._drag=!0,t._navType=t._runtime.navigationType(),t._runtime.noNav(),t._isect=new x3dom.fields.SFVec3f(e.worldX,e.worldY,e.worldZ),t.calcViewPlane(t._isect),t._firstRay=t._runtime.getViewingRay(e.layerX,e.layerY);var i=t._moveable.getAttribute("translation");if(t._matrixTrafo=null,i){t._translationOffset=x3dom.fields.SFVec3f.parse(i);var s=t._moveable.getAttribute("rotation");s=s?x3dom.fields.Quaternion.parseAxisAngle(s):new x3dom.fields.Quaternion(0,0,1,0),t._rotationOffset=s.toMatrix();var o=t._moveable.getAttribute("scale");t._scaleOffset=o?x3dom.fields.SFVec3f.parse(o):new x3dom.fields.SFVec3f(1,1,1)}else if(i=t._moveable.getAttribute("matrix")){t._matrixTrafo=x3dom.fields.SFMatrix4f.parse(i).transpose();var r=new x3dom.fields.SFVec3f(0,0,0),a=new x3dom.fields.SFVec3f(1,1,1),n=new x3dom.fields.Quaternion(0,0,1,0),d=new x3dom.fields.Quaternion(0,0,1,0);t._matrixTrafo.getTransform(r,n,a,d),t._translationOffset=r,t._rotationOffset=n.toMatrix(),t._scaleOffset=a}else t._translationOffset=new x3dom.fields.SFVec3f(0,0,0),t._rotationOffset=new x3dom.fields.SFMatrix4f,t._scaleOffset=new x3dom.fields.SFVec3f(1,1,1);t._runtime.getCanvas().style.cursor="crosshair"}},x3dom.Moveable.prototype.move=function(e){for(var t=0,i=this._iMove.length;t<i;t++){var s=this._iMove[t];if(s._drag){var o=s._runtime.mousePosition(e),r=s._runtime.getViewingRay(o[0],o[1]),a=null;if(a=2==s._buttonState?s.translateZ(s._firstRay,o[1]):1==s._buttonState?s.translateXY(r):s.rotate(o[0],o[1])){if(s._gridSize>0&&4!=s._buttonState){var n=s._gridSize*Math.round(a.x/s._gridSize),d=s._gridSize*Math.round(a.y/s._gridSize),l=s._gridSize*Math.round(a.z/s._gridSize);a=new x3dom.fields.SFVec3f(n,d,l)}s._matrixTrafo?(4==s._buttonState?s._matrixTrafo.setRotate(a):s._matrixTrafo.setTranslate(a),s._moveable.setAttribute("matrix",s._matrixTrafo.toGL().toString())):4==s._buttonState?s._moveable.setAttribute("rotation",a.toAxisAngle().toString()):s._moveable.setAttribute("translation",a.toString()),s._callback&&s._callback(s._moveable,a)}s._lastX=o[0],s._lastY=o[1]}}},x3dom.Moveable.prototype.stop=function(e){for(var t=0,i=this._iMove.length;t<i;t++){var s=this._iMove[t];if(s._drag){s._lastX=e.layerX,s._lastY=e.layerY,s._isect=null,s._drag=!1;var o=s._runtime.canvas.doc._scene.getNavigationInfo();o.setType(s._navType),s._runtime.getCanvas().style.cursor="pointer"}}},x3dom.Moveable.prototype.touchStartHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchStartHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchEndHandler=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},x3dom.Moveable.prototype.touchEndHandlerMoz=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},function(){"use strict";function e(e){throw e}function t(e,t){var i=e.split("."),s=F;!(i[0]in s)&&s.execScript&&s.execScript("var "+i[0]);for(var o;i.length&&(o=i.shift());)i.length||t===M?s=s[o]?s[o]:s[o]={}:s[o]=t}function i(t,i){this.index="number"==typeof i?i:0,this.m=0,this.buffer=t instanceof(E?Uint8Array:Array)?t:new(E?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}function s(e,t,i){var s,o="number"==typeof t?t:t=0,r="number"==typeof i?i:e.length;for(s=-1,o=7&r;o--;++t)s=s>>>8^V[255&(s^e[t])];for(o=r>>3;o--;t+=8)s=s>>>8^V[255&(s^e[t])],s=s>>>8^V[255&(s^e[t+1])],s=s>>>8^V[255&(s^e[t+2])],s=s>>>8^V[255&(s^e[t+3])],s=s>>>8^V[255&(s^e[t+4])],s=s>>>8^V[255&(s^e[t+5])],s=s>>>8^V[255&(s^e[t+6])],s=s>>>8^V[255&(s^e[t+7])];return(4294967295^s)>>>0}function o(){}function r(e){this.buffer=new(E?Uint16Array:Array)(2*e),this.length=0}function a(e){var t,i,s,o,r,a,n,d,l,h,u=e.length,f=0,c=Number.POSITIVE_INFINITY;for(d=0;d<u;++d)e[d]>f&&(f=e[d]),e[d]<c&&(c=e[d]);for(t=1<<f,i=new(E?Uint32Array:Array)(t),s=1,o=0,r=2;s<=f;){for(d=0;d<u;++d)if(e[d]===s){for(a=0,n=o,l=0;l<s;++l)a=a<<1|1&n,n>>=1;for(h=s<<16|d,l=a;l<t;l+=r)i[l]=h;++o}++s,o<<=1,r<<=1}return[i,f,c]}function n(e,t){this.k=O,this.I=0,this.input=E&&e instanceof Array?new Uint8Array(e):e,this.b=0,t&&(t.lazy&&(this.I=t.lazy),"number"==typeof t.compressionType&&(this.k=t.compressionType),t.outputBuffer&&(this.a=E&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.b=t.outputIndex)),this.a||(this.a=new(E?Uint8Array:Array)(32768))}function d(e,t){this.length=e,this.Q=t}function l(t,i){function s(t,i){var s,o=t.Q,r=[],a=0;s=U[t.length],r[a++]=65535&s,r[a++]=s>>16&255,r[a++]=s>>24;var n;switch(C){case 1===o:n=[0,o-1,0];break;case 2===o:n=[1,o-2,0];break;case 3===o:n=[2,o-3,0];break;case 4===o:n=[3,o-4,0];break;case 6>=o:n=[4,o-5,1];break;case 8>=o:n=[5,o-7,1];break;case 12>=o:n=[6,o-9,2];break;case 16>=o:n=[7,o-13,2];break;case 24>=o:n=[8,o-17,3];break;case 32>=o:n=[9,o-25,3];break;case 48>=o:n=[10,o-33,4];break;case 64>=o:n=[11,o-49,4];break;case 96>=o:n=[12,o-65,5];break;case 128>=o:n=[13,o-97,5];break;case 192>=o:n=[14,o-129,6];break;case 256>=o:n=[15,o-193,6];break;case 384>=o:n=[16,o-257,7];break;case 512>=o:n=[17,o-385,7];break;case 768>=o:n=[18,o-513,8];break;case 1024>=o:n=[19,o-769,8];break;case 1536>=o:n=[20,o-1025,9];break;case 2048>=o:n=[21,o-1537,9];break;case 3072>=o:n=[22,o-2049,10];break;case 4096>=o:n=[23,o-3073,10];break;case 6144>=o:n=[24,o-4097,11];break;case 8192>=o:n=[25,o-6145,11];break;case 12288>=o:n=[26,o-8193,12];break;case 16384>=o:n=[27,o-12289,12];break;case 24576>=o:n=[28,o-16385,13];break;case 32768>=o:n=[29,o-24577,13];break;default:e("invalid distance")}s=n,r[a++]=s[0],r[a++]=s[1],r[a++]=s[2];var d,l;for(d=0,l=r.length;d<l;++d)m[p++]=r[d];g[r[0]]++,v[r[3]]++,x=t.length+i-1,f=null}var o,r,a,n,d,l,u,f,c,_={},m=E?new Uint16Array(2*i.length):[],p=0,x=0,g=new(E?Uint32Array:Array)(286),v=new(E?Uint32Array:Array)(30),y=t.I;if(!E){for(a=0;285>=a;)g[a++]=0;for(a=0;29>=a;)v[a++]=0}for(g[256]=1,o=0,r=i.length;o<r;++o){for(a=d=0,n=3;a<n&&o+a!==r;++a)d=d<<8|i[o+a];if(_[d]===M&&(_[d]=[]),l=_[d],!(0<x--)){for(;0<l.length&&32768<o-l[0];)l.shift();if(o+3>=r){for(f&&s(f,-1),a=0,n=r-o;a<n;++a)c=i[o+a],m[p++]=c,++g[c];break}0<l.length?(u=h(i,o,l),f?f.length<u.length?(c=i[o-1],m[p++]=c,++g[c],s(u,0)):s(f,-1):u.length<y?f=u:s(u,0)):f?s(f,-1):(c=i[o],m[p++]=c,++g[c])}l.push(o)}return m[p++]=256,g[256]++,t.W=g,t.V=v,E?m.subarray(0,p):m}function h(e,t,i){var s,o,r,a,n,l,h=0,u=e.length;a=0,l=i.length;e:for(;a<l;a++){if(s=i[l-a-1],r=3,3<h){for(n=h;3<n;n--)if(e[s+n-1]!==e[t+n-1])continue e;r=h}for(;258>r&&t+r<u&&e[s+r]===e[t+r];)++r;if(r>h&&(o=s,h=r),258===r)break}return new d(h,t-o)}function u(e,t){var i,s,o,a,n,d=e.length,l=new r(572),h=new(E?Uint8Array:Array)(d);if(!E)for(a=0;a<d;a++)h[a]=0;for(a=0;a<d;++a)0<e[a]&&l.push(a,e[a]);if(i=Array(l.length/2),s=new(E?Uint32Array:Array)(l.length/2),1===i.length)return h[l.pop().index]=1,h;for(a=0,n=l.length/2;a<n;++a)i[a]=l.pop(),s[a]=i[a].value;for(o=f(s,s.length,t),a=0,n=i.length;a<n;++a)h[i[a].index]=o[a];return h}function f(e,t,i){function s(e){var i=c[e][_[e]];i===t?(s(e+1),s(e+1)):--u[i],++_[e]}var o,r,a,n,d,l=new(E?Uint16Array:Array)(i),h=new(E?Uint8Array:Array)(i),u=new(E?Uint8Array:Array)(t),f=Array(i),c=Array(i),_=Array(i),m=(1<<i)-t,p=1<<i-1;for(l[i-1]=t,r=0;r<i;++r)m<p?h[r]=0:(h[r]=1,m-=p),m<<=1,l[i-2-r]=(l[i-1-r]/2|0)+t;for(l[0]=h[0],f[0]=Array(l[0]),c[0]=Array(l[0]),r=1;r<i;++r)l[r]>2*l[r-1]+h[r]&&(l[r]=2*l[r-1]+h[r]),f[r]=Array(l[r]),c[r]=Array(l[r]);for(o=0;o<t;++o)u[o]=i;for(a=0;a<l[i-1];++a)f[i-1][a]=e[a],c[i-1][a]=a;for(o=0;o<i;++o)_[o]=0;for(1===h[i-1]&&(--u[0],++_[i-1]),r=i-2;0<=r;--r){for(n=o=0,d=_[r+1],a=0;a<l[r];a++)n=f[r+1][d]+f[r+1][d+1],n>e[o]?(f[r][a]=n,c[r][a]=t,d+=2):(f[r][a]=e[o],c[r][a]=o,++o);_[r]=0,1===h[r]&&s(r)}return u}function c(e){var t,i,s,o,r=new(E?Uint16Array:Array)(e.length),a=[],n=[],d=0;for(t=0,i=e.length;t<i;t++)a[e[t]]=(0|a[e[t]])+1;for(t=1,i=16;t<=i;t++)n[t]=d,d+=0|a[t],d<<=1;for(t=0,i=e.length;t<i;t++)for(d=n[e[t]],n[e[t]]+=1,s=r[t]=0,o=e[t];s<o;s++)r[t]=r[t]<<1|1&d,d>>>=1;return r}function _(e,t){this.input=e,this.b=this.c=0,this.i={},t&&(t.flags&&(this.i=t.flags),"string"==typeof t.filename&&(this.filename=t.filename),"string"==typeof t.comment&&(this.A=t.comment),t.deflateOptions&&(this.l=t.deflateOptions)),this.l||(this.l={})}function m(t,i){switch(this.p=[],this.q=32768,this.e=this.j=this.c=this.u=0,this.input=E?new Uint8Array(t):t,this.w=!1,this.r=Y,this.M=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.q=i.bufferSize),i.bufferType&&(this.r=i.bufferType),i.resize&&(this.M=i.resize)),this.r){case W:this.b=32768,this.a=new(E?Uint8Array:Array)(32768+this.q+258);break;case Y:this.b=0,this.a=new(E?Uint8Array:Array)(this.q),this.f=this.U,this.B=this.R,this.s=this.T;break;default:e(Error("invalid inflate mode"))}}function p(t,i){for(var s,o=t.j,r=t.e,a=t.input,n=t.c,d=a.length;r<i;)n>=d&&e(Error("input buffer is broken")),o|=a[n++]<<r,r+=8;return s=o&(1<<i)-1,t.j=o>>>i,t.e=r-i,t.c=n,s}function x(e,t){for(var i,s,o=e.j,r=e.e,a=e.input,n=e.c,d=a.length,l=t[0],h=t[1];r<h&&!(n>=d);)o|=a[n++]<<r,r+=8;return i=l[o&(1<<h)-1],s=i>>>16,e.j=o>>s,e.e=r-s,e.c=n,65535&i}function g(e){function t(e,t,i){var s,o,r,a=this.J;for(r=0;r<e;)switch(s=x(this,t)){case 16:for(o=3+p(this,2);o--;)i[r++]=a;break;case 17:for(o=3+p(this,3);o--;)i[r++]=0;a=0;break;case 18:for(o=11+p(this,7);o--;)i[r++]=0;a=0;break;default:a=i[r++]=s}return this.J=a,i}var i,s,o,r,n=p(e,5)+257,d=p(e,5)+1,l=p(e,4)+4,h=new(E?Uint8Array:Array)($.length);for(r=0;r<l;++r)h[$[r]]=p(e,3);if(!E)for(r=l,l=h.length;r<l;++r)h[$[r]]=0;i=a(h),s=new(E?Uint8Array:Array)(n),o=new(E?Uint8Array:Array)(d),e.J=0,e.s(a(t.call(e,n,i,s)),a(t.call(e,d,i,o)))}function v(e){this.input=e,this.c=0,this.t=[],this.D=!1}function y(e){if("string"==typeof e){var t,i,s=e.split("");for(t=0,i=s.length;t<i;t++)s[t]=(255&s[t].charCodeAt(0))>>>0;e=s}for(var o,r=1,a=0,n=e.length,d=0;0<n;){o=1024<n?1024:n,n-=o;do r+=e[d++],a+=r;while(--o);r%=65521,a%=65521}return(a<<16|r)>>>0}function b(t,i){var s,o;switch(this.input=t,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.$=i.verify)),s=t[this.c++],o=t[this.c++],15&s){case ce:this.method=ce;break;default:e(Error("unsupported compression method"))}0!==((s<<8)+o)%31&&e(Error("invalid fcheck flag:"+((s<<8)+o)%31)),32&o&&e(Error("fdict flag is not supported")),this.L=new m(t,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}function T(e,t){this.input=e,this.a=new(E?Uint8Array:Array)(32768),this.k=_e.o;var i,s={};!t&&(t={})||"number"!=typeof t.compressionType||(this.k=t.compressionType);for(i in t)s[i]=t[i];s.outputBuffer=this.a,this.K=new n(this.input,s)}function S(e,i){var s,o,r,a;if(Object.keys)s=Object.keys(i);else for(o in s=[],r=0,i)s[r++]=o;for(r=0,a=s.length;r<a;++r)o=s[r],t(e+"."+o,i[o])}var M=void 0,C=!0,F=this,E="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;i.prototype.f=function(){var e,t=this.buffer,i=t.length,s=new(E?Uint8Array:Array)(i<<1);if(E)s.set(t);else for(e=0;e<i;++e)s[e]=t[e];return this.buffer=s},i.prototype.d=function(e,t,i){var s,o=this.buffer,r=this.index,a=this.m,n=o[r];if(i&&1<t&&(e=8<t?(P[255&e]<<24|P[e>>>8&255]<<16|P[e>>>16&255]<<8|P[e>>>24&255])>>32-t:P[e]>>8-t),8>t+a)n=n<<t|e,a+=t;else for(s=0;s<t;++s)n=n<<1|e>>t-s-1&1,8===++a&&(a=0,o[r++]=P[n],n=0,r===o.length&&(o=this.f()));o[r]=n,this.buffer=o,this.m=a,this.index=r},i.prototype.finish=function(){var e,t=this.buffer,i=this.index;return 0<this.m&&(t[i]<<=8-this.m,t[i]=P[t[i]],i++),E?e=t.subarray(0,i):(t.length=i,e=t),e};var w,A=new(E?Uint8Array:Array)(256);for(w=0;256>w;++w){for(var N=w,R=N,I=7,N=N>>>1;N;N>>>=1)R<<=1,R|=1&N,--I;A[w]=(R<<I&255)>>>0}var P=A,D=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],V=E?new Uint32Array(D):D;o.prototype.getName=function(){return this.name},o.prototype.getData=function(){return this.data},o.prototype.Y=function(){return this.Z},t("Zlib.GunzipMember",o),t("Zlib.GunzipMember.prototype.getName",o.prototype.getName),t("Zlib.GunzipMember.prototype.getData",o.prototype.getData),t("Zlib.GunzipMember.prototype.getMtime",o.prototype.Y),r.prototype.getParent=function(e){return 2*((e-2)/4|0)},r.prototype.push=function(e,t){var i,s,o,r=this.buffer;for(i=this.length,r[this.length++]=t,r[this.length++]=e;0<i&&(s=this.getParent(i),r[i]>r[s]);)o=r[i],r[i]=r[s],r[s]=o,o=r[i+1],r[i+1]=r[s+1],r[s+1]=o,i=s;return this.length},r.prototype.pop=function(){var e,t,i,s,o,r=this.buffer;for(t=r[0],e=r[1],this.length-=2,r[0]=r[this.length],r[1]=r[this.length+1],o=0;(s=2*o+2,!(s>=this.length))&&(s+2<this.length&&r[s+2]>r[s]&&(s+=2),r[s]>r[o]);)i=r[o],r[o]=r[s],r[s]=i,i=r[o+1],r[o+1]=r[s+1],r[s+1]=i,o=s;return{index:e,value:t,length:this.length}};var L,O=2,B={NONE:0,v:1,o:O,ba:3},k=[];for(L=0;288>L;L++)switch(C){
case 143>=L:k.push([L+48,8]);break;case 255>=L:k.push([L-144+400,9]);break;case 279>=L:k.push([L-256+0,7]);break;case 287>=L:k.push([L-280+192,8]);break;default:e("invalid literal: "+L)}n.prototype.g=function(){var t,s,o,r,a=this.input;switch(this.k){case 0:for(o=0,r=a.length;o<r;){s=E?a.subarray(o,o+65535):a.slice(o,o+65535),o+=s.length;var n=s,d=o===r,h=M,f=M,_=M,m=M,p=M,x=this.a,g=this.b;if(E){for(x=new Uint8Array(this.a.buffer);x.length<=g+n.length+5;)x=new Uint8Array(x.length<<1);x.set(this.a)}if(h=d?1:0,x[g++]=0|h,f=n.length,_=~f+65536&65535,x[g++]=255&f,x[g++]=f>>>8&255,x[g++]=255&_,x[g++]=_>>>8&255,E)x.set(n,g),g+=n.length,x=x.subarray(0,g);else{for(m=0,p=n.length;m<p;++m)x[g++]=n[m];x.length=g}this.b=g,this.a=x}break;case 1:var v=new i(E?new Uint8Array(this.a.buffer):this.a,this.b);v.d(1,1,C),v.d(1,2,C);var y,b,T,S=l(this,a);for(y=0,b=S.length;y<b;y++)if(T=S[y],i.prototype.d.apply(v,k[T]),256<T)v.d(S[++y],S[++y],C),v.d(S[++y],5),v.d(S[++y],S[++y],C);else if(256===T)break;this.a=v.finish(),this.b=this.a.length;break;case O:var F,w,A,N,R,I,P,D,V,L,B,G,U,X,z,j=new i(E?new Uint8Array(this.a.buffer):this.a,this.b),H=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],W=Array(19);for(F=O,j.d(1,1,C),j.d(F,2,C),w=l(this,a),I=u(this.W,15),P=c(I),D=u(this.V,7),V=c(D),A=286;257<A&&0===I[A-1];A--);for(N=30;1<N&&0===D[N-1];N--);var Y,q,Q,K,Z,$,J=A,ee=N,te=new(E?Uint32Array:Array)(J+ee),ie=new(E?Uint32Array:Array)(316),se=new(E?Uint8Array:Array)(19);for(Y=q=0;Y<J;Y++)te[q++]=I[Y];for(Y=0;Y<ee;Y++)te[q++]=D[Y];if(!E)for(Y=0,K=se.length;Y<K;++Y)se[Y]=0;for(Y=Z=0,K=te.length;Y<K;Y+=q){for(q=1;Y+q<K&&te[Y+q]===te[Y];++q);if(Q=q,0===te[Y])if(3>Q)for(;0<Q--;)ie[Z++]=0,se[0]++;else for(;0<Q;)$=138>Q?Q:138,$>Q-3&&$<Q&&($=Q-3),10>=$?(ie[Z++]=17,ie[Z++]=$-3,se[17]++):(ie[Z++]=18,ie[Z++]=$-11,se[18]++),Q-=$;else if(ie[Z++]=te[Y],se[te[Y]]++,Q--,3>Q)for(;0<Q--;)ie[Z++]=te[Y],se[te[Y]]++;else for(;0<Q;)$=6>Q?Q:6,$>Q-3&&$<Q&&($=Q-3),ie[Z++]=16,ie[Z++]=$-3,se[16]++,Q-=$}for(t=E?ie.subarray(0,Z):ie.slice(0,Z),L=u(se,7),X=0;19>X;X++)W[X]=L[H[X]];for(R=19;4<R&&0===W[R-1];R--);for(B=c(L),j.d(A-257,5,C),j.d(N-1,5,C),j.d(R-4,4,C),X=0;X<R;X++)j.d(W[X],3,C);for(X=0,z=t.length;X<z;X++)if(G=t[X],j.d(B[G],L[G],C),16<=G){switch(X++,G){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:e("invalid code: "+G)}j.d(t[X],U,C)}var oe,re,ae,ne,de,le,he,ue,fe=[P,I],ce=[V,D];for(de=fe[0],le=fe[1],he=ce[0],ue=ce[1],oe=0,re=w.length;oe<re;++oe)if(ae=w[oe],j.d(de[ae],le[ae],C),256<ae)j.d(w[++oe],w[++oe],C),ne=w[++oe],j.d(he[ne],ue[ne],C),j.d(w[++oe],w[++oe],C);else if(256===ae)break;this.a=j.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var G=function(){function t(t){switch(C){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:e("invalid length: "+t)}}var i,s,o=[];for(i=3;258>=i;i++)s=t(i),o[i]=s[2]<<24|s[1]<<16|s[0];return o}(),U=E?new Uint32Array(G):G;_.prototype.g=function(){var e,t,i,o,r,a,d,l,h=new(E?Uint8Array:Array)(32768),u=0,f=this.input,c=this.c,_=this.filename,m=this.A;if(h[u++]=31,h[u++]=139,h[u++]=8,e=0,this.i.fname&&(e|=j),this.i.fcomment&&(e|=H),this.i.fhcrc&&(e|=z),h[u++]=e,t=(Date.now?Date.now():+new Date)/1e3|0,h[u++]=255&t,h[u++]=t>>>8&255,h[u++]=t>>>16&255,h[u++]=t>>>24&255,h[u++]=0,h[u++]=X,this.i.fname!==M){for(d=0,l=_.length;d<l;++d)a=_.charCodeAt(d),255<a&&(h[u++]=a>>>8&255),h[u++]=255&a;h[u++]=0}if(this.i.comment){for(d=0,l=m.length;d<l;++d)a=m.charCodeAt(d),255<a&&(h[u++]=a>>>8&255),h[u++]=255&a;h[u++]=0}return this.i.fhcrc&&(i=65535&s(h,0,u),h[u++]=255&i,h[u++]=i>>>8&255),this.l.outputBuffer=h,this.l.outputIndex=u,r=new n(f,this.l),h=r.g(),u=r.b,E&&(u+8>h.buffer.byteLength?(this.a=new Uint8Array(u+8),this.a.set(new Uint8Array(h.buffer)),h=this.a):h=new Uint8Array(h.buffer)),o=s(f,M,M),h[u++]=255&o,h[u++]=o>>>8&255,h[u++]=o>>>16&255,h[u++]=o>>>24&255,l=f.length,h[u++]=255&l,h[u++]=l>>>8&255,h[u++]=l>>>16&255,h[u++]=l>>>24&255,this.c=c,E&&u<h.length&&(this.a=h=h.subarray(0,u)),h};var X=255,z=2,j=8,H=16;t("Zlib.Gzip",_),t("Zlib.Gzip.prototype.compress",_.prototype.g);var W=0,Y=1,q={O:W,N:Y};m.prototype.h=function(){for(;!this.w;){var t=p(this,3);switch(1&t&&(this.w=C),t>>>=1){case 0:var i=this.input,s=this.c,o=this.a,r=this.b,a=i.length,n=M,d=M,l=o.length,h=M;switch(this.e=this.j=0,s+1>=a&&e(Error("invalid uncompressed block header: LEN")),n=i[s++]|i[s++]<<8,s+1>=a&&e(Error("invalid uncompressed block header: NLEN")),d=i[s++]|i[s++]<<8,n===~d&&e(Error("invalid uncompressed block header: length verify")),s+n>i.length&&e(Error("input buffer is broken")),this.r){case W:for(;r+n>o.length;){if(h=l-r,n-=h,E)o.set(i.subarray(s,s+h),r),r+=h,s+=h;else for(;h--;)o[r++]=i[s++];this.b=r,o=this.f(),r=this.b}break;case Y:for(;r+n>o.length;)o=this.f({F:2});break;default:e(Error("invalid inflate mode"))}if(E)o.set(i.subarray(s,s+n),r),r+=n,s+=n;else for(;n--;)o[r++]=i[s++];this.c=s,this.b=r,this.a=o;break;case 1:this.s(he,fe);break;case 2:g(this);break;default:e(Error("unknown BTYPE: "+t))}}return this.B()};var Q,K,Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],$=E?new Uint16Array(Z):Z,J=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],ee=E?new Uint16Array(J):J,te=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],ie=E?new Uint8Array(te):te,se=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],oe=E?new Uint16Array(se):se,re=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],ae=E?new Uint8Array(re):re,ne=new(E?Uint8Array:Array)(288);for(Q=0,K=ne.length;Q<K;++Q)ne[Q]=143>=Q?8:255>=Q?9:279>=Q?7:8;var de,le,he=a(ne),ue=new(E?Uint8Array:Array)(30);for(de=0,le=ue.length;de<le;++de)ue[de]=5;var fe=a(ue);m.prototype.s=function(e,t){var i=this.a,s=this.b;this.C=e;for(var o,r,a,n,d=i.length-258;256!==(o=x(this,e));)if(256>o)s>=d&&(this.b=s,i=this.f(),s=this.b),i[s++]=o;else for(r=o-257,n=ee[r],0<ie[r]&&(n+=p(this,ie[r])),o=x(this,t),a=oe[o],0<ae[o]&&(a+=p(this,ae[o])),s>=d&&(this.b=s,i=this.f(),s=this.b);n--;)i[s]=i[s++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=s},m.prototype.T=function(e,t){var i=this.a,s=this.b;this.C=e;for(var o,r,a,n,d=i.length;256!==(o=x(this,e));)if(256>o)s>=d&&(i=this.f(),d=i.length),i[s++]=o;else for(r=o-257,n=ee[r],0<ie[r]&&(n+=p(this,ie[r])),o=x(this,t),a=oe[o],0<ae[o]&&(a+=p(this,ae[o])),s+n>d&&(i=this.f(),d=i.length);n--;)i[s]=i[s++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=s},m.prototype.f=function(){var e,t,i=new(E?Uint8Array:Array)(this.b-32768),s=this.b-32768,o=this.a;if(E)i.set(o.subarray(32768,i.length));else for(e=0,t=i.length;e<t;++e)i[e]=o[e+32768];if(this.p.push(i),this.u+=i.length,E)o.set(o.subarray(s,s+32768));else for(e=0;32768>e;++e)o[e]=o[s+e];return this.b=32768,o},m.prototype.U=function(e){var t,i,s,o,r=this.input.length/this.c+1|0,a=this.input,n=this.a;return e&&("number"==typeof e.F&&(r=e.F),"number"==typeof e.P&&(r+=e.P)),2>r?(i=(a.length-this.c)/this.C[2],o=258*(i/2)|0,s=o<n.length?n.length+o:n.length<<1):s=n.length*r,E?(t=new Uint8Array(s),t.set(n)):t=n,this.a=t},m.prototype.B=function(){var e,t,i,s,o,r=0,a=this.a,n=this.p,d=new(E?Uint8Array:Array)(this.u+(this.b-32768));if(0===n.length)return E?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(t=0,i=n.length;t<i;++t)for(e=n[t],s=0,o=e.length;s<o;++s)d[r++]=e[s];for(t=32768,i=this.b;t<i;++t)d[r++]=a[t];return this.p=[],this.buffer=d},m.prototype.R=function(){var e,t=this.b;return E?this.M?(e=new Uint8Array(t),e.set(this.a.subarray(0,t))):e=this.a.subarray(0,t):(this.a.length>t&&(this.a.length=t),e=this.a),this.buffer=e},v.prototype.X=function(){return this.D||this.h(),this.t.slice()},v.prototype.h=function(){for(var t=this.input.length;this.c<t;){var i=new o,r=M,a=M,n=M,d=M,l=M,h=M,u=M,f=M,c=M,_=this.input,p=this.c;switch(i.G=_[p++],i.H=_[p++],(31!==i.G||139!==i.H)&&e(Error("invalid file signature:"+i.G+","+i.H)),i.z=_[p++],i.z){case 8:break;default:e(Error("unknown compression method: "+i.z))}if(i.n=_[p++],f=_[p++]|_[p++]<<8|_[p++]<<16|_[p++]<<24,i.Z=new Date(1e3*f),i.fa=_[p++],i.ea=_[p++],0<(4&i.n)&&(i.aa=_[p++]|_[p++]<<8,p+=i.aa),0<(i.n&j)){for(u=[],h=0;0<(l=_[p++]);)u[h++]=String.fromCharCode(l);i.name=u.join("")}if(0<(i.n&H)){for(u=[],h=0;0<(l=_[p++]);)u[h++]=String.fromCharCode(l);i.A=u.join("")}0<(i.n&z)&&(i.S=65535&s(_,0,p),i.S!==(_[p++]|_[p++]<<8)&&e(Error("invalid header crc16"))),r=_[_.length-4]|_[_.length-3]<<8|_[_.length-2]<<16|_[_.length-1]<<24,_.length-p-4-4<512*r&&(d=r),a=new m(_,{index:p,bufferSize:d}),i.data=n=a.h(),p=a.c,i.ca=c=(_[p++]|_[p++]<<8|_[p++]<<16|_[p++]<<24)>>>0,s(n,M,M)!==c&&e(Error("invalid CRC-32 checksum: 0x"+s(n,M,M).toString(16)+" / 0x"+c.toString(16))),i.da=r=(_[p++]|_[p++]<<8|_[p++]<<16|_[p++]<<24)>>>0,(4294967295&n.length)!==r&&e(Error("invalid input size: "+(4294967295&n.length)+" / "+r)),this.t.push(i),this.c=p}this.D=C;var x,g,v,y=this.t,b=0,T=0;for(x=0,g=y.length;x<g;++x)T+=y[x].data.length;if(E)for(v=new Uint8Array(T),x=0;x<g;++x)v.set(y[x].data,b),b+=y[x].data.length;else{for(v=[],x=0;x<g;++x)v[x]=y[x].data;v=Array.prototype.concat.apply([],v)}return v},t("Zlib.Gunzip",v),t("Zlib.Gunzip.prototype.decompress",v.prototype.h),t("Zlib.Gunzip.prototype.getMembers",v.prototype.X),b.prototype.h=function(){var t,i,s=this.input;return t=this.L.h(),this.c=this.L.c,this.$&&(i=(s[this.c++]<<24|s[this.c++]<<16|s[this.c++]<<8|s[this.c++])>>>0,i!==y(t)&&e(Error("invalid adler-32 checksum"))),t};var ce=8,_e=B;T.prototype.g=function(){var t,i,s,o,r,a,n,d=0;switch(n=this.a,t=ce){case ce:i=Math.LOG2E*Math.log(32768)-8;break;default:e(Error("invalid compression method"))}switch(s=i<<4|t,n[d++]=s,t){case ce:switch(this.k){case _e.NONE:r=0;break;case _e.v:r=1;break;case _e.o:r=2;break;default:e(Error("unsupported compression type"))}break;default:e(Error("invalid compression method"))}return o=r<<6|0,n[d++]=o|31-(256*s+o)%31,a=y(this.input),this.K.b=d,n=this.K.g(),d=n.length,E&&(n=new Uint8Array(n.buffer),n.length<=d+4&&(this.a=new Uint8Array(n.length+4),this.a.set(n),n=this.a),n=n.subarray(0,d+4)),n[d++]=a>>24&255,n[d++]=a>>16&255,n[d++]=a>>8&255,n[d++]=255&a,n},t("Zlib.Inflate",b),t("Zlib.Inflate.prototype.decompress",b.prototype.h),S("Zlib.Inflate.BufferType",{ADAPTIVE:q.N,BLOCK:q.O}),t("Zlib.Deflate",T),t("Zlib.Deflate.compress",function(e,t){return new T(e,t).g()}),t("Zlib.Deflate.prototype.compress",T.prototype.g),S("Zlib.Deflate.CompressionType",{NONE:_e.NONE,FIXED:_e.v,DYNAMIC:_e.o})}.call(this),x3dom.X3DCanvas=function(e,t){var i=this;if(this._canvasIdx=t,this.isFlashReady=!1,this.x3dElem=e,this._current_dim=[0,0],this.fps_t0=(new Date).getTime(),this.lastTimeFPSWasTaken=0,this.framesSinceLastTime=0,this.doc=null,this.lastMousePos={x:0,y:0},x3dom.caps.DOMNodeInsertedEvent_perSubtree=!(navigator.userAgent.indexOf("MSIE")!=-1||navigator.userAgent.indexOf("Trident")!=-1),e.__setAttribute=e.setAttribute,e.setAttribute=function(e,t){switch(this.__setAttribute(e,t),window.devicePixelRatio&&(t=parseInt(t)*window.devicePixelRatio),e){case"width":i.canvas.setAttribute("width",t),i.doc&&i.doc._viewarea&&(i.doc._viewarea._width=parseInt(i.canvas.getAttribute("width"),0),i.doc.needRender=!0);break;case"height":i.canvas.setAttribute("height",t),i.doc&&i.doc._viewarea&&(i.doc._viewarea._height=parseInt(i.canvas.getAttribute("height"),0),i.doc.needRender=!0)}},x3dom.caps.MOBILE=navigator.appVersion.indexOf("Mobile")>-1,this.backend=this.x3dElem.getAttribute("backend"),this.backend?this.backend=this.backend.toLowerCase():this.backend="none","flash"==this.backend){if(this.backend="flash",this.canvas=this._createFlashObject(e),null==this.canvas)return void this._createInitFailedDiv(e);this.canvas.parent=this,this.gl=this._initFlashContext(this.canvas,this.flash_renderType)}else if(this.canvas=this._createHTMLCanvas(e),this.canvas.parent=this,this.gl=this._initContext(this.canvas,this.backend.search("desktop")>=0,this.backend.search("mobile")>=0,this.backend.search("flashie")>=0,this.backend.search("webgl2")>=0),this.backend="webgl",null==this.gl){if(x3dom.debug.logInfo("Fallback to Flash Renderer"),this.backend="flash",this.canvas=this._createFlashObject(e),null==this.canvas)return void this._createInitFailedDiv(e);this.canvas.parent=this,this.gl=this._initFlashContext(this.canvas,this.flash_renderType)}x3dom.caps.BACKEND=this.backend;var s=e.getAttribute("runtimeEnabled");if(null!==s?this.hasRuntime="true"==s.toLowerCase():this.hasRuntime=e.hasRuntime,null===this.gl&&(this.hasRuntime=!1),"flash"!=this.backend&&(this.showStat=e.getAttribute("showStat"),this.stateViewer=new x3dom.States(e),null!==this.showStat&&"true"==this.showStat&&this.stateViewer.display(!0),this.x3dElem.appendChild(this.stateViewer.viewer)),this.showProgress=e.getAttribute("showProgress"),this.progressDiv=this._createProgressDiv(),this.progressDiv.style.display=null!==this.showProgress&&"true"==this.showProgress?"inline":"none",this.x3dElem.appendChild(this.progressDiv),this.showTouchpoints=e.getAttribute("showTouchpoints"),this.showTouchpoints=!this.showTouchpoints||!("false"==this.showTouchpoints.toLowerCase()),this.disableTouch=e.getAttribute("disableTouch"),this.disableTouch=!!this.disableTouch&&"true"==this.disableTouch.toLowerCase(),this.disableKeys=e.getAttribute("keysEnabled"),this.disableKeys=!!this.disableKeys&&"true"==this.disableKeys.toLowerCase(),this.disableRightDrag=e.getAttribute("disableRightDrag"),this.disableRightDrag=!!this.disableRightDrag&&"true"==this.disableRightDrag.toLowerCase(),this.disableLeftDrag=e.getAttribute("disableLeftDrag"),this.disableLeftDrag=!!this.disableLeftDrag&&"true"==this.disableLeftDrag.toLowerCase(),this.disableMiddleDrag=e.getAttribute("disableMiddleDrag"),this.disableMiddleDrag=!!this.disableMiddleDrag&&"true"==this.disableMiddleDrag.toLowerCase(),null!==this.canvas&&null!==this.gl&&this.hasRuntime&&"flash"!==this.backend){this.canvas.mouse_dragging=!1,this.canvas.mouse_button=0,this.canvas.mouse_drag_x=0,this.canvas.mouse_drag_y=0,this.canvas.isMulti=!1,this.canvas.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},this.canvas.addEventListener("webglcontextlost",function(e){x3dom.debug.logError("WebGL context lost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",function(e){x3dom.debug.logError("recover WebGL state and resources on context lost NYI"),e.preventDefault()},!1),this.canvas.addEventListener("mousedown",function(e){if(!this.isMulti){switch(this.focus(),this.classList.add("x3dom-canvas-mousedown"),e.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2);var t=this.parent.mousePosition(e);this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging=!0,this.parent.doc.onMousePress(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mouseup",function(e){if(!this.isMulti){var t=this.mouse_button;this.classList.remove("x3dom-canvas-mousedown"),this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseRelease(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button,t),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mouseover",function(e){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},!1),this.canvas.addEventListener("mouseout",function(e){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.classList.remove("x3dom-canvas-mousedown"),this.parent.doc.onMouseOut(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},!1),this.canvas.addEventListener("dblclick",function(e){if(!this.isMulti){this.mouse_button=0;var t=this.parent.mousePosition(e);this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging=!1,this.parent.doc.onDoubleClick(i.gl,this.mouse_drag_x,this.mouse_drag_y),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mousemove",function(e){if(!this.isMulti){var t=this.parent.mousePosition(e);t.x==i.lastMousePos.x&&t.y==i.lastMousePos.y||(i.lastMousePos=t,e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2),this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging?(1==this.mouse_button&&!this.parent.disableLeftDrag||2==this.mouse_button&&!this.parent.disableRightDrag||4==this.mouse_button&&!this.parent.disableMiddleDrag)&&this.parent.doc.onDrag(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button):this.parent.doc.onMove(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation())}},!1),this.canvas.addEventListener("DOMMouseScroll",function(e){if(!this.isMulti){this.focus();var t=this.parent.mousePosition(e).y;this.mouse_drag_y+=2*e.detail,this.parent.doc.onWheel(i.gl,this.mouse_drag_x,this.mouse_drag_y,t),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation()}},!1),this.canvas.addEventListener("mousewheel",function(e){if(!this.isMulti){this.focus();var t=this.parent.mousePosition(e).y;this.mouse_drag_y-=.1*e.wheelDelta,this.parent.doc.onWheel(i.gl,this.mouse_drag_x,this.mouse_drag_y,t),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation()}},!1),this.canvas.addEventListener("keypress",function(e){this.parent.disableKeys||this.parent.doc.onKeyPress(e.charCode),this.parent.doc.needRender=!0},!0),this.canvas.addEventListener("keyup",function(e){this.parent.disableKeys||this.parent.doc.onKeyUp(e.keyCode),this.parent.doc.needRender=!0},!0),this.canvas.addEventListener("keydown",function(e){this.parent.disableKeys||this.parent.doc.onKeyDown(e.keyCode),this.parent.doc.needRender=!0},!0);var o={numTouches:0,firstTouchTime:(new Date).getTime(),firstTouchPoint:new x3dom.fields.SFVec2f(0,0),lastPos:new x3dom.fields.SFVec2f,lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,lastLayer:[],examineNavType:1,calcAngle:function(e){var t=e.normalize().dot(new x3dom.fields.SFVec2f(1,0));return t=Math.acos(t),e.y<0&&(t=Math.PI+(Math.PI-t)),t},disableTouch:this.disableTouch,visMarker:this.showTouchpoints,visMarkerBag:[],visualizeTouches:function(e){if(this.visMarker){for(var t=[],i=null,s=0;s<e.touches.length;s++){var o=e.touches[s].identifier||e.touches[s].streamId;o||(o=0);var r=this.visMarkerBag.indexOf(o);r>=0?(i=document.getElementById("visMarker"+o),i.style.left=e.touches[s].pageX+"px",i.style.top=e.touches[s].pageY+"px"):(i=document.createElement("div"),i.appendChild(document.createTextNode("#"+o)),i.id="visMarker"+o,i.className="x3dom-touch-marker",document.body.appendChild(i),r=this.visMarkerBag.length,this.visMarkerBag[r]=o),t.push(o)}for(var a=this.visMarkerBag.length-1;a>=0;a--){var n=this.visMarkerBag[a];t.indexOf(n)<0&&(this.visMarkerBag.splice(a,1),i=document.getElementById("visMarker"+n),document.body.removeChild(i))}}}},r=function(e,t){this.isMulti=!0,e.preventDefault(),o.visualizeTouches(e),this.focus(),null==t&&(t=this.parent.doc);var s=t._scene.getNavigationInfo();switch(s.getType()){case"examine":o.examineNavType=1;break;case"turntable":o.examineNavType=2;break;default:o.examineNavType=0}o.lastLayer=[];var r,a;for(r=0;r<e.touches.length;r++)a=this.parent.mousePosition(e.touches[r]),o.lastLayer.push([e.touches[r].identifier,new x3dom.fields.SFVec2f(a.x,a.y)]);if(o.numTouches<1&&1==e.touches.length)o.numTouches=1,o.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY);else if(o.numTouches<2&&e.touches.length>=2){o.numTouches=2;var n=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),d=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),l=d.subtract(n),h=l.multiply(.5).add(n),u=l.dot(l);o.lastMiddle=h,o.lastSquareDistance=u,o.lastAngle=o.calcAngle(l),o.lastPos=this.parent.mousePosition(e.touches[0])}if(t._scene.updateVolume(),1==o.examineNavType)for(r=0;r<e.touches.length;r++)a=this.parent.mousePosition(e.touches[r]),t.onPick(i.gl,a.x,a.y),t._viewarea.prepareEvents(a.x,a.y,1,"onmousedown"),t._viewarea._pickingInfo.lastClickObj=t._viewarea._pickingInfo.pickObj;else e.touches.length&&(a=this.parent.mousePosition(e.touches[0]),t.onMousePress(i.gl,a.x,a.y,1));t.needRender=!0},a=function(e,t){e.preventDefault(),o.visualizeTouches(e),null==t&&(t=this.parent.doc);var s,r,a,n,d,l,h,u,f=null,c=null;if(1==o.examineNavType){if(1==e.touches.length){var _=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),m=_.subtract(o.lastDrag);o.lastDrag=_;var p=x3dom.fields.SFMatrix4f.rotationY(m.x/100),x=x3dom.fields.SFMatrix4f.rotationX(m.y/100);c=p.mult(x),t.onMoveView(i.gl,null,c)}else if(e.touches.length>=2){s=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),r=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),a=r.subtract(s),n=a.multiply(.5).add(s),d=a.dot(a),l=n.subtract(o.lastMiddle),h=d-o.lastSquareDistance,u=new x3dom.fields.SFVec3f(l.x/screen.width,-l.y/screen.height,h/(screen.width*screen.height*.2));var g=o.calcAngle(a),v=o.lastAngle-g;o.lastAngle=g,c=x3dom.fields.SFMatrix4f.rotationZ(v),o.lastMiddle=n,o.lastSquareDistance=d,t.onMoveView(i.gl,u,c)}}else e.touches.length&&(2==o.examineNavType&&e.touches.length>=2?(s=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),r=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),a=r.subtract(s),d=a.dot(a),h=(d-o.lastSquareDistance)/(.1*(screen.width+screen.height)),o.lastPos.y+=h,o.lastSquareDistance=d,t.onDrag(i.gl,o.lastPos.x,o.lastPos.y,2)):(f=this.parent.mousePosition(e.touches[0]),t.onDrag(i.gl,f.x,f.y,1)));t.needRender=!0},n=function(e,t){this.isMulti=!1,e.preventDefault(),o.visualizeTouches(e),null==t&&(t=this.parent.doc),t._viewarea._isMoving=!1,2==o.numTouches&&1==e.touches.length&&(o.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY));var s=!1;if(e.touches.length<2&&(1==o.numTouches&&(s=!0),o.numTouches=e.touches.length),1==o.examineNavType){for(var r=0;r<o.lastLayer.length;r++){var a=o.lastLayer[r][1];if(t.onPick(i.gl,a.x,a.y),"box"!==t._scene._vf.pickMode.toLowerCase())t._viewarea.prepareEvents(a.x,a.y,1,"onmouseup"),t._viewarea._pickingInfo.lastClickObj=t._viewarea._pickingInfo.pickObj,t._viewarea._pickingInfo.pickObj&&t._viewarea._pickingInfo.pickObj===t._viewarea._pickingInfo.lastClickObj&&t._viewarea.prepareEvents(a.x,a.y,1,"onclick");else{var n=t._viewarea.calcViewRay(a.x,a.y),d=t._scene.doIntersect(n),l=n.hitObject;d&&l&&(t._viewarea._pick.setValues(n.hitPoint),t._viewarea.checkEvents(l,a.x,a.y,1,"onclick"),x3dom.debug.logInfo("Hit '"+l._xmlNode.localName+"/ "+l._DEF+"' at pos "+t._viewarea._pick))}}if(s){var h=(new Date).getTime(),u=o.firstTouchPoint.subtract(o.lastDrag).length();u<18&&h-o.firstTouchTime<180&&t.onDoubleClick(i.gl,0,0),o.firstTouchTime=h,o.firstTouchPoint=o.lastDrag}}else o.lastLayer.length&&(a=o.lastLayer[0][1],t.onMouseRelease(i.gl,a.x,a.y,0,1));t.needRender=!0};this.disableTouch||(this.canvas.addEventListener("touchstart",r,!0),this.canvas.addEventListener("touchmove",a,!0),this.canvas.addEventListener("touchend",n,!0))}},x3dom.X3DCanvas.prototype._initContext=function(e,t,i,s,o){x3dom.debug.logInfo("Initializing X3DCanvas for ["+e.id+"]");var r=x3dom.gfx_webgl(e,t,i,o,this.x3dElem);if(!r)return x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(e),null;var a=parseFloat(x3dom.caps.VERSION.match(/\d+\.\d+/)[0]);if(a<1){if(console.log(s),s)return x3dom.debug.logError("No valid 3D context found..."),this.x3dElem.removeChild(e),null;x3dom.debug.logError("WebGL version "+x3dom.caps.VERSION+" lacks important WebGL/GLSL features needed for shadows, special vertex attribute types, etc.!")}return r},x3dom.X3DCanvas.prototype._initFlashContext=function(e,t){return x3dom.debug.logInfo("Initializing X3DObject for ["+e.id+"]"),x3dom.gfx_flash(e,t)},x3dom.X3DCanvas.prototype.appendParam=function(e,t,i){var s=document.createElement("param");s.setAttribute("name",t),s.setAttribute("value",i),e.appendChild(s)},x3dom.X3DCanvas.prototype._fileExists=function(e){var t=new XMLHttpRequest;try{return t.open("HEAD",e,!1),t.send(null),404!=t.status}catch(i){return!0}},x3dom.X3DCanvas.prototype._detectFlash=function(e,t){var i=e,s=t,o=0;if("object"==typeof navigator.plugins["Shockwave Flash"]){var r=navigator.plugins["Shockwave Flash"].description;o=r.substr(16,r.indexOf(".",16)-16)}else if("function"==typeof ActiveXObject)for(var a=10;a<s+1;a++)try{"object"==typeof new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+a)&&(o=a+1)}catch(n){}return[o,i]},x3dom.X3DCanvas.prototype._createInitFailedDiv=function(e){var t=document.createElement("div");t.setAttribute("id","x3dom-create-init-failed"),t.style.width=e.getAttribute("width"),t.style.height=e.getAttribute("height"),t.style.backgroundColor="#C00",t.style.color="#FFF",t.style.fontSize="20px",t.style.fontWidth="bold",t.style.padding="10px 10px 10px 10px",t.style.display="inline-block",t.style.fontFamily="Helvetica",t.style.textAlign="center",t.appendChild(document.createTextNode("Your Browser does not support X3DOM")),t.appendChild(document.createElement("br")),t.appendChild(document.createTextNode("Read more about Browser support on:")),t.appendChild(document.createElement("br"));var i=document.createElement("a");i.setAttribute("href","http://www.x3dom.org/?page_id=9"),i.appendChild(document.createTextNode("X3DOM | Browser Support")),t.appendChild(i);var s=e.getAttribute("altImg")||null;if(s){var o=new Image;o.src=s,t.style.backgroundImage="url("+s+")",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="50% 50%"}e.appendChild(t),x3dom.debug.logError("Your Browser does not support X3DOM!")},x3dom.X3DCanvas.prototype._createFlashObject=function(e){var t=this._detectFlash(11,11);if(!t[0]||t[0]<t[1])return null;x3dom.debug.logInfo("Creating FlashObject for (X)3D element...");var i=this.x3dElem.getAttribute("id");if(null!==i)i="x3dom-"+i+"-object";else{var s=(new Date).getTime();i="x3dom-"+s+"-object"}var o=this.x3dElem.getAttribute("swfpath");if(null===o&&(o="x3dom.swf"),!this._fileExists(o)){var r;if(void 0===x3dom.versionInfo||x3dom.versionInfo.version.indexOf("dev")!=-1)r="dev";else{r=x3dom.versionInfo.version;var a=r.substr(r.length-1);0==a&&(r=r.substr(0,3))}o="http://www.x3dom.org/download/"+r+"/x3dom.swf",x3dom.debug.logWarning("Can't find local x3dom.swf ("+r+"). X3DOM now using the online version from x3dom.org.The online version needs a <a href='http://examples.x3dom.org/crossdomain.xml'>crossdomain.xml</a> file in the root directory of your domain to access textures")}var n=this.x3dElem.getAttribute("width"),d=-1;null==n?n=550:(d=n.indexOf("px"),d!=-1&&(n=n.substr(0,d)));var l=this.x3dElem.getAttribute("height");null==l?l=400:(d=l.indexOf("px"),d!=-1&&(l=l.substr(0,d)));var h=this.x3dElem.getAttribute("flashrenderer");null==h?this.flash_renderType="forward":this.flash_renderType="deferred";var u=document.createElement("object");return u.setAttribute("width","100%"),u.setAttribute("height","100%"),u.setAttribute("id",i),!document.doctype||document.doctype&&document.doctype.publicId&&document.doctype.publicId.search(/DTD XHTML/i)!=-1?(x3dom.debug.logWarning("Flash backend doesn't like XHTML, please use HTML5!"),u.setAttribute("style","width:"+n+"px; height:"+l+"px;")):null==e.getAttribute("style")&&e.setAttribute("style","width:"+n+"px; height:"+l+"px;"),this.appendParam(u,"menu","false"),this.appendParam(u,"quality","high"),this.appendParam(u,"wmode","direct"),this.appendParam(u,"allowScriptAccess","always"),this.appendParam(u,"flashvars","canvasIdx="+this._canvasIdx+"&renderType="+this.flash_renderType),this.appendParam(u,"movie",o),"Microsoft Internet Explorer"==navigator.appName?(e.appendChild(u),u.setAttribute("classid","clsid:d27cdb6e-ae6d-11cf-96b8-444553540000")):(u.setAttribute("type","application/x-shockwave-flash"),u.setAttribute("data",o),e.appendChild(u)),u},x3dom.X3DCanvas.prototype._createHTMLCanvas=function(e){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var t=document.createElement("canvas");t.setAttribute("class","x3dom-canvas");var i=e.getAttribute("style");i&&x3dom.debug.logInfo("Inline X3D styles detected");for(var s=["onmousedown","onmousemove","onmouseout","onmouseover","onmouseup","onclick","ondblclick","onkeydown","onkeypress","onkeyup","ontouchstart","ontouchmove","ontouchend","ontouchcancel","ontouchleave","ontouchenter","ondragstart","ondrop","ondragover"],o=0;o<s.length;o++){var r=s[o],a=e.getAttribute(r);a&&(x3dom.debug.logInfo(r+", "+a),t.setAttribute(r,a),e.removeAttribute(r))}var n=e.getAttribute("draggable");n&&(x3dom.debug.logInfo("draggable="+n),t.setAttribute("draggable",n)),e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.__removeEventListener=e.removeEventListener,e.addEventListener=function(e,i,o){var r,a=!1;for(r=0;r<s.length&&!a;r++)s[r]===e&&(a=!0);a?(x3dom.debug.logInfo("addEventListener for div.on"+e),t.addEventListener(e,i,o)):(x3dom.debug.logInfo("addEventListener for X3D.on"+e),this.__addEventListener(e,i,o))},e.removeEventListener=function(e,i,o){var r,a=!1;for(r=0;r<s.length&&!a;r++)s[r]===e&&(a=!0);a?(x3dom.debug.logInfo("removeEventListener for div.on"+e),t.removeEventListener(e,i,o)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+e),this.__removeEventListener(e,i,o))}),e.hasAttribute("ondownloadsfinished")&&e.addEventListener("downloadsfinished",function(){var t={target:e,type:"downloadsfinished"},i=e.getAttribute("ondownloadsfinished"),s=new Function("event",i);s.call(e,t)},!0),e.appendChild(t);var d=e.getAttribute("id");if(null!==d)t.id="x3dom-"+d+"-canvas";else{var l=(new Date).getTime();t.id="x3dom-"+l+"-canvas"}var h,u;return null!==(h=e.getAttribute("width"))&&(h.indexOf("%")>=0&&x3dom.debug.logWarning("The width attribute is to be specified in pixels not in percent."),t.style.width=h,t.setAttribute("width",h)),null!==(u=e.getAttribute("height"))&&(u.indexOf("%")>=0&&x3dom.debug.logWarning("The height attribute is to be specified in pixels not in percent."),t.style.height=u,t.setAttribute("height",u)),t.setAttribute("tabindex","0"),t},x3dom.X3DCanvas.prototype._watchForResize=function(){var e=[parseInt(x3dom.getStyle(this.canvas,"width")),parseInt(x3dom.getStyle(this.canvas,"height"))];this._current_dim[0]==e[0]&&this._current_dim[1]==e[1]||(this._current_dim=e,this.x3dElem.setAttribute("width",e[0]+"px"),this.x3dElem.setAttribute("height",e[1]+"px"))},x3dom.X3DCanvas.prototype._createProgressDiv=function(){var e=document.createElement("div");e.setAttribute("class","x3dom-progress");var t=document.createElement("strong");t.appendChild(document.createTextNode("Loading...")),e.appendChild(t);var i=document.createElement("span");return i.setAttribute("style","width: 25%;"),i.appendChild(document.createTextNode(" ")),e.appendChild(i),e.oncontextmenu=e.onmousedown=function(e){return e.preventDefault(),e.stopPropagation(),!1},e},
x3dom.X3DCanvas.prototype.mousePosition=function(e){var t=0,i=0;if("getBoundingClientRect"in document.documentElement){var s=e.target.offsetParent,o=s.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft,a=window.pageYOffset||document.documentElement.scrollTop,n=document.defaultView.getComputedStyle(s,null),d=parseFloat(n.getPropertyValue("padding-left")),l=parseFloat(n.getPropertyValue("border-left-width")),h=parseFloat(n.getPropertyValue("padding-top")),u=parseFloat(n.getPropertyValue("border-top-width"));t=Math.round(e.pageX-(o.left+d+l+r)),i=Math.round(e.pageY-(o.top+h+u+a))}else x3dom.debug.logError("NO getBoundingClientRect");return new x3dom.fields.SFVec2f(t,i)},x3dom.X3DCanvas.prototype.tick=function(){var e=this,t=this.x3dElem.runtime,i=(new Date).getTime(),s=i-this.lastTimeFPSWasTaken,o=1e3/(i-this.fps_t0);this.fps_t0=i,this.doc.advanceTime(i/1e3);var r=(new Date).getTime()-i;if(this.doc.needRender&&(s>=1e3&&(t.fps=this.framesSinceLastTime/(s/1e3),t.addMeasurement("FPS",t.fps),this.framesSinceLastTime=0,this.lastTimeFPSWasTaken=i),this.framesSinceLastTime++,t.addMeasurement("ANIM",r),0==t.isReady&&(t.ready(),t.isReady=!0),t.enterFrame(),"flash"==this.backend?this.isFlashReady&&(this.canvas.setFPS({fps:o}),this.doc.needRender=!1,this.doc.render(this.gl)):(this.doc.needRender=!1,this.doc.render(this.gl),this.doc._scene._vf.doPickPass||t.removeMeasurement("PICKING")),t.exitFrame()),this.progressDiv&&(this.doc.downloadCount>0?t.addInfo("#LOADS:",this.doc.downloadCount):t.removeInfo("#LOADS:"),"false"!==this.doc.properties.getProperty("showProgress")?this.progressDiv&&(this.progressDiv.childNodes[0].textContent="Loading: "+ +this.doc.downloadCount,this.doc.downloadCount>0?this.progressDiv.style.display="inline":this.progressDiv.style.display="none"):this.progressDiv.style.display="none"),0==this.doc.downloadCount&&this.doc.previousDownloadCount>0){var a;document.createEvent?(a=document.createEvent("Events"),a.initEvent("downloadsfinished",!0,!0),e.x3dElem.dispatchEvent(a)):document.createEventObject&&(a=document.createEventObject(),e.x3dElem.fireEvent("ondownloadsfinished",a))}this.doc.previousDownloadCount=this.doc.downloadCount},x3dom.X3DCanvas.prototype.load=function(e,t,i){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,i);var s=this;this.doc.onload=function(){s.hasRuntime?!function e(){s.doc&&s.x3dElem.runtime&&(s._watchForResize(),s.tick(),window.requestAnimFrame(e,s))}():s.tick()},this.x3dElem.render=function(){s.hasRuntime?s.doc.needRender=!0:s.doc.render(s.gl)},this.x3dElem.context=s.gl.ctx3d,this.doc.onerror=function(){alert("Failed to load X3D document")},this.doc.load(e,t)},x3dom.runtime={},x3dom.Runtime=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},x3dom.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},x3dom.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},x3dom.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},x3dom.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},x3dom.Runtime.prototype.initialize=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0},x3dom.Runtime.prototype.noBackendFound=function(){x3dom.debug.logInfo("No backend found. Unable to render.")},x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")},x3dom.Runtime.prototype.enterFrame=function(){},x3dom.Runtime.prototype.exitFrame=function(){},x3dom.Runtime.prototype.triggerRedraw=function(){this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.getActiveBindable=function(e){var t,i,s,o,r;if(t=this.canvas.doc._bindableBag._stacks,o=[],r=x3dom.nodeTypesLC[e.toLowerCase()],!r)return x3dom.debug.logError('No node of type "'+e+'" found.'),null;for(i=0;i<t.length;i++)s=t[i].getActive(),void 0!==s._xmlNode&&x3dom.isa(s,r)&&o.push(s);return o[0]?o[0]._xmlNode:null},x3dom.Runtime.prototype.nextView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.prevView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()},x3dom.Runtime.prototype.viewMatrix=function(){return this.canvas.doc._viewarea.getViewMatrix()},x3dom.Runtime.prototype.projectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()},x3dom.Runtime.prototype.getWorldToCameraCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getWCtoCCMatrix()},x3dom.Runtime.prototype.getCameraToWorldCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getCCtoWCMatrix()},x3dom.Runtime.prototype.getViewingRay=function(e,t){return this.canvas.doc._viewarea.calcViewRay(e,t)},x3dom.Runtime.prototype.shootRay=function(e,t){var i=this.canvas.doc,s=i._viewarea._pickingInfo;return i.onPick(this.canvas.gl,e,t),{pickPosition:s.pickObj?s.pickPos:null,pickNormal:s.pickObj?s.pickNorm:null,pickObject:s.pickObj?s.pickObj._xmlNode:null}},x3dom.Runtime.prototype.getWidth=function(){return this.canvas.doc._viewarea._width},x3dom.Runtime.prototype.getHeight=function(){return this.canvas.doc._viewarea._height},x3dom.Runtime.prototype.mousePosition=function(e){var t=this.canvas.mousePosition(e);return[t.x,t.y]},x3dom.Runtime.prototype.calcCanvasPos=function(e,t,i){var s=new x3dom.fields.SFVec3f(e,t,i),o=this.canvas.doc._viewarea.getWCtoCCMatrix(),r=o.multFullMatrixPnt(s),a=this.canvas.doc._viewarea._width,n=this.canvas.doc._viewarea._height,d=Math.round((r.x+1)*(a-1)/2),l=Math.round((n-1)*(1-r.y)/2);return[d,l]},x3dom.Runtime.prototype.calcPagePos=function(e,t,i){var s=this.canvas.canvas.offsetParent;if(!s)return x3dom.debug.logError("Can't calc page pos without offsetParent."),[0,0];var o=s.getBoundingClientRect(),r=this.calcCanvasPos(e,t,i),a=window.pageXOffset||document.body.scrollLeft,n=window.pageYOffset||document.body.scrollTop,d=document.defaultView.getComputedStyle(s,null),l=parseFloat(d.getPropertyValue("padding-left")),h=parseFloat(d.getPropertyValue("border-left-width")),u=parseFloat(d.getPropertyValue("padding-top")),f=parseFloat(d.getPropertyValue("border-top-width")),c=o.left+l+h+a+r[0],_=o.top+u+f+n+r[1];return[c,_]},x3dom.Runtime.prototype.calcClientPos=function(e,t,i){var s=this.canvas.canvas.offsetParent;if(!s)return x3dom.debug.logError("Can't calc client pos without offsetParent."),[0,0];var o=s.getBoundingClientRect(),r=this.calcCanvasPos(e,t,i),a=document.defaultView.getComputedStyle(s,null),n=parseFloat(a.getPropertyValue("padding-left")),d=parseFloat(a.getPropertyValue("border-left-width")),l=parseFloat(a.getPropertyValue("padding-top")),h=parseFloat(a.getPropertyValue("border-top-width")),u=o.left+n+d+r[0],f=o.top+l+h+r[1];return[u,f]},x3dom.Runtime.prototype.getScreenshot=function(){var e="",t=this.canvas.backend,i=this.canvas.canvas;if(i)if("flash"==t)e=i.getScreenshot();else{var s=document.createElement("canvas");s.width=i.width,s.height=i.height;var o=s.getContext("2d");o.drawImage(i,0,0,i.width,i.height),o.scale(1,-1),o.translate(0,-i.height),e=s.toDataURL()}return e},x3dom.Runtime.prototype.getCanvas=function(){return this.canvas.canvas},x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()},x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()},x3dom.Runtime.prototype.lightView=function(){return this.canvas.doc._nodeBag.lights.length>0?(this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0):(x3dom.debug.logInfo("No lights to navigate to."),!1)},x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()},x3dom.Runtime.prototype.fitAll=function(e){void 0===e&&(e=!0);var t=this.canvas.doc._scene;t.updateVolume(),this.canvas.doc._viewarea.fit(t._lastMin,t._lastMax,e)},x3dom.Runtime.prototype.fitObject=function(e,t){if(e&&e._x3domNode){void 0===t&&(t=!0);var i=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN(),o=e._x3domNode.getVolume();o.getBounds(i,s);var r=e._x3domNode.getCurrentTransform();if(i=r.multMatrixPnt(i),s=r.multMatrixPnt(s),x3dom.isa(e._x3domNode,x3dom.nodeTypes.X3DTransformNode)){var a=e._x3domNode._trafo.inverse();i=a.multMatrixPnt(i),s=a.multMatrixPnt(s)}this.canvas.doc._viewarea.fit(i,s,t)}},x3dom.Runtime.prototype.showAll=function(e){this.canvas.doc._viewarea.showAll(e)},x3dom.Runtime.prototype.showObject=function(e){if(e&&e._x3domNode){var t=x3dom.fields.SFVec3f.MAX(),i=x3dom.fields.SFVec3f.MIN(),s=e._x3domNode.getVolume();s.getBounds(t,i);var o=e._x3domNode.getCurrentTransform();t=o.multMatrixPnt(t),i=o.multMatrixPnt(i);var r=this.canvas.doc._viewarea,a=r._width<r._height?r._width:r._height,n=new x3dom.fields.SFVec3f(0,0,1),d=this.canvas.doc._scene.getViewpoint(),l=d.getFieldOfView()/2,h=Math.tan(l);Math.abs(h)>x3dom.fields.Eps&&(a/=h);var u=r._width-1,f=r._height-1,c=.25,_=new x3dom.fields.SFVec2f(c*u,c*f);c=.75;var m=new x3dom.fields.SFVec2f(c*u,c*f),p=i.subtract(t).multiply(.5),x=p.length(),g=t.add(p),v=m.subtract(_).multiply(.5),y=1.5*v.length();v=v.add(_);var b=1;y>x3dom.fields.Eps&&(b=x/y*Math.sqrt(v.x*v.x+v.y*v.y+a*a)),n=o.multMatrixVec(n).normalize(),n=n.multiply(b);var T=g.add(n),S=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,1),n),M=S.toMatrix(),C=x3dom.fields.SFMatrix4f.translation(T.negate()),F=x3dom.fields.SFMatrix4f.translation(T);F=F.mult(M).mult(C).mult(F);var E=F.inverse();r.animateTo(E,d)}},x3dom.Runtime.prototype.getCenter=function(e){return e&&e._x3domNode&&(this.isA(e,"X3DShapeNode")||this.isA(e,"X3DGeometryNode"))?e._x3domNode.getCenter():null},x3dom.Runtime.prototype.getCurrentTransform=function(e){return e&&e._x3domNode?e._x3domNode.getCurrentTransform():null},x3dom.Runtime.prototype.getBBox=function(e){if(e&&e._x3domNode&&this.isA(e,"X3DBoundedObject")){var t=e._x3domNode.getVolume();return{min:x3dom.fields.SFVec3f.copy(t.min),max:x3dom.fields.SFVec3f.copy(t.max)}}return null},x3dom.Runtime.prototype.getSceneBBox=function(){var e=this.canvas.doc._scene;return e.updateVolume(),{min:x3dom.fields.SFVec3f.copy(e._lastMin),max:x3dom.fields.SFVec3f.copy(e._lastMax)}},x3dom.Runtime.prototype.debug=function(e){var t=this.canvas.doc;return void 0===t._viewarea._visDbgBuf&&(t._viewarea._visDbgBuf="true"===t._x3dElem.getAttribute("showLog")),arguments.length>0?e===!0?(t._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block"):(t._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none"):(t._viewarea._visDbgBuf=!t._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==t._viewarea._visDbgBuf?"block":"none"),t.needRender=!0,t._viewarea._visDbgBuf},x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()},x3dom.Runtime.prototype.noNav=function(){this.canvas.doc._scene.getNavigationInfo().setType("none")},x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")},x3dom.Runtime.prototype.turnTable=function(){this.canvas.doc._scene.getNavigationInfo().setType("turntable")},x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")},x3dom.Runtime.prototype.freeFly=function(){this.canvas.doc._scene.getNavigationInfo().setType("freefly")},x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")},x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")},x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")},x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")},x3dom.Runtime.prototype.helicopter=function(){this.canvas.doc._scene.getNavigationInfo().setType("helicopter")},x3dom.Runtime.prototype.resetExamin=function(){var e=this.canvas.doc._viewarea;e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0),e._needNavigationMatrixUpdate=!0,this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.disableKeys=function(){this.canvas.disableKeys=!0},x3dom.Runtime.prototype.enableKeys=function(){this.canvas.disableKeys=!1},x3dom.Runtime.prototype.disableLeftDrag=function(){this.canvas.disableLeftDrag=!0},x3dom.Runtime.prototype.enableLeftDrag=function(){this.canvas.disableLeftDrag=!1},x3dom.Runtime.prototype.disableRightDrag=function(){this.canvas.disableRightDrag=!0},x3dom.Runtime.prototype.enableRightDrag=function(){this.canvas.disableRightDrag=!1},x3dom.Runtime.prototype.disableMiddleDrag=function(){this.canvas.disableMiddleDrag=!0},x3dom.Runtime.prototype.enableMiddleDrag=function(){this.canvas.disableMiddleDrag=!1},x3dom.Runtime.prototype.togglePoints=function(e){var t=this.canvas.doc,i=e===!0?3:2;return t._viewarea._points=++t._viewarea._points%i,t.needRender=!0,t._viewarea._points},x3dom.Runtime.prototype.pickRect=function(e,t,i,s){return this.canvas.doc.onPickRect(this.canvas.gl,e,t,i,s)},x3dom.Runtime.prototype.pickMode=function(e){return e&&e.internal===!0?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()},x3dom.Runtime.prototype.changePickMode=function(e){switch(e=e.toLowerCase()){case"idbuf":e="idBuf";break;case"idbuf24":e="idBuf24";break;case"idbufid":e="idBufId";break;case"texcoord":e="texCoord";break;case"color":e="color";break;case"box":e="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+e+" unknown intersect type"),e=void 0}return void 0!==e&&(this.canvas.doc._scene._vf.pickMode=e,x3dom.debug.logInfo("Switched pickMode to '"+e+"'."),!0)},x3dom.Runtime.prototype.speed=function(e){var t=this.canvas.doc._scene.getNavigationInfo();return e&&(t._vf.speed=e,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed)),t._vf.speed},x3dom.Runtime.prototype.statistics=function(e){var t=this.canvas.stateViewer;return!!t&&(this.canvas.doc.needRender=!0,e===!0?(t.display(e),!0):e===!1?(t.display(e),!1):(t.display(!t.active),t.active))},x3dom.Runtime.prototype.processIndicator=function(e){var t=this.canvas.progressDiv;return!!t&&(e===!0?(t.style.display="inline",!0):e===!1?(t.style.display="none",!1):"none"!=t.style.display)},x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties},x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend},x3dom.Runtime.prototype.getFPS=function(){return this.fps},x3dom.Runtime.prototype.isA=function(e,t){var i=!1;return t&&e&&e._x3domNode&&(""===t&&(t="X3DNode"),i=x3dom.isa(e._x3domNode,x3dom.nodeTypesLC[t.toLowerCase()])),i},x3dom.detectActiveX=function(){var e=!1;if(window.ActiveXObject){var t=null;try{t=new ActiveXObject("AVALONATX.InstantPluginATXCtrl.1")}catch(i){}t&&(e=!0)}return e},x3dom.rerouteSetAttribute=function(e,t){e._setAttribute=e.setAttribute,e.setAttribute=function(i,s){var o=e.getAttribute("_x3domNode"),r=t.findNode(o);return r?r.parseField(i,s):0};for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];x3dom.rerouteSetAttribute(s,t)}},x3dom.insertActiveX=function(e){"undefined"==typeof x3dom.atxCtrlCounter&&(x3dom.atxCtrlCounter=0);var t=e.getAttribute("height"),i=e.getAttribute("width"),s=e.parentNode,o=document.createElement("div");o.setAttribute("id","x3dplaceholder");var r=s.insertBefore(o,e),a=document.createElement("div");a.style.display="none",s.appendChild(a),s.removeChild(e),a.appendChild(e);var n=document.createElement("object"),d="Avalon"+x3dom.atxCtrlCounter;x3dom.atxCtrlCounter++,n.setAttribute("id",d),n.setAttribute("classid","CLSID:F3254BA0-99FF-4D14-BD81-EDA9873A471E"),n.setAttribute("width",i?i:"500"),n.setAttribute("height",t?t:"500"),r.appendChild(n);var l=document.getElementById(d),h=l.getBrowser(),u=h.importDocument(e);h.replaceWorld(u),e.getBrowser=function(){return l.getBrowser()},x3dom.rerouteSetAttribute(e,h)},x3dom.userAgentFeature={supportsDOMAttrModified:!1},function(){"use strict";var e=function(){var e,t,i=document.getElementsByTagName("X3D"),s=[];for(e=0;e<i.length;e++)void 0===i[e].hasRuntime&&s.push(i[e]);var o,r,a,n=new x3dom.Properties,d=array_to_object(["showLog","showStat","showProgress","PrimitiveQuality","components","loadpath","disableDoubleClick","backend","altImg","flashrenderer","swfpath","runtimeEnabled","keysEnabled","showTouchpoints","disableTouch","maxActiveDownloads"]),l=!1;for(e=0;e<s.length;e++){for(n.setProperty("showLog",s[e].getAttribute("showLog")||"false"),n.setProperty("showStat",s[e].getAttribute("showStat")||"false"),n.setProperty("showProgress",s[e].getAttribute("showProgress")||"true"),n.setProperty("PrimitiveQuality",s[e].getAttribute("PrimitiveQuality")||"High"),o=s[e].getElementsByTagName("PARAM"),t=0;t<o.length;t++)o[t].getAttribute("name")in d&&n.setProperty(o[t].getAttribute("name"),o[t].getAttribute("value"));if("true"===n.getProperty("showLog")&&(l=!0),"undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0){if(r=n.getProperty("components",s[e].getAttribute("components")))for(a=n.getProperty("loadpath",s[e].getAttribute("loadpath")),r=r.trim().split(","),t=0;t<r.length;t++)x3dom.loadJS(r[t]+".js",a);if(s[e].getAttribute("src")){var h=document.createElement("scene"),u=document.createElement("Inline");u.setAttribute("url",s[e].getAttribute("src")),h.appendChild(u),s[e].appendChild(h)}}}1==l?x3dom.debug.activate(!0):x3dom.debug.activate(!1),s=Array.map(s,function(e){return e.hasRuntime=!0,e});var f=document.getElementsByTagName("webSG");for(e=0;e<f.length;e++)f[e].hasRuntime=!1,s.push(f[e]);void 0!==x3dom.versionInfo&&x3dom.debug.logInfo("X3DOM version "+x3dom.versionInfo.version+", Revison <a href='https://github.com/x3dom/x3dom/tree/"+x3dom.versionInfo.revision+"'>"+x3dom.versionInfo.revision+"</a>, Date "+x3dom.versionInfo.date),x3dom.debug.logInfo("Found "+(s.length-f.length)+" X3D and "+f.length+" (experimental) WebSG nodes...");var c,_,m,p,x,g,v;for(e=0;e<s.length;e++)c=s[e],x3dom.detectActiveX()?x3dom.insertActiveX(c):(_=new x3dom.X3DCanvas(c,x3dom.canvases.length),x3dom.canvases.push(_),null!==_.gl?(g=(new Date).getTime(),s[e].runtime=new x3dom.Runtime(s[e],_),s[e].runtime.initialize(s[e],_),x3dom.runtime.ready&&(s[e].runtime.ready=x3dom.runtime.ready),""==_.backend&&x3dom.runtime.noBackendFound(),_.load(s[e],e,n),"true"===n.getProperty("showStat")?s[e].runtime.statistics(!0):s[e].runtime.statistics(!1),"true"===n.getProperty("showProgress")?("bar"===n.getProperty("showProgress")&&_.progressDiv.setAttribute("class","x3dom-progress bar"),s[e].runtime.processIndicator(!0)):s[e].runtime.processIndicator(!1),v=(new Date).getTime()-g,x3dom.debug.logInfo("Time for setup and init of GL element no. "+e+": "+v+" ms.")):(m=document.createElement("div"),m.setAttribute("class","x3dom-nox3d"),m.setAttribute("id","x3dom-nox3d"),p=document.createElement("p"),p.appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),x=document.createElement("a"),x.setAttribute("href","http://www.x3dom.org/?page_id=9"),x.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),m.appendChild(p),m.appendChild(x),_.x3dElem.appendChild(m),_.stateViewer&&c.removeChild(_.stateViewer.viewer)));(function(e){var t=null;document.createEvent?(t=document.createEvent("Events"),t.initEvent(e,!0,!0),document.dispatchEvent(t)):document.createEventObject&&(t=document.createEventObject(),document.body.fireEvent("on"+e,t))})("load")},t=function(){if(x3dom.canvases){for(var e=0;e<x3dom.canvases.length;e++)x3dom.canvases[e].doc.shutdown(x3dom.canvases[e].gl);x3dom.canvases=[]}};x3dom.reload=function(){e()},navigator.userAgent.indexOf("Chrome")!=-1?(document.__getElementsByTagName=document.getElementsByTagName,document.getElementsByTagName=function(e){var t=[],i=this.__getElementsByTagName("*");if("*"==e)t=i;else{e=e.toUpperCase();for(var s=0;s<i.length;s++){var o=i[s].tagName.toUpperCase();o===e&&t.push(i[s])}}return t},document.__getElementById=document.getElementById,document.getElementById=function(e){var t=this.__getElementById(e);if(!t)for(var i=this.__getElementsByTagName("*"),s=0;s<i.length&&!t;s++)i[s].getAttribute("id")===e&&(t=i[s]);return t}):(document.__getElementById=document.getElementById,document.getElementById=function(e){var t=this.__getElementById(e);if(!t)for(var i=this.getElementsByTagName("*"),s=0;s<i.length&&!t;s++)i[s].getAttribute("id")===e&&(t=i[s]);return t}),window.addEventListener?(window.addEventListener("load",e,!1),window.addEventListener("unload",t,!1),window.addEventListener("reload",t,!1)):window.attachEvent&&(window.attachEvent("onload",e),window.attachEvent("onunload",t),window.attachEvent("onreload",t)),"complete"===document.readyState&&window.setTimeout(function(){e()},20)}(),x3dom.Cache=function(){this.textures=[],this.shaders=[]},x3dom.Cache.prototype.getTexture2D=function(e,t,i,s,o,r,a){var n=i;return void 0===this.textures[n]&&(this.textures[n]=x3dom.Utils.createTexture2D(e,t,i,s,o,r,a)),this.textures[n]},x3dom.Cache.prototype.getTexture2DByDEF=function(e,t,i){var s=t.name+"_"+i;return void 0===this.textures[s]&&(this.textures[s]=e.createTexture()),this.textures[s]},x3dom.Cache.prototype.getTextureCube=function(e,t,i,s,o,r,a){for(var n="",d=0;d<i.length;++d)n+=i[d]+"|";return void 0===this.textures[n]&&(this.textures[n]=x3dom.Utils.createTextureCube(e,t,i,s,o,r,a)),this.textures[n]},x3dom.Cache.prototype.getShader=function(e,t){var i=null;if(void 0===this.shaders[t]){switch(t){case x3dom.shader.PICKING:i=new x3dom.shader.PickingShader(e);break;case x3dom.shader.PICKING_24:i=new x3dom.shader.Picking24Shader(e);break;case x3dom.shader.PICKING_ID:i=new x3dom.shader.PickingIdShader(e);break;case x3dom.shader.PICKING_COLOR:i=new x3dom.shader.PickingColorShader(e);break;case x3dom.shader.PICKING_TEXCOORD:i=new x3dom.shader.PickingTexcoordShader(e);break;case x3dom.shader.FRONTGROUND_TEXTURE:i=new x3dom.shader.FrontgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_TEXTURE:i=new x3dom.shader.BackgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_SKYTEXTURE:i=new x3dom.shader.BackgroundSkyTextureShader(e);break;case x3dom.shader.BACKGROUND_CUBETEXTURE:i=new x3dom.shader.BackgroundCubeTextureShader(e);break;case x3dom.shader.SHADOW:i=new x3dom.shader.ShadowShader(e);break;case x3dom.shader.BLUR:i=new x3dom.shader.BlurShader(e);break;case x3dom.shader.DEPTH:break;case x3dom.shader.NORMAL:i=new x3dom.shader.NormalShader(e);break;case x3dom.shader.TEXTURE_REFINEMENT:i=new x3dom.shader.TextureRefinementShader(e)}i?this.shaders[t]=x3dom.Utils.wrapProgram(e,i,t):x3dom.debug.logError("Couldn't create shader: "+t)}return this.shaders[t]},x3dom.Cache.prototype.getDynamicShader=function(e,t,i){var s=x3dom.Utils.generateProperties(t,i),o=s.id;if(void 0===this.shaders[o]){var r=null;r=s.CSHADER!=-1?new x3dom.shader.ComposedShader(e,i):x3dom.caps.MOBILE&&!s.CSSHADER?new x3dom.shader.DynamicMobileShader(e,s):new x3dom.shader.DynamicShader(e,s),this.shaders[o]=x3dom.Utils.wrapProgram(e,r,o)}return this.shaders[o]},x3dom.Cache.prototype.getShaderByProperties=function(e,t,i,s,o){var r=i.id;if(void 0!==s&&null!==s&&(r+=s),void 0!==o&&null!==o&&(r+="S"),void 0===this.shaders[r]){var a=null;a=void 0!==s&&null!==s?new x3dom.shader.DynamicShaderPicking(e,i,s):void 0!==o&&null!==o?new x3dom.shader.DynamicShadowShader(e,i):i.CSHADER!=-1?new x3dom.shader.ComposedShader(e,t):x3dom.caps.MOBILE&&!i.CSSHADER?new x3dom.shader.DynamicMobileShader(e,i):new x3dom.shader.DynamicShader(e,i),this.shaders[r]=x3dom.Utils.wrapProgram(e,a,r)}return this.shaders[r]},x3dom.Cache.prototype.getShadowRenderingShader=function(e,t){for(var i="shadow",s=0;s<t.length;s++)i+=x3dom.isa(t[s],x3dom.nodeTypes.SpotLight)?"S":x3dom.isa(t[s],x3dom.nodeTypes.PointLight)?"P":"D";if(void 0===this.shaders[i]){var o=new x3dom.shader.ShadowRenderingShader(e,t);this.shaders[i]=x3dom.Utils.wrapProgram(e,o,i)}return this.shaders[i]},x3dom.Cache.prototype.Release=function(e){for(var t in this.textures)e.deleteTexture(this.textures[t]);this.textures=[];for(var i in this.shaders){for(var s=this.shaders[i],o=e.getAttachedShaders(s.program),r=0;r<o.length;++r)e.detachShader(s.program,o[r]),e.deleteShader(o[r]);e.deleteProgram(s.program)}this.shaders=[]},x3dom.Texture=function(e,t,i,s){this.gl=e,this.doc=t,this.cache=i,this.node=s,this.samplerName="diffuseMap",this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR,this.wrapS=e.REPEAT,this.wrapT=e.REPEAT,this.genMipMaps=!1,this.texture=null,this.ready=!1,this.dashtexture=!1;var o=this.node,r="mpd";if(this.node._x3domTexture=this,x3dom.isa(o,x3dom.nodeTypes.MovieTexture)&&o._vf.url[0].indexOf(r,o._vf.url[0].length-r.length)!==-1){this.dashtexture=!0;var a=document.getElementById("AdditionalDashVideoScript");a||(a=document.createElement("script"),a.setAttribute("type","text/javascript"),a.setAttribute("src",x3dom.Texture.dashVideoScriptFile),a.setAttribute("id","AdditionalDashVideoScript"),a.onload=function(){for(var e;e=x3dom.Texture.loadDashVideos.pop();)x3dom.Texture.textNum++,e.update();a.ready=!0},document.getElementsByTagName("head")[0].appendChild(a)),a.ready===!0?(x3dom.Texture.textNum++,this.update()):x3dom.Texture.loadDashVideos.push(this)}this.dashtexture||this.update()},x3dom.Texture.dashVideoScriptFile="dash.all.js",x3dom.Texture.loadDashVideos=[],x3dom.Texture.textNum=0,x3dom.Texture.clampFontSize=!1,x3dom.Texture.minFontQuality=.5,x3dom.Texture.maxFontQuality=10,x3dom.Texture.prototype.update=function(){x3dom.isa(this.node,x3dom.nodeTypes.Text)?this.updateText():this.updateTexture()},x3dom.Texture.prototype.setPixel=function(e,t,i,s){var o=this.gl,r=new Uint8Array(i);o.bindTexture(this.type,this.texture),o.pixelStorei(o.UNPACK_ALIGNMENT,1),o.texSubImage2D(this.type,0,e,t,1,1,this.format,o.UNSIGNED_BYTE,r),o.bindTexture(this.type,null),s&&(this.doc.needRender=!0)},x3dom.Texture.prototype.updateTexture=function(){var e=this.gl,t=this.doc,i=this.node;if(this.samplerName=i._type,x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.type=e.TEXTURE_CUBE_MAP:this.type=e.TEXTURE_2D,x3dom.isa(i,x3dom.nodeTypes.PixelTexture))switch(i._vf.image.comp){case 1:this.format=e.LUMINANCE;break;case 2:this.format=e.LUMINANCE_ALPHA;break;case 3:this.format=e.RGB;break;case 4:this.format=e.RGBA}else this.format=e.RGBA;if(null!==i._cf.textureProperties.node){var s=i._cf.textureProperties.node;this.wrapS=x3dom.Utils.boundaryModesDic(e,s._vf.boundaryModeS),this.wrapT=x3dom.Utils.boundaryModesDic(e,s._vf.boundaryModeT),this.minFilter=x3dom.Utils.minFilterDic(e,s._vf.minificationFilter),this.magFilter=x3dom.Utils.magFilterDic(e,s._vf.magnificationFilter),s._vf.generateMipMaps===!0?(this.genMipMaps=!0,this.minFilter==e.NEAREST?this.minFilter=e.NEAREST_MIPMAP_NEAREST:this.minFilter==e.LINEAR&&(this.minFilter=e.LINEAR_MIPMAP_LINEAR),this.texture&&(this.texture.ready||this.texture.textureCubeReady)&&(e.bindTexture(this.type,this.texture),e.generateMipmap(this.type),e.bindTexture(this.type,null))):(this.genMipMaps=!1,this.minFilter==e.LINEAR_MIPMAP_LINEAR||this.minFilter==e.LINEAR_MIPMAP_NEAREST?this.minFilter=e.LINEAR:this.minFilter!=e.NEAREST_MIPMAP_LINEAR&&this.minFilter!=e.NEAREST_MIPMAP_NEAREST||(this.minFilter=e.NEAREST))}else 0==i._vf.repeatS?this.wrapS=e.CLAMP_TO_EDGE:this.wrapS=e.REPEAT,0==i._vf.repeatT?this.wrapT=e.CLAMP_TO_EDGE:this.wrapT=e.REPEAT,"displacementMap"!=this.samplerName&&"multiDiffuseAlphaMap"!=this.samplerName&&"multiVisibilityMap"!=this.samplerName&&"multiEmissiveAmbientMap"!=this.samplerName&&"multiSpecularShininessMap"!=this.samplerName||(this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.minFilter=e.NEAREST,this.magFilter=e.NEAREST);var o=i._video&&i._needPerFrameUpdate===!0;if(i._isCanvas&&i._canvas)null==this.texture&&(this.texture=e.createTexture()),this.texture.width=i._canvas.width,this.texture.height=i._canvas.height,this.texture.ready=!0,e.bindTexture(this.type,this.texture),e.texImage2D(this.type,0,this.format,this.format,e.UNSIGNED_BYTE,i._canvas),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null);else if(x3dom.isa(i,x3dom.nodeTypes.RenderedTexture))i._webgl&&i._webgl.fbo?i._webgl.fbo.dtex&&i._vf.depthMap?this.texture=i._webgl.fbo.dtex:this.texture=i._webgl.fbo.tex:(this.texture=null,x3dom.debug.logError("Try updating RenderedTexture without FBO initialized!")),this.texture&&(this.texture.ready=!0);else if(x3dom.isa(i,x3dom.nodeTypes.PixelTexture)){null==this.texture&&(this.node._DEF?this.texture=this.cache.getTexture2DByDEF(e,this.node._nameSpace,this.node._DEF):this.texture=e.createTexture()),this.texture.width=i._vf.image.width,this.texture.height=i._vf.image.height,this.texture.ready=!0;var r=i._vf.image.array,a=i._vf.image.width*i._vf.image.height*i._vf.image.comp;if(r.length<a)for(r=i._vf.image.toGL();r.length<a;)r.push(0);var n=new Uint8Array(r);e.bindTexture(this.type,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(this.type,0,this.format,i._vf.image.width,i._vf.image.height,0,this.format,e.UNSIGNED_BYTE,n),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null)}else if(x3dom.isa(i,x3dom.nodeTypes.MovieTexture)||o){var d=this,l=document.getElementsByTagName("body")[0];if(null==this.texture&&(this.texture=e.createTexture()),this.dashtexture){var h=document.createElement("div");h.setAttribute("class","dash-video-player"+x3dom.Texture.textNum),i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted");var u=document.createElement("script");u.setAttribute("type","text/javascript"),u.innerHTML='startDashVideo("'+i._vf.url[0]+'",".dash-video-player'+x3dom.Texture.textNum+' video")',h.appendChild(u),h.appendChild(i._video),l.appendChild(h),i._video.style.visibility="hidden",i._video.style.display="none"}else{o||(i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted"),l.appendChild(i._video),i._video.style.visibility="hidden",i._video.style.display="none");for(var f=0;f<i._vf.url.length;f++){var c=i._nameSpace.getURL(i._vf.url[f]);x3dom.debug.logInfo("Adding video file: "+c);var _=document.createElement("source");_.setAttribute("src",c),i._video.appendChild(_)}}var m=function(){e.bindTexture(d.type,d.texture),e.texImage2D(d.type,0,d.format,d.format,e.UNSIGNED_BYTE,i._video),d.genMipMaps&&e.generateMipmap(d.type),e.bindTexture(d.type,null),d.texture.ready=!0,t.needRender=!0},p=function(){i._video.play(),i._intervalID=setInterval(m,16)},x=function(){clearInterval(i._intervalID),i._vf.loop===!0&&(i._video.play(),i._intervalID=setInterval(m,16))};i._video.addEventListener("canplaythrough",p,!0),i._video.addEventListener("ended",x,!0)}else x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.texture=this.cache.getTextureCube(e,t,i.getTexUrl(),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps):this.texture=this.cache.getTexture2D(e,t,i._nameSpace.getURL(i._vf.url[0]),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps)},x3dom.Texture.prototype.updateText=function(){var e=this.gl;this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR;var t=this.node._cf.fontStyle.node,i="serif",s="normal",o="left",r=1,a=1,n=!0,d="",l=2,h="FIRST";if(null!==t){var u=t._vf.family.toString();switch(u=u.trim().replace(/\'/g,"").replace(/\,/," "),u=u.split(" "),i=Array.map(u,function(e){return"SANS"==e?"sans-serif":"SERIF"==e?"serif":"TYPEWRITER"==e?"monospace":""+e}).join(","),s=t._vf.style.toString().replace(/\'/g,""),s.toUpperCase()){case"PLAIN":s="normal";break;case"BOLD":s="bold";break;case"ITALIC":s="italic";break;case"BOLDITALIC":s="italic bold";break;
default:s="normal"}var f=t._vf.leftToRight?"ltr":"rtl",c=t._vf.topToBottom;switch(o=t._vf.justify[0].toString().replace(/\'/g,""),o.toUpperCase()){case"BEGIN":o="left";break;case"END":o="right";break;case"FIRST":o="left";break;case"MIDDLE":o="center";break;default:o="left"}if(void 0===t._vf.justify[1])h="FIRST";else switch(h=t._vf.justify[1].toString().replace(/\'/g,""),h.toUpperCase()){case"BEGIN":h="BEGIN";break;case"FIRST":h="FIRST";break;case"MIDDLE":h="MIDDLE";break;case"END":h="END";break;default:h="FIRST"}r=t._vf.size,a=t._vf.spacing,n=t._vf.horizontal,d=t._vf.language,l=t._vf.quality,l=Math.max(x3dom.Texture.minFontQuality,l),l=Math.min(x3dom.Texture.maxFontQuality,l),r<.1&&(r=.1),x3dom.Texture.clampFontSize&&r>2.3&&(r=2.3)}var _,m,p=this.node._vf.string,x=this.node._vf.maxExtent,g=[],v=document.createElement("canvas");v.dir=f;var y=42,b=r*y,T=o;document.body.appendChild(v);var S=v.getContext("2d");S.font=s+" "+b+"px "+i;var M,C,F,E,w=0;for(F=0;F<p.length;F++)M=S.measureText(p[F]).width,M>w&&(w=M),C=0|this.node._vf.length[F],x>0&&(C>x||0==C)&&(C=x),g[F]=C<=0?M:C*y;var A=.1*b,N=w,R=b*a*p.length+A;_=0,m=0;var I=0,P=0,D="top";switch(o){case"center":I=-N/2,_=N/2;break;case"left":I="ltr"==f?0:-N,_=0;break;case"right":I="ltr"==f?-N:0,_=N}switch(h){case"MIDDLE":P=R/2;break;case"BEGIN":P=c?0:R-A,D=c?"top":"bottom",m=c?0:b;break;case"FIRST":P=c?b:R-A,D=c?"alphabetic":"bottom",m=c?b:b;break;case"END":P=c?R-A:0,D=c?"bottom":"top",m=c?b:0}var V=1/42,L=N*V,O=R*V;for(I*=V,P*=V,v.width=N*l,v.height=R*l,v.dir=f,S.scale(l,l),S.fillStyle="rgba(0,0,0,0)",S.fillRect(0,0,S.canvas.width,S.canvas.height),S.fillStyle="white",S.textBaseline=D,S.font=s+" "+b+"px "+i,S.textAlign=T,F=0;F<p.length;F++)E=c?F:p.length-1-F,S.fillText(p[E],_,m,g[E]),m+=b*a;null===this.texture&&(this.texture=e.createTexture()),e.bindTexture(this.type,this.texture),e.texImage2D(this.type,0,this.format,this.format,e.UNSIGNED_BYTE,v),e.bindTexture(this.type,null),document.body.removeChild(v),this.node._mesh._positions[0]=[0+I,-O+P,0,L+I,-O+P,0,L+I,0+P,0,0+I,0+P,0],this.node.invalidateVolume(),Array.forEach(this.node._parentNodes,function(e){e.setAllDirty()})},x3dom.X3DDocument=function(e,t,i){this.canvas=e,this.ctx=t,this.properties=i,this.needRender=!0,this._x3dElem=null,this._scene=null,this._viewarea=null,this.downloadCount=0,this.previousDownloadCount=0,this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[],affectedPointingSensors:[]},this.onload=function(){},this.onerror=function(){}},x3dom.X3DDocument.prototype.load=function(e,t){function i(){if(0===o.length)return r._setup(s[e],s,t),void r.onload();var a=o.shift();!x3dom.isX3DElement(a)||"x3d"!==a.localName.toLowerCase()&&"websg"!==a.localName.toLowerCase()||(s[a]=a,r._x3dElem=a,i())}var s={},o=[e],r=this;i()},x3dom.findScene=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];s&&s.localName&&"scene"===s.localName.toLowerCase()&&t.push(s)}return t.length>1?(x3dom.debug.logError("X3D element has more than one Scene child (has "+e.childNodes.length+")."),null):t[0]},x3dom.X3DDocument.prototype._setup=function(e,t,i){function s(e,t){for(var i=0,s=e.length;i<s;i++)if(e[i]===t){e.splice(i,1);break}}function o(e){for(var t=e.childNodes,i=0,a=t.length;i<a;i++)o(t[i]);if(e._x3domNode){var n=e._x3domNode,d=n._nameSpace;if(x3dom.isa(n,x3dom.nodeTypes.X3DShapeNode))n._cleanupGLObjects&&n._cleanupGLObjects(!0),x3dom.nodeTypes.Shape.idMap.nodeID[n._objectID]&&delete x3dom.nodeTypes.Shape.idMap.nodeID[n._objectID];else if(x3dom.isa(n,x3dom.nodeTypes.TimeSensor))s(r._nodeBag.timer,n);else if(x3dom.isa(n,x3dom.nodeTypes.X3DLightNode))s(r._nodeBag.lights,n);else if(x3dom.isa(n,x3dom.nodeTypes.X3DFollowerNode))s(r._nodeBag.followers,n);else if(x3dom.isa(n,x3dom.nodeTypes.X3DTransformNode))s(r._nodeBag.trans,n);else if(x3dom.isa(n,x3dom.nodeTypes.RenderedTexture))s(r._nodeBag.renderTextures,n),n._cleanupGLObjects&&n._cleanupGLObjects();else if(x3dom.isa(n,x3dom.nodeTypes.X3DPointingDeviceSensorNode))s(r._nodeBag.affectedPointingSensors,n);else if(x3dom.isa(n,x3dom.nodeTypes.Texture))n.shutdown();else if(x3dom.isa(n,x3dom.nodeTypes.AudioClip))n.shutdown();else if(x3dom.isa(n,x3dom.nodeTypes.X3DBindableNode)){var l=n._stack;l&&(n.bind(!1),s(l._bindBag,n)),n._cleanupGLObjects&&n._cleanupGLObjects()}else x3dom.isa(n,x3dom.nodeTypes.Scene)&&n._webgl&&(n._webgl=null);!d||e.getAttribute("use")||e.getAttribute("USE")||d.removeNode(n._DEF),n._xmlNode=null,delete e._x3domNode}}var r=this,a={onAttrModified:function(e){if("_x3domNode"in e.target){e.target._x3domNode.updateField(e.attrName,e.newValue),r.needRender=!0}},onNodeRemoved:function(e){var t=e.target;if(t)if("_x3domNode"in t.parentNode&&"_x3domNode"in t){var i=t.parentNode._x3domNode,s=t._x3domNode;i&&s&&(i.removeChild(s),i.nodeChanged(),o(t),r._viewarea&&r._viewarea._scene&&(r._viewarea._scene.nodeChanged(),r._viewarea._scene.updateVolume(),r.needRender=!0))}else if(t.localName&&"ROUTE"==t.localName.toUpperCase()&&t._nodeNameSpace){var a=t._nodeNameSpace.defMap[t.getAttribute("fromNode")],n=t._nodeNameSpace.defMap[t.getAttribute("toNode")];a&&n&&a.removeRoute(t.getAttribute("fromField"),n,t.getAttribute("toField"))}else if(t.localName&&"X3D"==t.localName.toUpperCase()){var d=t.runtime;if(d&&d.canvas&&d.canvas.doc&&d.canvas.doc._scene){var l=d.canvas.doc._scene._xmlNode;o(l);for(var h=0;h<x3dom.canvases.length;h++)if(x3dom.canvases[h]===d.canvas){x3dom.canvases[h].doc.shutdown(x3dom.canvases[h].gl),x3dom.canvases.splice(h,1);break}d.canvas.doc._scene=null,d.canvas.doc._viewarea=null,d.canvas.doc=null,d.canvas=null,d=null,t.context=null,t.runtime=null}}},onNodeInserted:function(e){var t=e.target,i=t.parentNode;if("_x3domNode"in i)if(i.tagName&&"inline"==i.tagName.toLowerCase()||"multipart"==i.tagName.toLowerCase());else{var s=i._x3domNode;if(s&&s._nameSpace&&t instanceof Element){x3dom.caps.DOMNodeInsertedEvent_perSubtree&&o(t);var a=s._nameSpace.setupTree(t);s.addChild(a,t.getAttribute("containerField")),s.nodeChanged();var n=i.parentNode;n&&n._x3domNode&&n._x3domNode.nodeChanged(),r._viewarea&&r._viewarea._scene&&(r._viewarea._scene.nodeChanged(),r._viewarea._scene.updateVolume(),r.needRender=!0)}else x3dom.debug.logWarning("No _nameSpace in onNodeInserted")}}};e.addEventListener("DOMNodeRemoved",a.onNodeRemoved,!0),e.addEventListener("DOMNodeInserted",a.onNodeInserted,!0),x3dom.userAgentFeature.supportsDOMAttrModified===!0&&e.addEventListener("DOMAttrModified",a.onAttrModified,!0);var n=x3dom.findScene(e);this._bindableBag=new x3dom.BindableBag(this);var d=new x3dom.NodeNameSpace("scene",r),l=d.setupTree(n);this._scene=l,this._bindableBag.setRefNode(l),this._viewarea=new x3dom.Viewarea(this,l),this._viewarea._width=this.canvas.width,this._viewarea._height=this.canvas.height},x3dom.X3DDocument.prototype.advanceTime=function(e){var t=0;if(this._nodeBag.timer.length)for(t=0;t<this._nodeBag.timer.length;t++)this.needRender|=this._nodeBag.timer[t].tick(e);if(this._nodeBag.followers.length)for(t=0;t<this._nodeBag.followers.length;t++)this.needRender|=this._nodeBag.followers[t].tick(e);if(this._nodeBag.trans.length)for(t=0;t<this._nodeBag.trans.length;t++)this.needRender|=this._nodeBag.trans[t].tick(e);if(this._nodeBag.viewarea.length)for(t=0;t<this._nodeBag.viewarea.length;t++)this.needRender|=this._nodeBag.viewarea[t].tick(e)},x3dom.X3DDocument.prototype.render=function(e){e&&this._viewarea&&e.renderScene(this._viewarea)},x3dom.X3DDocument.prototype.onPick=function(e,t,i){e&&this._viewarea&&e.pickValue(this._viewarea,t,i,1)},x3dom.X3DDocument.prototype.onPickRect=function(e,t,i,s,o){return e&&this._viewarea?e.pickRect(this._viewarea,t,i,s,o):[]},x3dom.X3DDocument.prototype.onMove=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,i,s),this._viewarea.onMove(t,i,s))},x3dom.X3DDocument.prototype.onMoveView=function(e,t,i){e&&this._viewarea&&this._viewarea.onMoveView(t,i)},x3dom.X3DDocument.prototype.onDrag=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,i,s),this._viewarea.onDrag(t,i,s))},x3dom.X3DDocument.prototype.onWheel=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,s,0),this._viewarea.onDrag(t,i,2))},x3dom.X3DDocument.prototype.onMousePress=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene.updateVolume(),e.pickValue(this._viewarea,t,i,s),this._viewarea.onMousePress(t,i,s))},x3dom.X3DDocument.prototype.onMouseRelease=function(e,t,i,s,o){if(e&&this._viewarea){var r=o<<8|s;e.pickValue(this._viewarea,t,i,r),this._viewarea.onMouseRelease(t,i,s,o)}},x3dom.X3DDocument.prototype.onMouseOver=function(e,t,i,s){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,s),this._viewarea.onMouseOver(t,i,s))},x3dom.X3DDocument.prototype.onMouseOut=function(e,t,i,s){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,s),this._viewarea.onMouseOut(t,i,s))},x3dom.X3DDocument.prototype.onDoubleClick=function(e,t,i){e&&this._viewarea&&this._viewarea.onDoubleClick(t,i)},x3dom.X3DDocument.prototype.onKeyDown=function(e){switch(e){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}},x3dom.X3DDocument.prototype.onKeyUp=function(e){var t=null;switch(e){case 13:x3dom.toggleFullScreen();break;case 33:t=this._scene.getViewpoint()._stack,t?t.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:t=this._scene.getViewpoint()._stack,t?t.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 37:break;case 38:break;case 39:break;case 40:}},x3dom.X3DDocument.prototype.onKeyPress=function(e){var t=this._scene.getNavigationInfo(),i=this._scene.getEnvironment();switch(e){case 32:var s=this.canvas.parent.stateViewer;s&&s.display(),x3dom.debug.logInfo("a: show all | d: show helper buffers | s: small feature culling | t: light view | m: toggle render mode | c: frustum culling | p: intersect type | r: reset view | \ne: examine mode | f: fly mode | y: freefly mode | w: walk mode | h: helicopter mode | l: lookAt mode | o: lookaround | g: game mode | n: turntable | u: upright position | \nv: print viewpoint info | pageUp: next view | pageDown: prev. view | +: increase speed | -: decrease speed ");break;case 43:t._vf.speed=2*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 45:t._vf.speed=.5*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 51:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor+=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 52:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor-=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 54:t._vf.typeParams[1]+=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 55:t._vf.typeParams[1]-=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 56:t._vf.typeParams[0]-=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 57:t._vf.typeParams[0]+=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 97:this._viewarea.showAll();break;case 99:i._vf.frustumCulling=!i._vf.frustumCulling,x3dom.debug.logInfo("Viewfrustum culling "+(i._vf.frustumCulling?"on":"off"));break;case 100:void 0===this._viewarea._visDbgBuf&&(this._viewarea._visDbgBuf="true"===this._x3dElem.getAttribute("showLog")),this._viewarea._visDbgBuf=!this._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==this._viewarea._visDbgBuf?"block":"none";break;case 101:t.setType("examine",this._viewarea);break;case 102:t.setType("fly",this._viewarea);break;case 103:t.setType("game",this._viewarea);break;case 104:t.setType("helicopter",this._viewarea);break;case 105:this._viewarea.fit(this._scene._lastMin,this._scene._lastMax);break;case 108:t.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=++this._viewarea._points%2;break;case 110:t.setType("turntable",this._viewarea);break;case 111:t.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case"idbuf":this._scene._vf.pickMode="color";break;case"color":this._scene._vf.pickMode="texCoord";break;case"texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:i._vf.smallFeatureCulling=!i._vf.smallFeatureCulling,x3dom.debug.logInfo("Small feature culling "+(i._vf.smallFeatureCulling?"on":"off"));break;case 116:this._nodeBag.lights.length>0&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());break;case 117:this._viewarea.uprightView();break;case 118:var o=this;!function(){var e=o._viewarea._scene.getViewpoint(),t=o._viewarea.getViewMatrix().inverse(),i=new x3dom.fields.Quaternion(0,0,1,0);i.setValue(t);var s=i.toAxisAngle(),r=t.e3();x3dom.debug.logInfo('\n&lt;Viewpoint position="'+r.x.toFixed(5)+" "+r.y.toFixed(5)+" "+r.z.toFixed(5)+'" orientation="'+s[0].x.toFixed(5)+" "+s[0].y.toFixed(5)+" "+s[0].z.toFixed(5)+" "+s[1].toFixed(5)+'" \n\tzNear="'+e.getNear().toFixed(5)+'" zFar="'+e.getFar().toFixed(5)+'" description="'+e._vf.description+'"&gt;&lt;/Viewpoint&gt;')}();break;case 119:t.setType("walk",this._viewarea);break;case 121:t.setType("freefly",this._viewarea)}},x3dom.X3DDocument.prototype.shutdown=function(e){e&&e.shutdown(this._viewarea)},x3dom.MatrixMixer=function(e,t){0===arguments.length?(this._beginTime=0,this._endTime=1):(this._beginTime=e,this._endTime=t),this._beginMat=x3dom.fields.SFMatrix4f.identity(),this._beginInvMat=x3dom.fields.SFMatrix4f.identity(),this._beginLogMat=x3dom.fields.SFMatrix4f.identity(),this._endMat=x3dom.fields.SFMatrix4f.identity(),this._endLogMat=x3dom.fields.SFMatrix4f.identity(),this._beginRot=new x3dom.fields.Quaternion,this._endRot=new x3dom.fields.Quaternion,this._beginPos=new x3dom.fields.SFVec3f,this._endPos=new x3dom.fields.SFVec3f,this._result=x3dom.fields.SFMatrix4f.identity(),this._useQuaternion=!1},x3dom.MatrixMixer.prototype.calcFraction=function(e){var t=(e-this._beginTime)/(this._endTime-this._beginTime);return(Math.sin(t*Math.PI-Math.PI/2)+1)/2},x3dom.MatrixMixer.prototype._isValid=function(){var e=this._beginMat.inverse().mult(this._endMat).getEulerAngles();return Math.abs(e[0])!=Math.PI&&Math.abs(e[1])!=Math.PI&&Math.abs(e[2])!=Math.PI},x3dom.MatrixMixer.prototype._prepareQuaternionAnimation=function(){this._beginRot.setValue(this._beginMat),this._endRot.setValue(this._endMat),this._beginPos=this._beginMat.e3(),this._endPos=this._endMat.e3(),this._useQuaternion=!0},x3dom.MatrixMixer.prototype.setBeginMatrix=function(e){this._beginMat.setValues(e),this._beginInvMat=e.inverse(),this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()},x3dom.MatrixMixer.prototype.reset=function(){this._beginTime=0,this._endTime=0,this._useQuaternion=!1},x3dom.MatrixMixer.prototype.setEndMatrix=function(e){this._endMat.setValues(e),this._isValid()||this._prepareQuaternionAnimation(),this._endLogMat=this._endMat.mult(this._beginInvMat).log(),this._logDiffMat=this._endLogMat.addScaled(this._beginLogMat,-1)},x3dom.MatrixMixer.prototype.mixQuaternion=function(e){var t=this.calcFraction(e),i=this._beginRot.slerp(this._endRot,t),s=this._beginPos.addScaled(this._endPos.subtract(this._beginPos),t);return this._result.setRotate(i),this._result.setTranslate(s),this._result.copy()},x3dom.MatrixMixer.prototype.mixMatrix=function(e){var t=null;if(e<=this._beginTime)t=x3dom.fields.SFMatrix4f.copy(this._beginLogMat);else if(e>=this._endTime)t=x3dom.fields.SFMatrix4f.copy(this._endLogMat);else{var i=this.calcFraction(e);t=this._logDiffMat.multiply(i).add(this._beginLogMat)}return t.exp().mult(this._beginMat)},x3dom.MatrixMixer.prototype.mix=function(e){return this._useQuaternion?this.mixQuaternion(e):this.mixMatrix(e)},x3dom.InputTypes={NAVIGATION:1,INTERACTION:2},x3dom.Viewarea=function(e,t){this._doc=e,this._scene=t,e._nodeBag.viewarea.push(this),this._pickingInfo={pickPos:new x3dom.fields.SFVec3f(0,0,0),pickNorm:new x3dom.fields.SFVec3f(0,0,1),pickObj:null,firstObj:null,lastObj:null,lastClickObj:null,shadowObjectId:-1},this._currentInputType=x3dom.InputTypes.NAVIGATION,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,this._deltaT=0,this._flyMat=null,this._pitch=0,this._yaw=0,this._eyePos=new x3dom.fields.SFVec3f(0,0,0),this._width=400,this._height=300,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._points=0,this._numRenderedNodes=0,this._pick=new x3dom.fields.SFVec3f(0,0,0),this._pickNorm=new x3dom.fields.SFVec3f(0,0,1),this._isAnimating=!1,this._isMoving=!1,this._lastTS=0,this._mixer=new x3dom.MatrixMixer,this.arc=null},x3dom.Viewarea.prototype.tick=function(e){var t=!1,i=this._scene.getEnvironment();if(i._vf.enableARC&&null==this.arc&&(this.arc=new x3dom.arc.AdaptiveRenderControl(this._scene)),this._mixer._beginTime>0)if(t=!0,e>=this._mixer._beginTime)if(e<=this._mixer._endTime){var s=this._mixer.mix(e);this._scene.getViewpoint().setView(s)}else this._mixer.reset(),this._scene.getViewpoint().setView(this._mixer._endMat);else this._mixer.reset(),this._scene.getViewpoint().setView(this._mixer._beginMat);var o=this.navigateTo(e),r=this._isAnimating;return this._lastTS=e,this._isAnimating=t||o,null!=this.arc&&this.arc.update(this.isMovingOrAnimating()?1:0,this._doc._x3dElem.runtime.getFPS()),this._isAnimating||r},x3dom.Viewarea.prototype.isMoving=function(){return this._isMoving},x3dom.Viewarea.prototype.isAnimating=function(){return this._isAnimating},x3dom.Viewarea.prototype.isMovingOrAnimating=function(){return this._isMoving||this._isAnimating},x3dom.Viewarea.prototype.navigateTo=function(e){var t=this._scene.getNavigationInfo(),i=t.getType(),s=null,o=this._currentInputType==x3dom.InputTypes.NAVIGATION&&("game"===i||this._lastButton>0&&(i.indexOf("fly")>=0||"walk"===i||"helicopter"===i||"looka"===i.substr(0,5)));this._deltaT=e-this._lastTS;var r=function(e,t){return e>0?e<=t?0:e-t:e<=0?e>=-t?0:e+t:void 0},a=function(e,t){return(t<0?-1:1)*Math.pow(e*Math.abs(t),1.65)};if(o){null!==this._pickingInfo.pickObj&&(s={pickPos:this._pickingInfo.pickPos,pickNorm:this._pickingInfo.pickNorm,pickObj:this._pickingInfo.pickObj,firstObj:this._pickingInfo.firstObj,lastObj:this._pickingInfo.lastObj,lastClickObj:this._pickingInfo.lastClickObj,shadowObjectId:this._pickingInfo.shadowObjectId});var n=.25,d=1.6,l=.75;t._vf.avatarSize.length>2&&(n=t._vf.avatarSize[0],d=t._vf.avatarSize[1],l=t._vf.avatarSize[2]);var h=this.getViewMatrix(),u=0,f=Math.min(this._width,this._height),c=r((this._pressX-this._lastX)/f,.01),_=r((this._pressY-this._lastY)/f,.01),m=a(1,c),p=a(1,_),x=2&this._lastButton?-1:1;x*=this._deltaT*t._vf.speed;var g=(this._deltaT*t._vf.speed*m,this._deltaT*t._vf.speed*p),v=Math.PI*this._deltaT*m,y=Math.PI*this._deltaT*p;if(this._needNavigationMatrixUpdate===!0){this._needNavigationMatrixUpdate=!1,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0);var b=0,T=Math.asin(h._02),S=Math.cos(T);Math.abs(S)>1e-4&&(b=Math.atan2(-h._12/S,h._22/S)),this._flyMat=h.inverse(),this._from=this._flyMat.e3(),this._at=this._from.subtract(this._flyMat.e2()),"helicopter"===i&&(this._at.y=this._from.y),this._up=this._flyMat.e1(),this._pitch=180*b/Math.PI,this._yaw=180*T/Math.PI,this._eyePos=this._from.negate()}var M,C,F,E,w,A,N=null,R=null,I=null;if("game"===i){this._pitch+=this._dy,this._yaw+=this._dx,this._pitch>=89&&(this._pitch=89),this._pitch<=-89&&(this._pitch=-89),this._yaw>=360&&(this._yaw-=360),this._yaw<0&&(this._yaw=360+this._yaw),this._dx=0,this._dy=0;var P=x3dom.fields.SFMatrix4f.rotationX(this._pitch/180*Math.PI),D=x3dom.fields.SFMatrix4f.rotationY(this._yaw/180*Math.PI),V=x3dom.fields.SFMatrix4f.translation(this._eyePos);this._flyMat=P.mult(D).mult(V);var L=this._flyMat.inverse(),O=L.e3();return R=new x3dom.fields.SFVec3f(0,(-1),0),N=O.add(R),R=L.e0().cross(R).normalize(),I=x3dom.fields.SFMatrix4f.lookAt(O,N,R),I=I.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,this.getProjectionMatrix().mult(I)),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(O).length(),O.y+=d-u,L.setTranslate(O),this._eyePos=L.e3().negate(),this._flyMat=L.inverse(),this._pickingInfo.pickObj=null),this._scene.getViewpoint().setView(this._flyMat),o}if("helicopter"===i){var B=t.getTypeParams();if(2&this._lastButton){var k=200*g;B[1]+=k,t.setTypeParams(B)}x=1&this._lastButton?300*g:0,y=B[0],this._from.y=B[1],this._at.y=this._from.y,M=x3dom.fields.Quaternion.axisAngle(this._up,v),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),E=this._at.subtract(this._from).normalize(),w=E.cross(this._up).normalize(),A=w.cross(E).normalize(),E=E.multiply(x),this._from=this._from.add(E),this._at=this._at.add(E),M=x3dom.fields.Quaternion.axisAngle(w,y),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C);var G=F.multMatrixPnt(this._at);return this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,G,A),this._scene.getViewpoint().setView(this._flyMat.inverse()),o}if(M=x3dom.fields.Quaternion.axisAngle(this._up,v),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),E=this._at.subtract(this._from).normalize(),w=E.cross(this._up).normalize(),A=w.cross(E).normalize(),M=x3dom.fields.Quaternion.axisAngle(w,y),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),"looka"!==i.substr(0,5)){var U=this.getProjectionMatrix();"freefly"!==i&&(x<0?(I=new x3dom.fields.SFMatrix4f,I.setValue(this._last_mat_view.e0(),this._last_mat_view.e1(),this._last_mat_view.e2().negate(),this._last_mat_view.e3()),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,U.mult(I))):this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(this._from).length(),u<=n&&(x=0))),E=this._at.subtract(this._from).normalize().multiply(x),this._at=this._at.add(E),this._from=this._from.add(E),"walk"===i&&(N=this._from.addScaled(A,-1),R=w.cross(A.negate()).normalize(),I=x3dom.fields.SFMatrix4f.lookAt(this._from,N,R),I=I.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,U.mult(I)),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(this._from).length(),this._at=this._at.add(A.multiply(d-u)),this._from=this._from.add(A.multiply(d-u)))),this._pickingInfo.pickObj=null}this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,A),this._scene.getViewpoint().setView(this._flyMat.inverse()),null!==s&&(this._pickingInfo=s)}return o},x3dom.Viewarea.prototype.moveFwd=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=.25,i=1.6;e._vf.avatarSize.length>2&&(t=e._vf.avatarSize[0],i=e._vf.avatarSize[1]);var s=5*this._deltaT*e._vf.speed,o=this._yaw/180*Math.PI,r=this._pitch/180*Math.PI,a=0,n=this._flyMat.inverse();this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(a=this._pickingInfo.pickPos.subtract(n.e3()).length(),a<=2*t||(this._eyePos.x-=Math.sin(o)*s,this._eyePos.z+=Math.cos(o)*s,this._eyePos.y+=Math.sin(r)*s))}},x3dom.Viewarea.prototype.moveBwd=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI,s=this._pitch/180*Math.PI;this._eyePos.x+=Math.sin(i)*t,this._eyePos.z-=Math.cos(i)*t,this._eyePos.y-=Math.sin(s)*t}},x3dom.Viewarea.prototype.strafeRight=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x-=Math.cos(i)*t,this._eyePos.z-=Math.sin(i)*t}},x3dom.Viewarea.prototype.strafeLeft=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x+=Math.cos(i)*t,this._eyePos.z+=Math.sin(i)*t}},x3dom.Viewarea.prototype.animateTo=function(e,t,i){var s=this._scene.getNavigationInfo();x3dom.isa(e,x3dom.nodeTypes.X3DViewpointNode)&&(e=e.getViewMatrix().mult(e.getCurrentTransform().inverse())),"teleport"!==s._vf.transitionType[0].toLowerCase()&&0!=i&&"game"!==s.getType()&&t&&x3dom.isa(t,x3dom.nodeTypes.X3DViewpointNode)?(t=t.getViewMatrix().mult(t.getCurrentTransform().inverse()).mult(this._transMat).mult(this._rotMat),this._mixer._beginTime=this._lastTS,arguments.length>=3?this._mixer._endTime=this._lastTS+i:this._mixer._endTime=this._lastTS+s._vf.transitionTime,this._mixer.setBeginMatrix(t),this._mixer.setEndMatrix(e),this._scene.getViewpoint().setView(t)):this._scene.getViewpoint().setView(e),this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.getLights=function(){for(var e=[],t=0;t<this._doc._nodeBag.lights.length;t++)1==this._doc._nodeBag.lights[t]._vf.on&&e.push(this._doc._nodeBag.lights[t]);return e},x3dom.Viewarea.prototype.getLightsShadow=function(){for(var e=this._doc._nodeBag.lights,t=0;t<e.length;t++)if(e[t]._vf.shadowIntensity>0)return!0;return!1},x3dom.Viewarea.prototype.updateSpecialNavigation=function(e,t){var i=this._scene.getNavigationInfo(),s=i.getType();if("helicopter"==s&&!i._heliUpdated){var o=i.getTypeParams(),r=o[0],a=e.getViewMatrix().mult(t.inverse()).inverse();this._from=a.e3(),this._at=this._from.subtract(a.e2()),this._up=new x3dom.fields.SFVec3f(0,1,0),this._from.y=o[1],this._at.y=this._from.y;var n=a.e0(),d=x3dom.fields.Quaternion.axisAngle(n,r),l=d.toMatrix(),h=x3dom.fields.SFMatrix4f.translation(this._from);h=h.mult(l),l=x3dom.fields.SFMatrix4f.translation(this._from.negate()),h=h.mult(l),this._at=h.multMatrixPnt(this._at),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._scene.getViewpoint().setView(this._flyMat.inverse()),i._heliUpdated=!0}},x3dom.Viewarea.prototype.getViewpointMatrix=function(){var e=this._scene.getViewpoint(),t=e.getCurrentTransform();return this.updateSpecialNavigation(e,t),e.getViewMatrix().mult(t.inverse())},x3dom.Viewarea.prototype.getViewMatrix=function(){return this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)},x3dom.Viewarea.prototype.getLightMatrix=function(){var e,t=this._doc._nodeBag.lights,i=t.length;if(i>0){var s=this._scene.getVolume();if(s.isValid()){var o=x3dom.fields.SFVec3f.MAX(),r=x3dom.fields.SFVec3f.MIN();s.getBounds(o,r);var a=[],n=this._scene.getViewpoint(),d=n.getFieldOfView(),l=r.subtract(o),h=l.y/2/Math.tan(d/2)+l.z/2,u=l.x/2/Math.tan(d/2)+l.z/2;for(l=o.add(l.multiply(.5)),e=0;e<i;e++){if(x3dom.isa(t[e],x3dom.nodeTypes.PointLight)){var f=t[e].getCurrentTransform().multMatrixPnt(t[e]._vf.location);l=l.subtract(f).normalize()}else{var c=t[e].getCurrentTransform().multMatrixVec(t[e]._vf.direction);c=c.normalize().negate(),l=l.add(c.multiply(1.2*(h>u?h:u)))}a[e]=t[e].getViewMatrix(l)}return a}}return[this.getViewMatrix()]},x3dom.Viewarea.prototype.getWCtoLCMatrix=function(e){var t,i=this.getProjectionMatrix();return t=0===arguments.length?this.getLightMatrix()[0]:e,i.mult(t)},x3dom.Viewarea.prototype.getWCtoLCMatricesPointLight=function(e,t,i){var s=t._vf.zNear,o=t._vf.zFar,r=this.getLightProjectionMatrix(e,s,o,!1,i);r._00=1,r._11=1;var a=[];a[0]=r.mult(e);for(var n,d=1;d<=3;d++)n=x3dom.fields.SFMatrix4f.rotationY(d*Math.PI/2),a[d]=r.mult(n.mult(e));return n=x3dom.fields.SFMatrix4f.rotationX(Math.PI/2),a[4]=r.mult(n.mult(e)),n=x3dom.fields.SFMatrix4f.rotationX(3*Math.PI/2),a[5]=r.mult(n.mult(e)),a},x3dom.Viewarea.prototype.getWCtoLCMatricesCascaded=function(e,t,i){var s=Math.max(1,Math.min(t._vf.shadowCascades,6)),o=Math.max(0,Math.min(t._vf.shadowSplitFactor,1)),r=Math.max(0,Math.min(t._vf.shadowSplitOffset,1)),a=x3dom.isa(t,x3dom.nodeTypes.SpotLight),n=t._vf.zNear,d=t._vf.zFar,l=this.getLightProjectionMatrix(e,n,d,!0,i);a&&(l._00=1,l._11=1);var h=l.mult(e),u=[];if(1==s)return u[0]=h,u;for(var f=this.getShadowSplitDepths(s,o,r,!0,i),c=0;c<s;c++){var _=this.getLightFittingMatrix(h,f[c],f[c+1],i);u[c]=_.mult(h)}return u},x3dom.Viewarea.prototype.getLightProjectionMatrix=function(e,t,i,s,o){var r=x3dom.fields.SFMatrix4f.copy(o);if(!s||t>0||i>0){var a,n,d=e.inverse().e3(),l=.8,h=1.2,u=x3dom.fields.SFVec3f.copy(this._scene._lastMin),f=x3dom.fields.SFVec3f.copy(this._scene._lastMax),c=f.subtract(u),_=c.length()/2,m=u.add(c.multiply(.5)),p=d.subtract(m).length();return _&&(a=p>_?(p-_)*l:1,n=(p+_)*h),t>0&&(a=t),i>0&&(n=i),r._22=-(n+a)/(n-a),r._23=-2*n*a/(n-a),r}var x=this.getLightCropMatrix(r.mult(e));return x.mult(r)},x3dom.Viewarea.prototype.getProjectionMatrix=function(){var e=this._scene.getViewpoint();return e.getProjectionMatrix(this._width/this._height)},x3dom.Viewarea.prototype.getViewfrustum=function(e){var t=this._scene.getEnvironment();if(1==t._vf.frustumCulling){if(0==arguments.length){var i=this.getProjectionMatrix(),s=this.getViewMatrix();return new x3dom.fields.FrustumVolume(i.mult(s))}return new x3dom.fields.FrustumVolume(e)}return null},x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){var e=this.getWCtoCCMatrix();return e.inverse()},x3dom.Viewarea.prototype.calcViewRay=function(e,t,i){var s=i?i:this.getCCtoWCMatrix(),o=e/(this._width-1)*2-1,r=(this._height-1-t)/(this._height-1)*2-1,a=s.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,r,(-1))),n=s.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,r,1)),d=n.subtract(a);return new x3dom.fields.Ray(a,d)},x3dom.Viewarea.prototype.showAll=function(e){void 0===e&&(e="negZ");var t=this._scene;t.updateVolume();var i,s=x3dom.fields.SFVec3f.copy(t._lastMin),o=x3dom.fields.SFVec3f.copy(t._lastMax),r="x",a="y",n="z",d=1,l=new x3dom.fields.SFVec3f(0,0,(-1));switch(e){case"posX":d=-1;case"negX":n="x",r="y",a="z",i=new x3dom.fields.SFVec3f(d,0,0);break;case"posY":d=-1;case"negY":n="y",r="z",a="x",i=new x3dom.fields.SFVec3f(0,d,0);break;case"posZ":d=-1;case"negZ":default:i=new x3dom.fields.SFVec3f(0,0,(-d))}var h=t.getViewpoint(),u=h.getFieldOfView(),f=o.subtract(s),c=f[n]/2,_=Math.tan(u/2),m=f[a]/2/_+c,p=f[r]/2/_+c;f=s.add(f.multiply(.5)),f[n]+=d*(m>p?m:p)*1.01;var x=x3dom.fields.Quaternion.rotateFromTo(l,i),g=x.toMatrix();g=g.mult(x3dom.fields.SFMatrix4f.translation(f.negate())),this.animateTo(g,h)},x3dom.Viewarea.prototype.fit=function(e,t,i){void 0===i&&(i=!0);var s=t.subtract(e).multiply(.5),o=e.add(s),r=s.length(),a=this._scene.getViewpoint(),n=a.getFieldOfView(),d=x3dom.fields.SFMatrix4f.copy(this.getViewMatrix()),l=new x3dom.fields.SFVec3f(d._00,d._01,d._02),h=new x3dom.fields.SFVec3f(d._10,d._11,d._12),u=new x3dom.fields.SFVec3f(d._20,d._21,d._22),f=Math.tan(n/2),c=r/f,_=o.add(u.multiply(c));d._03=-l.dot(_),d._13=-h.dot(_),d._23=-u.dot(_),i&&a.setCenterOfRotation(o),x3dom.isa(a,x3dom.nodeTypes.OrthoViewpoint)?(a._vf.fieldOfView[0]=-c,
a._vf.fieldOfView[1]=-c,a._vf.fieldOfView[2]=c,a._vf.fieldOfView[3]=c,a._projMatrix=null,this.animateTo(d,a,0)):this.animateTo(d,a)},x3dom.Viewarea.prototype.resetView=function(){var e=this._scene.getNavigationInfo();if("teleport"!==e._vf.transitionType[0].toLowerCase()&&"game"!==e.getType()){this._mixer._beginTime=this._lastTS,this._mixer._endTime=this._lastTS+e._vf.transitionTime,this._mixer.setBeginMatrix(this.getViewMatrix());var t=this._scene.getViewpoint();t.resetView(),t=t.getViewMatrix().mult(t.getCurrentTransform().inverse()),this._mixer.setEndMatrix(t)}else this._scene.getViewpoint().resetView();this.resetNavHelpers(),e._heliUpdated=!1},x3dom.Viewarea.prototype.resetNavHelpers=function(){this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.uprightView=function(){var e=this.getViewMatrix().inverse(),t=e.e3(),i=t.subtract(e.e2()),s=new x3dom.fields.SFVec3f(0,1,0),o=e.e2().cross(s).normalize(),r=o.cross(s).normalize();i=t.add(r),e=x3dom.fields.SFMatrix4f.lookAt(t,i,s),e=e.inverse(),this.animateTo(e,this._scene.getViewpoint())},x3dom.Viewarea.prototype.callEvtHandler=function(e,t,i){if(!e||!e._xmlNode)return null;try{var s=e._xmlNode[t];if("function"==typeof s)s.call(e._xmlNode,i);else{var o=e._xmlNode.getAttribute(t),r=new Function("event",o);r.call(e._xmlNode,i)}var a=e._listeners[i.type];if(a)for(var n=0;n<a.length;n++)a[n].call(e._xmlNode,i)}catch(d){x3dom.debug.logException(d)}return i.cancelBubble},x3dom.Viewarea.prototype.checkEvents=function(e,t,i,s,o){var r,a,n,d=this,l=!0,h=e&&e._xmlNode?e._xmlNode:{},u=this._doc._nodeBag.affectedPointingSensors,f={viewarea:d,target:h,type:o.substr(2,o.length-2),button:s,layerX:t,layerY:i,worldX:d._pick.x,worldY:d._pick.y,worldZ:d._pick.z,normalX:d._pickNorm.x,normalY:d._pickNorm.y,normalZ:d._pickNorm.z,hitPnt:d._pick.toGL(),hitObject:h,shadowObjectId:d._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};try{var c=e;c&&c._xmlNode&&c._cf.geometry&&!c._xmlNode[o]&&!c._xmlNode.hasAttribute(o)&&!c._listeners[f.type]&&(c=c._cf.geometry.node),c&&d.callEvtHandler(c,o,f)===!0&&(l=!1)}catch(_){x3dom.debug.logException(_)}var m=function(e){Array.forEach(e._parentNodes,function(e){if(e._xmlNode&&(e._xmlNode[o]||e._xmlNode.hasAttribute(o)||e._listeners[f.type])&&d.callEvtHandler(e,o,f)===!0&&(l=!1),0==s&&0==u.length&&("onmousemove"==o||"onmouseover"==o||"onmouseout"==o))for(n=e._childNodes.length,a=0;a<n;++a)r=e._childNodes[a],x3dom.isa(r,x3dom.nodeTypes.X3DPointingDeviceSensorNode)&&r._vf.enabled&&u.push(r);x3dom.isa(e,x3dom.nodeTypes.Anchor)&&"onclick"===o?(e.handleTouch(),l=!1):l&&m(e)})};return l&&e&&m(e),l},x3dom.Viewarea.prototype._notifyAffectedPointingSensors=function(e){var t,i={mousedown:"pointerPressedOverSibling",mousemove:"pointerMoved",mouseover:"pointerMovedOver",mouseout:"pointerMovedOut"},s=i[e.type],o=this._doc._nodeBag.affectedPointingSensors,r=o.length;if(r>0&&void 0!==s)for(t=0;t<r;t++)o[t][s](e)},x3dom.Viewarea.prototype.initMouseState=function(){this._deltaT=0,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._isMoving=!1,this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.initTurnTable=function(e,t){t=void 0==t||t;var i=this.getViewMatrix(),s=this._scene.getViewpoint(),o=x3dom.fields.SFVec3f.copy(s.getCenterOfRotation());this._flyMat=i.inverse(),this._from=this._flyMat.e3(),this._at=o,this._up=this._flyMat.e1(),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._flyMat=this.calcOrbit(0,0,e);var r=0;t&&(r=.2/e._vf.speed),this.animateTo(this._flyMat.inverse(),s,r),this.resetNavHelpers()},x3dom.Viewarea.prototype.onMousePress=function(e,t,i){if(this._needNavigationMatrixUpdate=!0,this.prepareEvents(e,t,i,"onmousedown"),this._pickingInfo.lastClickObj=this._pickingInfo.pickObj,this._pickingInfo.firstObj=this._pickingInfo.pickObj,this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._pressX=e,this._pressY=t,this._lastButton=i,this._isMoving=!1,this._currentInputType==x3dom.InputTypes.NAVIGATION){var s=this._scene.getNavigationInfo();"turntable"===s.getType()&&this.initTurnTable(s,!1)}},x3dom.Viewarea.prototype.onMouseRelease=function(e,t,i,s){var o,r=this._doc._nodeBag.affectedPointingSensors;for(o=0;o<r.length;++o)r[o].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[];var a,n=3,d=this._scene.getNavigationInfo(),l=d.getType();if("box"!==this._scene._vf.pickMode.toLowerCase()){if(this.prepareEvents(e,t,s,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj)this.prepareEvents(e,t,s,"onclick");else if(!this._pickingInfo.pickObj&&!this._pickingInfo.lastClickObj&&!this._pickingInfo.firstObj){var h="backgroundClicked";try{if(this._scene._xmlNode&&(this._scene._xmlNode["on"+h]||this._scene._xmlNode.hasAttribute("on"+h)||this._scene._listeners[h])){var u={target:this._scene._xmlNode,type:h,button:s,layerX:e,layerY:t,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._scene.callEvtHandler("on"+h,u)}}catch(f){x3dom.debug.logException("backgroundClicked: "+f)}}}else{var c=(new Date).getTime(),_=this.calcViewRay(e,t),m=this._scene.doIntersect(_),p=_.hitObject;m&&p&&(this._pick.setValues(_.hitPoint),this.checkEvents(p,e,t,i,"onclick"),x3dom.debug.logInfo("Hit '"+p._xmlNode.localName+"/ "+p._DEF+"' at dist="+_.dist.toFixed(4)),x3dom.debug.logInfo("Ray hit at position "+this._pick));var x=(new Date).getTime()-c;if(x3dom.debug.logInfo("Picking time (box): "+x+"ms"),!m){a=this.getViewMatrix().e2().negate();var g=a.dot(_.pos.negate())/a.dot(_.dir);this._pick=_.pos.add(_.dir.multiply(g))}}if(this._pickingInfo.firstObj=null,this._currentInputType==x3dom.InputTypes.NAVIGATION&&(this._pickingInfo.pickObj||this._pickingInfo.shadowObjectId>=0)&&"lookat"===l&&this._pressX===e&&this._pressY===t){var v=2&this._lastButton?-1:1,y=this._pickingInfo.pickPos.subtract(this._from).length()/n,b=new x3dom.fields.SFMatrix4f;b.setValues(this.getViewMatrix()),b=b.inverse();var T=b.e3(),S=(T.subtract(b.e2()),b.e1());a=this._pickingInfo.pickPos.subtract(T);var M=a.length();a=a.normalize();var C=T.addScaled(a,M),F=a.cross(S).normalize();a=F.cross(S).normalize(),v<0&&(y=2*(.5+M+y));var E=C.addScaled(a,y);b=x3dom.fields.SFMatrix4f.lookAt(E,C,S),b=b.inverse(),y=E.subtract(T).length();var w=Math.max(.5,Math.log((1+y)/d._vf.speed));this.animateTo(b,this._scene.getViewpoint(),w)}this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._lastButton=i,this._isMoving=!1},x3dom.Viewarea.prototype.onMouseOver=function(e,t,i){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0},x3dom.Viewarea.prototype.onMouseOut=function(e,t,i){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0;var s,o=this._doc._nodeBag.affectedPointingSensors;for(s=0;s<o.length;++s)o[s].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[]},x3dom.Viewarea.prototype.onDoubleClick=function(e,t){if(!this._doc._x3dElem.hasAttribute("disableDoubleClick")||"true"!==this._doc._x3dElem.getAttribute("disableDoubleClick")){var i=this._scene.getNavigationInfo();if("none"!=i.getType()){var s=this._scene._vf.pickMode.toLowerCase();if("color"!=s&&"texcoord"!=s){var o=this._scene.getViewpoint();o.setCenterOfRotation(this._pick),x3dom.debug.logInfo("New center of Rotation:  "+this._pick);var r=this.getViewMatrix().inverse(),a=r.e3(),n=this._pick,d=r.e1(),l=r.e0().cross(d).normalize(),h=l.dot(this._pick.subtract(a));a=n.addScaled(l,-h),r=x3dom.fields.SFMatrix4f.lookAt(a,n,d),x3dom.debug.logInfo("New camera position:  "+a),this.animateTo(r.inverse(),o)}}}},x3dom.Viewarea.prototype.handleMoveEvt=function(e,t,i){if(0==i&&(this._doc._nodeBag.affectedPointingSensors=[]),this.prepareEvents(e,t,i,"onmousemove"),this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var s=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj,this.prepareEvents(e,t,i,"onmouseout"),this._pickingInfo.pickObj=s}this._pickingInfo.pickObj&&this.prepareEvents(e,t,i,"onmouseover"),this._pickingInfo.lastObj=this._pickingInfo.pickObj}},x3dom.Viewarea.prototype.onMove=function(e,t,i){this.handleMoveEvt(e,t,i),(this._lastX<0||this._lastY<0)&&(this._lastX=e,this._lastY=t),this._dx=e-this._lastX,this._dy=t-this._lastY,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.onMoveView=function(e,t){if(this._currentInputType==x3dom.InputTypes.NAVIGATION){var i=this._scene.getNavigationInfo(),s=this._scene.getViewpoint();if("examine"===i.getType()){if(e){var o=this._scene._lastMax.subtract(this._scene._lastMin).length();o=(o<x3dom.fields.Eps?1:o)*i._vf.speed,e=e.multiply(o),this._movement=this._movement.add(e),this._transMat=s.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(s.getViewMatrix())}if(t){var r=s.getCenterOfRotation(),a=this.getViewMatrix();a.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(r)).mult(a.inverse()).mult(t).mult(a).mult(x3dom.fields.SFMatrix4f.translation(r.negate()))}this._isMoving=!0}}},x3dom.Viewarea.prototype.onDrag=function(e,t,i){if(this.handleMoveEvt(e,t,i),this._currentInputType==x3dom.InputTypes.NAVIGATION){var s=this._scene.getNavigationInfo(),o=s.getType(),r=s.getExplorationMode();if("none"===o||0==r)return;var a,n,d,l,h,u=this._scene.getViewpoint(),f=e-this._lastX,c=t-this._lastY,_=null;if(i=!r||7!=r&&1==i?r:i,"examine"===o){if(1&i){l=2*c*Math.PI/this._width,h=2*f*Math.PI/this._height,_=this.getViewMatrix();var m=x3dom.fields.SFMatrix4f.rotationX(l),p=x3dom.fields.SFMatrix4f.rotationY(h),x=u.getCenterOfRotation();_.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(x)).mult(_.inverse()).mult(m).mult(p).mult(_).mult(x3dom.fields.SFMatrix4f.translation(x.negate()))}if(4&i&&(a=this._scene._lastMax.subtract(this._scene._lastMin).length(),a=(a<x3dom.fields.Eps?1:a)*s._vf.speed,n=new x3dom.fields.SFVec3f(a*f/this._width,a*-c/this._height,0),this._movement=this._movement.add(n),_=this.getViewpointMatrix().mult(this._transMat),this._transMat=_.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(_)),2&i)if(a=this._scene._lastMax.subtract(this._scene._lastMin).length(),a=(a<x3dom.fields.Eps?1:a)*s._vf.speed,n=new x3dom.fields.SFVec3f(0,0,a*(f+c)/this._height),x3dom.isa(u,x3dom.nodeTypes.OrthoViewpoint))u._vf.fieldOfView[0]+=n.z,u._vf.fieldOfView[1]+=n.z,u._vf.fieldOfView[2]-=n.z,u._vf.fieldOfView[3]-=n.z,u._projMatrix=null;else{if(s._vf.typeParams.length>=6){var g=-s._vf.typeParams[5],v=s._vf.typeParams[4];this._movement.z=Math.min(Math.max(this._movement.z,g),v)}this._movement=this._movement.add(n),_=this.getViewpointMatrix().mult(this._transMat),this._transMat=_.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(_)}this._isMoving=!0}else if("turntable"===o){if(this._flyMat||this.initTurnTable(s,!1),1&i)l=2*c*Math.PI/this._height,h=2*f*Math.PI/this._width,this._flyMat=this.calcOrbit(l,h,s),u.setView(this._flyMat.inverse());else if(2&i){a=this._scene._lastMax.subtract(this._scene._lastMin).length(),a=(a<x3dom.fields.Eps?1:a)*s._vf.speed,this._up=this._flyMat.e1(),this._from=this._flyMat.e3(),d=u.getCenterOfRotation();var y=d.subtract(this._from),b=y.length();y=y.normalize();var T=a*(f+c)/this._height;if(s._vf.typeParams.length>=5&&s._vf.typeParams[4]>0){var S=Math.min(T,b-s._vf.typeParams[4]);this._from=this._from.addScaled(y,S)}else{var M=T-b+.01;M>=0&&(d=d.addScaled(y,M),u.setCenterOfRotation(d)),this._from=this._from.addScaled(y,T)}this._from=this._from.addScaled(y,T),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,d,this._up),u.setView(this._flyMat.inverse())}else if(4&i){a=this._scene._lastMax.subtract(this._scene._lastMin).length(),a=(a<x3dom.fields.Eps?1:a)*s._vf.speed*.75;var C=-a*f/this._width,F=a*c/this._height;this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var E=this._flyMat.e0();this._from=this._from.addScaled(this._up,F),this._from=this._from.addScaled(E,C),d=u.getCenterOfRotation(),d=d.addScaled(this._up,F),d=d.addScaled(E,C),u.setCenterOfRotation(d),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,d,this._up),u.setView(this._flyMat.inverse())}this._isMoving=!0}}this._dx=f,this._dy=c,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.calcOrbit=function(e,t,i){this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var s=this._from.subtract(this._at),o=Math.atan2(s.x,s.z),r=Math.atan2(Math.sqrt(s.x*s.x+s.z*s.z),s.y);o-=t,r-=e;var a=i.getTypeParams();r=Math.max(a[2],Math.min(a[3],r));var n=s.length(),d=n*Math.sin(r);s.x=d*Math.sin(o),s.y=n*Math.cos(r),s.z=d*Math.cos(o),s=this._at.add(s),r-=Math.PI/2;var l=Math.sin(r),h=Math.cos(r),u=new x3dom.fields.SFVec3f(l*Math.sin(o),h,l*Math.cos(o));return u.y<0&&(u=u.negate()),x3dom.fields.SFMatrix4f.lookAt(s,this._at,u)},x3dom.Viewarea.prototype.prepareEvents=function(e,t,i,s){var o=this._doc._nodeBag.affectedPointingSensors,r=this._scene._vf.pickMode.toLowerCase(),a=0==r.indexOf("idbuf")||"color"==r||"texcoord"==r,n=null;a&&(n=this._pickingInfo.pickObj,n&&(this._pick.setValues(this._pickingInfo.pickPos),this._pickNorm.setValues(this._pickingInfo.pickNorm),this.checkEvents(n,e,t,i,s),"onclick"===s&&(n._xmlNode&&x3dom.debug.logInfo('Hit "'+n._xmlNode.localName+"/ "+n._DEF+'"'),x3dom.debug.logInfo("Ray hit at position "+this._pick))));var d={viewarea:this,target:{},type:s.substr(2,s.length-2),button:i,layerX:e,layerY:t,worldX:this._pick.x,worldY:this._pick.y,worldZ:this._pick.z,normalX:this._pickNorm.x,normalY:this._pickNorm.y,normalZ:this._pickNorm.z,hitPnt:this._pick.toGL(),hitObject:n&&n._xmlNode?n._xmlNode:null,shadowObjectId:this._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._notifyAffectedPointingSensors(d),o.length>0?this._currentInputType=x3dom.InputTypes.INTERACTION:this._currentInputType=x3dom.InputTypes.NAVIGATION},x3dom.Viewarea.prototype.getRenderMode=function(){return this._points},x3dom.Viewarea.prototype.getShadowedLights=function(){for(var e=[],t=0,i=this.getLights(),s=0;s<i.length;s++)i[s]._vf.shadowIntensity>0&&(e[t]=i[s],t++);return e},x3dom.Viewarea.prototype.getShadowSplitDepths=function(e,t,i,s,o){var r,a=[],n=this._scene.getViewpoint(),d=n.getNear(),l=n.getFar();a[0]=d,d+=i*(l-d)/10;for(var h=1;h<e;h++)r=d*Math.pow(l/d,h/e),a[h]=t*r+(1-t)*(d+h/(e*(d-l)));if(a[e]=l,!s)return a;for(var u=[],f=0;f<=e;f++)u[f]=o.multFullMatrixPnt(new x3dom.fields.SFVec3f(0,0,(-a[f]))).z;return u},x3dom.Viewarea.prototype.getLightCropMatrix=function(e){var t=x3dom.fields.SFVec3f.copy(this._scene._lastMin),i=x3dom.fields.SFVec3f.copy(this._scene._lastMax),s=[];s[0]=new x3dom.fields.SFVec3f(t.x,t.y,t.z),s[1]=new x3dom.fields.SFVec3f(t.x,t.y,i.z),s[2]=new x3dom.fields.SFVec3f(t.x,i.y,t.z),s[3]=new x3dom.fields.SFVec3f(t.x,i.y,i.z),s[4]=new x3dom.fields.SFVec3f(i.x,t.y,t.z),s[5]=new x3dom.fields.SFVec3f(i.x,t.y,i.z),s[6]=new x3dom.fields.SFVec3f(i.x,i.y,t.z),s[7]=new x3dom.fields.SFVec3f(i.x,i.y,i.z);var o;for(o=0;o<8;o++)s[o]=e.multFullMatrixPnt(s[o]);var r=x3dom.fields.SFVec3f.copy(s[0]),a=x3dom.fields.SFVec3f.copy(s[0]);for(o=1;o<8;o++)r.z=Math.min(s[o].z,r.z),a.z=Math.max(s[o].z,a.z);var n=2/(a.z-r.z),d=-(n*(a.z+r.z))/2,l=x3dom.fields.SFMatrix4f.identity();return l._22=n,l._23=d,l},x3dom.Viewarea.prototype.getLightFittingMatrix=function(e,t,i,s){function o(e,t){var i=e.x,s=e.y,o=e.z,r=t.x,a=t.y,n=t.z;i>1||r<-1?(i=-1,r=1):(i=Math.max(i,-1),r=Math.min(r,1)),s>1||a<-1?(s=-1,a=1):(s=Math.max(s,-1),a=Math.min(a,1)),o>1||n<-1?(o=-1,n=1):(o=Math.max(o,-1),n=Math.min(n,1));var d=new x3dom.fields.SFVec3f(i,s,o),l=new x3dom.fields.SFVec3f(r,a,n);return new x3dom.fields.BoxVolume(d,l)}var r=this.getViewMatrix(),a=s.mult(r),n=a.inverse(),d=[];d[0]=new x3dom.fields.SFVec3f((-1),(-1),i),d[1]=new x3dom.fields.SFVec3f((-1),(-1),t),d[2]=new x3dom.fields.SFVec3f((-1),1,i),d[3]=new x3dom.fields.SFVec3f((-1),1,t),d[4]=new x3dom.fields.SFVec3f(1,(-1),i),d[5]=new x3dom.fields.SFVec3f(1,(-1),t),d[6]=new x3dom.fields.SFVec3f(1,1,i),d[7]=new x3dom.fields.SFVec3f(1,1,t);var l;for(l=0;l<8;l++)d[l]=n.multFullMatrixPnt(d[l]),d[l]=e.multFullMatrixPnt(d[l]);var h=x3dom.fields.SFVec3f.copy(d[0]),u=x3dom.fields.SFVec3f.copy(d[0]);for(l=1;l<8;l++)h.x=Math.min(d[l].x,h.x),h.y=Math.min(d[l].y,h.y),h.z=Math.min(d[l].z,h.z),u.x=Math.max(d[l].x,u.x),u.y=Math.max(d[l].y,u.y),u.z=Math.max(d[l].z,u.z);var f=o(h,u),c=2/(f.max.x-f.min.x),_=2/(f.max.y-f.min.y),m=-(c*(f.max.x+f.min.x))/2,p=-(_*(f.max.y+f.min.y))/2,x=x3dom.fields.SFMatrix4f.identity();return x._00=c,x._11=_,x._03=m,x._13=p,x},x3dom.Mesh=function(e){this._parent=e,this._vol=new x3dom.fields.BoxVolume,this._invalidate=!0,this._numFaces=0,this._numCoords=0,this._primType="TRIANGLES",this._positions=[],this._normals=[],this._texCoords=[],this._colors=[],this._indices=[],this._positions[0]=[],this._normals[0]=[],this._texCoords[0]=[],this._colors[0]=[],this._indices[0]=[]},x3dom.Mesh.prototype._dynamicFields={},x3dom.Mesh.prototype._numPosComponents=3,x3dom.Mesh.prototype._numTexComponents=2,x3dom.Mesh.prototype._numColComponents=3,x3dom.Mesh.prototype._numNormComponents=3,x3dom.Mesh.prototype._lit=!0,x3dom.Mesh.prototype._vol=null,x3dom.Mesh.prototype._invalidate=!0,x3dom.Mesh.prototype._numFaces=0,x3dom.Mesh.prototype._numCoords=0,x3dom.Mesh.prototype.setMeshData=function(e,t,i,s,o){this._positions[0]=e,this._normals[0]=t,this._texCoords[0]=i,this._colors[0]=s,this._indices[0]=o,this._invalidate=!0,this._numFaces=this._indices[0].length/3,this._numCoords=this._positions[0].length/3},x3dom.Mesh.prototype.getVolume=function(){if(1==this._invalidate&&!this._vol.isValid()){var e=this._positions[0],t=e.length;if(t>3){var i=new x3dom.fields.SFVec3f(e[0],e[1],e[2]);this._vol.setBounds(i,i);for(var s=3;s<t;s+=3)this._vol.min.x>e[s]&&(this._vol.min.x=e[s]),this._vol.min.y>e[s+1]&&(this._vol.min.y=e[s+1]),this._vol.min.z>e[s+2]&&(this._vol.min.z=e[s+2]),this._vol.max.x<e[s]&&(this._vol.max.x=e[s]),this._vol.max.y<e[s+1]&&(this._vol.max.y=e[s+1]),this._vol.max.z<e[s+2]&&(this._vol.max.z=e[s+2]);this._invalidate=!1}}return this._vol},x3dom.Mesh.prototype.invalidate=function(){this._invalidate=!0,this._vol.invalidate()},x3dom.Mesh.prototype.isValid=function(){return this._vol.isValid()},x3dom.Mesh.prototype.getCenter=function(){return this.getVolume().getCenter()},x3dom.Mesh.prototype.getDiameter=function(){return this.getVolume().getDiameter()},x3dom.Mesh.prototype.doIntersect=function(e){var t=this.getVolume(),i=e.intersect(t.min,t.max);return i&&e.enter<e.dist&&(e.dist=e.enter,e.hitObject=this._parent,e.hitPoint=e.pos.add(e.dir.multiply(e.enter))),i},x3dom.Mesh.prototype.calcNormals=function(e,t){void 0===t&&(t=!0);var i,s,o,r,a=this._multiIndIndices&&this._multiIndIndices.length,n=a?this._multiIndIndices:this._indices[0],d=this._positions[0],l=[],h=[],u=d.length,f=null,c=void 0!==this._posSize&&this._posSize>u?this._posSize/3:u/3;for(c=3*(c-Math.floor(c)>0?Math.floor(c+1):c),i=0;i<c;++i)h[i]=[];for(c=n.length,i=0;i<c;i+=3){var _,m,p,x;a?(_=3*i,m=3*(i+1),p=3*(i+2),x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),o=new x3dom.fields.SFVec3f(d[_],d[_+1],d[_+2]).subtract(x),r=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2]))):(_=3*n[i],m=3*n[i+1],p=3*n[i+2],x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),o=new x3dom.fields.SFVec3f(d[_],d[_+1],d[_+2]).subtract(x),r=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2])),_=3*i,m=3*(i+1),p=3*(i+2)),f=o.cross(r).normalize(),t||(f=f.negate()),e<=x3dom.fields.Eps?(l[_]=l[m]=l[p]=f.x,l[_+1]=l[m+1]=l[p+1]=f.y,l[_+2]=l[m+2]=l[p+2]=f.z):(h[n[i]].push(f),h[n[i+1]].push(f),h[n[i+2]].push(f))}if(e>x3dom.fields.Eps)for(i=0;i<u;i+=3){var g,v=i/3;for(g=a?h[n[v]]:h[v],c=g.length,f=new x3dom.fields.SFVec3f(0,0,0),s=0;s<c;++s)f=f.add(g[s]);f=f.normalize(),l[i]=f.x,l[i+1]=f.y,l[i+2]=f.z}this._normals[0]=l},x3dom.Mesh.prototype.splitMesh=function(e,t){var i,s;i=void 0===typeof e?3:e,void 0===typeof t&&(t=!1);var o=x3dom.Utils.maxIndexableCoords;if(o=Math.floor(o/i)*i,!(this._positions[0].length/3<=o)||t){s=!!t&&(this._multiIndIndices&&this._multiIndIndices.length);var r=this._positions[0],a=this._normals[0],n=this._texCoords[0],d=this._colors[0],l=s?this._multiIndIndices:this._indices[0],h=0;do{this._positions[h]=[],this._normals[h]=[],this._texCoords[h]=[],this._colors[h]=[],this._indices[h]=[];var u=l.length-(h+1)*o>=0;if(u?this._indices[h]=l.slice(h*o,(h+1)*o):this._indices[h]=l.slice(h*o),s)for(var f=0,c=this._indices[h].length;f<c;f++)this._indices[h][f]=f;else if(h)for(var _=h*o,f=0,c=this._indices[h].length;f<c;f++)this._indices[h][f]-=_;u?this._positions[h]=r.slice(h*o*3,3*(h+1)*o):this._positions[h]=r.slice(h*o*3),a.length&&(u?this._normals[h]=a.slice(h*o*3,3*(h+1)*o):this._normals[h]=a.slice(h*o*3)),n.length&&(u?this._texCoords[h]=n.slice(h*o*this._numTexComponents,this._numTexComponents*(h+1)*o):this._texCoords[h]=n.slice(h*o*this._numTexComponents)),d.length&&(u?this._colors[h]=d.slice(h*o*this._numColComponents,this._numColComponents*(h+1)*o):this._colors[h]=d.slice(h*o*this._numColComponents))}while(r.length>++h*o*3)}},x3dom.Mesh.prototype.calcTexCoords=function(e){if(this._texCoords[0]=[],"sphere-local"===e.toLowerCase())for(var t=0,i=0,s=this._normals[0].length;t<s;t+=3)this._texCoords[0][i++]=.5+this._normals[0][t]/2,this._texCoords[0][i++]=.5+this._normals[0][t+1]/2;else{var o=new x3dom.fields.SFVec3f(0,0,0),r=new x3dom.fields.SFVec3f(0,0,0),a=this.getVolume();a.getBounds(o,r);var n=r.subtract(o),d=0,l=1;n.x>=n.y?n.x>=n.z?(d=0,l=n.y>=n.z?1:2):(d=2,l=0):n.y>=n.z?(d=1,l=n.x>=n.z?0:2):(d=2,l=1);var h=1,u=1,f=0,c=0;switch(d){case 0:h=n.x,f=o.x;break;case 1:h=n.y,f=o.y;break;case 2:h=n.z,f=o.z}switch(l){case 0:u=n.x,c=o.x;break;case 1:u=n.y,c=o.y;break;case 2:u=n.z,c=o.z}for(var _=0,m=0,p=this._positions[0].length;_<p;_+=3)this._texCoords[0][m++]=(this._positions[0][_+d]-f)/h,this._texCoords[0][m++]=(this._positions[0][_+l]-c)/u}},"undefined"==typeof x3dom&&(x3dom={extend:function(e){function t(){}return t.prototype=e.prototype||e,new t},debug:{logInfo:function(e){console.log(e)},logWarning:function(e){console.warn(e)},logError:function(e){console.error(e)}}},Array.map||(Array.map=function(e,t,i){for(var s=e.length,o=[],r=0;r<s;r++)r in e&&(o[r]=t.call(i,e[r],r,e));return o}),console.log("Using x3dom fields.js as standalone math and/or base types library.")),x3dom.fields={};var VecMath=x3dom.fields;x3dom.fields.Eps=1e-6,x3dom.fields.SFMatrix4f=function(e,t,i,s,o,r,a,n,d,l,h,u,f,c,_,m){0===arguments.length?(this._00=1,this._01=0,this._02=0,this._03=0,this._10=0,this._11=1,this._12=0,this._13=0,this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):(this._00=e,this._01=t,this._02=i,this._03=s,this._10=o,this._11=r,this._12=a,this._13=n,this._20=d,this._21=l,this._22=h,this._23=u,this._30=f,this._31=c,this._32=_,this._33=m)},x3dom.fields.SFMatrix4f.prototype.e0=function(){var e=new x3dom.fields.SFVec3f(this._00,this._10,this._20);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e1=function(){var e=new x3dom.fields.SFVec3f(this._01,this._11,this._21);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e2=function(){var e=new x3dom.fields.SFVec3f(this._02,this._12,this._22);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)},x3dom.fields.SFMatrix4f.copy=function(e){return new x3dom.fields.SFMatrix4f(e._00,e._01,e._02,e._03,e._10,e._11,e._12,e._13,e._20,e._21,e._22,e._23,e._30,e._31,e._32,e._33)},x3dom.fields.SFMatrix4f.prototype.copy=function(){return x3dom.fields.SFMatrix4f.copy(this)},x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},x3dom.fields.SFMatrix4f.translation=function(e){return new x3dom.fields.SFMatrix4f(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationX=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,t,(-i),0,0,i,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationY=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,0,i,0,0,1,0,0,(-i),0,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationZ=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,(-i),0,0,i,t,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.scale=function(e){return new x3dom.fields.SFMatrix4f(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1)},x3dom.fields.SFMatrix4f.lookAt=function(e,t,i){var s=e.subtract(t).normalize(),o=i.normalize().cross(s).normalize();if(o.dot(o)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(e);var r=s.cross(o).normalize(),a=x3dom.fields.SFMatrix4f.identity();return a.setValue(o,r,s,e),a},x3dom.fields.SFMatrix4f.perspectiveFrustum=function(e,t,i,s,o,r){return new x3dom.fields.SFMatrix4f(2*o/(t-e),0,(t+e)/(t-e),0,0,2*o/(s-i),(s+i)/(s-i),0,0,0,-(r+o)/(r-o),-2*r*o/(r-o),0,0,(-1),0)},x3dom.fields.SFMatrix4f.perspective=function(e,t,i,s){var o=1/Math.tan(e/2);return new x3dom.fields.SFMatrix4f(o/t,0,0,0,0,o,0,0,0,0,(i+s)/(i-s),2*i*s/(i-s),0,0,(-1),0)},x3dom.fields.SFMatrix4f.ortho=function(e,t,i,s,o,r,a){var n=(t-e)/2,d=(s-i)/2,l=r-o;return void 0===a&&(a=1),a<n/d?d=n/a:n=d*a,e=-n,t=n,i=-d,s=d,n*=2,d*=2,new x3dom.fields.SFMatrix4f(2/n,0,0,-(t+e)/n,0,2/d,0,-(s+i)/d,0,0,-2/l,-(r+o)/l,0,0,0,1)},x3dom.fields.SFMatrix4f.prototype.setTranslate=function(e){this._03=e.x,this._13=e.y,this._23=e.z},x3dom.fields.SFMatrix4f.prototype.setScale=function(e){this._00=e.x,this._11=e.y,this._22=e.z},x3dom.fields.SFMatrix4f.prototype.setRotate=function(e){var t=e.x*e.x,i=e.x*e.y,s=e.x*e.z,o=e.y*e.y,r=e.y*e.z,a=e.z*e.z,n=e.w*e.x,d=e.w*e.y,l=e.w*e.z;this._00=1-2*(o+a),this._01=2*(i-l),this._02=2*(s+d),this._10=2*(i+l),this._11=1-2*(t+a),this._12=2*(r-n),this._20=2*(s-d),this._21=2*(r+n),this._22=1-2*(t+o)},x3dom.fields.SFMatrix4f.parseRotation=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e),i=+t[1],s=+t[2],o=+t[3],r=+t[4],a=Math.sqrt(i*i+s*s+o*o);0===a?(i=1,s=o=0):(i/=a,s/=a,o/=a);var n=Math.cos(r),d=Math.sin(r),l=1-n;return new x3dom.fields.SFMatrix4f(l*i*i+n,l*i*s+d*o,l*i*o-d*s,0,l*i*s-d*o,l*s*s+n,l*s*o+d*i,0,l*i*o+d*s,l*s*o-d*i,l*o*o+n,0,0,0,0,1).transpose()},x3dom.fields.SFMatrix4f.parse=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var s=Array.map(e.split(/[,\s]+/),function(e){return+e});return s.length>=16?t?new x3dom.fields.SFMatrix4f(s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15]):new x3dom.fields.SFMatrix4f(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],s[10],s[11],s[12],s[13],s[14],s[15]):6===s.length?new x3dom.fields.SFMatrix4f(s[0],s[1],0,s[4],s[2],s[3],0,s[5],0,0,1,0,0,0,0,1):(x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),x3dom.fields.SFMatrix4f.identity())},x3dom.fields.SFMatrix4f.prototype.mult=function(e){return new x3dom.fields.SFMatrix4f(this._00*e._00+this._01*e._10+this._02*e._20+this._03*e._30,this._00*e._01+this._01*e._11+this._02*e._21+this._03*e._31,this._00*e._02+this._01*e._12+this._02*e._22+this._03*e._32,this._00*e._03+this._01*e._13+this._02*e._23+this._03*e._33,this._10*e._00+this._11*e._10+this._12*e._20+this._13*e._30,this._10*e._01+this._11*e._11+this._12*e._21+this._13*e._31,this._10*e._02+this._11*e._12+this._12*e._22+this._13*e._32,this._10*e._03+this._11*e._13+this._12*e._23+this._13*e._33,this._20*e._00+this._21*e._10+this._22*e._20+this._23*e._30,this._20*e._01+this._21*e._11+this._22*e._21+this._23*e._31,this._20*e._02+this._21*e._12+this._22*e._22+this._23*e._32,this._20*e._03+this._21*e._13+this._22*e._23+this._23*e._33,this._30*e._00+this._31*e._10+this._32*e._20+this._33*e._30,this._30*e._01+this._31*e._11+this._32*e._21+this._33*e._31,this._30*e._02+this._31*e._12+this._32*e._22+this._33*e._32,this._30*e._03+this._31*e._13+this._32*e._23+this._33*e._33)},x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z+this._03,this._10*e.x+this._11*e.y+this._12*e.z+this._13,this._20*e.x+this._21*e.y+this._22*e.z+this._23)},x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z,this._10*e.x+this._11*e.y+this._12*e.z,this._20*e.x+this._21*e.y+this._22*e.z)},x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(e){var t=this._30*e.x+this._31*e.y+this._32*e.z+this._33;return t&&(t=1/t),new x3dom.fields.SFVec3f((this._00*e.x+this._01*e.y+this._02*e.z+this._03)*t,(this._10*e.x+this._11*e.y+this._12*e.z+this._13)*t,(this._20*e.x+this._21*e.y+this._22*e.z+this._23)*t)},x3dom.fields.SFMatrix4f.prototype.multMatrixPlane=function(e){var t=new x3dom.fields.SFVec3f(e.x,e.y,e.z),i=t.multiply(-e.w);i=this.multMatrixPnt(i);var s=this.inverse().transpose();t=s.multMatrixVec(t);var o=-t.dot(i);return new x3dom.fields.SFVec4f(t.x,t.y,t.z,o)},x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)},x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f((-this._00),(-this._01),(-this._02),(-this._03),(-this._10),(-this._11),(-this._12),(-this._13),(-this._20),(-this._21),(-this._22),(-this._23),(-this._30),(-this._31),(-this._32),(-this._33))},x3dom.fields.SFMatrix4f.prototype.multiply=function(e){return new x3dom.fields.SFMatrix4f(e*this._00,e*this._01,e*this._02,e*this._03,e*this._10,e*this._11,e*this._12,e*this._13,e*this._20,e*this._21,e*this._22,e*this._23,e*this._30,e*this._31,e*this._32,e*this._33)},x3dom.fields.SFMatrix4f.prototype.add=function(e){return new x3dom.fields.SFMatrix4f(this._00+e._00,this._01+e._01,this._02+e._02,this._03+e._03,this._10+e._10,this._11+e._11,this._12+e._12,this._13+e._13,this._20+e._20,this._21+e._21,this._22+e._22,this._23+e._23,this._30+e._30,this._31+e._31,this._32+e._32,this._33+e._33)},x3dom.fields.SFMatrix4f.prototype.addScaled=function(e,t){return new x3dom.fields.SFMatrix4f(this._00+t*e._00,this._01+t*e._01,this._02+t*e._02,this._03+t*e._03,this._10+t*e._10,this._11+t*e._11,this._12+t*e._12,this._13+t*e._13,this._20+t*e._20,this._21+t*e._21,this._22+t*e._22,this._23+t*e._23,this._30+t*e._30,this._31+t*e._31,this._32+t*e._32,this._33+t*e._33)},x3dom.fields.SFMatrix4f.prototype.setValues=function(e){this._00=e._00,this._01=e._01,this._02=e._02,this._03=e._03,this._10=e._10,this._11=e._11,this._12=e._12,this._13=e._13,this._20=e._20,this._21=e._21,this._22=e._22,this._23=e._23,this._30=e._30,this._31=e._31,this._32=e._32,this._33=e._33},x3dom.fields.SFMatrix4f.prototype.setValue=function(e,t,i,s){this._00=e.x,this._01=t.x,this._02=i.x,this._10=e.y,this._11=t.y,this._12=i.y,this._20=e.z,this._21=t.z,this._22=i.z,this._30=0,this._31=0,this._32=0,arguments.length>3&&(this._03=s.x,this._13=s.y,this._23=s.z,this._33=1)},x3dom.fields.SFMatrix4f.prototype.setFromArray=function(e){this._00=e[0],this._01=e[4],this._02=e[8],this._03=e[12],this._10=e[1],this._11=e[5],this._12=e[9],this._13=e[13],this._20=e[2],this._21=e[6],this._22=e[10],this._23=e[14],this._30=e[3],this._31=e[7],this._32=e[11],this._33=e[15]},x3dom.fields.SFMatrix4f.prototype.toGL=function(){
return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]},x3dom.fields.SFMatrix4f.prototype.at=function(e,t){var i="_"+e+t;return this[i]},x3dom.fields.SFMatrix4f.prototype.sqrt=function(){for(var e=x3dom.fields.SFMatrix4f.identity(),t=x3dom.fields.SFMatrix4f.copy(this),i=0;i<6;i++){var s=t.inverse(),o=0==i?x3dom.fields.SFMatrix4f.identity():e.inverse(),r=t.det(),a=e.det(),n=Math.abs(Math.pow(r*a,-.125)),d=1/n;t=t.multiply(n),t=t.addScaled(o,d),t=t.multiply(.5),e=e.multiply(n),e=e.addScaled(s,d),e=e.multiply(.5)}return t},x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var e=0,t=0;return(e=Math.abs(this._00))>t&&(t=e),(e=Math.abs(this._01))>t&&(t=e),(e=Math.abs(this._02))>t&&(t=e),(e=Math.abs(this._03))>t&&(t=e),(e=Math.abs(this._10))>t&&(t=e),(e=Math.abs(this._11))>t&&(t=e),(e=Math.abs(this._12))>t&&(t=e),(e=Math.abs(this._13))>t&&(t=e),(e=Math.abs(this._20))>t&&(t=e),(e=Math.abs(this._21))>t&&(t=e),(e=Math.abs(this._22))>t&&(t=e),(e=Math.abs(this._23))>t&&(t=e),(e=Math.abs(this._30))>t&&(t=e),(e=Math.abs(this._31))>t&&(t=e),(e=Math.abs(this._32))>t&&(t=e),(e=Math.abs(this._33))>t&&(t=e),t},x3dom.fields.SFMatrix4f.prototype.norm1_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._10)+Math.abs(this._20),t=0;return(t=Math.abs(this._01)+Math.abs(this._11)+Math.abs(this._21))>e&&(e=t),(t=Math.abs(this._02)+Math.abs(this._12)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.normInf_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._01)+Math.abs(this._02),t=0;return(t=Math.abs(this._10)+Math.abs(this._11)+Math.abs(this._12))>e&&(e=t),(t=Math.abs(this._20)+Math.abs(this._21)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.adjointT_3x3=function(){var e=x3dom.fields.SFMatrix4f.identity();return e._00=this._11*this._22-this._12*this._21,e._01=this._12*this._20-this._10*this._22,e._02=this._10*this._21-this._11*this._20,e._10=this._21*this._02-this._22*this._01,e._11=this._22*this._00-this._20*this._02,e._12=this._20*this._01-this._21*this._00,e._20=this._01*this._12-this._02*this._11,e._21=this._02*this._10-this._00*this._12,e._22=this._00*this._11-this._01*this._10,e},x3dom.fields.SFMatrix4f.prototype.equals=function(e){var t=1e-12;return Math.abs(this._00-e._00)<t&&Math.abs(this._01-e._01)<t&&Math.abs(this._02-e._02)<t&&Math.abs(this._03-e._03)<t&&Math.abs(this._10-e._10)<t&&Math.abs(this._11-e._11)<t&&Math.abs(this._12-e._12)<t&&Math.abs(this._13-e._13)<t&&Math.abs(this._20-e._20)<t&&Math.abs(this._21-e._21)<t&&Math.abs(this._22-e._22)<t&&Math.abs(this._23-e._23)<t&&Math.abs(this._30-e._30)<t&&Math.abs(this._31-e._31)<t&&Math.abs(this._32-e._32)<t&&Math.abs(this._33-e._33)<t},x3dom.fields.SFMatrix4f.prototype.getTransform=function(e,t,i,s,o){var r=null;if(arguments.length>4){r=x3dom.fields.SFMatrix4f.translation(o.negate()),r=r.mult(this);var a=x3dom.fields.SFMatrix4f.translation(o);r=r.mult(a)}else r=x3dom.fields.SFMatrix4f.copy(this);var n=r.decompose(e,t,i,s);i.setValues(i.multiply(n))},x3dom.fields.SFMatrix4f.prototype.decompose=function(e,t,i,s){var o=x3dom.fields.SFMatrix4f.copy(this),r=x3dom.fields.SFMatrix4f.identity(),a=x3dom.fields.SFMatrix4f.identity(),n=x3dom.fields.SFMatrix4f.identity();e.x=o._03,e.y=o._13,e.z=o._23,o._03=0,o._13=0,o._23=0,o._30=0,o._31=0,o._32=0;var d=o.polarDecompose(r,a),l=1;return d<0&&(r=r.negate(),l=-1),t.setValue(r),a.spectralDecompose(n,i),s.setValue(n),l},x3dom.fields.SFMatrix4f.prototype.polarDecompose=function(e,t){var i,s,o,r,a,n=1e-12,d=this.transpose(),l=x3dom.fields.SFMatrix4f.identity(),h=d.norm1_3x3(),u=d.normInf_3x3();do{if(i=d.adjointT_3x3(),a=d._00*i._00+d._01*i._01+d._02*i._02,0==a){x3dom.debug.logWarning("polarDecompose: Mk_det == 0.0");break}s=i.norm1_3x3(),o=i.normInf_3x3();var f=Math.sqrt(Math.sqrt(s*o/(h*u))/Math.abs(a)),c=.5*f,_=.5/(f*a);l.setValues(d),d=d.multiply(c),d=d.addScaled(i,_),l=l.addScaled(d,-1),r=l.norm1_3x3(),h=d.norm1_3x3(),u=d.normInf_3x3()}while(r>h*n);e.setValues(d.transpose()),t.setValues(d.mult(this));for(var m=0;m<3;++m)for(var p=m;p<3;++p)t["_"+p+m]=.5*(t["_"+p+m]+t["_"+m+p]),t["_"+m+p]=.5*(t["_"+p+m]+t["_"+m+p]);return a},x3dom.fields.SFMatrix4f.prototype.spectralDecompose=function(e,t){for(var i=[1,2,0],s=20,o=[this._00,this._11,this._22],r=[this._12,this._20,this._01],a=0;a<s;++a){var n=Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2]);if(0==n)break;for(var d=2;d>=0;--d){var l=i[d],h=i[l],u=Math.abs(r[d]),f=100*u;if(u>0){var c=0,_=o[h]-o[l],m=Math.abs(_);if(m+f==m)c=r[d]/_;else{var p=.5*_/r[d];c=1/(Math.abs(p)+Math.sqrt(p*p+1)),c=p<0?-c:c}var x=1/Math.sqrt(c*c+1),g=c*x,v=g/(x+1),y=c*r[d];r[d]=0,o[l]-=y,o[h]+=y;var b=r[h];r[h]-=g*(r[l]+v*b),r[l]+=g*(b-v*r[l]);for(var T=2;T>=0;--T){var S=e["_"+T+l],M=e["_"+T+h];e["_"+T+l]-=g*(M+v*S),e["_"+T+h]+=g*(S-v*M)}}}}t.x=o[0],t.y=o[1],t.z=o[2]},x3dom.fields.SFMatrix4f.prototype.log=function(){var e=12,t=1e-12,i=x3dom.fields.SFMatrix4f.copy(this),s=x3dom.fields.SFMatrix4f.copy(this);s._00-=1,s._11-=1,s._22-=1,s._33-=1;for(var o=0;s.normInfinity()>.5;)i=i.sqrt(),s.setValues(i),s._00-=1,s._11-=1,s._22-=1,s._33-=1,o++;i._00-=1,i._11-=1,i._22-=1,i._33-=1,i=i.negate(),s.setValues(i);for(var r=x3dom.fields.SFMatrix4f.copy(i),a=1;s.normInfinity()>t&&a<e;)s=s.mult(i),a++,r=r.addScaled(s,1/a);return r.multiply(-(1<<o))},x3dom.fields.SFMatrix4f.prototype.exp=function(){var e=6,t=x3dom.fields.SFMatrix4f.copy(this),i=x3dom.fields.SFMatrix4f.identity(),s=x3dom.fields.SFMatrix4f.identity(),o=x3dom.fields.SFMatrix4f.identity(),r=0,a=1,n=1+parseInt(Math.log(t.normInfinity()/.693));for(n<0&&(n=0),t=t.multiply(1/(1<<n)),r=1;r<=e;r++)a*=(e-r+1)/(r*(2*e-r+1)),o=t.mult(o),s=s.addScaled(o,a),i=r%2?i.addScaled(o,-a):i.addScaled(o,a);for(o=i.inverse().mult(s),r=0;r<n;r++)o=o.mult(o);return o},x3dom.fields.SFMatrix4f.prototype.det3=function(e,t,i,s,o,r,a,n,d){return e*o*d+t*r*a+i*s*n-e*r*n-t*s*d-i*o*a},x3dom.fields.SFMatrix4f.prototype.det=function(){var e=this._00,t=this._10,i=this._20,s=this._30,o=this._01,r=this._11,a=this._21,n=this._31,d=this._02,l=this._12,h=this._22,u=this._32,f=this._03,c=this._13,_=this._23,m=this._33;return e*this.det3(r,l,c,a,h,_,n,u,m)-t*this.det3(o,d,f,a,h,_,n,u,m)+i*this.det3(o,d,f,r,l,c,n,u,m)-s*this.det3(o,d,f,r,l,c,a,h,_)},x3dom.fields.SFMatrix4f.prototype.inverse=function(){var e=this._00,t=this._10,i=this._20,s=this._30,o=this._01,r=this._11,a=this._21,n=this._31,d=this._02,l=this._12,h=this._22,u=this._32,f=this._03,c=this._13,_=this._23,m=this._33,p=this.det();return 0==p?(x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity()):(p=1/p,new x3dom.fields.SFMatrix4f(+this.det3(r,l,c,a,h,_,n,u,m)*p,-this.det3(o,d,f,a,h,_,n,u,m)*p,+this.det3(o,d,f,r,l,c,n,u,m)*p,-this.det3(o,d,f,r,l,c,a,h,_)*p,-this.det3(t,l,c,i,h,_,s,u,m)*p,+this.det3(e,d,f,i,h,_,s,u,m)*p,-this.det3(e,d,f,t,l,c,s,u,m)*p,+this.det3(e,d,f,t,l,c,i,h,_)*p,+this.det3(t,r,c,i,a,_,s,n,m)*p,-this.det3(e,o,f,i,a,_,s,n,m)*p,+this.det3(e,o,f,t,r,c,s,n,m)*p,-this.det3(e,o,f,t,r,c,i,a,_)*p,-this.det3(t,r,l,i,a,h,s,n,u)*p,+this.det3(e,o,d,i,a,h,s,n,u)*p,-this.det3(e,o,d,t,r,l,s,n,u)*p,+this.det3(e,o,d,t,r,l,i,a,h)*p))},x3dom.fields.SFMatrix4f.prototype.getEulerAngles=function(){var e,t,i,s,o,r,a,n,d,l,h;return Math.abs(Math.abs(this._20)-1)>1e-4?(e=-Math.asin(this._20),t=Math.PI-e,l=Math.cos(e),h=Math.cos(t),a=Math.atan2(this._21/l,this._22/l),n=Math.atan2(this._21/h,this._22/h),s=Math.atan2(this._10/l,this._00/l),o=Math.atan2(this._10/h,this._00/h),[a,e,s,n,t,o]):(r=0,this._20==-1?(i=Math.PI/2,d=r+Math.atan2(this._01,this._02)):(i=-(Math.PI/2),d=-r+Math.atan2(-this._01,-this._02)),[d,i,r,d,i,r])},x3dom.fields.SFMatrix4f.prototype.toString=function(){return"\n"+this._00.toFixed(6)+", "+this._01.toFixed(6)+", "+this._02.toFixed(6)+", "+this._03.toFixed(6)+", \n"+this._10.toFixed(6)+", "+this._11.toFixed(6)+", "+this._12.toFixed(6)+", "+this._13.toFixed(6)+", \n"+this._20.toFixed(6)+", "+this._21.toFixed(6)+", "+this._22.toFixed(6)+", "+this._23.toFixed(6)+", \n"+this._30.toFixed(6)+", "+this._31.toFixed(6)+", "+this._32.toFixed(6)+", "+this._33.toFixed(6)},x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var s=Array.map(e.split(/[,\s]+/),function(e){return+e});return s.length>=16?t?(this._00=s[0],this._01=s[4],this._02=s[8],this._03=s[12],this._10=s[1],this._11=s[5],this._12=s[9],this._13=s[13],this._20=s[2],this._21=s[6],this._22=s[10],this._23=s[14],this._30=s[3],this._31=s[7],this._32=s[11],this._33=s[15]):(this._00=s[0],this._01=s[1],this._02=s[2],this._03=s[3],this._10=s[4],this._11=s[5],this._12=s[6],this._13=s[7],this._20=s[8],this._21=s[9],this._22=s[10],this._23=s[11],this._30=s[12],this._31=s[13],this._32=s[14],this._33=s[15]):6===s.length?(this._00=s[0],this._01=s[1],this._02=0,this._03=s[4],this._10=s[2],this._11=s[3],this._12=0,this._13=s[5],this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),this},x3dom.fields.SFVec2f=function(e,t){0===arguments.length?(this.x=0,this.y=0):(this.x=e,this.y=t)},x3dom.fields.SFVec2f.copy=function(e){return new x3dom.fields.SFVec2f(e.x,e.y)},x3dom.fields.SFVec2f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec2f((+t[1]),(+t[2]))},x3dom.fields.SFVec2f.prototype.copy=function(){return x3dom.fields.SFVec2f.copy(this)},x3dom.fields.SFVec2f.prototype.setValues=function(e){this.x=e.x,this.y=e.y},x3dom.fields.SFVec2f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;default:return this.x}},x3dom.fields.SFVec2f.prototype.add=function(e){return new x3dom.fields.SFVec2f(this.x+e.x,this.y+e.y)},x3dom.fields.SFVec2f.prototype.subtract=function(e){return new x3dom.fields.SFVec2f(this.x-e.x,this.y-e.y)},x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f((-this.x),(-this.y))},x3dom.fields.SFVec2f.prototype.dot=function(e){return this.x*e.x+this.y*e.y},x3dom.fields.SFVec2f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec2f(this.x-t*e.x,this.y-t*e.y)},x3dom.fields.SFVec2f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.multComponents=function(e){return new x3dom.fields.SFVec2f(this.x*e.x,this.y*e.y)},x3dom.fields.SFVec2f.prototype.multiply=function(e){return new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec2f(this.x*t,this.y*t)},x3dom.fields.SFVec2f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]},x3dom.fields.SFVec2f.prototype.toString=function(){return this.x+" "+this.y},x3dom.fields.SFVec2f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return this.x=+t[1],this.y=+t[2],this},x3dom.fields.SFVec3f=function(e,t,i){0===arguments.length?(this.x=0,this.y=0,this.z=0):(this.x=e,this.y=t,this.z=i)},x3dom.fields.SFVec3f.NullVector=new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.SFVec3f.OneVector=new x3dom.fields.SFVec3f(1,1,1),x3dom.fields.SFVec3f.copy=function(e){return new x3dom.fields.SFVec3f(e.x,e.y,e.z)},x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f((-Number.MAX_VALUE),(-Number.MAX_VALUE),(-Number.MAX_VALUE))},x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},x3dom.fields.SFVec3f.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec3f((+t[1]),(+t[2]),(+t[3]))}catch(i){var s=x3dom.fields.SFColor.colorParse(e);return new x3dom.fields.SFVec3f(s.r,s.g,s.b)}},x3dom.fields.SFVec3f.prototype.copy=function(){return x3dom.fields.SFVec3f.copy(this)},x3dom.fields.SFVec3f.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z},x3dom.fields.SFVec3f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:return this.x}},x3dom.fields.SFVec3f.prototype.add=function(e){return new x3dom.fields.SFVec3f(this.x+e.x,this.y+e.y,this.z+e.z)},x3dom.fields.SFVec3f.prototype.addScaled=function(e,t){return new x3dom.fields.SFVec3f(this.x+t*e.x,this.y+t*e.y,this.z+t*e.z)},x3dom.fields.SFVec3f.prototype.subtract=function(e){return new x3dom.fields.SFVec3f(this.x-e.x,this.y-e.y,this.z-e.z)},x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f((-this.x),(-this.y),(-this.z))},x3dom.fields.SFVec3f.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},x3dom.fields.SFVec3f.prototype.cross=function(e){return new x3dom.fields.SFVec3f(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},x3dom.fields.SFVec3f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec3f(this.x-t*e.x,this.y-t*e.y,this.z-t*e.z)},x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},x3dom.fields.SFVec3f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.multComponents=function(e){return new x3dom.fields.SFVec3f(this.x*e.x,this.y*e.y,this.z*e.z)},x3dom.fields.SFVec3f.prototype.multiply=function(e){return new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec3f(this.x*t,this.y*t,this.z*t)},x3dom.fields.SFVec3f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t},x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]},x3dom.fields.SFVec3f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z},x3dom.fields.SFVec3f.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.x=+t[1],this.y=+t[2],this.z=+t[3]}catch(i){var s=x3dom.fields.SFColor.colorParse(e);this.x=s.r,this.y=s.g,this.z=s.b}return this},x3dom.fields.SFVec4f=function(e,t,i,s){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x=e,this.y=t,this.z=i,this.w=s)},x3dom.fields.SFVec4f.copy=function(e){return new x3dom.fields.SFVec4f(e.x,e.y,e.z,e.w)},x3dom.fields.SFVec4f.prototype.copy=function(){return x3dom.fields.SFVec4f(this)},x3dom.fields.SFVec4f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec4f((+t[1]),(+t[2]),(+t[3]),(+t[4]))},x3dom.fields.SFVec4f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return this.x=+t[1],this.y=+t[2],this.z=+t[3],this.w=+t[4],this},x3dom.fields.SFVec4f.prototype.toGL=function(){return[this.x,this.y,this.z,this.w]},x3dom.fields.SFVec4f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+" "+this.w},x3dom.fields.Quaternion=function(e,t,i,s){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=1):(this.x=e,this.y=t,this.z=i,this.w=s)},x3dom.fields.Quaternion.copy=function(e){return new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w)},x3dom.fields.Quaternion.prototype.multiply=function(e){return new x3dom.fields.Quaternion(this.w*e.x+this.x*e.w+this.y*e.z-this.z*e.y,this.w*e.y+this.y*e.w+this.z*e.x-this.x*e.z,this.w*e.z+this.z*e.w+this.x*e.y-this.y*e.x,this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z)},x3dom.fields.Quaternion.parseAxisAngle=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f((+t[1]),(+t[2]),(+t[3])),+t[4])},x3dom.fields.Quaternion.axisAngle=function(e,t){var i=e.length();if(i>x3dom.fields.Eps){var s=Math.sin(t/2)/i,o=Math.cos(t/2);return new x3dom.fields.Quaternion(e.x*s,e.y*s,e.z*s,o)}return new x3dom.fields.Quaternion(0,0,0,1)},x3dom.fields.Quaternion.prototype.copy=function(){return x3dom.fields.Quaternion.copy(this)},x3dom.fields.Quaternion.prototype.toMatrix=function(){var e=this.x*this.x,t=this.x*this.y,i=this.x*this.z,s=this.y*this.y,o=this.y*this.z,r=this.z*this.z,a=this.w*this.x,n=this.w*this.y,d=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(s+r),2*(t-d),2*(i+n),0,2*(t+d),1-2*(e+r),2*(o-a),0,2*(i-n),2*(o+a),1-2*(e+s),0,0,0,0,1)},x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var e=0,t=0,i=0,s=0,o=0,r=this;return this.w>1&&(r=x3dom.fields.Quaternion.normalize(this)),o=2*Math.acos(r.w),s=Math.sqrt(1-r.w*r.w),0==s?(e=r.x,t=r.y,i=r.z):(e=r.x/s,t=r.y/s,i=r.z/s),[new x3dom.fields.SFVec3f(e,t,i),o]},x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)},x3dom.fields.Quaternion.prototype.setValue=function(e){var t,i=1,s=[0,0,0],o=0,r=0,a=0,n=[1,2,0];if(t=e._00+e._11+e._22,t>0?(i=Math.sqrt(t+1),this.w=.5*i,i=.5/i,this.x=(e._21-e._12)*i,this.y=(e._02-e._20)*i,this.z=(e._10-e._01)*i):(o=e._11>e._00?1:0,e._22>e.at(o,o)&&(o=2),r=n[o],a=n[r],i=Math.sqrt(e.at(o,o)-(e.at(r,r)+e.at(a,a))+1),s[o]=.5*i,i=.5/i,this.w=(e.at(a,r)-e.at(r,a))*i,s[r]=(e.at(r,o)+e.at(o,r))*i,s[a]=(e.at(a,o)+e.at(o,a))*i,this.x=s[0],this.y=s[1],this.z=s[2]),this.w>1||this.w<-1){var d=1+100*x3dom.fields.Eps;(this.w>d||this.w<-d)&&x3dom.debug.logInfo("MatToQuat: BUG: |quat[4]| ("+this.w+") >> 1.0 !"),this.w>1?this.w=1:this.w=-1}},x3dom.fields.Quaternion.prototype.setFromEuler=function(e,t,i){var s=Math.sin(.5*e),o=Math.cos(.5*e),r=Math.sin(.5*t),a=Math.cos(.5*t),n=Math.sin(.5*i),d=Math.cos(.5*i);this.x=s*a*d-o*r*n,this.y=o*r*d+s*a*n,this.z=o*a*n-s*r*d,this.w=o*a*d+s*r*n},x3dom.fields.Quaternion.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},x3dom.fields.Quaternion.prototype.add=function(e){return new x3dom.fields.Quaternion(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},x3dom.fields.Quaternion.prototype.subtract=function(e){return new x3dom.fields.Quaternion(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},x3dom.fields.Quaternion.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},x3dom.fields.Quaternion.prototype.equals=function(e,t){return this.dot(e)>=1-t},x3dom.fields.Quaternion.prototype.multScalar=function(e){return new x3dom.fields.Quaternion(this.x*e,this.y*e,this.z*e,this.w*e)},x3dom.fields.Quaternion.prototype.normalize=function(e){var t=this.dot(e),i=1;return t&&(i=1/Math.sqrt(t)),new x3dom.fields.Quaternion(this.x*i,this.y*i,this.z*i,this.w*i)},x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion((-this.x),(-this.y),(-this.z),(-this.w))},x3dom.fields.Quaternion.prototype.inverse=function(){return new x3dom.fields.Quaternion((-this.x),(-this.y),(-this.z),this.w)},x3dom.fields.Quaternion.prototype.slerp=function(e,t){var i,s=this.dot(e);s<0?(s=-s,i=e.negate()):i=new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w);var o,r;if(1-s>1e-5){var a=Math.acos(s),n=Math.sin(a);o=Math.sin((1-t)*a)/n,r=Math.sin(t*a)/n}else o=1-t,r=t;return this.multScalar(o).add(i.multScalar(r))},x3dom.fields.Quaternion.rotateFromTo=function(e,t){var i=e.normalize(),s=t.normalize(),o=i.dot(s);if(o>.99999)return new x3dom.fields.Quaternion(0,0,0,1);if(o<-.99999){var r=new x3dom.fields.SFVec3f(1,0,0),a=i.cross(r);return a.length()<1e-5&&(r.x=0,r.y=1,r.z=0,a=i.cross(r)),a=a.normalize(),x3dom.fields.Quaternion.axisAngle(a,Math.PI)}var n=e.cross(t);n=n.normalize();var d=Math.sqrt(.5*(1-o));return n=n.multiply(d),d=Math.sqrt(.5*(1+o)),new x3dom.fields.Quaternion(n.x,n.y,n.z,d)},x3dom.fields.Quaternion.prototype.toGL=function(){var e=this.toAxisAngle();return[e[0].x,e[0].y,e[0].z,e[1]]},x3dom.fields.Quaternion.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+", "+this.w},x3dom.fields.Quaternion.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e),i=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f((+t[1]),(+t[2]),(+t[3])),+t[4]);return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},x3dom.fields.SFColor=function(e,t,i){0===arguments.length?(this.r=0,this.g=0,this.b=0):(this.r=e,this.g=t,this.b=i)},x3dom.fields.SFColor.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFColor((+t[1]),(+t[2]),(+t[3]))}catch(i){return x3dom.fields.SFColor.colorParse(e)}},x3dom.fields.SFColor.copy=function(e){return new x3dom.fields.SFColor(e.r,e.g,e.b)},x3dom.fields.SFColor.prototype.copy=function(){return x3dom.fields.SFColor.copy(this)},x3dom.fields.SFColor.prototype.setHSV=function(e,t,i){x3dom.debug.logWarning("SFColor.setHSV() NYI")},x3dom.fields.SFColor.prototype.getHSV=function(){var e=0,t=0,i=0;return x3dom.debug.logWarning("SFColor.getHSV() NYI"),[e,t,i]},x3dom.fields.SFColor.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b},x3dom.fields.SFColor.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t},x3dom.fields.SFColor.prototype.add=function(e){return new x3dom.fields.SFColor(this.r+e.r,this.g+e.g,this.b+e.b)},x3dom.fields.SFColor.prototype.subtract=function(e){return new x3dom.fields.SFColor(this.r-e.r,this.g-e.g,this.b-e.b)},x3dom.fields.SFColor.prototype.multiply=function(e){return new x3dom.fields.SFColor(this.r*e,this.g*e,this.b*e)},x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]},x3dom.fields.SFColor.prototype.toString=function(){return this.r+" "+this.g+" "+this.b},x3dom.fields.SFColor.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3]}catch(i){var s=x3dom.fields.SFColor.colorParse(e);this.r=s.r,this.g=s.g,this.b=s.b}return this},x3dom.fields.SFColor.colorParse=function(e){var t=0,i=0,s=0,o={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(o[e]&&(e="#"+o[e]),e.substr&&"#"===e.substr(0,1)){e=e.substr(1);var r=e.length;6===r?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,s=parseInt("0x"+e.substr(4,2),16)/255):3===r&&(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,s=parseInt("0x"+e.substr(2,1),16)/15)}return new x3dom.fields.SFColor(t,i,s)},x3dom.fields.SFColorRGBA=function(e,t,i,s){0===arguments.length?(this.r=0,this.g=0,this.b=0,this.a=1):(this.r=e,this.g=t,this.b=i,this.a=s)},x3dom.fields.SFColorRGBA.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFColorRGBA((+t[1]),(+t[2]),(+t[3]),(+t[4]))}catch(i){return x3dom.fields.SFColorRGBA.colorParse(e)}},x3dom.fields.SFColorRGBA.copy=function(e){return new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,e.a)},x3dom.fields.SFColorRGBA.prototype.copy=function(){return x3dom.fields.SFColorRGBA.copy(this)},x3dom.fields.SFColorRGBA.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},x3dom.fields.SFColorRGBA.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t},x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]},x3dom.fields.SFColorRGBA.prototype.toString=function(){return this.r+" "+this.g+" "+this.b+" "+this.a},x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3],this.a=+t[4]}catch(i){var s=x3dom.fields.SFColorRGBA.colorParse(e);this.r=s.r,this.g=s.g,this.b=s.b,this.a=s.a}return this},x3dom.fields.SFColorRGBA.prototype.toUint=function(){return(Math.round(255*this.r)<<24|Math.round(255*this.g)<<16|Math.round(255*this.b)<<8|Math.round(255*this.a))>>>0},x3dom.fields.SFColorRGBA.colorParse=function(e){var t=0,i=0,s=0,o=0,r={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(r[e]&&(e="#"+r[e]+"ff"),e.substr&&"#"===e.substr(0,1)){e=e.substr(1);var a=e.length;8===a?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,s=parseInt("0x"+e.substr(4,2),16)/255,o=parseInt("0x"+e.substr(6,2),16)/255):6===a?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,s=parseInt("0x"+e.substr(4,2),16)/255,o=1):4===a?(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,s=parseInt("0x"+e.substr(2,1),16)/15,o=parseInt("0x"+e.substr(3,1),16)/15):3===a&&(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,s=parseInt("0x"+e.substr(2,1),16)/15,o=1)}return new x3dom.fields.SFColorRGBA(t,i,s,o)},x3dom.fields.SFImage=function(e,t,i,s){if(0!==arguments.length&&s&&s.map){this.width=e,this.height=t,this.comp=i;var o=this.array;s.map(function(e){o.push(e)},this.array)}else this.width=0,this.height=0,this.comp=0,this.array=[]},x3dom.fields.SFImage.parse=function(e){var t=new x3dom.fields.SFImage;return t.setValueByStr(e),t},x3dom.fields.SFImage.copy=function(e){var t=new x3dom.fields.SFImage;return t.width=e.width,t.height=e.height,t.comp=e.comp,t.setPixels(e.getPixels()),t},x3dom.fields.SFImage.prototype.copy=function(){return x3dom.fields.SFImage.copy(this)},x3dom.fields.SFImage.prototype.setValueByStr=function(e){var t=e.match(/(\w+)/g),i=t.length,s=0;if(this.array=[],!(i>2))return this.width=0,this.height=0,void(this.comp=0);this.width=+t[0],this.height=+t[1],this.comp=+t[2],s=2*this.comp;var o,r;for(r=3;r<i;r++){var a,n,d,l;if(t[r].substr)if("x"!==t[r].substr(1,1).toLowerCase()){
var h=parseInt(t[r],10);1===this.comp?(a=h,this.array.push(a)):2===this.comp?(a=h>>8&255,n=255&h,this.array.push(a,n)):3===this.comp?(a=h>>16&255,n=h>>8&255,d=255&h,this.array.push(a,n,d)):4===this.comp&&(a=h>>24&255,n=h>>16&255,d=h>>8&255,l=255&h,this.array.push(a,n,d,l))}else"x"===t[r].substr(1,1).toLowerCase()&&(t[r]=t[r].substr(2),o=t[r].length,o===s&&(1===this.comp?(a=parseInt("0x"+t[r].substr(0,2),16),this.array.push(a)):2===this.comp?(a=parseInt("0x"+t[r].substr(0,2),16),n=parseInt("0x"+t[r].substr(2,2),16),this.array.push(a,n)):3===this.comp?(a=parseInt("0x"+t[r].substr(0,2),16),n=parseInt("0x"+t[r].substr(2,2),16),d=parseInt("0x"+t[r].substr(4,2),16),this.array.push(a,n,d)):4===this.comp&&(a=parseInt("0x"+t[r].substr(0,2),16),n=parseInt("0x"+t[r].substr(2,2),16),d=parseInt("0x"+t[r].substr(4,2),16),l=parseInt("0x"+t[r].substr(6,2),16),this.array.push(a,n,d,l))))}},x3dom.fields.SFImage.prototype.setPixel=function(e,t,i){var s=(t*this.width+e)*this.comp;1===this.comp&&s<this.array.length?this.array[s]=255*i.r:2===this.comp&&s+1<this.array.length?(this.array[s]=255*i.r,this.array[s+1]=255*i.g):3===this.comp&&s+2<this.array.length?(this.array[s]=255*i.r,this.array[s+1]=255*i.g,this.array[s+2]=255*i.b):4===this.comp&&s+3<this.array.length&&(this.array[s]=255*i.r,this.array[s+1]=255*i.g,this.array[s+2]=255*i.b,this.array[s+3]=255*i.a)},x3dom.fields.SFImage.prototype.getPixel=function(e,t){var i=(t*this.width+e)*this.comp;return 1===this.comp&&i<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,0,0,1):2===this.comp&&i+1<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,0,1):3===this.comp&&i+2<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,1):4===this.comp&&i+3<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,this.array[i+3]/255):void 0},x3dom.fields.SFImage.prototype.setPixels=function(e){var t,i=0;if(1===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r;else if(2===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g;else if(3===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b;else if(4===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b,this.array[i++]=255*e[t].a},x3dom.fields.SFImage.prototype.getPixels=function(){var e,t=[];if(1===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,0,0,1));else if(2===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,0,1));else if(3===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,1));else if(4===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,this.array[e+3]/255));return t},x3dom.fields.SFImage.prototype.toGL=function(){var e=[];return Array.map(this.array,function(t){e.push(t)}),e},x3dom.fields.MFColor=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColor.copy=function(e){var t=new x3dom.fields.MFColor;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFColor.prototype=x3dom.extend([]),x3dom.fields.MFColor.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=3)i.push(new x3dom.fields.SFColor((+t[s+0]),(+t[s+1]),(+t[s+2])));return new x3dom.fields.MFColor(i)},x3dom.fields.MFColor.prototype.copy=function(){return x3dom.fields.MFColor.copy(this)},x3dom.fields.MFColor.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=3)this.push(new x3dom.fields.SFColor((+t[i+0]),(+t[i+1]),(+t[i+2])))},x3dom.fields.MFColor.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b)}),e},x3dom.fields.MFColorRGBA=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColorRGBA.copy=function(e){var t=new x3dom.fields.MFColorRGBA;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]),x3dom.fields.MFColorRGBA.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=4)i.push(new x3dom.fields.SFColorRGBA((+t[s+0]),(+t[s+1]),(+t[s+2]),(+t[s+3])));return new x3dom.fields.MFColorRGBA(i)},x3dom.fields.MFColorRGBA.prototype.copy=function(){return x3dom.fields.MFColorRGBA.copy(this)},x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=4)this.push(new x3dom.fields.SFColorRGBA((+t[i+0]),(+t[i+1]),(+t[i+2]),(+t[i+3])))},x3dom.fields.MFColorRGBA.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b),e.push(t.a)}),e},x3dom.fields.MFRotation=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFRotation.prototype=x3dom.extend([]),x3dom.fields.MFRotation.copy=function(e){var t=new x3dom.fields.MFRotation;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFRotation.prototype.copy=function(){return x3dom.fields.MFRotation.copy(this)},x3dom.fields.MFRotation.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=4)i.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f((+t[s+0]),(+t[s+1]),(+t[s+2])),+t[s+3]));return new x3dom.fields.MFRotation(i)},x3dom.fields.MFRotation.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f((+t[i+0]),(+t[i+1]),(+t[i+2])),+t[i+3]))},x3dom.fields.MFRotation.prototype.toGL=function(){var e=[];return Array.map(this,function(t){var i=t.toAxisAngle();e.push(i[0].x),e.push(i[0].y),e.push(i[0].z),e.push(i[1])}),e},x3dom.fields.MFVec3f=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec3f.prototype=x3dom.extend(Array),x3dom.fields.MFVec3f.copy=function(e){var t=new x3dom.fields.MFVec3f;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFVec3f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=3)i.push(new x3dom.fields.SFVec3f((+t[s+0]),(+t[s+1]),(+t[s+2])));return new x3dom.fields.MFVec3f(i)},x3dom.fields.MFVec3f.prototype.copy=function(){x3dom.fields.MFVec3f.copy(this)},x3dom.fields.MFVec3f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=3)this.push(new x3dom.fields.SFVec3f((+t[i+0]),(+t[i+1]),(+t[i+2])))},x3dom.fields.MFVec3f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y),e.push(t.z)}),e},x3dom.fields.MFVec2f=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec2f.prototype=x3dom.extend([]),x3dom.fields.MFVec2f.copy=function(e){var t=new x3dom.fields.MFVec2f;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFVec2f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=2)i.push(new x3dom.fields.SFVec2f((+t[s+0]),(+t[s+1])));return new x3dom.fields.MFVec2f(i)},x3dom.fields.MFVec2f.prototype.copy=function(){return x3dom.fields.MFVec2f.copy(this)},x3dom.fields.MFVec2f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=2)this.push(new x3dom.fields.SFVec2f((+t[i+0]),(+t[i+1])))},x3dom.fields.MFVec2f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y)}),e},x3dom.fields.MFInt32=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFInt32.prototype=x3dom.extend([]),x3dom.fields.MFInt32.copy=function(e){var t=new x3dom.fields.MFInt32;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFInt32.parse=function(e){for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=[],s=0,o=t?t.length:0;s<o;++s)i.push(parseInt(t[s],10));return new x3dom.fields.MFInt32(i)},x3dom.fields.MFInt32.prototype.copy=function(){return x3dom.fields.MFInt32.copy(this)},x3dom.fields.MFInt32.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=0,s=t?t.length:0;i<s;++i)this.push(parseInt(t[i],10))},x3dom.fields.MFInt32.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFFloat=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFFloat.prototype=x3dom.extend([]),x3dom.fields.MFFloat.copy=function(e){var t=new x3dom.fields.MFFloat;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFFloat.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s++)i.push(+t[s]);return new x3dom.fields.MFFloat(i)},x3dom.fields.MFFloat.prototype.copy=function(){return x3dom.fields.MFFloat.copy(this)},x3dom.fields.MFFloat.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i++)this.push(+t[i])},x3dom.fields.MFFloat.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFBoolean=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFBoolean.prototype=x3dom.extend([]),x3dom.fields.MFBoolean.copy=function(e){var t=new x3dom.fields.MFBoolean;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFBoolean.parse=function(e){for(var t=e.match(/(true|false|1|0)/gi),i=[],s=0,o=t?t.length:0;s<o;s++)i.push("1"==t[s]||"true"==t[s].toLowerCase());return new x3dom.fields.MFBoolean(i)},x3dom.fields.MFBoolean.prototype.copy=function(){return x3dom.fields.MFBoolean.copy(this)},x3dom.fields.MFBoolean.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/(true|false|1|0)/gi),i=0,s=t?t.length:0;i<s;i++)this.push("1"==t[i]||"true"==t[i].toLowerCase())},x3dom.fields.MFBoolean.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t?1:0)}),e},x3dom.fields.MFString=function(e){if(e&&e.map){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFString.prototype=x3dom.extend([]),x3dom.fields.MFString.copy=function(e){var t=new x3dom.fields.MFString;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFString.parse=function(e){var t=[];if(e.length&&'"'==e[0])for(var i,s=/"((?:[^\\"]|\\\\|\\")*)"/g;i=s.exec(e);){var o=i[1].replace(/\\([\\"])/g,"$1");void 0!==o&&t.push(o)}else t.push(e);return new x3dom.fields.MFString(t)},x3dom.fields.MFString.prototype.copy=function(){return x3dom.fields.MFString.copy(this)},x3dom.fields.MFString.prototype.setValueByStr=function(e){if(this.length=0,e.length&&'"'==e[0])for(var t,i=/"((?:[^\\"]|\\\\|\\")*)"/g;t=i.exec(e);){var s=t[1].replace(/\\([\\"])/,"$1");void 0!==s&&this.push(s)}else this.push(e);return this},x3dom.fields.MFString.prototype.toString=function(){for(var e="",t=0,i=this.length;t<i;t++)e=e+this[t]+" ";return e},x3dom.fields.SFNode=function(e){this.type=e,this.node=null},x3dom.fields.SFNode.prototype.hasLink=function(e){return e?this.node===e:this.node},x3dom.fields.SFNode.prototype.addLink=function(e){return this.node=e,!0},x3dom.fields.SFNode.prototype.rmLink=function(e){return this.node===e&&(this.node=null,!0)},x3dom.fields.MFNode=function(e){this.type=e,this.nodes=[]},x3dom.fields.MFNode.prototype.hasLink=function(e){if(!e)return this.length>0;for(var t=0,i=this.nodes.length;t<i;t++)if(this.nodes[t]===e)return!0;return!1},x3dom.fields.MFNode.prototype.addLink=function(e){return this.nodes.push(e),!0},x3dom.fields.MFNode.prototype.rmLink=function(e){for(var t=0,i=this.nodes.length;t<i;t++)if(this.nodes[t]===e)return this.nodes.splice(t,1),!0;return!1},x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length},x3dom.fields.Line=function(e,t){0===arguments.length&&(this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1)),this.pos=x3dom.fields.SFVec3f.copy(e),this.dir=x3dom.fields.SFVec3f.copy(t)},x3dom.fields.Line.prototype.closestPoint=function(e){var t=e.subtract(this.pos),i=t.dot(this.dir);return this.pos.add(this.dir.multiply(i))},x3dom.fields.Line.prototype.shortestDistance=function(e){var t=e.subtract(this.pos),i=t.dot(this.dir);return t.subtract(this.dir.multiply(i)).length()},x3dom.fields.Ray=function(e,t){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(e.x,e.y,e.z);var i=t.length();i&&(i=1/i),this.dir=new x3dom.fields.SFVec3f(t.x*i,t.y*i,t.z*i)}this.enter=0,this.exit=0,this.hitObject=null,this.hitPoint={},this.dist=Number.MAX_VALUE},x3dom.fields.Ray.prototype.toString=function(){return"Ray: ["+this.pos.toString()+"; "+this.dir.toString()+"]"},x3dom.fields.Ray.prototype.intersectPlane=function(e,t){var i,s=null,o=t.dot(this.dir);return o<0&&(i=(e.dot(t)-this.pos.dot(t))/o,s=this.pos.addScaled(this.dir,i)),s},x3dom.fields.Ray.prototype.intersect=function(e,t){var i,s,o,r=0,a=Number.MAX_VALUE;if(this.dir.x>x3dom.fields.Eps)i=1/this.dir.x,s=(e.x-this.pos.x)*i,o=(t.x-this.pos.x)*i,o<a&&(a=o),s>r&&(r=s);else if(this.dir.x<-x3dom.fields.Eps)i=1/this.dir.x,s=(t.x-this.pos.x)*i,o=(e.x-this.pos.x)*i,o<a&&(a=o),s>r&&(r=s);else if(this.pos.x<e.x||this.pos.x>t.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(i=1/this.dir.y,s=(e.y-this.pos.y)*i,o=(t.y-this.pos.y)*i,o<a&&(a=o),s>r&&(r=s),r-a>=x3dom.fields.Eps)return!1}else if(this.dir.y<-x3dom.fields.Eps){if(i=1/this.dir.y,s=(t.y-this.pos.y)*i,o=(e.y-this.pos.y)*i,o<a&&(a=o),s>r&&(r=s),r-a>=x3dom.fields.Eps)return!1}else if(this.pos.y<e.y||this.pos.y>t.y)return!1;if(this.dir.z>x3dom.fields.Eps)i=1/this.dir.z,s=(e.z-this.pos.z)*i,o=(t.z-this.pos.z)*i,o<a&&(a=o),s>r&&(r=s);else if(this.dir.z<-x3dom.fields.Eps)i=1/this.dir.z,s=(t.z-this.pos.z)*i,o=(e.z-this.pos.z)*i,o<a&&(a=o),s>r&&(r=s);else if(this.pos.z<e.z||this.pos.z>t.z)return!1;return this.enter=r,this.exit=a,r-a<x3dom.fields.Eps},x3dom.fields.BoxVolume=function(e,t){arguments.length<2?(this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.valid=!1):(this.min=x3dom.fields.SFVec3f.copy(e),this.max=x3dom.fields.SFVec3f.copy(t),this.valid=!0),this.updateInternals()},x3dom.fields.BoxVolume.prototype.getScalarValue=function(){var e=this.max.subtract(this.min);return e.x*e.y*e.z},x3dom.fields.BoxVolume.copy=function(e){return new x3dom.fields.BoxVolume(e.min,e.max)},x3dom.fields.BoxVolume.prototype.updateInternals=function(){this.radialVec=this.max.subtract(this.min).multiply(.5),this.center=this.min.add(this.radialVec),this.diameter=2*this.radialVec.length()},x3dom.fields.BoxVolume.prototype.setBounds=function(e,t){this.min.setValues(e),this.max.setValues(t),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.setBoundsByCenterSize=function(e,t){var i=t.multiply(.5);this.min=e.subtract(i),this.max=e.add(i),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.extendBounds=function(e,t){this.valid?(this.min.x>e.x&&(this.min.x=e.x),this.min.y>e.y&&(this.min.y=e.y),this.min.z>e.z&&(this.min.z=e.z),this.max.x<t.x&&(this.max.x=t.x),this.max.y<t.y&&(this.max.y=t.y),this.max.z<t.z&&(this.max.z=t.z),this.updateInternals()):this.setBounds(e,t)},x3dom.fields.BoxVolume.prototype.getBounds=function(e,t){e.setValues(this.min),t.setValues(this.max)},x3dom.fields.BoxVolume.prototype.getRadialVec=function(){return this.radialVec},x3dom.fields.BoxVolume.prototype.invalidate=function(){this.valid=!1,this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0)},x3dom.fields.BoxVolume.prototype.isValid=function(){return this.valid},x3dom.fields.BoxVolume.prototype.getCenter=function(){return this.center},x3dom.fields.BoxVolume.prototype.getDiameter=function(){return this.diameter},x3dom.fields.BoxVolume.prototype.transform=function(e){var t,i,s,o,r,a;t=o=e._03,i=r=e._13,s=a=e._23;var n=this.max.x*e._00,d=this.min.x*e._00;n>=d?(o+=n,t+=d):(o+=d,t+=n),n=this.max.y*e._01,d=this.min.y*e._01,n>=d?(o+=n,t+=d):(o+=d,t+=n),n=this.max.z*e._02,d=this.min.z*e._02,n>=d?(o+=n,t+=d):(o+=d,t+=n),n=this.max.x*e._10,d=this.min.x*e._10,n>=d?(r+=n,i+=d):(r+=d,i+=n),n=this.max.y*e._11,d=this.min.y*e._11,n>=d?(r+=n,i+=d):(r+=d,i+=n),n=this.max.z*e._12,d=this.min.z*e._12,n>=d?(r+=n,i+=d):(r+=d,i+=n),n=this.max.x*e._20,d=this.min.x*e._20,n>=d?(a+=n,s+=d):(a+=d,s+=n),n=this.max.y*e._21,d=this.min.y*e._21,n>=d?(a+=n,s+=d):(a+=d,s+=n),n=this.max.z*e._22,d=this.min.z*e._22,n>=d?(a+=n,s+=d):(a+=d,s+=n),this.min.x=t,this.min.y=i,this.min.z=s,this.max.x=o,this.max.y=r,this.max.z=a,this.updateInternals()},x3dom.fields.BoxVolume.prototype.transformFrom=function(e,t){var i,s,o,r,a,n;i=r=e._03,s=a=e._13,o=n=e._23;var d=t.max.x*e._00,l=t.min.x*e._00;d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.y*e._01,l=t.min.y*e._01,d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.z*e._02,l=t.min.z*e._02,d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.x*e._10,l=t.min.x*e._10,d>=l?(a+=d,s+=l):(a+=l,s+=d),d=t.max.y*e._11,l=t.min.y*e._11,d>=l?(a+=d,s+=l):(a+=l,s+=d),d=t.max.z*e._12,l=t.min.z*e._12,d>=l?(a+=d,s+=l):(a+=l,s+=d),d=t.max.x*e._20,l=t.min.x*e._20,d>=l?(n+=d,o+=l):(n+=l,o+=d),d=t.max.y*e._21,l=t.min.y*e._21,d>=l?(n+=d,o+=l):(n+=l,o+=d),d=t.max.z*e._22,l=t.min.z*e._22,d>=l?(n+=d,o+=l):(n+=l,o+=d),this.min.x=i,this.min.y=s,this.min.z=o,this.max.x=r,this.max.y=a,this.max.z=n,this.updateInternals(),this.valid=!0},x3dom.fields.FrustumVolume=function(e){if(this.planeNormals=[],this.planeDistances=[],this.directionIndex=[],0!==arguments.length){for(var t=[],i=0;i<6;i++)this.planeNormals[i]=new x3dom.fields.SFVec3f(0,0,0),this.planeDistances[i]=0,this.directionIndex[i]=0,t[i]=new x3dom.fields.SFVec4f(0,0,0,0);for(t[0].x=e._30-e._00,t[0].y=e._31-e._01,t[0].z=e._32-e._02,t[0].w=e._33-e._03,t[1].x=e._30+e._00,t[1].y=e._31+e._01,t[1].z=e._32+e._02,t[1].w=e._33+e._03,t[2].x=e._30+e._10,t[2].y=e._31+e._11,t[2].z=e._32+e._12,t[2].w=e._33+e._13,t[3].x=e._30-e._10,t[3].y=e._31-e._11,t[3].z=e._32-e._12,t[3].w=e._33-e._13,t[4].x=e._30+e._20,t[4].y=e._31+e._21,t[4].z=e._32+e._22,t[4].w=e._33+e._23,t[5].x=e._30-e._20,t[5].y=e._31-e._21,t[5].z=e._32-e._22,t[5].w=e._33-e._23,i=0;i<6;i++){var s=Math.sqrt(t[i].x*t[i].x+t[i].y*t[i].y+t[i].z*t[i].z);t[i].x/=s,t[i].y/=s,t[i].z/=s,t[i].w/=-s}var o=function(e){var t=0;return e.x>0&&(t|=1),e.y>0&&(t|=2),e.z>0&&(t|=4),t};this.planeNormals[3].setValues(t[0]),this.planeDistances[3]=t[0].w,this.directionIndex[3]=o(this.planeNormals[3]),this.planeNormals[2].setValues(t[1]),this.planeDistances[2]=t[1].w,this.directionIndex[2]=o(this.planeNormals[2]),this.planeNormals[5].setValues(t[2]),this.planeDistances[5]=t[2].w,this.directionIndex[5]=o(this.planeNormals[5]),this.planeNormals[4].setValues(t[3]),this.planeDistances[4]=t[3].w,this.directionIndex[4]=o(this.planeNormals[4]),this.planeNormals[0].setValues(t[4]),this.planeDistances[0]=t[4].w,this.directionIndex[0]=o(this.planeNormals[0]),this.planeNormals[1].setValues(t[5]),this.planeDistances[1]=t[5].w,this.directionIndex[1]=o(this.planeNormals[1])}},x3dom.fields.FrustumVolume.prototype.intersect=function(e,t){if(this.planeNormals.length<6)return x3dom.debug.logWarning("FrustumVolume not initialized!"),!1;var i=this,s=e.min,o=e.max,r=function(e){var t=new x3dom.fields.SFVec3f(0,0,0);return 1&e?t.x=s.x:t.x=o.x,2&e?t.y=s.y:t.y=o.y,4&e?t.z=s.z:t.z=o.z,t},a=function(e,t){var s=i.planeNormals[e].dot(t)-i.planeDistances[e];return s>=0},n=function(e){var t=r(i.directionIndex[e]);return a(e,t)},d=function(e){var t=r(7^i.directionIndex[e]);return!a(e,t)},l=1;t<0&&(t=0);for(var h=0;h<6;h++,l<<=1)if(0==(t&l)){if(d(h))return-1;n(h)&&(t|=l)}return t},x3dom.docs={},x3dom.docs.specURLMap={CADGeometry:"CADGeometry.html",Core:"core.html",DIS:"dis.html",CubeMapTexturing:"env_texture.html",EnvironmentalEffects:"enveffects.html",EnvironmentalSensor:"envsensor.html",Followers:"followers.html",Geospatial:"geodata.html",Geometry2D:"geometry2D.html",Geometry3D:"geometry3D.html",Grouping:"group.html","H-Anim":"hanim.html",Interpolation:"interp.html",KeyDeviceSensor:"keyboard.html",Layering:"layering.html",Layout:"layout.html",Lighting:"lighting.html",Navigation:"navigation.html",Networking:"networking.html",NURBS:"nurbs.html",ParticleSystems:"particle_systems.html",Picking:"picking.html",PointingDeviceSensor:"pointingsensor.html",Rendering:"rendering.html",RigidBodyPhysics:"rigid_physics.html",Scripting:"scripting.html",Shaders:"shaders.html",Shape:"shape.html",Sound:"sound.html",Text:"text.html",Texturing3D:"texture3D.html",Texturing:"texturing.html",Time:"time.html",EventUtilities:"utils.html",VolumeRendering:"volume.html"},x3dom.docs.specBaseURL="http://www.web3d.org/x3d/specifications/ISO-IEC-19775-1.2-X3D-AbstractSpecification/Part01/components/",x3dom.docs.getNodeTreeInfo=function(){var e,t,i="",s=function(e,t){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},o=function(e,t){for(var s=0;s<t;s++)i+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";i+="<a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"#"+e+"' style='color:black; text-decoration:none; font-weight:bold;'>"+e+"</a> &nbsp; <a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"' style='color:black; text-decoration:none; font-style:italic;'>"+x3dom.nodeTypes[e]._compName+"</a><br/>";for(var s in x3dom.nodeTypes[e].childTypes[e])o(x3dom.nodeTypes[e].childTypes[e][s],t+1)};for(e in x3dom.nodeTypes){var t=x3dom.nodeTypes[e];for(void 0===t.childTypes&&(t.childTypes={});t.superClass;)void 0===t.superClass.childTypes[t.superClass._typeName]&&(t.superClass.childTypes[t.superClass._typeName]=[]),s(t.superClass.childTypes[t.superClass._typeName],t._typeName)||t.superClass.childTypes[t.superClass._typeName].push(t._typeName),t=t.superClass}return o("X3DNode",0),"<div class='x3dom-doc-nodes-tree'>"+i+"</div>"},x3dom.docs.getComponentInfo=function(){var e,t,i,s=[],o="";for(t in x3dom.components)s.push(t);s.sort();for(i in s){t=s[i],e=x3dom.components[t],o+="<h2><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"' style='color:black; text-decoration:none; font-style:italic;'>"+t+"</a></h2>",o+="<ul style='list-style-type:circle;'>";for(var r in e)o+="<li><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"#"+r+"' style='color:black; text-decoration:none; font-weight:bold;'>"+r+"</a></li>";o+="</ul>"}return o},x3dom.shader={},x3dom.shader.PICKING="picking",x3dom.shader.PICKING_24="picking24",x3dom.shader.PICKING_ID="pickingId",x3dom.shader.PICKING_COLOR="pickingColor",x3dom.shader.PICKING_TEXCOORD="pickingTexCoord",x3dom.shader.FRONTGROUND_TEXTURE="frontgroundTexture",x3dom.shader.BACKGROUND_TEXTURE="backgroundTexture",x3dom.shader.BACKGROUND_SKYTEXTURE="backgroundSkyTexture",x3dom.shader.BACKGROUND_CUBETEXTURE="backgroundCubeTexture",x3dom.shader.BLUR="blur",x3dom.shader.DEPTH="depth",x3dom.shader.NORMAL="normal",x3dom.shader.TEXTURE_REFINEMENT="textureRefinement",x3dom.shader.SSAO="ssao",x3dom.shader.material=function(){var e="uniform vec3  diffuseColor;\nuniform vec3  specularColor;\nuniform vec3  emissiveColor;\nuniform float shininess;\nuniform float transparency;\nuniform float ambientIntensity;\n";return e},x3dom.shader.twoSidedMaterial=function(){var e="uniform vec3  backDiffuseColor;\nuniform vec3  backSpecularColor;\nuniform vec3  backEmissiveColor;\nuniform float backShininess;\nuniform float backTransparency;\nuniform float backAmbientIntensity;\n";return e},x3dom.shader.fog=function(){var e="uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nvarying vec3 fragEyePosition;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}\n";return e},x3dom.shader.clipPlanes=function(e){var t,i="";for(t=0;t<e;t++)i+="uniform vec4 clipPlane"+t+"_Plane;\n",i+="uniform float clipPlane"+t+"_CappingStrength;\n",i+="uniform vec3 clipPlane"+t+"_CappingColor;\n";for(i+="vec3 calculateClipPlanes() {\n",t=0;t<e;t++)i+="    vec4 clipPlane"+t+" = clipPlane"+t+"_Plane * viewMatrixInverse;\n",i+="    float dist"+t+" = dot(fragPosition, clipPlane"+t+");\n";for(i+="    if( ",t=0;t<e;t++)0!=t&&(i+=" || "),i+="dist"+t+" < 0.0";for(i+=" ) ",i+="{ discard; }\n",t=0;t<e;t++)i+="    if( abs(dist"+t+") < clipPlane"+t+"_CappingStrength ) ",i+="{ return clipPlane"+t+"_CappingColor; }\n";return i+="    return vec3(-1.0, -1.0, -1.0);\n",i+="}\n"},x3dom.shader.gammaCorrectionDecl=function(e){var t="";return"none"===e.GAMMACORRECTION||("fastlinear"===e.GAMMACORRECTION?(t+="vec4 gammaEncode(vec4 color){\n  vec4 tmp = sqrt(color);\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec4 gammaDecode(vec4 color){\n  vec4 tmp = color * color;\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec3 gammaEncode(vec3 color){\n  return sqrt(color);\n}\n",t+="vec3 gammaDecode(vec3 color){\n  return (color * color);\n}\n"):(t+="const vec4 gammaEncode4Vector = vec4(0.4545454545454545, 0.4545454545454545, 0.4545454545454545, 1.0);\n",t+="const vec4 gammaDecode4Vector = vec4(2.2, 2.2, 2.2, 1.0);\n",t+="vec4 gammaEncode(vec4 color){\n    return pow(color, gammaEncode4Vector);\n}\n",t+="vec4 gammaDecode(vec4 color){\n    return pow(color, gammaDecode4Vector);\n}\n",t+="const vec3 gammaEncode3Vector = vec3(0.4545454545454545, 0.4545454545454545, 0.4545454545454545);\n",t+="const vec3 gammaDecode3Vector = vec3(2.2, 2.2, 2.2);\n",t+="vec3 gammaEncode(vec3 color){\n    return pow(color, gammaEncode3Vector);\n}\n",t+="vec3 gammaDecode(vec3 color){\n    return pow(color, gammaDecode3Vector);\n}\n")),t},x3dom.shader.encodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaEncode ("+t+")"},x3dom.shader.decodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaDecode ("+t+")"},x3dom.shader.rgbaPacking=function(){var e="";return e+="vec4 packDepth(float depth){\n depth = (depth + 1.0)*0.5;\n vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n outVal = fract(outVal);\n   outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n   return outVal;\n}\n",e+="float unpackDepth(vec4 color){\n float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n return (2.0*depth - 1.0);\n}\n"},x3dom.shader.shadowRendering=function(){var e="";return e+="float getLightInfluence(float lType, float lShadowIntensity, float lOn, vec3 lLocation, vec3 lDirection, float lCutOffAngle, float lBeamWidth, vec3 lAttenuation, float lRadius, vec3 eyeCoords) {\n if (lOn == 0.0 || lShadowIntensity == 0.0){ return 0.0;\n } else if (lType == 0.0) {\n  return 1.0;\n } else {\n    float attenuation = 0.0;\n    vec3 lightVec = (lLocation - (eyeCoords));\n    float distance = length(lightVec);\n  lightVec = normalize(lightVec);\n  eyeCoords = normalize(-eyeCoords);\n    if(lRadius == 0.0 || distance <= lRadius) {\n        attenuation = 1.0 / max(lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance), 1.0);\n  }\n   if (lType == 1.0) return attenuation;\n    float spotAngle = acos(max(0.0, dot(-lightVec, normalize(lDirection))));\n    if(spotAngle >= lCutOffAngle) return 0.0;\n    else if(spotAngle <= lBeamWidth) return attenuation;\n    else return attenuation * (spotAngle - lCutOffAngle) / (lBeamWidth - lCutOffAngle);\n }\n}\n",e+="void getShadowValues(inout vec4 shadowMapValues, inout float viewSampleDepth, in mat4 lightMatrix, in vec4 worldCoords, in sampler2D shadowMap){\n vec4 lightSpaceCoords = lightMatrix*worldCoords;\n vec3 lightSpaceCoordsCart = lightSpaceCoords.xyz / lightSpaceCoords.w;\n vec2 textureCoords = (lightSpaceCoordsCart.xy + 1.0)*0.5;\n viewSampleDepth = lightSpaceCoordsCart.z;\n shadowMapValues = texture2D(shadowMap, textureCoords);\n",x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE||(e+=" shadowMapValues = vec4(1.0,1.0,unpackDepth(shadowMapValues),1.0);\n"),e+="}\n",e+="void getShadowValuesPointLight(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec3 lLocation, in vec4 worldCoords, in mat4 lightViewMatrix,in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2, in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5,in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2, in sampler2D shadowMap_3,in sampler2D shadowMap_4, in sampler2D shadowMap_5){\n vec4 transformed = lightViewMatrix * worldCoords;\n vec3 lightVec = normalize(transformed.xyz/transformed.w);\n vec3 lightVecAbs = abs(lightVec);\n float maximum = max(max(lightVecAbs.x, lightVecAbs.y),lightVecAbs.z);\n if (lightVecAbs.x == maximum) {\n  if (lightVec.x < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3,worldCoords,shadowMap_3);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1,worldCoords,shadowMap_1);\n }\n else if (lightVecAbs.y == maximum) {\n  if (lightVec.y < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4,worldCoords,shadowMap_4);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5,worldCoords,shadowMap_5);\n }\n else if (lightVec.z < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0,worldCoords,shadowMap_0);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2,worldCoords,shadowMap_2);\n}\n",e+="void getShadowValuesCascaded(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec4 worldCoords, in float eyeDepth, in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2,in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5, in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2,in sampler2D shadowMap_3, in sampler2D shadowMap_4, in sampler2D shadowMap_5, in float split_0, in float split_1, in float split_2, in float split_3, in float split_4){\n if (eyeDepth < split_0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0, worldCoords, shadowMap_0);\n else if (eyeDepth < split_1) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1, worldCoords, shadowMap_1);\n else if (eyeDepth < split_2) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2, worldCoords, shadowMap_2);\n else if (eyeDepth < split_3) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3, worldCoords, shadowMap_3);\n else if (eyeDepth < split_4) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4, worldCoords, shadowMap_4);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5, worldCoords, shadowMap_5);\n}\n",e+="float ESM(float shadowMapDepth, float viewSampleDepth, float offset){\n",e+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?" return exp(-80.0*(1.0-offset)*(viewSampleDepth - shadowMapDepth));\n":" return shadowMapDepth * exp(-80.0*(1.0-offset)*viewSampleDepth);\n",e+="}\n",e+="float VSM(vec2 moments, float viewSampleDepth, float offset){\n viewSampleDepth = (viewSampleDepth + 1.0) * 0.5;\n if (viewSampleDepth <= moments.x) return 1.0;\n float variance = moments.y - moments.x * moments.x;\n variance = max(variance, 0.00002 + offset*0.01);\n float d = viewSampleDepth - moments.x;\n return variance/(variance + d*d);\n}\n"},x3dom.shader.light=function(e){for(var t="",i=0;i<e;i++)t+="uniform float light"+i+"_On;\nuniform float light"+i+"_Type;\nuniform vec3  light"+i+"_Location;\nuniform vec3  light"+i+"_Direction;\nuniform vec3  light"+i+"_Color;\nuniform vec3  light"+i+"_Attenuation;\nuniform float light"+i+"_Radius;\nuniform float light"+i+"_Intensity;\nuniform float light"+i+"_AmbientIntensity;\nuniform float light"+i+"_BeamWidth;\nuniform float light"+i+"_CutOffAngle;\nuniform float light"+i+"_ShadowIntensity;\n";return t+="vec3 lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, float shin, float ambIntensity)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n  V = normalize(V);\n  attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n  L = normalize(L);\n  V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n        attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n  }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = clamp(dot(L, N), 0.0, 1.0);\n   float NdotH = clamp(dot(H, N), 0.0, 1.0);\n   float ambientFactor  = lAmbientIntensity * ambIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shin*128.0);\n   return vec3(ambientFactor, diffuseFactor, specularFactor) * attentuation * spot;\n}\n";
},x3dom.shader.TBNCalculation=function(){var e="";return e+="mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\n",e+="vec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = 2.0 * map - 1.0;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n"},x3dom.shader.DynamicShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShader.prototype.generateVertexShader=function(e,t){var i="";if(i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",3==t.POSCOMPONENTS?i+="attribute vec3 position;\n":4==t.POSCOMPONENTS&&(i+="attribute vec4 position;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var s=0;s<t.IG_PRECISION;s++)i+="uniform sampler2D IG_coords"+s+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}if(t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.LIGHTS&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="varying vec3 fragNormal;\n",i+="uniform mat4 normalMatrix;\n",t.IMAGEGEOMETRY?i+="uniform sampler2D IG_normals;\n":2==t.NORCOMPONENTS?4!=t.POSCOMPONENTS&&(i+="attribute vec2 normal;\n"):3==t.NORCOMPONENTS&&(i+="attribute vec3 normal;\n"))),t.VERTEXCOLOR&&(t.IMAGEGEOMETRY?(i+="uniform sampler2D IG_colors;\n",3==t.COLCOMPONENTS?i+="varying vec3 fragColor;\n":4==t.COLCOMPONENTS&&(i+="varying vec4 fragColor;\n")):3==t.COLCOMPONENTS?(i+="attribute vec3 color;\n",i+="varying vec3 fragColor;\n"):4==t.COLCOMPONENTS&&(i+="attribute vec4 color;\n",i+="varying vec4 fragColor;\n")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",t.SPHEREMAPPING||(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_texCoords;\n":t.IS_PARTICLE||(i+="attribute vec2 texcoord;\n")),t.TEXTRAFO&&(i+="uniform mat4 texTrafoMatrix;\n"),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&!x3dom.caps.STD_DERIVATIVES&&(x3dom.debug.logWarning("Your System doesn't support the 'OES_STANDARD_DERIVATIVES' Extension. You must set tangents and binormals manually via the FloatVertexAttribute-Node to use normal maps"),i+="attribute vec3 tangent;\n",i+="attribute vec3 binormal;\n",i+="varying vec3 fragTangent;\n",i+="varying vec3 fragBinormal;\n"),t.CUBEMAP&&(i+="varying vec3 fragViewDir;\n",i+="uniform mat4 viewMatrix;\n"),t.DISPLACEMENTMAP&&(i+="uniform sampler2D displacementMap;\n",i+="uniform float displacementFactor;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n",i+="uniform float displacementAxis;\n"),t.DIFFPLACEMENTMAP&&(i+="uniform sampler2D diffuseDisplacementMap;\n",i+="uniform float displacementFactor;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n",i+="uniform float displacementAxis;\n")),t.VERTEXID&&(i+="attribute float id;\n",i+="varying float fragID;\n"),t.IS_PARTICLE&&(i+="attribute vec3 particleSize;\n"),(t.LIGHTS||t.FOG||t.CLIPPLANES)&&(i+="uniform vec3 eyePosition;\n",i+="varying vec4 fragPosition;\n",t.FOG&&(i+="varying vec3 fragEyePosition;\n")),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXNOR&&(i+="uniform float bgPrecisionNorMax;\n"),t.REQUIREBBOXCOL&&(i+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(i+="uniform float bgPrecisionTexMax;\n"),i+="void main(void) {\n",t.IMAGEGEOMETRY){t.IG_INDEXED?(i+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",i+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var s=0;s<t.IG_PRECISION;s++)i+="temp = 255.0 * texture2D( IG_coords"+s+", IG_texCoord ).rgb;\n",i+="vertPosition *= 256.0;\n",i+="vertPosition += temp;\n";i+="vertPosition /= (pow(2.0, 8.0 * "+t.IG_PRECISION+".0) - 1.0);\n",i+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",t.LIGHTS&&(i+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",i+="vertNormal = vertNormal * 2.0 - 1.0;\n"),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="fragColor = texture2D( IG_colors, IG_texCoord ).rgb;\n":4==t.COLCOMPONENTS&&(i+="fragColor = texture2D( IG_colors, IG_texCoord ).rgba;\n")),t.TEXTURED&&(i+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",i+="vec2 vertTexCoord;",i+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",i+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else i+="vec3 vertPosition = position.xyz;\n",t.POPGEOMETRY?(i+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",i+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",i+="   vertPosition /= (65536.0 - PG_powPrecision);\n",i+="}\n",i+="else {\n",i+="   vertPosition /= bgPrecisionMax;\n",i+="}\n",i+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),t.LIGHTS&&(2==t.NORCOMPONENTS?(4==t.POSCOMPONENTS?(i+="vec3 vertNormal = vec3(position.w / 256.0); \n",i+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",i+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):t.REQUIREBBOXNOR&&(i+="vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n"),i+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",i+="vec4 sinCosThetaPhi = sin( vec4(thetaPhi, thetaPhi + 1.5707963267949) ); \n",i+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",i+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",i+="vertNormal.z = sinCosThetaPhi.z; \n"):t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="vec3 vertNormal = normal;\n",t.REQUIREBBOXNOR&&(i+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),t.POPGEOMETRY&&(i+="vertNormal = 2.0*vertNormal - 1.0;\n"))),t.VERTEXCOLOR&&(i+="fragColor = color;\n",t.REQUIREBBOXCOL&&(i+="fragColor = fragColor / bgPrecisionColMax;\n")),t.TEXTURED&&!t.SPHEREMAPPING&&(t.IS_PARTICLE?i+="vec2 vertTexCoord = vec2(0.0);\n":(i+="vec2 vertTexCoord = texcoord;\n",t.REQUIREBBOXTEX&&(i+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n")));t.LIGHTS&&(!t.DISPLACEMENTMAP&&!t.DIFFPLACEMENTMAP||t.NORMALMAP?t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="fragNormal = (normalMatrix * vec4(vertNormal, 0.0)).xyz;\n"):(i+="float dx = 1.0 / displacementWidth;\n",i+="float dy = 1.0 / displacementHeight;\n",t.DISPLACEMENTMAP?(i+="float s1 = texture2D(displacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).r;\n",i+="float s2 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).r;\n",i+="float s3 = texture2D(displacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).r;\n",i+="float s4 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).r;\n"):t.DIFFPLACEMENTMAP&&(i+="float s1 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).a;\n",i+="float s2 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).a;\n",i+="float s3 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).a;\n",i+="float s4 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).a;\n"),i+="float coef = displacementFactor;\n",i+="vec3 calcNormal;\n",i+="if (displacementAxis == 0.0) {\n",i+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",i+="} else if(displacementAxis == 1.0) {\n",i+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",i+="} else {\n",i+="calcNormal = vec3((s1 - s3) * coef, -(s2 - s4) * coef, 5.0);\n",i+="}\n",i+="calcNormal = normalize(calcNormal);\n",i+="fragNormal = (normalMatrix * vec4(calcNormal, 0.0)).xyz;\n")),t.TEXTURED&&(t.CUBEMAP&&(i+="fragViewDir = (viewMatrix[3].xyz);\n"),t.SPHEREMAPPING?i+=" fragTexcoord = 0.5 + fragNormal.xy / 2.0;\n":t.TEXTRAFO?i+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(i+=" fragTexcoord = vertTexCoord;\n",t.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(i+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&!x3dom.caps.STD_DERIVATIVES&&(i+="fragTangent  = (normalMatrix * vec4(tangent, 0.0)).xyz;\n",i+="fragBinormal = (normalMatrix * vec4(binormal, 0.0)).xyz;\n")),(t.LIGHTS||t.FOG||t.CLIPPLANES)&&(i+="fragPosition = (modelViewMatrix * vec4(vertPosition, 1.0));\n",t.FOG&&(i+="fragEyePosition = eyePosition - fragPosition.xyz;\n")),t.MULTIDIFFALPMAP&&(i+="fragID = id;\n"),t.DISPLACEMENTMAP?i+="vertPosition += normalize(vertNormal) * texture2D(displacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).r * displacementFactor;\n":t.DIFFPLACEMENTMAP&&(i+="vertPosition += normalize(vertNormal) * texture2D(diffuseDisplacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).a * displacementFactor;\n"),i+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",t.IS_PARTICLE?(i+="float spriteDist = (gl_Position.w > 0.000001) ? gl_Position.w : 0.000001;\n",i+="float pointSize = floor(length(particleSize) * 256.0 / spriteDist + 0.5);\n",i+="gl_PointSize = clamp(pointSize, 2.0, 256.0);\n"):i+="gl_PointSize = 2.0;\n",i+="}\n";var o=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+i),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(o))),o},x3dom.shader.DynamicShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";if(i+=" precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="uniform mat4 modelMatrix;\n",i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 viewMatrixInverse;\n",i+=x3dom.shader.material(),t.TWOSIDEDMAT&&(i+=x3dom.shader.twoSidedMaterial()),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="varying vec3 fragColor;  \n":4==t.COLCOMPONENTS&&(i+="varying vec4 fragColor;  \n")),(t.CUBEMAP||t.CLIPPLANES)&&(i+="uniform mat4 modelViewMatrixInverse;\n"),t.VERTEXID&&(i+="varying float fragID;\n",t.MULTIDIFFALPMAP&&(i+="uniform sampler2D multiDiffuseAlphaMap;\n",i+="uniform float multiDiffuseAlphaWidth;\n",i+="uniform float multiDiffuseAlphaHeight;\n"),t.MULTIEMIAMBMAP&&(i+="uniform sampler2D multiEmissiveAmbientMap;\n",i+="uniform float multiEmissiveAmbientWidth;\n",i+="uniform float multiEmissiveAmbientHeight;\n"),t.MULTISPECSHINMAP&&(i+="uniform sampler2D multiSpecularShininessMap;\n",i+="uniform float multiSpecularShininessWidth;\n",i+="uniform float multiSpecularShininessHeight;\n"),t.MULTIVISMAP&&(i+="uniform sampler2D multiVisibilityMap;\n",i+="uniform float multiVisibilityWidth;\n",i+="uniform float multiVisibilityHeight;\n")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",(t.TEXTURED||t.DIFFUSEMAP)&&(i+="uniform sampler2D diffuseMap;\n"),t.CUBEMAP&&(i+="uniform samplerCube environmentMap;\n",i+="varying vec3 fragViewDir;\n"),t.SPECMAP&&(i+="uniform sampler2D specularMap;\n"),t.SHINMAP&&(i+="uniform sampler2D shininessMap;\n"),t.DISPLACEMENTMAP&&(i+="uniform sampler2D displacementMap;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n"),t.DIFFPLACEMENTMAP&&(i+="uniform sampler2D diffuseDisplacementMap;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n"),t.NORMALMAP&&(i+="uniform sampler2D normalMap;\n","TANGENT"==t.NORMALSPACE?x3dom.caps.STD_DERIVATIVES?(i+="#extension GL_OES_standard_derivatives:enable\n",i+=x3dom.shader.TBNCalculation()):(i+="varying vec3 fragTangent;\n",i+="varying vec3 fragBinormal;\n"):"OBJECT"==t.NORMALSPACE&&(i+="uniform mat4 normalMatrix;\n"))),t.FOG&&(i+=x3dom.shader.fog()),(t.LIGHTS||t.CLIPPLANES)&&(i+="varying vec4 fragPosition;\n"),t.LIGHTS&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="varying vec3 fragNormal;\n"),i+=x3dom.shader.light(t.LIGHTS)),t.CLIPPLANES&&(i+=x3dom.shader.clipPlanes(t.CLIPPLANES)),i+=x3dom.shader.gammaCorrectionDecl(t),i+="void main(void) {\n",t.CLIPPLANES&&(i+="vec3 cappingColor = calculateClipPlanes();\n"),i+="vec4 color;\n",i+="color.rgb = "+x3dom.shader.decodeGamma(t,"diffuseColor")+";\n",i+="color.a = 1.0 - transparency;\n",i+="vec3 _emissiveColor     = emissiveColor;\n",i+="float _shininess        = shininess;\n",i+="vec3 _specularColor     = specularColor;\n",i+="float _ambientIntensity = ambientIntensity;\n",i+="float _transparency     = transparency;\n",(t.MULTIVISMAP||t.MULTIDIFFALPMAP||t.MULTISPECSHINMAP||t.MULTIEMIAMBMAP)&&(i+="vec2 idCoord;\n",i+="float roundedIDVisibility = floor(fragID+0.5);\n",i+="float roundedIDMaterial = floor(fragID+0.5);\n",i+="if(!gl_FrontFacing) {\n",i+="    roundedIDMaterial = floor(fragID + (multiDiffuseAlphaWidth*multiDiffuseAlphaWidth) + 0.5);\n",i+="}\n"),t.MULTIVISMAP&&(i+="idCoord.x = mod(roundedIDVisibility, multiVisibilityWidth) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",i+="idCoord.y = floor(roundedIDVisibility / multiVisibilityWidth) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",i+="vec4 visibility = texture2D( multiVisibilityMap, idCoord );\n",i+="if (visibility.r < 1.0) discard; \n"),t.MULTIDIFFALPMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaWidth) + (0.5 / multiDiffuseAlphaWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaHeight) + (0.5 / multiDiffuseAlphaHeight);\n",i+="vec4 diffAlpha = texture2D( multiDiffuseAlphaMap, idCoord );\n",i+="color.rgb = "+x3dom.shader.decodeGamma(t,"diffAlpha.rgb")+";\n",i+="_transparency = 1.0 - diffAlpha.a;\n",i+="color.a = diffAlpha.a;\n"),t.MULTIEMIAMBMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaWidth) + (0.5 / multiDiffuseAlphaWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaHeight) + (0.5 / multiDiffuseAlphaHeight);\n",i+="vec4 emiAmb = texture2D( multiEmissiveAmbientMap, idCoord );\n",i+="_emissiveColor = emiAmb.rgb;\n",i+="_ambientIntensity = emiAmb.a;\n"),t.VERTEXCOLOR&&(3===t.COLCOMPONENTS?i+="color.rgb = "+x3dom.shader.decodeGamma(t,"fragColor")+";\n":4===t.COLCOMPONENTS&&(i+="color = "+x3dom.shader.decodeGamma(t,"fragColor")+";\n")),t.LIGHTS){if(i+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",i+="vec3 eye    = -fragPosition.xyz;\n",i+=t.NORMALMAP&&"OBJECT"==t.NORMALSPACE?"vec3 normal  = vec3(0.0, 0.0, 0.0);\n":"vec3 normal    = normalize(fragNormal);\n",t.NORMALMAP&&("TANGENT"==t.NORMALSPACE?(i+="vec3 n = normal;\n",x3dom.caps.STD_DERIVATIVES?i+="normal = perturb_normal( n, fragPosition.xyz, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) );\n":(i+="vec3 t = normalize( fragTangent );\n",i+="vec3 b = normalize( fragBinormal );\n",i+="mat3 tangentToWorld = mat3(t, b, n);\n",i+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",i+="normal = 2.0 * normal - 1.0;\n",i+="normal = normalize( normal * tangentToWorld );\n",i+="normal.y = -normal.y;\n",i+="normal.x = -normal.x;\n")):"OBJECT"==t.NORMALSPACE&&(i+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",i+="normal = 2.0 * normal - 1.0;\n",i+="normal = (normalMatrix * vec4(normal, 0.0)).xyz;\n",i+="normal = normalize(normal);\n")),t.SHINMAP&&(i+="_shininess = texture2D( shininessMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).r;\n"),t.SPECMAP&&(i+="_specularColor = "+x3dom.shader.decodeGamma(t,"texture2D(specularMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).rgb")+";\n"),t.MULTISPECSHINMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiSpecularShininessWidth) * (1.0 / multiSpecularShininessWidth) + (0.5 / multiSpecularShininessWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiSpecularShininessWidth) * (1.0 / multiSpecularShininessHeight) + (0.5 / multiSpecularShininessHeight);\n",i+="vec4 specShin = texture2D( multiSpecularShininessMap, idCoord );\n",i+="_specularColor = specShin.rgb;\n",i+="_shininess = specShin.a;\n"),t.SOLID&&!t.TWOSIDEDMAT||(i+="if (dot(normal, eye) < 0.0) {\n",i+="  normal *= -1.0;\n",i+="}\n"),t.SEPARATEBACKMAT&&(i+="  if(!gl_FrontFacing) {\n",i+="    color.rgb = "+x3dom.shader.decodeGamma(t,"backDiffuseColor")+";\n",i+="    color.a = 1.0 - backTransparency;\n",i+="    _transparency = 1.0 - backTransparency;\n",i+="    _shininess = backShininess;\n",i+="    _emissiveColor = backEmissiveColor;\n",i+="    _specularColor = backSpecularColor;\n",i+="    _ambientIntensity = backAmbientIntensity;\n",i+="  }\n"),t.LIGHTS){i+="vec3 ads;\n";for(var s=0;s<t.LIGHTS;s++){var o="light"+s+"_Color";i+="ads = lighting(light"+s+"_Type, light"+s+"_Location, light"+s+"_Direction, "+o+", light"+s+"_Attenuation, light"+s+"_Radius, light"+s+"_Intensity, light"+s+"_AmbientIntensity, light"+s+"_BeamWidth, light"+s+"_CutOffAngle, normal, eye, _shininess, _ambientIntensity);\n",i+="   ambient  += "+o+" * ads.r;\n   diffuse  += "+o+" * ads.g;\n   specular += "+o+" * ads.b;\n"}i+="ambient = max(ambient, 0.0);\n",i+="diffuse = max(diffuse, 0.0);\n",i+="specular = max(specular, 0.0);\n"}t.TEXTURED&&(t.DIFFUSEMAP||t.DIFFPLACEMENTMAP||t.TEXT||t.CUBEMAP)?(t.CUBEMAP&&(i+="vec3 viewDir = normalize(fragViewDir);\n",i+="vec3 reflected = reflect(-eye, normal);\n",i+="reflected = (modelViewMatrixInverse * vec4(reflected, 0.0)).xyz;\n",i+="vec4 envColor = "+x3dom.shader.decodeGamma(t,"textureCube(environmentMap, reflected)")+";\n",i+="color.a *= envColor.a;\n"),t.DIFFPLACEMENTMAP?(i+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",i+="vec4 texColor = texture2D(diffuseDisplacementMap, texCoord);\n"):(t.DIFFUSEMAP||t.TEXT)&&(i+=t.PIXELTEX?"vec2 texCoord = fragTexcoord;\n":"vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",i+="vec4 texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texCoord)")+";\n",i+="color.a *= texColor.a;\n"),t.BLENDING?(i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * color.rgb + specular*_specularColor);\n",(t.DIFFUSEMAP||t.TEXT)&&(i+="color.rgb *= texColor.rgb;\n"),t.CUBEMAP&&(i+="color.rgb *= envColor.rgb;\n")):i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * texColor.rgb + specular*_specularColor);\n"):i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * color.rgb + specular*_specularColor);\n"}else t.APPMAT&&!t.VERTEXCOLOR&&(i+="color = vec4(0.0, 0.0, 0.0, 1.0 - _transparency);\n"),t.TEXTURED&&(t.DIFFUSEMAP||t.DIFFPLACEMENTMAP||t.TEXT)?(i+=t.PIXELTEX?"vec2 texCoord = fragTexcoord;\n":"vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",t.IS_PARTICLE&&(i+="texCoord = clamp(gl_PointCoord, 0.01, 0.99);\n"),i+="vec4 texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texCoord)")+";\n",i+="color.a = texColor.a;\n",t.BLENDING||t.IS_PARTICLE?(i+="color.rgb += _emissiveColor.rgb;\n",i+="color.rgb *= texColor.rgb;\n"):i+="color = texColor;\n"):t.VERTEXCOLOR||t.POINTLINE2D?!t.VERTEXCOLOR&&t.POINTLINE2D?(i+="color.rgb = _emissiveColor;\n",t.IS_PARTICLE&&(i+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",i+="color.rgb *= vec3(pAlpha);\n",i+="color.a = pAlpha;\n")):t.IS_PARTICLE&&(i+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",i+="color.rgb *= vec3(pAlpha);\n",i+="color.a = pAlpha;\n"):i+="color.rgb += _emissiveColor;\n";t.CLIPPLANES&&(i+="if (cappingColor.r != -1.0) {\n",i+="    color.rgb = cappingColor;\n",i+="}\n"),i+=t.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= "+t.ALPHATHRESHOLD+") discard;\n",i+="color = clamp(color, 0.0, 1.0);\n",i+="color = "+x3dom.shader.encodeGamma(t,"color")+";\n",t.FOG&&(i+="float f0 = calcFog(fragEyePosition);\n",i+="color.rgb = fogColor * (1.0-f0) + f0 * (color.rgb);\n"),i+="gl_FragColor = color;\n",i+="}\n";var r=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+i),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(r))),r},x3dom.shader.DynamicMobileShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicMobileShader.prototype.generateVertexShader=function(e,t){var i="";if(i+=x3dom.shader.material(),t.TWOSIDEDMAT&&(i+=x3dom.shader.twoSidedMaterial()),i+="uniform mat4 normalMatrix;\n",i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",3==t.POSCOMPONENTS?i+="attribute vec3 position;\n":4==t.POSCOMPONENTS&&(i+="attribute vec4 position;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var s=0;s<t.IG_PRECISION;s++)i+="uniform sampler2D IG_coords"+s+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}if(t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.POINTLINE2D||(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_normals;\n":2==t.NORCOMPONENTS?4!=t.POSCOMPONENTS&&(i+="attribute vec2 normal;\n"):3==t.NORCOMPONENTS&&(i+="attribute vec3 normal;\n")),i+="varying vec4 fragColor;\n",t.VERTEXCOLOR&&(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_colors;":3==t.COLCOMPONENTS?i+="attribute vec3 color;":4==t.COLCOMPONENTS&&(i+="attribute vec4 color;")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",i+=t.IMAGEGEOMETRY?"uniform sampler2D IG_texCoords;":"attribute vec2 texcoord;\n",t.TEXTRAFO&&(i+="uniform mat4 texTrafoMatrix;\n"),t.BLENDING||(i+="varying vec3 fragAmbient;\n",i+="varying vec3 fragDiffuse;\n"),t.CUBEMAP&&(i+="varying vec3 fragViewDir;\n",i+="varying vec3 fragNormal;\n",i+="uniform mat4 viewMatrix;\n")),t.FOG&&(i+=x3dom.shader.fog()),t.LIGHTS&&(i+=x3dom.shader.light(t.LIGHTS)),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXNOR&&(i+="uniform float bgPrecisionNorMax;\n"),t.REQUIREBBOXCOL&&(i+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(i+="uniform float bgPrecisionTexMax;\n"),i+="void main(void) {\n",i+="gl_PointSize = 2.0;\n",t.IMAGEGEOMETRY){t.IG_INDEXED?(i+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",i+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var s=0;s<t.IG_PRECISION;s++)i+="temp = 255.0 * texture2D( IG_coords"+s+", IG_texCoord ).rgb;\n",i+="vertPosition *= 256.0;\n",i+="vertPosition += temp;\n";i+="vertPosition /= (pow(2.0, 8.0 * "+t.IG_PRECISION+".0) - 1.0);\n",i+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",t.POINTLINE2D||(i+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",i+="vertNormal = vertNormal * 2.0 - 1.0;\n"),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="vec3 vertColor = texture2D( IG_colors, IG_texCoord ).rgb;":4==t.COLCOMPONENTS&&(i+="vec4 vertColor = texture2D( IG_colors, IG_texCoord ).rgba;")),t.TEXTURED&&(i+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",i+="vec2 vertTexCoord;",i+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",i+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else i+="vec3 vertPosition = position.xyz;\n",t.POPGEOMETRY?(i+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",i+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",i+="   vertPosition /= (65536.0 - PG_powPrecision);\n",i+="}\n",i+="else {\n",i+="   vertPosition /= bgPrecisionMax;\n",i+="}\n",i+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),t.POINTLINE2D||(2==t.NORCOMPONENTS?(4==t.POSCOMPONENTS?(i+="vec3 vertNormal = vec3(position.w / 256.0); \n",i+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",i+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):i+=t.REQUIREBBOXNOR?"vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n":"vec3 vertNormal = vec3(normal.xy, 0.0);\n",i+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",i+="vec4 sinCosThetaPhi = vec4(thetaPhi, thetaPhi + 1.5707963267949); \n",i+="vec4 thetaPhiPow2 = sinCosThetaPhi * sinCosThetaPhi; \n",i+="vec4 thetaPhiPow3 =  thetaPhiPow2  * sinCosThetaPhi; \n",i+="vec4 thetaPhiPow5 =  thetaPhiPow3  * thetaPhiPow2; \n",i+="vec4 thetaPhiPow7 =  thetaPhiPow5  * thetaPhiPow2; \n",i+="vec4 thetaPhiPow9 =  thetaPhiPow7  * thetaPhiPow2; \n",i+="sinCosThetaPhi +=  -0.16666666667   * thetaPhiPow3; \n",i+="sinCosThetaPhi +=   0.00833333333   * thetaPhiPow5; \n",i+="sinCosThetaPhi +=  -0.000198412698  * thetaPhiPow7; \n",i+="sinCosThetaPhi +=   0.0000027557319 * thetaPhiPow9; \n",i+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",i+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",i+="vertNormal.z = sinCosThetaPhi.z; \n"):(i+="vec3 vertNormal = normal;\n",t.REQUIREBBOXNOR&&(i+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),t.POPGEOMETRY&&(i+="vertNormal = 2.0*vertNormal - 1.0;\n"))),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="vec3 vertColor = color;":4==t.COLCOMPONENTS&&(i+="vec4 vertColor = color;"),t.REQUIREBBOXCOL&&(i+="vertColor = vertColor / bgPrecisionColMax;\n")),t.TEXTURED&&(i+="vec2 vertTexCoord = texcoord;\n",t.REQUIREBBOXTEX&&(i+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"));if(i+="vec3 positionMV = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",t.POINTLINE2D||(i+="vec3 normalMV = normalize( (normalMatrix * vec4(vertNormal, 0.0)).xyz );\n"),i+="vec3 eye = -positionMV;\n",t.VERTEXCOLOR?(i+="vec3 rgb = vertColor.rgb;\n",4==t.COLCOMPONENTS?i+="float alpha = vertColor.a;\n":3==t.COLCOMPONENTS&&(i+="float alpha = 1.0 - transparency;\n")):(i+="vec3 rgb = diffuseColor;\n",i+="float alpha = 1.0 - transparency;\n"),t.TEXTURED&&(t.CUBEMAP?(i+="fragViewDir = viewMatrix[3].xyz;\n",i+="fragNormal = normalMV;\n"):t.SPHEREMAPPING?i+=" fragTexcoord = 0.5 + normalMV.xy / 2.0;\n":t.TEXTRAFO?i+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(i+=" fragTexcoord = vertTexCoord;\n",t.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(i+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);"))),t.LIGHTS){if(i+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",i+="float _shininess     = shininess;\n",i+="vec3 _specularColor  = specularColor;\n",i+="vec3 _emissiveColor  = emissiveColor;\n",i+="float _ambientIntensity = ambientIntensity;\n",t.SOLID&&!t.TWOSIDEDMAT||(i+="if (dot(normalMV, eye) < 0.0) {\n",i+="  normalMV *= -1.0;\n",t.SEPARATEBACKMAT&&(i+="    rgb = backDiffuseColor;\n",i+="    alpha = 1.0 - backTransparency;\n",i+="    _shininess = backShininess;\n",i+="    _emissiveColor = backEmissiveColor;\n",i+="    _specularColor = backSpecularColor;\n",i+="    _ambientIntensity = backAmbientIntensity;\n"),i+="  }\n"),t.LIGHTS){i+="vec3 ads;\n";for(var o=0;o<t.LIGHTS;o++){var r="light"+o+"_Color";i+="ads = lighting(light"+o+"_Type, light"+o+"_Location, light"+o+"_Direction, "+r+", light"+o+"_Attenuation, light"+o+"_Radius, light"+o+"_Intensity, light"+o+"_AmbientIntensity, light"+o+"_BeamWidth, light"+o+"_CutOffAngle, normalMV, eye, _shininess, _ambientIntensity);\n",i+="   ambient  += "+r+" * ads.r;\n   diffuse  += "+r+" * ads.g;\n   specular += "+r+" * ads.b;\n"}i+="ambient = max(ambient, 0.0);\n",i+="diffuse = max(diffuse, 0.0);\n",i+="specular = max(specular, 0.0);\n"}t.TEXTURED&&!t.BLENDING?(i+="fragAmbient = ambient;\n",i+="fragDiffuse = diffuse;\n",i+="fragColor.rgb = (_emissiveColor + specular*_specularColor);\n",i+="fragColor.a = alpha;\n"):(i+="fragColor.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * rgb + specular*_specularColor);\n",i+="fragColor.a = alpha;\n")}else t.APPMAT&&!t.VERTEXCOLOR&&(i+="rgb = vec3(0.0, 0.0, 0.0);\n"),t.TEXTURED&&!t.BLENDING?(i+="fragAmbient = vec3(0.0);\n",i+="fragDiffuse = vec3(1.0);\n",i+="fragColor.rgb = vec3(0.0);\n",i+="fragColor.a = alpha;\n"):!t.VERTEXCOLOR&&t.POINTLINE2D?(i+="fragColor.rgb = emissiveColor;\n",i+="fragColor.a = alpha;\n"):(i+="fragColor.rgb = rgb + emissiveColor;\n",i+="fragColor.a = alpha;\n");t.FOG&&(i+="float f0 = calcFog(-positionMV);\n",i+="fragColor.rgb = fogColor * (1.0-f0) + f0 * (fragColor.rgb);\n"),i+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",i+="}\n";var a=e.createShader(e.VERTEX_SHADER);return e.shaderSource(a,i),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] VertexShader "+e.getShaderInfoLog(a)),a},x3dom.shader.DynamicMobileShader.prototype.generateFragmentShader=function(e,t){
var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";i+="precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="varying vec4 fragColor;\n",t.TEXTURED&&(t.CUBEMAP?(i+="uniform samplerCube cubeMap;\n",i+="varying vec3 fragViewDir;\n",i+="varying vec3 fragNormal;\n",i+="uniform mat4 modelViewMatrixInverse;\n"):(i+="uniform sampler2D diffuseMap;           \n",i+="varying vec2 fragTexcoord;       \n"),t.BLENDING||(i+="varying vec3 fragAmbient;\n",i+="varying vec3 fragDiffuse;\n")),i+="void main(void) {\n",i+="vec4 color = fragColor;\n",t.TEXTURED&&(t.CUBEMAP?(i+="vec3 normal = normalize(fragNormal);\n",i+="vec3 viewDir = normalize(fragViewDir);\n",i+="vec3 reflected = reflect(viewDir, normal);\n",i+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",i+="vec4 texColor = textureCube(cubeMap, reflected);\n"):i+="vec4 texColor = texture2D(diffuseMap, vec2(fragTexcoord.s, 1.0-fragTexcoord.t));\n",t.BLENDING?t.CUBEMAP?(i+="color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n",i+="color.a = texColor.a;\n"):(i+="color.rgb *= texColor.rgb;\n",i+="color.a *= texColor.a;\n"):(i+="color.rgb += max(fragAmbient + fragDiffuse, 0.0) * texColor.rgb;\n",i+="color.a *= texColor.a;\n")),i+=t.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= 0.1) discard;\n",i+="gl_FragColor = clamp(color, 0.0, 1.0);\n",i+="}\n";var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.DynamicShaderPicking=function(e,t,i){this.program=e.createProgram();var s=this.generateVertexShader(e,t,i),o=this.generateFragmentShader(e,t,i);return e.attachShader(this.program,s),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShaderPicking.prototype.generateVertexShader=function(e,t,i){var s="";if(s+="uniform mat4 modelMatrix;\n",s+="uniform mat4 modelViewProjectionMatrix;\n",s+="attribute vec3 position;\n",s+="uniform vec3 from;\n",s+="varying vec3 worldCoord;\n",1==i?(s+="attribute vec3 color;\n",s+="varying vec3 fragColor;\n"):2==i&&(s+="attribute vec2 texcoord;\n",s+="varying vec3 fragColor;\n"),t.REQUIREBBOX&&(s+="uniform vec3 bgCenter;\n",s+="uniform vec3 bgSize;\n",s+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXCOL&&(s+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(s+="uniform float bgPrecisionTexMax;\n"),t.VERTEXID&&(s+="uniform float shadowIDs;\n",s+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",s+="varying float fragID;\n",s+="attribute float id;\n"),t.IMAGEGEOMETRY){s+="uniform vec3 IG_bboxMin;\n",s+="uniform vec3 IG_bboxMax;\n",s+="uniform float IG_coordTextureWidth;\n",s+="uniform float IG_coordTextureHeight;\n",s+="uniform vec2 IG_implicitMeshSize;\n";for(var o=0;o<t.IG_PRECISION;o++)s+="uniform sampler2D IG_coords"+o+"\n;";t.IG_INDEXED&&(s+="uniform sampler2D IG_index;\n",s+="uniform float IG_indexTextureWidth;\n",s+="uniform float IG_indexTextureHeight;\n")}t.POPGEOMETRY&&(s+="uniform float PG_precisionLevel;\n",s+="uniform float PG_powPrecision;\n",s+="uniform vec3 PG_maxBBSize;\n",s+="uniform vec3 PG_bbMin;\n",s+="uniform vec3 PG_bbMaxModF;\n",s+="uniform vec3 PG_bboxShiftVec;\n",s+="uniform float PG_numAnchorVertices;\n",s+="attribute float PG_vertexID;\n"),t.CLIPPLANES&&(s+="uniform mat4 modelViewMatrix;\n",s+="varying vec4 fragPosition;\n"),s+="void main(void) {\n",s+="gl_PointSize = 2.0;\n",s+="vec3 pos = position;\n",t.VERTEXID&&(0==i?(s+="idCoord = vec2((id + shadowIDs) / 256.0);\n",s+="idCoord.x = floor(idCoord.x) / 255.0;\n",s+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",s+="fragID = id;\n"):3==i?(s+="float ID = id + shadowIDs;\n",s+="float h = floor(ID / 256.0);\n",s+="idCoord.x = ID - (h * 256.0);\n",s+="idCoord.z = floor(h / 256.0);\n",s+="idCoord.y = h - (idCoord.z * 256.0);\n",s+="idCoord = idCoord.zyx / 255.0;\n",s+="fragID = id;\n"):4==i&&(s+="idCoord = vec2((id + shadowIDs) / 256.0);\n",s+="idCoord.x = floor(idCoord.x) / 255.0;\n",s+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",s+="fragID = id;\n")),t.IMAGEGEOMETRY?(t.IG_INDEXED?(s+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",s+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",s+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",s+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",s+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(s+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",s+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),s+="pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n",s+="pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n"):t.POPGEOMETRY?(s+="vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",s+="if (PG_precisionLevel <= 2.0) {\n",s+="pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",s+="pos /= (65536.0 - PG_powPrecision);\n",s+="}\n",s+="else {\n",s+="pos /= bgPrecisionMax;\n",s+="}\n",s+="pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):(t.REQUIREBBOX&&(s+="pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),1!=i||t.REQUIREBBOXCOL?1==i&&t.REQUIREBBOXCOL?s+="fragColor = color / bgPrecisionColMax;\n":2!=i||t.REQUIREBBOXTEX?2==i&&t.REQUIREBBOXTEX&&(s+="vec2 texCoord = texcoord / bgPrecisionTexMax;\n",s+="fragColor = vec3(abs(texCoord.x), abs(texCoord.y), 0.0);\n"):s+="fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);\n":s+="fragColor = color;\n"),t.CLIPPLANES&&(s+="fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n"),s+="worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n",s+="gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n",s+="}\n";var r=e.createShader(e.VERTEX_SHADER);return e.shaderSource(r,s),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+s),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(r))),r},x3dom.shader.DynamicShaderPicking.prototype.generateFragmentShader=function(e,t,i){var s="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";s+=" precision highp float;\n",s+="#else\n",s+=" precision mediump float;\n",s+="#endif\n\n",s+="uniform float highBit;\n",s+="uniform float lowBit;\n",s+="uniform float sceneSize;\n",s+="varying vec3 worldCoord;\n",1!=i&&2!=i||(s+="varying vec3 fragColor;\n"),t.VERTEXID&&(s+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",s+="varying float fragID;\n"),t.CLIPPLANES&&(s+="uniform mat4 viewMatrixInverse;\n",s+="varying vec4 fragPosition;\n"),t.MULTIVISMAP&&(s+="uniform sampler2D multiVisibilityMap;\n",s+="uniform float multiVisibilityWidth;\n",s+="uniform float multiVisibilityHeight;\n"),t.CLIPPLANES&&(s+=x3dom.shader.clipPlanes(t.CLIPPLANES)),s+="void main(void) {\n",t.CLIPPLANES&&(s+="calculateClipPlanes();\n"),s+=1==i||2==i?"vec4 color = vec4(fragColor, lowBit);\n":4==i?"vec4 color = vec4(highBit, lowBit, 0.0, 0.0);\n":"vec4 color = vec4(0.0, 0.0, highBit, lowBit);\n",t.VERTEXID&&(0==i||4==i?s+="color.ba = idCoord;\n":3==i&&(s+="color.gba = idCoord;\n"),t.MULTIVISMAP&&(s+="vec2 idTexCoord;\n",s+="float roundedID = floor(fragID+0.5);\n",s+="idTexCoord.x = (mod(roundedID, multiVisibilityWidth)) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",s+="idTexCoord.y = (floor(roundedID / multiVisibilityHeight)) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",s+="vec4 visibility = texture2D( multiVisibilityMap, idTexCoord );\n",s+="if (visibility.r < 1.0) discard; \n")),1!=i&&2!=i&&(s+="float d = length(worldCoord) / sceneSize;\n"),0==i?(s+="vec2 comp = fract(d * vec2(256.0, 1.0));\n",s+="color.rg = comp - (comp.rr * vec2(0.0, 1.0/256.0));\n"):3==i&&(s+="color.r = d;\n"),s+="gl_FragColor = color;\n",s+="}\n";var o=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(o,s),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+s),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(o))),o},x3dom.shader.DynamicShadowShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShadowShader.prototype.generateVertexShader=function(e,t){var i="";if(i+="attribute vec3 position;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",i+="varying vec4 projCoords;\n",t.VERTEXID&&(i+="varying float fragID;\n",i+="attribute float id;\n"),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var s=0;s<t.IG_PRECISION;s++)i+="uniform sampler2D IG_coords"+s+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.CLIPPLANES&&(i+="uniform mat4 modelViewMatrix;\n",i+="varying vec4 fragPosition;\n"),i+="void main(void) {\n",i+="    vec3 pos = position;\n",t.IMAGEGEOMETRY?(t.IG_INDEXED?(i+="    vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="    vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="    vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="    halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="    IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="    vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="    vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="    pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n",i+="    pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n"):t.POPGEOMETRY?(i+="    vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="    if (PG_precisionLevel <= 2.0) {\n",i+="        pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",i+="        pos /= (65536.0 - PG_powPrecision);\n",i+="    }\n",i+="    else {\n",i+="        pos /= bgPrecisionMax;\n",i+="    }\n",i+="    pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="    pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),t.VERTEXID&&(i+="    fragID = id;\n"),t.CLIPPLANES&&(i+="    fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n"),i+="    projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n",i+="    gl_Position = projCoords;\n",i+="}\n";var o=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] VertexShader "+e.getShaderInfoLog(o)),o},x3dom.shader.DynamicShadowShader.prototype.generateFragmentShader=function(e,t){var i="";i+="#ifdef GL_FRAGMENT_PRECISION_HIGH\n",i+="    precision highp float;\n",i+="#else\n",i+="    precision mediump float;\n",i+="#endif\n\n",i+="varying vec4 projCoords;\n",i+="uniform float offset;\n",i+="uniform bool cameraView;\n",t.VERTEXID&&(i+="varying float fragID;\n"),t.MULTIVISMAP&&(i+="uniform sampler2D multiVisibilityMap;\n",i+="uniform float multiVisibilityWidth;\n",i+="uniform float multiVisibilityHeight;\n"),t.CLIPPLANES&&(i+="uniform mat4 viewMatrixInverse;\n",i+="varying vec4 fragPosition;\n",i+=x3dom.shader.clipPlanes(t.CLIPPLANES)),x3dom.caps.FP_TEXTURES||(i+=x3dom.shader.rgbaPacking()),i+="void main(void) {\n",t.CLIPPLANES&&(i+="calculateClipPlanes();\n"),t.MULTIVISMAP&&(i+="    vec2 idTexCoord;\n",i+="    float roundedID = floor(fragID+0.5);\n",i+="    idTexCoord.x = (mod(roundedID, multiVisibilityWidth)) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",i+="    idTexCoord.y = (floor(roundedID / multiVisibilityHeight)) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",i+="    vec4 visibility = texture2D( multiVisibilityMap, idTexCoord );\n",i+="    if (visibility.r < 1.0) discard; \n"),i+="    vec3 proj = (projCoords.xyz / projCoords.w);\n",x3dom.caps.FP_TEXTURES?(i+="    if (!cameraView){\n",i+="     proj.z = (proj.z + 1.0)*0.5;\n",i+="     proj.y = proj.z * proj.z;\n",i+="    }\n",i+="    gl_FragColor = vec4(proj, 1.0);\n"):i+="    gl_FragColor = packDepth(proj.z);\n",i+="}\n";var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ComposedShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ComposedShader.prototype.generateVertexShader=function(e,t){var i=t._cf.appearance.node._shader._vertex._vf.url[0],s=e.createShader(e.VERTEX_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] VertexShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ComposedShader.prototype.generateFragmentShader=function(e,t){var i=t._cf.appearance.node._shader._fragment._vf.url[0],s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.NormalShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.NormalShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nattribute vec3 normal;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float bgPrecisionNorMax;\nuniform mat4 normalMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    fragNormal = (normalMatrix * vec4(normal / bgPrecisionNorMax, 0.0)).xyz;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.NormalShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="varying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4(normalize(fragNormal) / 2.0 + 0.5, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.FrontgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.FrontgroundTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.FrontgroundTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec4 col = texture2D(tex, fragTexCoord);\n    gl_FragColor = vec4(col.rgb, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundSkyTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundSkyTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nattribute vec2 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = texcoord;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundSkyTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundCubeTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundCubeTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    fragNormal = normalize(position);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundCubeTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform samplerCube tex;\nvarying vec3 fragNormal;\n\nfloat magn(float val) {\n    return ((val >= 0.0) ? val : -1.0 * val);\n}\nvoid main(void) {\n    vec3 normal = -reflect(normalize(fragNormal), vec3(0.0,0.0,1.0));\n    if (magn(normal.y) >= magn(normal.x) && magn(normal.y) >= magn(normal.z))\n        normal.xz = -normal.xz;\n    gl_FragColor = textureCube(tex, normal);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.ShadowRenderingShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ShadowRenderingShader.prototype.generateVertexShader=function(e){var t="";t+="attribute vec2 position;\n",t+="varying vec2 vPosition;\n",t+="void main(void) {\n",t+=" vPosition = position;\n",t+=" gl_Position = vec4(position, -1.0, 1.0);\n",t+="}\n";var i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.ShadowRenderingShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";i+="precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="uniform mat4 inverseViewProj;\n",i+="uniform mat4 inverseProj;\n",i+="varying vec2 vPosition;\n",i+="uniform sampler2D sceneMap;\n";for(var s=0;s<5;s++)i+="uniform float cascade"+s+"_Depth;\n";for(var o=0;o<t.length;o++){i+="uniform float light"+o+"_On;\nuniform float light"+o+"_Type;\nuniform vec3  light"+o+"_Location;\nuniform vec3  light"+o+"_Direction;\nuniform vec3  light"+o+"_Attenuation;\nuniform float light"+o+"_Radius;\nuniform float light"+o+"_BeamWidth;\nuniform float light"+o+"_CutOffAngle;\nuniform float light"+o+"_ShadowIntensity;\nuniform float light"+o+"_ShadowOffset;\nuniform mat4 light"+o+"_ViewMatrix;\n";for(var r=0;r<6;r++)i+="uniform mat4 light"+o+"_"+r+"_Matrix;\n",i+="uniform sampler2D light"+o+"_"+r+"_ShadowMap;\n";for(var r=0;r<5;r++)i+="uniform float light"+o+"_"+r+"_Split;\n"}x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE||(i+=x3dom.shader.rgbaPacking()),i+=x3dom.shader.shadowRendering(),i+=x3dom.shader.gammaCorrectionDecl({}),i+="void main(void) {\n float shadowValue = 1.0;\n vec2 texCoordsSceneMap = (vPosition + 1.0)*0.5;\n vec4 projCoords = texture2D(sceneMap, texCoordsSceneMap);\n if (projCoords != vec4(1.0,1.0,1.0,0.0)){\n",x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE||(i+=" projCoords.z = unpackDepth(projCoords);\n projCoords.w = 1.0;\n"),i+=" projCoords = projCoords / projCoords.w;\n projCoords.xy = vPosition;\n vec4 eyeCoords = inverseProj*projCoords;\n vec4 worldCoords = inverseViewProj*projCoords;\n float lightInfluence = 0.0;\n";for(var o=0;o<t.length;o++)i+=" lightInfluence = getLightInfluence(light"+o+"_Type, light"+o+"_ShadowIntensity, light"+o+"_On, light"+o+"_Location, light"+o+"_Direction, light"+o+"_CutOffAngle, light"+o+"_BeamWidth, light"+o+"_Attenuation, light"+o+"_Radius, eyeCoords.xyz/eyeCoords.w);\n if (lightInfluence != 0.0){\n  vec4 shadowMapValues;\n  float viewSampleDepth;\n",i+=x3dom.isa(t[o],x3dom.nodeTypes.PointLight)?"  getShadowValuesPointLight(shadowMapValues, viewSampleDepth, light"+o+"_Location, worldCoords, light"+o+"_ViewMatrix, light"+o+"_0_Matrix,light"+o+"_1_Matrix,light"+o+"_2_Matrix,light"+o+"_3_Matrix,light"+o+"_4_Matrix,light"+o+"_5_Matrix,light"+o+"_0_ShadowMap,light"+o+"_1_ShadowMap,light"+o+"_2_ShadowMap,light"+o+"_3_ShadowMap,light"+o+"_4_ShadowMap,light"+o+"_5_ShadowMap);\n":"  getShadowValuesCascaded(shadowMapValues, viewSampleDepth, worldCoords, -eyeCoords.z/eyeCoords.w,light"+o+"_0_Matrix,light"+o+"_1_Matrix,light"+o+"_2_Matrix,light"+o+"_3_Matrix,light"+o+"_4_Matrix,light"+o+"_5_Matrix,light"+o+"_0_ShadowMap,light"+o+"_1_ShadowMap,light"+o+"_2_ShadowMap,light"+o+"_3_ShadowMap,light"+o+"_4_ShadowMap,light"+o+"_5_ShadowMap, light"+o+"_0_Split, light"+o+"_1_Split, light"+o+"_2_Split, light"+o+"_3_Split, \nlight"+o+"_4_Split);\n",i+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?" shadowValue *= clamp(ESM(shadowMapValues.z, viewSampleDepth, light"+o+"_ShadowOffset),     1.0 - light"+o+"_ShadowIntensity*lightInfluence, 1.0);\n":"  shadowValue *= clamp(VSM(shadowMapValues.zy, viewSampleDepth, light"+o+"_ShadowOffset),     1.0 - light"+o+"_ShadowIntensity*lightInfluence, 1.0);\n",i+=" }\n";i+="}\n gl_FragColor = "+x3dom.shader.encodeGamma({},"vec4(shadowValue, shadowValue, shadowValue, 1.0)")+";\n}\n";var a=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(a,i),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] FragmentShader "+e.getShaderInfoLog(a)),a},x3dom.shader.TextureRefinementShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.TextureRefinementShader.prototype.generateVertexShader=function(e){var t="attribute vec2 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = (position.xy + 1.0) / 2.0;\n    gl_Position = vec4(position, -1.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.TextureRefinementShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n#else\n precision mediump float;\n#endif\n\n";t+="uniform sampler2D stamp;\nuniform sampler2D lastTex;\nuniform sampler2D curTex;\nuniform int mode;\nuniform vec2 repeat;\nvarying vec2 fragTexCoord;\n\nvoid init(void);\nvoid refine(void);\n\nvoid main(void) {\n    if (mode == 0) { init(); }\n    else { refine(); }\n}\n\nvoid init(void) {\n    gl_FragColor = texture2D(curTex, fragTexCoord);\n}\n\nvoid refine(void) {\n    vec3 red = texture2D(stamp, repeat * fragTexCoord).rgb;\n    vec3 v1  = texture2D(lastTex, fragTexCoord).rgb;\n    vec3 v2  = texture2D(curTex, fragTexCoord).rgb;\n    if (red.r <= 0.5) {\n        gl_FragColor = vec4(v1, 1.0);\n    }\n    else {\n        gl_FragColor = vec4(v2, 1.0);\n    }\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BlurShader.prototype.generateVertexShader=function(e){var t="";t+="attribute vec2 position;\n",t+="varying vec2 vPosition;\n",t+="void main(void) {\n",t+=" vPosition = position;\n",t+=" gl_Position = vec4(position, -1.0, 1.0);\n",t+="}\n";var i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="varying vec2 vPosition;\nuniform sampler2D texture;\nuniform bool horizontal;\nuniform float pixelSizeHor;\nuniform float pixelSizeVert;\nuniform int filterSize;\n",t+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?x3dom.shader.rgbaPacking()+"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n float depth = unpackDepth(texture2D(texture, texCoords));\n if (filterSize == 3){\n  depth = depth * 0.3844;\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords+offset));\n } else if (filterSize == 5){\n  depth = depth * 0.2921;\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n } else if (filterSize == 7){\n  depth = depth * 0.2161;\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords-3.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords+3.0*offset));\n }\n gl_FragColor = packDepth(depth);\n}\n":"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n vec4 color = texture2D(texture, texCoords);\n if (filterSize == 3){\n  color = color * 0.3844;\n  color += 0.3078*texture2D(texture, texCoords-offset);\n  color += 0.3078*texture2D(texture, texCoords+offset);\n } else if (filterSize == 5){\n  color = color * 0.2921;\n  color += 0.2339*texture2D(texture, texCoords-offset);\n  color += 0.2339*texture2D(texture, texCoords+offset);\n  color += 0.1201*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1201*texture2D(texture, texCoords+2.0*offset);\n } else if (filterSize == 7){\n  color = color * 0.2161;\n  color += 0.1907*texture2D(texture, texCoords-offset);\n  color += 0.1907*texture2D(texture, texCoords+offset);\n  color += 0.1311*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1311*texture2D(texture, texCoords+2.0*offset);\n  color += 0.0702*texture2D(texture, texCoords-3.0*offset);\n  color += 0.0702*texture2D(texture, texCoords+3.0*offset);\n }\n gl_FragColor = color;\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] FragmentShader "+e.getShaderInfoLog(i)),
i},x3dom.shader.SSAOShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\nuniform vec2 randomTextureTilingFactor;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    depthTexCoord = texCoord;\n  randomTexCoord = randomTextureTilingFactor*texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOShader.depthReconsructionFunctionCode=function(){var e="uniform float depthReconstructionConstantA;\nuniform float depthReconstructionConstantB;\n";return x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE||(e+=x3dom.shader.rgbaPacking()),e+="float getDepth(vec2 depthTexCoord) {\n    vec4 col = texture2D(depthTexture, depthTexCoord);\n    float d;\n",e+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?"    d = unpackDepth(col);\n":"    d = col.b;\n",e+="    return depthReconstructionConstantB/(depthReconstructionConstantA+d);\n",e+="}\n"},x3dom.shader.SSAOShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D depthTexture;\nuniform sampler2D randomTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float radius;\nuniform float depthBufferEpsilon;\nuniform vec3 samples[16];\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float referenceDepth = getDepth(depthTexCoord);\n    if(referenceDepth == 1.0)\n    {\n        gl_FragColor = vec4(1.0,1.0,1.0, 1.0);\n        return;\n    }\n    int numOcclusions = 0;\n    for(int i = 0; i<16; ++i){\n        float scale  = 1.0/referenceDepth;\n        vec3 samplepos = reflect(samples[i],texture2D(randomTexture,randomTexCoord).xyz*2.0-vec3(1.0,1.0,1.0));\n        float sampleDepth = getDepth(depthTexCoord+samplepos.xy*scale*radius);\n        //if(abs(sampleDepth-referenceDepth)<=radius*(1.0/nearPlane))\n        if( sampleDepth < referenceDepth-depthBufferEpsilon) {\n            ++numOcclusions;\n        }\n    }\n    float r = 1.0-float(numOcclusions)/16.0;\n    r*=2.0;\n    gl_FragColor = vec4(r,r,r, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOBlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOBlurShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOBlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D SSAOTexture;\nuniform sampler2D depthTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float amount;\nuniform vec2 pixelSize;\nuniform float depthThreshold;\nvarying vec2 fragTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float sum = 0.0;\n    float numSamples = 0.0;\n    float referenceDepth = getDepth(fragTexCoord);\n    for(int i = -2; i<2;i++){\n        for(int j = -2; j<2;j++){\n            vec2 sampleTexCoord = fragTexCoord+vec2(pixelSize.x*float(i),pixelSize.y*float(j));\n            if(abs(referenceDepth - getDepth(sampleTexCoord))<depthThreshold){\n                sum+= texture2D(SSAOTexture,sampleTexCoord).r;\n                numSamples++;\n    }}}\n    float intensity = mix(1.0,sum/numSamples,amount);\n    gl_FragColor = vec4(intensity,intensity,intensity,1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.SSAO={},x3dom.SSAO.isEnabled=function(e){return e.getEnvironment()._vf.SSAO},x3dom.SSAO.reinitializeShadersIfNecessary=function(e){void 0===x3dom.SSAO.shaderProgram&&(x3dom.SSAO.shaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOShader(e),"ssao")),void 0===x3dom.SSAO.blurShaderProgram&&(x3dom.SSAO.blurShaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOBlurShader(e),"ssao-blur"))},x3dom.SSAO.reinitializeRandomTextureIfNecessary=function(e,t){var i=t.getEnvironment()._vf.SSAOrandomTextureSize!=x3dom.SSAO.currentRandomTextureSize;if(void 0===x3dom.SSAO.randomTexture&&(x3dom.SSAO.randomTexture=e.createTexture()),void 0===x3dom.SSAO.randomTexture||i){e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.randomTexture);for(var s=x3dom.SSAO.currentRandomTextureSize=t.getEnvironment()._vf.SSAOrandomTextureSize,o=new ArrayBuffer(s*s*4),r=new Uint8Array(o),a=0;a<s*s;++a){var n=2*Math.random()-1,d=2*Math.random()-1,l=0,h=Math.sqrt(n*n+d*d+l*l);n/=h,d/=h,r[4*a]=.5*(n+1)*255,r[4*a+1]=.5*(d+1)*255,r[4*a+2]=.5*(l+1)*255,r[4*a+3]=255}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s,s,0,e.RGBA,e.UNSIGNED_BYTE,r),e.bindTexture(e.TEXTURE_2D,null)}},x3dom.SSAO.reinitializeFBOIfNecessary=function(e,t){var i=x3dom.SSAO.currentFBOWidth!=t.width||x3dom.SSAO.currentFBOHeight!=t.height;if(void 0===x3dom.SSAO.fbo||i){x3dom.SSAO.currentFBOWidth=t.width,x3dom.SSAO.currentFBOHeight=t.height;var s=e.getParameter(e.FRAMEBUFFER_BINDING);void 0===x3dom.SSAO.fbo&&(x3dom.SSAO.fbo=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,x3dom.SSAO.fbo),void 0===x3dom.SSAO.fbotex&&(x3dom.SSAO.fbotex=e.createTexture()),e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.fbotex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,x3dom.SSAO.currentFBOWidth,x3dom.SSAO.currentFBOHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,x3dom.SSAO.fbotex,0),e.bindFramebuffer(e.FRAMEBUFFER,s)}},x3dom.SSAO.render=function(e,t,i,s,o,r){var a=t.getParameter(t.FRAMEBUFFER_BINDING);null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,r),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var n=x3dom.SSAO.shaderProgram;e.useProgram(n),n.depthTexture=0,n.randomTexture=1,n.radius=i.getEnvironment()._vf.SSAOradius,n.randomTextureTilingFactor=[o.width/x3dom.SSAO.currentRandomTextureSize,o.height/x3dom.SSAO.currentRandomTextureSize];var d=i.getViewpoint(),l=d.getNear(),h=d.getFar();n.nearPlane=l,n.farPlane=h,n.depthReconstructionConstantA=(h+l)/(l-h),n.depthReconstructionConstantB=2*h*l/(l-h),n.depthBufferEpsilon=1e-4*(h-l),n.samples=[.03800223814729654,.10441029119843426,-.04479934806797181,-.03800223814729654,-.10441029119843426,.04479934806797181,-.17023209847088397,.1428416910414532,.6154407640895228,.17023209847088397,-.1428416910414532,-.6154407640895228,-.288675134594813,-.16666666666666646,-.3774214123135722,.288675134594813,.16666666666666646,.3774214123135722,.07717696785196887,-.43769233467209245,-.5201284112706428,-.07717696785196887,.43769233467209245,.5201284112706428,.5471154183401156,-.09647120981496134,-.15886420745887797,-.5471154183401156,.09647120981496134,.15886420745887797,.3333333333333342,.5773502691896253,-.8012446019636266,-.3333333333333342,-.5773502691896253,.8012446019636266,-.49994591864508653,.5958123446480936,-.15385106176844343,.49994591864508653,-.5958123446480936,.15385106176844343,-.8352823295874743,-.3040179051783715,.7825440557226517,.8352823295874743,.3040179051783715,-.7825440557226517],n.tex||(n.tex=0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,x3dom.SSAO.randomTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[0]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[1]),t.vertexAttribPointer(n.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(n.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(n.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,a)},x3dom.SSAO.blur=function(e,t,i,s,o,r,a){var n=t.getParameter(t.FRAMEBUFFER_BINDING);null!=a&&t.bindFramebuffer(t.FRAMEBUFFER,a),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var d=x3dom.SSAO.blurShaderProgram;e.useProgram(d),d.SSAOTexture=0,d.depthTexture=1,d.depthThreshold=i.getEnvironment()._vf.SSAOblurDepthTreshold;var l=i.getViewpoint(),h=l.getNear(),u=l.getFar();d.nearPlane=h,d.farPlane=u,d.depthReconstructionConstantA=(u+h)/(h-u),d.depthReconstructionConstantB=2*u*h/(h-u),d.pixelSize=[1/r.width,1/r.height],d.amount=i.getEnvironment()._vf.SSAOamount,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[0]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[1]),t.vertexAttribPointer(d.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(d.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(d.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=a&&t.bindFramebuffer(t.FRAMEBUFFER,n)},x3dom.SSAO.renderSSAO=function(e,t,i,s){this.reinitializeShadersIfNecessary(t),this.reinitializeRandomTextureIfNecessary(t,i),this.reinitializeFBOIfNecessary(t,s),e.viewport(0,0,s.width,s.height),this.render(e,t,i,i._webgl.fboScene.tex,s,x3dom.SSAO.fbo),t.enable(t.BLEND),t.blendFunc(t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA),this.blur(e,t,i,x3dom.SSAO.fbotex,i._webgl.fboScene.tex,s,null),t.disable(t.BLEND)},x3dom.gfx_webgl=function(){"use strict";function e(e,t,i,s){this.ctx3d=e,this.canvas=t,this.name=i,this.x3dElem=s,this.IG_PositionBuffer=null,this.cache=new x3dom.Cache,this.stateManager=new x3dom.StateManager(e)}function t(t,i,s,o,r){var a=["webgl","experimental-webgl","moz-webgl","webkit-3d"];o&&(a=["experimental-webgl2"].concat(a));for(var n=null,d=r.getElementsByTagName("Environment"),l=!!(d&&d[0]&&d[0].hasAttribute("SSAO")&&"true"===d[0].getAttribute("SSAO").toLowerCase()),h={alpha:!0,depth:!0,stencil:!0,antialias:!l,premultipliedAlpha:!1,preserveDrawingBuffer:!0,failIfMajorPerformanceCaveat:!0},u=0;u<a.length;u++)try{if(n=t.getContext(a[u],h),n||(x3dom.caps.RENDERMODE="SOFTWARE",h.failIfMajorPerformanceCaveat=!1,n=t.getContext(a[u],h)),n){var f=new e(n,t,"webgl",r);try{x3dom.caps.VENDOR=n.getParameter(n.VENDOR),x3dom.caps.VERSION=n.getParameter(n.VERSION),x3dom.caps.RENDERER=n.getParameter(n.RENDERER),x3dom.caps.SHADING_LANGUAGE_VERSION=n.getParameter(n.SHADING_LANGUAGE_VERSION),x3dom.caps.RED_BITS=n.getParameter(n.RED_BITS),x3dom.caps.GREEN_BITS=n.getParameter(n.GREEN_BITS),x3dom.caps.BLUE_BITS=n.getParameter(n.BLUE_BITS),x3dom.caps.ALPHA_BITS=n.getParameter(n.ALPHA_BITS),x3dom.caps.DEPTH_BITS=n.getParameter(n.DEPTH_BITS),x3dom.caps.MAX_VERTEX_ATTRIBS=n.getParameter(n.MAX_VERTEX_ATTRIBS),x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_VARYING_VECTORS=n.getParameter(n.MAX_VARYING_VECTORS),x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_TEXTURE_SIZE=n.getParameter(n.MAX_TEXTURE_SIZE),x3dom.caps.MAX_TEXTURE_IMAGE_UNITS=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE),x3dom.caps.COMPRESSED_TEXTURE_FORMATS=n.getParameter(n.COMPRESSED_TEXTURE_FORMATS),x3dom.caps.MAX_RENDERBUFFER_SIZE=n.getParameter(n.MAX_RENDERBUFFER_SIZE),x3dom.caps.MAX_VIEWPORT_DIMS=n.getParameter(n.MAX_VIEWPORT_DIMS),x3dom.caps.ALIASED_LINE_WIDTH_RANGE=n.getParameter(n.ALIASED_LINE_WIDTH_RANGE),x3dom.caps.ALIASED_POINT_SIZE_RANGE=n.getParameter(n.ALIASED_POINT_SIZE_RANGE),x3dom.caps.SAMPLES=n.getParameter(n.SAMPLES),x3dom.caps.INDEX_UINT=n.getExtension("OES_element_index_uint"),x3dom.caps.FP_TEXTURES=n.getExtension("OES_texture_float"),x3dom.caps.FPL_TEXTURES=n.getExtension("OES_texture_float_linear"),x3dom.caps.STD_DERIVATIVES=n.getExtension("OES_standard_derivatives"),x3dom.caps.DRAW_BUFFERS=n.getExtension("WEBGL_draw_buffers"),x3dom.caps.DEBUGRENDERINFO=n.getExtension("WEBGL_debug_renderer_info"),x3dom.caps.DEPTH_TEXTURE=n.getExtension("WEBGL_depth_texture"),x3dom.caps.EXTENSIONS=n.getSupportedExtensions(),x3dom.caps.DEBUGRENDERINFO?(x3dom.caps.UNMASKED_RENDERER_WEBGL=n.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_RENDERER_WEBGL),x3dom.caps.UNMASKED_VENDOR_WEBGL=n.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_VENDOR_WEBGL)):(x3dom.caps.UNMASKED_RENDERER_WEBGL="",x3dom.caps.UNMASKED_VENDOR_WEBGL="");var c=x3dom.caps.EXTENSIONS.toString().replace(/,/g,", ");x3dom.debug.logInfo(a[u]+" context found\nVendor: "+x3dom.caps.VENDOR+" "+x3dom.caps.UNMASKED_VENDOR_WEBGL+", Renderer: "+x3dom.caps.RENDERER+" "+x3dom.caps.UNMASKED_RENDERER_WEBGL+", Version: "+x3dom.caps.VERSION+", ShadingLangV.: "+x3dom.caps.SHADING_LANGUAGE_VERSION+", MSAA samples: "+x3dom.caps.SAMPLES+"\nExtensions: "+c),x3dom.caps.INDEX_UINT&&(x3dom.Utils.maxIndexableCoords=4294967295),x3dom.caps.MOBILE=function(e){return/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),(x3dom.caps.RENDERER.indexOf("PowerVR")>=0||navigator.appVersion.indexOf("Mobile")>-1||x3dom.caps.MAX_VARYING_VECTORS<=8||x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2)&&(x3dom.caps.MOBILE=!0),x3dom.caps.MOBILE?i?(x3dom.caps.MOBILE=!1,x3dom.debug.logWarning("Detected mobile graphics card! But being forced to desktop shaders which might not work!")):x3dom.debug.logWarning("Detected mobile graphics card! Using low quality shaders without ImageGeometry support!"):s&&(x3dom.caps.MOBILE=!0,x3dom.debug.logWarning("Detected desktop graphics card! But being forced to mobile shaders with lower quality!"))}catch(_){x3dom.debug.logWarning("Your browser probably supports an older WebGL version. Please try the old mobile runtime instead:\nhttp://www.x3dom.org/x3dom/src_mobile/x3dom.js"),f=null}return f}}catch(m){x3dom.debug.logWarning(m)}return null}return e.prototype.getName=function(){return this.name},e.prototype.setupShape=function(e,t,i){var s,o,r,a,n,d,l,h,u,f,c=0,_=t.shape,m=_._cf.geometry.node;if(void 0!==_._webgl){var p=!1;if(_._dirty.colors===!0&&void 0===_._webgl.shader.color&&m._mesh._colors[0].length&&(p=!0),p&&_._cleanupGLObjects&&_._cleanupGLObjects(!0,!1),_._dirty.texture===!0){if(_._webgl.texture.length!=_.getTextures().length){for(r=0;r<_._webgl.texture.length;++r)_._webgl.texture.pop();for(o=_.getTextures(),r=0;r<o.length;++r)_._webgl.texture.push(new x3dom.Texture(e,_._nameSpace.doc,this.cache,o[r]));_._dirty.shader=!0,void 0===_._webgl.shader.texcoord&&(_._dirty.texcoords=!0)}else for(o=_.getTextures(),r=0;r<o.length;++r)o[r]===_._webgl.texture[r].node?_._webgl.texture[r].update():(_._webgl.texture[r].texture=null,_._webgl.texture[r].node=o[r],_._webgl.texture[r].update());_._dirty.texture=!1}if(_._webgl.shader=this.cache.getShaderByProperties(e,_,_.getShaderProperties(i)),!p&&0==_._webgl.binaryGeometry)for(c=0;c<_._webgl.positions.length;c++)if(s=6*c,1!=_._dirty.positions&&1!=_._dirty.indexes||(void 0!==_._webgl.shader.position&&(_._webgl.indexes[c]=m._mesh._indices[c],e.deleteBuffer(_._webgl.buffers[s]),u=e.createBuffer(),_._webgl.buffers[s]=u,x3dom.caps.INDEX_UINT&&m._mesh._positions[0].length/3>65535?(f=new Uint32Array(_._webgl.indexes[c]),_._webgl.indexType=e.UNSIGNED_INT):(f=new Uint16Array(_._webgl.indexes[c]),_._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u),e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW),f=null,_._webgl.positions[c]=m._mesh._positions[c],e.deleteBuffer(_._webgl.buffers[s+1]),n=e.createBuffer(),_._webgl.buffers[s+1]=n,e.bindBuffer(e.ARRAY_BUFFER,n),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,_._webgl.buffers[s]),a=new Float32Array(_._webgl.positions[c]),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(_._webgl.shader.position,m._mesh._numPosComponents,_._webgl.coordType,!1,_._coordStrideOffset[0],_._coordStrideOffset[1]),a=null),_._dirty.positions=!1,_._dirty.indexes=!1),1==_._dirty.colors&&(void 0!==_._webgl.shader.color&&(_._webgl.colors[c]=m._mesh._colors[c],e.deleteBuffer(_._webgl.buffers[s+4]),h=e.createBuffer(),_._webgl.buffers[s+4]=h,M=new Float32Array(_._webgl.colors[c]),e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,M,e.STATIC_DRAW),e.vertexAttribPointer(_._webgl.shader.color,m._mesh._numColComponents,_._webgl.colorType,!1,_._colorStrideOffset[0],_._colorStrideOffset[1]),M=null),_._dirty.colors=!1),1==_._dirty.normals&&(void 0!==_._webgl.shader.normal&&(_._webgl.normals[c]=m._mesh._normals[c],e.deleteBuffer(_._webgl.buffers[s+2]),l=e.createBuffer(),_._webgl.buffers[s+2]=l,b=new Float32Array(_._webgl.normals[c]),e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW),e.vertexAttribPointer(_._webgl.shader.normal,m._mesh._numNormComponents,_._webgl.normalType,!1,_._normalStrideOffset[0],_._normalStrideOffset[1]),b=null),_._dirty.normals=!1),1==_._dirty.texcoords&&(void 0!==_._webgl.shader.texcoord&&(_._webgl.texcoords[c]=m._mesh._texCoords[c],e.deleteBuffer(_._webgl.buffers[s+3]),d=e.createBuffer(),_._webgl.buffers[s+3]=d,S=new Float32Array(_._webgl.texcoords[c]),e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,S,e.STATIC_DRAW),e.vertexAttribPointer(_._webgl.shader.texCoord,m._mesh._numTexComponents,_._webgl.texCoordType,!1,_._texCoordStrideOffset[0],_._texCoordStrideOffset[1]),S=null),_._dirty.texcoords=!1),1==_._dirty.specialAttribs&&void 0!==_._webgl.shader.particleSize){var x=m._vf.size.toGL();x.length&&(e.deleteBuffer(_._webgl.buffers[s+5]),_._webgl.buffers[s+5]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,_._webgl.buffers[s+5]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(x),e.STATIC_DRAW)),_._dirty.specialAttribs=!1}if(0!=_._webgl.imageGeometry){for(r=0;r<_._webgl.texture.length;++r)_._webgl.texture[r].updateTexture();m.unsetGeoDirty(),_.unsetGeoDirty()}if(!p)return}else if(!(x3dom.isa(m,x3dom.nodeTypes.Text)||x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry)||x3dom.isa(m,x3dom.nodeTypes.PopGeometry)||x3dom.isa(m,x3dom.nodeTypes.ExternalGeometry))&&(!m||m._mesh._positions[0].length<1))return void(x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2&&x3dom.isa(m,x3dom.nodeTypes.ImageGeometry)?x3dom.debug.logError("Can't render ImageGeometry nodes with only "+x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS+" vertex texture units. Please upgrade your GPU!"):x3dom.debug.logError("NO VALID MESH OR NO VERTEX POSITIONS SET!"));for(_.unsetDirty(),_._cleanupGLObjects||(_._cleanupGLObjects=function(t,i){if(this._webgl&&(arguments.length>0&&t||0==this._parentNodes.length)){for(var s=this._webgl.shader,o=0;o<this._webgl.positions.length;o++){var r=6*o;void 0!==s.position&&(e.deleteBuffer(this._webgl.buffers[r+1]),e.deleteBuffer(this._webgl.buffers[r])),void 0!==s.normal&&e.deleteBuffer(this._webgl.buffers[r+2]),void 0!==s.texcoord&&e.deleteBuffer(this._webgl.buffers[r+3]),void 0!==s.color&&e.deleteBuffer(this._webgl.buffers[r+4]),void 0!==s.id&&e.deleteBuffer(this._webgl.buffers[r+5])}for(var a=0;a<this._webgl.dynamicFields.length;a++){var n=this._webgl.dynamicFields[a];void 0!==s[n.name]&&e.deleteBuffer(n.buf)}void 0===i&&(i=!0),i&&(delete this._webgl,x3dom.BinaryContainerLoader.outOfMemory=!1)}}),_._webgl={positions:m._mesh._positions,normals:m._mesh._normals,texcoords:m._mesh._texCoords,colors:m._mesh._colors,indexes:m._mesh._indices,indexType:e.UNSIGNED_SHORT,coordType:e.FLOAT,normalType:e.FLOAT,texCoordType:e.FLOAT,colorType:e.FLOAT,texture:[],dirtyLighting:x3dom.Utils.checkDirtyLighting(i),imageGeometry:0,binaryGeometry:0,popGeometry:0,externalGeometry:0},o=_.getTextures(),r=0;r<o.length;++r)_._webgl.texture.push(new x3dom.Texture(e,_._nameSpace.doc,this.cache,o[r]));_._webgl.shader=this.cache.getShaderByProperties(e,_,_.getShaderProperties(i));var g=_._webgl.shader,v=0;if(_._webgl.buffers=[],_._webgl.dynamicFields=[],x3dom.isa(m,x3dom.nodeTypes.X3DBinaryContainerGeometryNode)){_._webgl.primType=[];for(var y=0;y<m._vf.primType.length;++y)_._webgl.primType.push(x3dom.Utils.primTypeDic(e,m._vf.primType[y]))}else _._webgl.primType=x3dom.Utils.primTypeDic(e,m._mesh._primType);if(x3dom.isa(m,x3dom.nodeTypes.ExternalGeometry))m.updateRenderData(_,g,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry))x3dom.BinaryContainerLoader.setupBinGeo(_,g,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.PopGeometry))x3dom.BinaryContainerLoader.setupPopGeo(_,g,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.ImageGeometry))x3dom.BinaryContainerLoader.setupImgGeo(_,g,e,i,this);else{for(c=0;c<_._webgl.positions.length;c++){if(s=6*c,void 0!==g.position&&(u=e.createBuffer(),_._webgl.buffers[s]=u,x3dom.caps.INDEX_UINT&&_._webgl.positions[0].length/3>65535?(f=new Uint32Array(_._webgl.indexes[c]),_._webgl.indexType=e.UNSIGNED_INT):(f=new Uint16Array(_._webgl.indexes[c]),_._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u),e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW),f=null,n=e.createBuffer(),_._webgl.buffers[s+1]=n,e.bindBuffer(e.ARRAY_BUFFER,n),a=new Float32Array(_._webgl.positions[c]),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(g.position,m._mesh._numPosComponents,_._webgl.coordType,!1,_._coordStrideOffset[0],_._coordStrideOffset[1]),e.enableVertexAttribArray(g.position),a=null),void 0!==g.normal||_._webgl.normals[c]){l=e.createBuffer(),_._webgl.buffers[s+2]=l;var b=new Float32Array(_._webgl.normals[c]);e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW),e.vertexAttribPointer(g.normal,m._mesh._numNormComponents,_._webgl.normalType,!1,_._normalStrideOffset[0],_._normalStrideOffset[1]),e.enableVertexAttribArray(g.normal),b=null}if(void 0!==g.texcoord){var T=e.createBuffer();_._webgl.buffers[s+3]=T;var S=new Float32Array(_._webgl.texcoords[c]);e.bindBuffer(e.ARRAY_BUFFER,T),e.bufferData(e.ARRAY_BUFFER,S,e.STATIC_DRAW),e.vertexAttribPointer(g.texcoord,m._mesh._numTexComponents,_._webgl.texCoordType,!1,_._texCoordStrideOffset[0],_._texCoordStrideOffset[1]),e.enableVertexAttribArray(g.texcoord),S=null}if(void 0!==g.color){h=e.createBuffer(),_._webgl.buffers[s+4]=h;var M=new Float32Array(_._webgl.colors[c]);e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,M,e.STATIC_DRAW),e.vertexAttribPointer(g.color,m._mesh._numColComponents,_._webgl.colorType,!1,_._colorStrideOffset[0],_._colorStrideOffset[1]),e.enableVertexAttribArray(g.color),M=null}if(void 0!==g.particleSize){var C=m._vf.size.toGL();if(C.length){var F=e.createBuffer();_._webgl.buffers[s+5]=F,e.bindBuffer(e.ARRAY_BUFFER,F),e.bufferData(e.ARRAY_BUFFER,new Float32Array(C),e.STATIC_DRAW)}}}for(var E in m._mesh._dynamicFields)if(m._mesh._dynamicFields.hasOwnProperty(E)){var w=m._mesh._dynamicFields[E];if(_._webgl.dynamicFields[v]={buf:{},name:E,numComponents:w.numComponents},void 0!==g[E]){var A=e.createBuffer();_._webgl.dynamicFields[v++].buf=A;var N=new Float32Array(w.value);e.bindBuffer(e.ARRAY_BUFFER,A),e.bufferData(e.ARRAY_BUFFER,N,e.STATIC_DRAW),e.vertexAttribPointer(g[E],w.numComponents,e.FLOAT,!1,0,0),N=null}}}},e.prototype.setupScene=function(e,t){var i=null,s=null,o=this;if(void 0!==t._webgl){if(!t._dirty)return;void 0!==t._webgl.texture&&t._webgl.texture&&e.deleteTexture(t._webgl.texture),t._cleanupGLObjects&&t._cleanupGLObjects(),t._webgl={}}t._dirty=!1;var r=t.getTexUrl(),a=0,n=1,d=1;if(r.length>0&&r[0].length>0)r.length>=6&&r[1].length>0&&r[2].length>0&&r[3].length>0&&r[4].length>0&&r[5].length>0?(i=new x3dom.nodeTypes.Sphere,t._webgl={positions:i._mesh._positions[0],indexes:i._mesh._indices[0],buffers:[{},{}]},t._webgl.primType=e.TRIANGLES,t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_CUBETEXTURE),t._webgl.texture=x3dom.Utils.createTextureCube(e,t._nameSpace.doc,r,!0,t._vf.crossOrigin,!0,!1)):(t._webgl={positions:[-n,-d,0,-n,d,0,n,-d,0,n,d,0],indexes:[0,1,2,3],buffers:[{},{}]},r=t._nameSpace.getURL(r[0]),t._webgl.texture=x3dom.Utils.createTexture2D(e,t._nameSpace.doc,r,!0,t._vf.crossOrigin,!0,!1),t._webgl.primType=e.TRIANGLE_STRIP,t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_TEXTURE));else if(t.getSkyColor().length>1||t.getGroundColor().length){i=new x3dom.nodeTypes.Sphere,s=e.createTexture(),t._webgl={positions:i._mesh._positions[0],texcoords:i._mesh._texCoords[0],indexes:i._mesh._indices[0],buffers:[{},{},{}],texture:s,primType:e.TRIANGLES};var l=x3dom.Utils.nextHighestPowerOfTwo(t.getSkyColor().length+t.getGroundColor().length+2);l=l<512?512:l;var h=t._vf.groundAngle.length,u=[],f=[],c=[],_=[0];for(a=0;a<t._vf.skyColor.length;a++)c[a]=t._vf.skyColor[a];for(a=0;a<t._vf.skyAngle.length;a++)_[a+1]=t._vf.skyAngle[a];if(h>0||1==t._vf.groundColor.length){for(_[_.length-1]<Math.PI/2&&(_[_.length]=Math.PI/2-x3dom.fields.Eps,c[c.length]=c[c.length-1]),a=h-1;a>=0;a--)a==h-1&&Math.PI-t._vf.groundAngle[a]<=Math.PI/2&&(_[_.length]=Math.PI/2,c[c.length]=t._vf.groundColor[t._vf.groundColor.length-1]),_[_.length]=Math.PI-t._vf.groundAngle[a],c[c.length]=t._vf.groundColor[a+1];0==h&&1==t._vf.groundColor.length&&(_[_.length]=Math.PI/2,c[c.length]=t._vf.groundColor[0]),_[_.length]=Math.PI,c[c.length]=t._vf.groundColor[0]}else _[_.length-1]<Math.PI&&(_[_.length]=Math.PI,c[c.length]=c[c.length-1]);for(a=0;a<_.length;a++)_[a]/=Math.PI;if(_.length!=c.length){x3dom.debug.logError("Number of background colors and corresponding angles are different!");var m=_.length<c.length?_.length:c.length;_.length=m,c.length=m}var p=new x3dom.nodeTypes.ColorInterpolator;for(p._vf.key=new x3dom.fields.MFFloat(_),p._vf.keyValue=new x3dom.fields.MFColor(c),a=0;a<l;a++)p._vf.set_fraction=a/(l-1),p.fieldChanged("set_fraction"),u[a]=p._vf.value_changed;u.reverse();var x=Math.floor(255*(1-t.getTransparency()));for(a=0;a<u.length;a++)f.push(Math.floor(255*u[a].r),Math.floor(255*u[a].g),Math.floor(255*u[a].b),x);var g=new Uint8Array(f),v=e.RGBA;l=g.length/4,e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,v,1,l,0,v,e.UNSIGNED_BYTE,g),e.bindTexture(e.TEXTURE_2D,null),t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_SKYTEXTURE)}else t._webgl={};if(t._webgl.shader){var y=t._webgl.shader,b=e.createBuffer();t._webgl.buffers[1]=b,e.bindBuffer(e.ARRAY_BUFFER,b);var T=new Float32Array(t._webgl.positions);e.bufferData(e.ARRAY_BUFFER,T,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,b),e.vertexAttribPointer(y.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.position);var S=e.createBuffer();t._webgl.buffers[0]=S;var M=new Uint16Array(t._webgl.indexes);if(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,S),e.bufferData(e.ELEMENT_ARRAY_BUFFER,M,e.STATIC_DRAW),T=null,M=null,void 0!==y.texcoord){var C=e.createBuffer();t._webgl.buffers[2]=C;var F=new Float32Array(t._webgl.texcoords);e.bindBuffer(e.ARRAY_BUFFER,C),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(y.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.texcoord),F=null}t._cleanupGLObjects=function(){var t=this._webgl.shader;void 0!==t.position&&(e.deleteBuffer(this._webgl.buffers[0]),e.deleteBuffer(this._webgl.buffers[1])),void 0!==t.texcoord&&e.deleteBuffer(this._webgl.buffers[2])}}t._webgl.render=function(e,i,s){var r=t._webgl.shader,a=1-t.getTransparency(),n=null,d=s._22,l=s._23,h=i.e3();if(void 0!==r&&null!==r&&void 0!==r.texcoord&&null!==r.texcoord&&void 0!==t._webgl.texture&&null!==t._webgl.texture)e.clearColor(0,0,0,a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),o.stateManager.frontFace(e.CCW),o.stateManager.disable(e.CULL_FACE),
o.stateManager.disable(e.DEPTH_TEST),o.stateManager.disable(e.BLEND),o.stateManager.useProgram(r),r.tex||(r.tex=0),s._22=100001/99999,s._23=2e5/99999,i._03=0,i._13=0,i._23=0,n=s.mult(i),r.modelViewProjectionMatrix=n.toGL(),i._03=h.x,i._13=h.y,i._23=h.z,s._22=d,s._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[2]),e.vertexAttribPointer(r.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.texcoord),e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(r.position),e.disableVertexAttribArray(r.texcoord),e.clear(e.DEPTH_BUFFER_BIT);else if(!r||!t._webgl.texture||void 0!==t._webgl.texture.textureCubeReady&&t._webgl.texture.textureCubeReady!==!0){var u=t.getSkyColor().toGL();e.clearColor(u[0],u[1],u[2],a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}else e.clearColor(0,0,0,a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),o.stateManager.frontFace(e.CCW),o.stateManager.disable(e.CULL_FACE),o.stateManager.disable(e.DEPTH_TEST),o.stateManager.disable(e.BLEND),o.stateManager.useProgram(r),r.tex||(r.tex=0),t._webgl.texture.textureCubeReady?(s._22=100001/99999,s._23=2e5/99999,i._03=0,i._13=0,i._23=0,n=s.mult(i),r.modelViewProjectionMatrix=n.toGL(),i._03=h.x,i._13=h.y,i._23=h.z,s._22=d,s._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,t._webgl.texture),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(r.position),e.activeTexture(e.TEXTURE0),t._webgl.texture.textureCubeReady?e.bindTexture(e.TEXTURE_CUBE_MAP,null):e.bindTexture(e.TEXTURE_2D,null),e.clear(e.DEPTH_BUFFER_BIT)}},e.prototype.setupFgnds=function(e,t){if(void 0===t._fgnd){var i=this,s=1,o=1;t._fgnd={},t._fgnd._webgl={positions:[-s,-o,0,-s,o,0,s,-o,0,s,o,0],indexes:[0,1,2,3],buffers:[{},{}]},t._fgnd._webgl.primType=e.TRIANGLE_STRIP,t._fgnd._webgl.shader=this.cache.getShader(e,x3dom.shader.FRONTGROUND_TEXTURE);var r=t._fgnd._webgl.shader,a=e.createBuffer();t._fgnd._webgl.buffers[1]=a,e.bindBuffer(e.ARRAY_BUFFER,a);var n=new Float32Array(t._fgnd._webgl.positions);e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0);var d=e.createBuffer();t._fgnd._webgl.buffers[0]=d;var l=new Uint16Array(t._fgnd._webgl.indexes);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d),e.bufferData(e.ELEMENT_ARRAY_BUFFER,l,e.STATIC_DRAW),n=null,l=null,t._fgnd._webgl.render=function(e,s){t._fgnd._webgl.texture=s,i.stateManager.frontFace(e.CCW),i.stateManager.disable(e.CULL_FACE),i.stateManager.disable(e.DEPTH_TEST),i.stateManager.useProgram(r),r.tex||(r.tex=0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._fgnd._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._fgnd._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._fgnd._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.drawElements(t._fgnd._webgl.primType,t._fgnd._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(r.position),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}}},e.prototype.renderShadowPass=function(e,t,i,s,o,r,a){var n=t._scene,d=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,o.fbo),this.stateManager.viewport(0,0,o.width,o.height),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND);var l,h=(x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL(),n.getEnvironment()),u=h._vf.shadowExcludeTransparentObjects,f=n.drawableCollection.length;for(l=0;l<f;l++){var c=n.drawableCollection.get(l),_=c.transform,m=c.shape,p=m._webgl;if(p&&(!u||"transparent"!=c.sortType)){var x=m._cf.geometry.node,g=m._cf.appearance.node,v=x._mesh,y=m.getShaderProperties(t),b=this.cache.getShaderByProperties(e,m,y,null,!0);if(!b)return;if(this.stateManager.useProgram(b),b.cameraView=a,b.offset=r,b.modelViewProjectionMatrix=i.mult(_).toGL(),p.coordType!=e.FLOAT&&(!p.popGeometry&&x3dom.Utils.isUnsignedType(x._vf.coordType)?b.bgCenter=x.getMin().toGL():b.bgCenter=x._vf.position.toGL(),b.bgSize=x._vf.size.toGL(),b.bgPrecisionMax=x.getPrecisionMax("coordType")),m._clipPlanes){b.modelViewMatrix=s.mult(_).toGL(),b.viewMatrixInverse=s.inverse().toGL();for(var T=0;T<m._clipPlanes.length;T++){var S=m._clipPlanes[T].plane,M=m._clipPlanes[T].trafo;b["clipPlane"+T+"_Plane"]=M.multMatrixPlane(S._vf.plane).toGL(),b["clipPlane"+T+"_CappingStrength"]=S._vf.cappingStrength,b["clipPlane"+T+"_CappingColor"]=S._vf.cappingColor.toGL()}}if(0==p.imageGeometry||x3dom.caps.MOBILE){if((0!=p.binaryGeometry||0!=p.externalGeometry)&&1==x._vf.idsPerVertex){var C=g._shader;if(C&&x3dom.isa(g._shader,x3dom.nodeTypes.CommonSurfaceShader)&&C.getMultiVisibilityMap()){b.multiVisibilityMap=0;var F=x3dom.Utils.findTextureByName(p.texture,"multiVisibilityMap");b.multiVisibilityWidth=F.texture.width,b.multiVisibilityHeight=F.texture.height,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,F.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}}}else{b.IG_bboxMin=x.getMin().toGL(),b.IG_bboxMax=x.getMax().toGL(),b.IG_implicitMeshSize=x._vf.implicitMeshSize.toGL();var E=x3dom.Utils.findTextureByName(p.texture,"IG_coords0");if(E&&(b.IG_coordTextureWidth=E.texture.width,b.IG_coordTextureHeight=E.texture.height),1==p.imageGeometry){var w=x3dom.Utils.findTextureByName(p.texture,"IG_index");w&&(b.IG_indexTextureWidth=w.texture.width,b.IG_indexTextureHeight=w.texture.height),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,w.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,E.texture)}else e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,E.texture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);var A=0;x.getIndexTexture()&&(b.IG_indexTexture||(b.IG_indexTexture=A++)),x.getCoordinateTexture(0)&&(b.IG_coordinateTexture||(b.IG_coordinateTexture=A++))}m.isSolid()?(this.stateManager.enable(e.CULL_FACE),m.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);var N=g?g._cf.depthMode.node:null;if(N?N._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!N._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,N._vf.depthFunc)),this.stateManager.depthRange(N._vf.zNearRange,N._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),p.popGeometry){var R=s.mult(_);this.updatePopState(c,x,b,p,n,R,t,this.x3dElem.runtime.fps)}var I;I=0!=p.externalGeometry?p.primType.length:p.positions.length;for(var P=0;P<I;P++){var D,V,L,O=6*P;if(void 0!==b.position&&p.buffers[O+1]&&(p.indexes[P]||0!=p.externalGeometry)){if(d=!1,p.buffers[O]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p.buffers[O]),d=!0),void 0!==b.position&&p.buffers[O+1]&&(e.bindBuffer(e.ARRAY_BUFFER,p.buffers[O+1]),e.vertexAttribPointer(b.position,v._numPosComponents,p.coordType,!1,m._coordStrideOffset[0],m._coordStrideOffset[1]),e.enableVertexAttribArray(b.position)),void 0!==b.id&&p.buffers[O+5]&&(e.bindBuffer(e.ARRAY_BUFFER,p.buffers[O+5]),0==p.binaryGeometry&&0==p.externalGeometry||1!=x._vf.idsPerVertex||(e.vertexAttribPointer(b.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(b.id))),d&&(p.binaryGeometry>0||p.popGeometry>0))for(D=0,L=0,V=x._vf.vertexCount.length;D<V;D++)e.drawElements(p.primType[D],x._vf.vertexCount[D],p.indexType,x3dom.Utils.getByteAwareOffset(L,p.indexType,e)),L+=x._vf.vertexCount[D];else if(p.binaryGeometry<0||p.popGeometry<0||p.imageGeometry)for(D=0,L=0,V=x._vf.vertexCount.length;D<V;D++)e.drawArrays(p.primType[D],L,x._vf.vertexCount[D]),L+=x._vf.vertexCount[D];else if(1==p.externalGeometry)e.drawElements(p.primType[P],p.drawCount[P],p.indexType,p.indexOffset[P]);else if(p.externalGeometry==-1)e.drawArrays(p.primType[P],0,p.drawCount[P]);else if(x.hasIndexOffset()){var B=m.tessellationProperties();for(D=0,V=B.length;D<V;D++)e.drawElements(p.primType,B[D].count,p.indexType,B[D].offset*x3dom.Utils.getOffsetMultiplier(p.indexType,e))}else 0==p.indexes[P].length?e.drawArrays(p.primType,0,p.positions[P].length/3):e.drawElements(p.primType,p.indexes[P].length,p.indexType,0);e.disableVertexAttribArray(b.position),void 0!==b.texcoord&&p.buffers[O+3]&&e.disableVertexAttribArray(b.texcoord),void 0!==b.color&&p.buffers[O+4]&&e.disableVertexAttribArray(b.color),void 0!==b.id&&p.buffers[O+5]&&e.disableVertexAttribArray(b.id)}}0==p.imageGeometry||x3dom.caps.MOBILE||(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),1==p.imageGeometry&&(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null)))}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),N&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderPickingPass=function(e,t,i,s,o,r,a,n,d,l,h){var u=t._webgl.pickScale,f=t._webgl.fboPick.height,c=n*u,_=f-1-d*u,m=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,t._webgl.fboPick.fbo),this.stateManager.viewport(0,0,t._webgl.fboPick.width,f),e.clearColor(0,0,0,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var p=t.drawableCollection.viewarea,x=t.getEnvironment(),g=t.drawableCollection.length;x._vf.smallFeatureCulling&&x._lowPriorityThreshold<1&&p.isMovingOrAnimating()&&(g=Math.floor(g*x._lowPriorityThreshold),!g&&t.drawableCollection.length&&(g=1));x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL();this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(2);for(var v=0;v<g;v++){var y=t.drawableCollection.get(v),b=y.transform,T=y.shape,S=T._webgl;if(S&&!(T._objectID<1)&&T._vf.isPickable){var M=T._cf.geometry.node,C=T._cf.appearance.node,F=M._mesh,E=T.getShaderProperties(p),w=this.cache.getShaderByProperties(e,T,E,a);if(!w)return;if(this.stateManager.useProgram(w),w.modelMatrix=b.toGL(),w.modelViewProjectionMatrix=s.mult(b).toGL(),w.lowBit=(255&T._objectID)/255,w.highBit=(T._objectID>>>8)/255,w.from=o.toGL(),w.sceneSize=r,0==S.binaryGeometry&&0==S.externalGeometry||1!=M._vf.idsPerVertex||(w.shadowIDs=T._vf.idOffset+x3dom.nodeTypes.Shape.objectID+2),S.coordType!=e.FLOAT&&(!S.popGeometry&&x3dom.Utils.isUnsignedType(M._vf.coordType)?w.bgCenter=M.getMin().toGL():w.bgCenter=M._vf.position.toGL(),w.bgSize=M._vf.size.toGL(),w.bgPrecisionMax=M.getPrecisionMax("coordType")),1==a&&S.colorType!=e.FLOAT&&(w.bgPrecisionColMax=M.getPrecisionMax("colorType")),2==a&&S.texCoordType!=e.FLOAT&&(w.bgPrecisionTexMax=M.getPrecisionMax("texCoordType")),T._clipPlanes){w.modelViewMatrix=i.mult(b).toGL(),w.viewMatrixInverse=i.inverse().toGL();for(var A=0;A<T._clipPlanes.length;A++){var N=T._clipPlanes[A].plane,R=T._clipPlanes[A].trafo;w["clipPlane"+A+"_Plane"]=R.multMatrixPlane(N._vf.plane).toGL(),w["clipPlane"+A+"_CappingStrength"]=N._vf.cappingStrength,w["clipPlane"+A+"_CappingColor"]=N._vf.cappingColor.toGL()}}if(0==S.imageGeometry||x3dom.caps.MOBILE){if((0!=S.binaryGeometry||0!=S.externalGeometry)&&1==M._vf.idsPerVertex){var I=C._shader;if(I&&x3dom.isa(C._shader,x3dom.nodeTypes.CommonSurfaceShader)&&I.getMultiVisibilityMap()){w.multiVisibilityMap=0;var P=x3dom.Utils.findTextureByName(S.texture,"multiVisibilityMap");w.multiVisibilityWidth=P.texture.width,w.multiVisibilityHeight=P.texture.height,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,P.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}}}else{w.IG_bboxMin=M.getMin().toGL(),w.IG_bboxMax=M.getMax().toGL(),w.IG_implicitMeshSize=M._vf.implicitMeshSize.toGL();var D=x3dom.Utils.findTextureByName(S.texture,"IG_coords0");if(D&&(w.IG_coordTextureWidth=D.texture.width,w.IG_coordTextureHeight=D.texture.height),1==S.imageGeometry){var V=x3dom.Utils.findTextureByName(S.texture,"IG_index");V&&(w.IG_indexTextureWidth=V.texture.width,w.IG_indexTextureHeight=V.texture.height),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,V.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,D.texture)}else e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,D.texture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);var L=0;M.getIndexTexture()&&(w.IG_indexTexture||(w.IG_indexTexture=L++)),M.getCoordinateTexture(0)&&(w.IG_coordinateTexture||(w.IG_coordinateTexture=L++))}T.isSolid()?(this.stateManager.enable(e.CULL_FACE),T.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);var O=C?C._cf.depthMode.node:null;if(O?O._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!O._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,O._vf.depthFunc)),this.stateManager.depthRange(O._vf.zNearRange,O._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),S.popGeometry){var B=i.mult(b);this.updatePopState(y,M,w,S,t,B,p,this.x3dElem.runtime.fps)}var k;k=0!=S.externalGeometry?S.primType.length:S.positions.length;for(var G=0;G<k;G++){var U,X,z,j=6*G;if(void 0!==w.position&&S.buffers[j+1]&&(S.indexes[G]||0!=S.externalGeometry)){if(m=!1,S.buffers[j]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,S.buffers[j]),m=!0),void 0!==w.position&&S.buffers[j+1]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+1]),e.vertexAttribPointer(w.position,F._numPosComponents,S.coordType,!1,T._coordStrideOffset[0],T._coordStrideOffset[1]),e.enableVertexAttribArray(w.position)),1==a&&void 0!==w.color&&S.buffers[j+4]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+4]),e.vertexAttribPointer(w.color,F._numColComponents,S.colorType,!1,T._colorStrideOffset[0],T._colorStrideOffset[1]),e.enableVertexAttribArray(w.color)),2==a&&void 0!==w.texcoord&&S.buffers[j+3]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+3]),e.vertexAttribPointer(w.texcoord,F._numTexComponents,S.texCoordType,!1,T._texCoordStrideOffset[0],T._texCoordStrideOffset[1]),e.enableVertexAttribArray(w.texcoord)),void 0!==w.id&&S.buffers[j+5]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+5]),0==S.binaryGeometry&&0==S.externalGeometry||1!=M._vf.idsPerVertex||(e.vertexAttribPointer(w.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(w.id))),m&&(S.binaryGeometry>0||S.popGeometry>0))for(U=0,z=0,X=M._vf.vertexCount.length;U<X;U++)e.drawElements(S.primType[U],M._vf.vertexCount[U],S.indexType,x3dom.Utils.getByteAwareOffset(z,S.indexType,e)),z+=M._vf.vertexCount[U];else if(S.binaryGeometry<0||S.popGeometry<0||S.imageGeometry)for(U=0,z=0,X=M._vf.vertexCount.length;U<X;U++)e.drawArrays(S.primType[U],z,M._vf.vertexCount[U]),z+=M._vf.vertexCount[U];else if(1==S.externalGeometry)e.drawElements(S.primType[G],S.drawCount[G],S.indexType,S.indexOffset[G]);else if(S.externalGeometry==-1)e.drawArrays(S.primType[G],0,S.drawCount[G]);else if(M.hasIndexOffset()){var H=T.tessellationProperties();for(U=0,X=H.length;U<X;U++)e.drawElements(S.primType,H[U].count,S.indexType,H[U].offset*x3dom.Utils.getOffsetMultiplier(S.indexType,e))}else 0==S.indexes[G].length?e.drawArrays(S.primType,0,S.positions[G].length/3):e.drawElements(S.primType,S.indexes[G].length,S.indexType,0);e.disableVertexAttribArray(w.position),void 0!==w.texcoord&&S.buffers[j+3]&&e.disableVertexAttribArray(w.texcoord),void 0!==w.color&&S.buffers[j+4]&&e.disableVertexAttribArray(w.color),void 0!==w.id&&S.buffers[j+5]&&e.disableVertexAttribArray(w.id)}}0==S.imageGeometry||x3dom.caps.MOBILE||(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),1==S.imageGeometry&&(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null)))}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),O&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush();try{var W=new Uint8Array(4*l*h);e.readPixels(c,_,l,h,e.RGBA,e.UNSIGNED_BYTE,W),t._webgl.fboPick.pixelData=W}catch(Y){t._webgl.fboPick.pixelData=[],x3dom.debug.logException(Y+" (cannot pick)")}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderShape=function(e,t,i,s,o,r,a,n,d){var l=!1,h=e.shape,u=e.transform;if(!h||!h._webgl||!u)return void x3dom.debug.logError("[Context|RenderShape] No valid Shape!");var f=h._webgl,c=f.shader;if(!c)return void x3dom.debug.logError("[Context|RenderShape] No Shader is set!");var _=this.stateManager.useProgram(c),m=h._cf.appearance.node,p=h._cf.geometry.node,x=p._mesh,g=t._scene,v=null;f.coordType!=d.FLOAT?(!f.popGeometry&&x3dom.Utils.isUnsignedType(p._vf.coordType)?c.bgCenter=p.getMin().toGL():c.bgCenter=p._vf.position.toGL(),c.bgSize=p._vf.size.toGL(),c.bgPrecisionMax=p.getPrecisionMax("coordType")):(c.bgCenter=[0,0,0],c.bgSize=[1,1,1],c.bgPrecisionMax=1),f.colorType!=d.FLOAT?c.bgPrecisionColMax=p.getPrecisionMax("colorType"):c.bgPrecisionColMax=1,f.texCoordType!=d.FLOAT?c.bgPrecisionTexMax=p.getPrecisionMax("texCoordType"):c.bgPrecisionTexMax=1,f.normalType!=d.FLOAT?c.bgPrecisionNorMax=p.getPrecisionMax("normalType"):c.bgPrecisionNorMax=1,0!=f.imageGeometry&&(c.IG_bboxMin=p.getMin().toGL(),c.IG_bboxMax=p.getMax().toGL(),c.IG_implicitMeshSize=p._vf.implicitMeshSize.toGL(),v=x3dom.Utils.findTextureByName(f.texture,"IG_coords0"),v&&(c.IG_coordTextureWidth=v.texture.width,c.IG_coordTextureHeight=v.texture.height),1==f.imageGeometry&&(v=x3dom.Utils.findTextureByName(f.texture,"IG_index"),v&&(c.IG_indexTextureWidth=v.texture.width,c.IG_indexTextureHeight=v.texture.height)),v=null);var y=g.getFog();y&&_&&(c.fogColor=y._vf.color.toGL(),c.fogRange=y._vf.visibilityRange,c.fogType="LINEAR"==y._vf.fogType?0:1);var b=m?m._cf.material.node:null,T=m?m._shader:null,S=!1,M=T&&x3dom.isa(T,x3dom.nodeTypes.ComposedShader);if(f.csshader?(c.diffuseColor=T._vf.diffuseFactor.toGL(),c.specularColor=T._vf.specularFactor.toGL(),c.emissiveColor=T._vf.emissiveFactor.toGL(),c.shininess=T._vf.shininessFactor,c.ambientIntensity=(T._vf.ambientFactor.x+T._vf.ambientFactor.y+T._vf.ambientFactor.z)/3,c.transparency=1-T._vf.alphaFactor,T.getDisplacementMap()?(v=x3dom.Utils.findTextureByName(f.texture,"displacementMap"),c.displacementWidth=v.texture.width,c.displacementHeight=v.texture.height,c.displacementFactor=T._vf.displacementFactor,c.displacementAxis="x"==T._vf.displacementAxis?0:"y"==T._vf.displacementAxis?1:2):T.getDiffuseDisplacementMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"diffuseDisplacementMap"),c.displacementWidth=v.texture.width,c.displacementHeight=v.texture.height,c.displacementFactor=T._vf.displacementFactor,c.displacementAxis="x"==T._vf.displacementAxis?0:"y"==T._vf.displacementAxis?1:2),T.getMultiDiffuseAlphaMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiDiffuseAlphaMap"),c.multiDiffuseAlphaWidth=v.texture.width,c.multiDiffuseAlphaHeight=v.texture.height),T.getMultiEmissiveAmbientMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiEmissiveAmbientMap"),c.multiEmissiveAmbientWidth=v.texture.width,c.multiEmissiveAmbientHeight=v.texture.height),T.getMultiSpecularShininessMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiSpecularShininessMap"),c.multiSpecularShininessWidth=v.texture.width,c.multiSpecularShininessHeight=v.texture.height),T.getMultiVisibilityMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiVisibilityMap"),c.multiVisibilityWidth=v.texture.width,c.multiVisibilityHeight=v.texture.height)):b?(c.diffuseColor=b._vf.diffuseColor.toGL(),c.specularColor=b._vf.specularColor.toGL(),c.emissiveColor=b._vf.emissiveColor.toGL(),c.shininess=b._vf.shininess,c.ambientIntensity=b._vf.ambientIntensity,c.transparency=b._vf.transparency,x3dom.isa(b,x3dom.nodeTypes.TwoSidedMaterial)&&(S=!0,c.backDiffuseColor=b._vf.backDiffuseColor.toGL(),c.backSpecularColor=b._vf.backSpecularColor.toGL(),c.backEmissiveColor=b._vf.backEmissiveColor.toGL(),c.backShininess=b._vf.backShininess,c.backAmbientIntensity=b._vf.backAmbientIntensity,c.backTransparency=b._vf.backTransparency)):(c.diffuseColor=[1,1,1],c.specularColor=[0,0,0],c.emissiveColor=[0,0,0],c.shininess=0,c.ambientIntensity=1,c.transparency=0),T)if(M){for(var C in T._vf)if(T._vf.hasOwnProperty(C)&&"language"!==C){var F=T._vf[C];void 0!==F&&null!==F&&(F.toGL?c[C]=F.toGL():c[C]=F)}}else x3dom.isa(T,x3dom.nodeTypes.CommonSurfaceShader)&&(f.csshader=T);for(var E=0;E<s&&_;E++){var w=o.mult(i[E].getCurrentTransform());x3dom.isa(i[E],x3dom.nodeTypes.DirectionalLight)?(c["light"+E+"_Type"]=0,c["light"+E+"_On"]=i[E]._vf.on?1:0,c["light"+E+"_Color"]=i[E]._vf.color.toGL(),c["light"+E+"_Intensity"]=i[E]._vf.intensity,c["light"+E+"_AmbientIntensity"]=i[E]._vf.ambientIntensity,c["light"+E+"_Direction"]=w.multMatrixVec(i[E]._vf.direction).toGL(),c["light"+E+"_Attenuation"]=[1,1,1],c["light"+E+"_Location"]=[1,1,1],c["light"+E+"_Radius"]=0,c["light"+E+"_BeamWidth"]=0,c["light"+E+"_CutOffAngle"]=0,c["light"+E+"_ShadowIntensity"]=i[E]._vf.shadowIntensity):x3dom.isa(i[E],x3dom.nodeTypes.PointLight)?(c["light"+E+"_Type"]=1,c["light"+E+"_On"]=i[E]._vf.on?1:0,c["light"+E+"_Color"]=i[E]._vf.color.toGL(),c["light"+E+"_Intensity"]=i[E]._vf.intensity,c["light"+E+"_AmbientIntensity"]=i[E]._vf.ambientIntensity,c["light"+E+"_Direction"]=[1,1,1],c["light"+E+"_Attenuation"]=i[E]._vf.attenuation.toGL(),c["light"+E+"_Location"]=w.multMatrixPnt(i[E]._vf.location).toGL(),c["light"+E+"_Radius"]=i[E]._vf.radius,c["light"+E+"_BeamWidth"]=0,c["light"+E+"_CutOffAngle"]=0,c["light"+E+"_ShadowIntensity"]=i[E]._vf.shadowIntensity):x3dom.isa(i[E],x3dom.nodeTypes.SpotLight)&&(c["light"+E+"_Type"]=2,c["light"+E+"_On"]=i[E]._vf.on?1:0,c["light"+E+"_Color"]=i[E]._vf.color.toGL(),c["light"+E+"_Intensity"]=i[E]._vf.intensity,c["light"+E+"_AmbientIntensity"]=i[E]._vf.ambientIntensity,c["light"+E+"_Direction"]=w.multMatrixVec(i[E]._vf.direction).toGL(),c["light"+E+"_Attenuation"]=i[E]._vf.attenuation.toGL(),c["light"+E+"_Location"]=w.multMatrixPnt(i[E]._vf.location).toGL(),c["light"+E+"_Radius"]=i[E]._vf.radius,c["light"+E+"_BeamWidth"]=i[E]._vf.beamWidth,c["light"+E+"_CutOffAngle"]=i[E]._vf.cutOffAngle,c["light"+E+"_ShadowIntensity"]=i[E]._vf.shadowIntensity)}var A=g.getNavigationInfo();if(A._vf.headlight&&_&&(s=s?s:0,c["light"+s+"_Type"]=0,c["light"+s+"_On"]=1,c["light"+s+"_Color"]=[1,1,1],c["light"+s+"_Intensity"]=1,c["light"+s+"_AmbientIntensity"]=0,c["light"+s+"_Direction"]=[0,0,-1],c["light"+s+"_Attenuation"]=[1,1,1],c["light"+s+"_Location"]=[1,1,1],c["light"+s+"_Radius"]=0,c["light"+s+"_BeamWidth"]=0,c["light"+s+"_CutOffAngle"]=0,c["light"+s+"_ShadowIntensity"]=0),h._clipPlanes)for(var N=0;N<h._clipPlanes.length;N++){var R=h._clipPlanes[N].plane,I=h._clipPlanes[N].trafo;c["clipPlane"+N+"_Plane"]=I.multMatrixPlane(R._vf.plane).toGL(),c["clipPlane"+N+"_CappingStrength"]=R._vf.cappingStrength,c["clipPlane"+N+"_CappingColor"]=R._vf.cappingColor.toGL()}var P=m?m._cf.depthMode.node:null;P?P._vf.enableDepthTest?(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!P._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(d,P._vf.depthFunc)),this.stateManager.depthRange(P._vf.zNearRange,P._vf.zFarRange)):this.stateManager.disable(d.DEPTH_TEST):(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL));var D=m?m._cf.blendMode.node:null;if(D){var V=x3dom.Utils.blendFunc(d,D._vf.srcFactor),L=x3dom.Utils.blendFunc(d,D._vf.destFactor);V&&L?(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(V,L,d.ONE,d.ONE),this.stateManager.blendColor(D._vf.color.r,D._vf.color.g,D._vf.color.b,1-D._vf.colorTransparency),this.stateManager.blendEquation(x3dom.Utils.blendEquation(d,D._vf.equation))):this.stateManager.disable(d.BLEND)}else this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE);var O=m?m._cf.colorMaskMode.node:null;O?this.stateManager.colorMask(O._vf.maskR,O._vf.maskG,O._vf.maskB,O._vf.maskA):this.stateManager.colorMask(!0,!0,!0,!0);var B=m?m._cf.lineProperties.node:null;B?this.stateManager.lineWidth(B._vf.linewidthScaleFactor):x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),h.isSolid()&&!S?(this.stateManager.enable(d.CULL_FACE),h.isCCW()?this.stateManager.frontFace(d.CCW):this.stateManager.frontFace(d.CW)):this.stateManager.disable(d.CULL_FACE);var k=o.mult(u),G=k.inverse();c.modelViewMatrix=k.toGL(),c.viewMatrix=o.toGL(),c.normalMatrix=G.transpose().toGL(),c.modelViewMatrixInverse=G.toGL(),c.modelViewProjectionMatrix=r.mult(u).toGL(),(M||h._clipPlanes&&h._clipPlanes.length)&&(c.viewMatrixInverse=o.inverse().toGL()),M&&(c.projectionMatrix=n.toGL(),c.worldMatrix=u.toGL(),c.worldInverseTranspose=u.inverse().transpose().toGL()),f.popGeometry&&this.updatePopState(e,p,c,f,g,k,t,this.x3dElem.runtime.fps);for(var U=0,X=f.texture.length;U<X;U++)v=f.texture[U],d.activeTexture(d.TEXTURE0+U),d.bindTexture(v.type,v.texture),d.texParameteri(v.type,d.TEXTURE_WRAP_S,v.wrapS),d.texParameteri(v.type,d.TEXTURE_WRAP_T,v.wrapT),d.texParameteri(v.type,d.TEXTURE_MAG_FILTER,v.magFilter),d.texParameteri(v.type,d.TEXTURE_MIN_FILTER,v.minFilter),T&&M||c[v.samplerName]||(c[v.samplerName]=U);if(m&&m._cf.textureTransform.node){var z=m.texTransformMatrix();c.texTrafoMatrix=z.toGL()}var j,H=null,W=f.dynamicFields.length;for(j=0;j<W;j++)H=f.dynamicFields[j],void 0!==c[H.name]&&(d.bindBuffer(d.ARRAY_BUFFER,H.buf),d.vertexAttribPointer(c[H.name],H.numComponents,d.FLOAT,!1,0,0),d.enableVertexAttribArray(c[H.name]));var Y,q,Q,K,Z=!1;x3dom.isa(p,x3dom.nodeTypes.ParticleSet)&&(Z=!0),K=0!=f.externalGeometry?f.primType.length:f.positions.length;for(var $=0;$<K;$++){var J=6*$;if(void 0!==c.position&&f.buffers[J+1]&&(f.indexes[$]||0!=f.externalGeometry)){if(l=!1,f.buffers[J]){if(Z&&"any"!=p.drawOrder()){for(var ee,te=[],ie=p._cf.coord.node.getPoints(),se=ie.length==f.indexes[$].length?f.indexes[$].length:0,oe=0;oe<se;oe++){var re=k.multMatrixPnt(ie[oe]);te.push([oe,re.z])}for("backtofront"==p.drawOrder()?te.sort(function(e,t){return e[1]-t[1]}):te.sort(function(e,t){return t[1]-e[1]}),oe=0;oe<se;oe++)h._webgl.indexes[$][oe]=te[oe][0];x3dom.caps.INDEX_UINT&&se>65535?(ee=new Uint32Array(h._webgl.indexes[$]),h._webgl.indexType=d.UNSIGNED_INT):(ee=new Uint16Array(h._webgl.indexes[$]),h._webgl.indexType=d.UNSIGNED_SHORT),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,f.buffers[J]),d.bufferData(d.ELEMENT_ARRAY_BUFFER,ee,d.DYNAMIC_DRAW),ee=null}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,f.buffers[J]),l=!0}void 0!==c.position&&f.buffers[J+1]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+1]),d.vertexAttribPointer(c.position,x._numPosComponents,f.coordType,!1,h._coordStrideOffset[0],h._coordStrideOffset[1]),d.enableVertexAttribArray(c.position)),void 0!==c.normal&&f.buffers[J+2]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+2]),d.vertexAttribPointer(c.normal,x._numNormComponents,f.normalType,!1,h._normalStrideOffset[0],h._normalStrideOffset[1]),d.enableVertexAttribArray(c.normal)),void 0!==c.texcoord&&f.buffers[J+3]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+3]),d.vertexAttribPointer(c.texcoord,x._numTexComponents,f.texCoordType,!1,h._texCoordStrideOffset[0],h._texCoordStrideOffset[1]),d.enableVertexAttribArray(c.texcoord)),void 0!==c.color&&f.buffers[J+4]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+4]),d.vertexAttribPointer(c.color,x._numColComponents,f.colorType,!1,h._colorStrideOffset[0],h._colorStrideOffset[1]),d.enableVertexAttribArray(c.color)),void 0===c.id&&void 0===c.particleSize||!f.buffers[J+5]||(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+5]),0==f.binaryGeometry&&0==f.externalGeometry||1!=p._vf.idsPerVertex?Z&&(d.vertexAttribPointer(c.particleSize,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(c.particleSize)):(d.vertexAttribPointer(c.id,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(c.id))),0!=f.popGeometry&&f.buffers[J+5]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[J+5]),d.vertexAttribPointer(c.PG_vertexID,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(c.PG_vertexID));var ae,ne=t.getRenderMode();if(ne>0){var de=1==ne?d.POINTS:d.LINES;if(l&&(f.binaryGeometry>0||f.popGeometry>0))for(Y=0,Q=0,q=p._vf.vertexCount.length;Y<q;Y++)d.drawElements(de,p._vf.vertexCount[Y],f.indexType,x3dom.Utils.getByteAwareOffset(Q,f.indexType,d)),Q+=p._vf.vertexCount[Y];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for(Y=0,Q=0,q=p._vf.vertexCount.length;Y<q;Y++)d.drawArrays(de,Q,p._vf.vertexCount[Y]),Q+=p._vf.vertexCount[Y];else if(1==f.externalGeometry)d.drawElements(de,f.drawCount[$],f.indexType,f.indexOffset[$]);else if(f.externalGeometry==-1)d.drawArrays(de,0,f.drawCount[$]);else if(p.hasIndexOffset())for(ae=h.tessellationProperties(),Y=0,q=ae.length;Y<q;Y++)d.drawElements(de,ae[Y].count,f.indexType,ae[Y].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,d));else 0==f.indexes[$].length?d.drawArrays(de,0,f.positions[$].length/3):d.drawElements(de,f.indexes[$].length,f.indexType,0)}else if(l&&(f.binaryGeometry>0||f.popGeometry>0))for(Y=0,Q=0,q=p._vf.vertexCount.length;Y<q;Y++)d.drawElements(f.primType[Y],p._vf.vertexCount[Y],f.indexType,x3dom.Utils.getByteAwareOffset(Q,f.indexType,d)),Q+=p._vf.vertexCount[Y];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for(Y=0,Q=0,q=p._vf.vertexCount.length;Y<q;Y++)d.drawArrays(f.primType[Y],Q,p._vf.vertexCount[Y]),Q+=p._vf.vertexCount[Y];else if(1==f.externalGeometry)d.drawElements(f.primType[$],f.drawCount[$],f.indexType,f.indexOffset[$]);else if(f.externalGeometry==-1)d.drawArrays(f.primType[$],0,f.drawCount[$]);else if(p.hasIndexOffset())for(ae=h.tessellationProperties(),
Y=0,q=ae.length;Y<q;Y++)d.drawElements(f.primType,ae[Y].count,f.indexType,ae[Y].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,d));else 0==f.indexes[$].length?d.drawArrays(f.primType,0,f.positions[$].length/3):d.drawElements(f.primType,f.indexes[$].length,f.indexType,0);d.disableVertexAttribArray(c.position),void 0!==c.normal&&d.disableVertexAttribArray(c.normal),void 0!==c.texcoord&&d.disableVertexAttribArray(c.texcoord),void 0!==c.color&&d.disableVertexAttribArray(c.color),f.buffers[J+5]&&(void 0!==c.id?d.disableVertexAttribArray(c.id):void 0!==c.particleSize&&d.disableVertexAttribArray(c.particleSize)),0!=f.popGeometry&&void 0!==c.PG_vertexID&&d.disableVertexAttribArray(c.PG_vertexID)}}for(j=0;j<W;j++)H=f.dynamicFields[j],void 0!==c[H.name]&&d.disableVertexAttribArray(c[H.name]);if(f.imageGeometry)for(q=p._vf.vertexCount.length,this.numDrawCalls+=q,Y=0;Y<q;Y++)f.primType[Y]==d.TRIANGLE_STRIP?this.numFaces+=p._vf.vertexCount[Y]-2:this.numFaces+=p._vf.vertexCount[Y]/3,this.numCoords+=p._vf.vertexCount[Y];else this.numCoords+=x._numCoords,this.numFaces+=x._numFaces,f.binaryGeometry||f.popGeometry?this.numDrawCalls+=p._vf.vertexCount.length:p.hasIndexOffset()?this.numDrawCalls+=h.tessellationProperties().length:this.numDrawCalls+=K;P&&(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL),this.stateManager.depthRange(0,1)),D&&(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE),this.stateManager.blendColor(1,1,1,1),this.stateManager.blendEquation(d.FUNC_ADD)),O&&this.stateManager.colorMask(!0,!0,!0,!0),B&&this.stateManager.lineWidth(1);var le=f.texture;for(X=le?le.length:0,U=0;U<X;U++)le[U]&&m&&m._cf.texture.node&&(v=m._cf.texture.node.getTexture(U),d.activeTexture(d.TEXTURE0+U),x3dom.isa(v,x3dom.nodeTypes.X3DEnvironmentTextureNode)?d.bindTexture(d.TEXTURE_CUBE_MAP,null):d.bindTexture(d.TEXTURE_2D,null))},e.prototype.updatePopState=function(e,t,i,s,o,r,a,n){var d=x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor*t._vf.precisionFactor;(n<=1||a.isMovingOrAnimating())&&(d*=x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove);var l=16;if(d>0){var h=o.getViewpoint(),u=h.getImgPlaneHeightAtDistOne(),f=h.getNear(),c=r.multMatrixPnt(t._vf.position),_=.5*r.multMatrixVec(t._vf.size).length(),m=.5*r.multMatrixVec(t._vf.maxBBSize).length(),p=Math.max(-c.z-_,f),x=p*(u/a._height),g=2*m/(d*x);l=Math.ceil(Math.log(g)/.693147180559945),l=l<1?1:l>16?16:l}var v=t._vf.minPrecisionLevel,y=t._vf.maxPrecisionLevel;l=v!=-1&&l<v?v:l,l=y!=-1&&l>y?y:l;var b=s.levelsAvailable<l?s.levelsAvailable:l;l=b,d<=1&&(l=l==t.getNumLevels()?16:l);var T=t._vf.indexedRendering,S=t._mesh;S._numCoords=0,S._numFaces=0;for(var M=0;M<b;++M){var C=s.numVerticesAtLevel[M];S._numCoords+=C,S._numFaces+=(T?t.getNumIndicesByLevel(M):C)/3}x3dom.nodeTypes.PopGeometry.numRenderedVerts+=S._numCoords,x3dom.nodeTypes.PopGeometry.numRenderedTris+=S._numFaces,S.currentLOD=l,t.adaptVertexCount(T?3*S._numFaces:S._numCoords),i.PG_maxBBSize=t._vf.maxBBSize.toGL(),i.PG_bbMin=t._bbMinBySize,i.PG_numAnchorVertices=t._vf.numAnchorVertices,i.PG_bbMaxModF=t._vf.bbMaxModF.toGL(),i.PG_bboxShiftVec=t._vf.bbShiftVec.toGL(),i.PG_precisionLevel=l,i.PG_powPrecision=x3dom.nodeTypes.PopGeometry.powLUT[l-1]},e.prototype.pickValue=function(e,t,i,s,o,r){x3dom.Utils.startMeasure("picking");var a=e._scene,n=this.ctx3d;if(!(n&&a&&a._webgl&&a.drawableCollection))return!1;var d=a._vf.pickMode.toLowerCase(),l=0;switch(d){case"box":return!1;case"idbuf":l=0;break;case"idbuf24":l=3;break;case"idbufid":l=4;break;case"color":l=1;break;case"texcoord":l=2}var h,u;arguments.length>4?(h=o,u=r):(h=e._last_mat_view,u=e._last_mat_scene);var f=x3dom.fields.SFVec3f.copy(a._lastMin),c=x3dom.fields.SFVec3f.copy(a._lastMax),_=h.inverse().e3(),m=x3dom.fields.SFVec3f.copy(_),p=x3dom.fields.SFVec3f.copy(_);m.x>f.x&&(m.x=f.x),m.y>f.y&&(m.y=f.y),m.z>f.z&&(m.z=f.z),p.x<c.x&&(p.x=c.x),p.y<c.y&&(p.y=c.y),p.z<c.z&&(p.z=c.z),a._lastMin.setValues(m),a._lastMax.setValues(p);var x=a._lastMax.subtract(a._lastMin).length(),g=e.getCCtoWCMatrix();a._lastMin.setValues(f),a._lastMax.setValues(c);var v=x3dom.nodeTypes.Shape.objectID+2;this.renderPickingPass(n,a,h,u,_,x,l,t,i,2,2);var y=a._webgl.fboPick.pixelData;if(y&&y.length){var b,T,S,M,C,F,E=new x3dom.fields.SFVec3f(0,0,0),w=new x3dom.fields.SFVec3f(0,0,1),A=0,N=y[A+3],R=1/a._webgl.pickScale,I=1/256;0==l?(N+=256*y[A+2],T=y[A]/255*I+y[A+1]/255,S=e.calcViewRay(t,i,g),E=S.pos.add(S.dir.multiply(T*x)),A=4,T=y[A]/255*I+y[A+1]/255,M=e.calcViewRay(t+R,i,g),C=M.pos.add(M.dir.multiply(T*x)),C=C.subtract(E).normalize(),A=8,T=y[A]/255*I+y[A+1]/255,M=e.calcViewRay(t,i-R,g),F=M.pos.add(M.dir.multiply(T*x)),F=F.subtract(E).normalize(),w=C.cross(F).normalize()):3==l?(N+=256*y[A+2]+65536*y[A+1],T=y[A]/255,S=e.calcViewRay(t,i,g),E=S.pos.add(S.dir.multiply(T*x)),A=4,T=y[A]/255,M=e.calcViewRay(t+R,i,g),C=M.pos.add(M.dir.multiply(T*x)),C=C.subtract(E).normalize(),A=8,T=y[A]/255,M=e.calcViewRay(t,i-R,g),F=M.pos.add(M.dir.multiply(T*x)),F=F.subtract(E).normalize(),w=C.cross(F).normalize()):4==l?(N+=256*y[A+2],b=y[A+1],b+=256*y[A],0==N&&b>0&&b<v&&(N=b)):(E.x=y[A],E.y=y[A+1],E.z=y[A+2]);var P,D,V="shadowObjectIdChanged",L=Math.max(s>>>8,255&s);if(N>=v){N-=v;var O;if(4!=l?(e._pickingInfo.pickPos=E,e._pick.setValues(E),e._pickingInfo.pickNorm=w,e._pickNorm.setValues(w),e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null,O=a._xmlNode):(e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[b],O=e._pickingInfo.pickObj._xmlNode),a._multiPartMap){var B,k;for(B=0;B<a._multiPartMap.multiParts.length;B++)k=a._multiPartMap.multiParts[B],N>=k._minId&&N<=k._maxId?(O=k._xmlNode,D={target:k._xmlNode,button:L,mouseup:s>>>8>0,layerX:t,layerY:i,pickedId:N,worldX:E.x,worldY:E.y,worldZ:E.z,normalX:w.x,normalY:w.y,normalZ:w.z,hitPnt:E.toGL(),hitObject:O,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D)):(D={target:k._xmlNode,button:L,mouseup:s>>>8>0,layerX:t,layerY:i,pickedId:-1,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D))}if(P=e._pickingInfo.shadowObjectId!=N,e._pickingInfo.lastShadowObjectId=e._pickingInfo.shadowObjectId,e._pickingInfo.shadowObjectId=N,(P||L)&&a._xmlNode&&(a._xmlNode["on"+V]||a._xmlNode.hasAttribute("on"+V)||a._listeners[V])&&(D={target:a._xmlNode,type:V,button:L,mouseup:s>>>8>0,layerX:t,layerY:i,shadowObjectId:N,worldX:E.x,worldY:E.y,worldZ:E.z,normalX:w.x,normalY:w.y,normalZ:w.z,hitPnt:E.toGL(),hitObject:O,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},a.callEvtHandler("on"+V,D)),a._shadowIdMap&&a._shadowIdMap.mapping&&N<a._shadowIdMap.mapping.length){var G,U,X,z=a._shadowIdMap.mapping[N].usage;for(S||(S=e.calcViewRay(t,i,g)),U=0;U<z.length;U++)if(X=a._nameSpace.defMap[z[U]],X&&X.doIntersect(S)){e._pickingInfo.pickObj=X;break}for(G=0;G<a._nameSpace.childSpaces.length;G++)for(U=0;U<z.length;U++)if(X=a._nameSpace.childSpaces[G].defMap[z[U]],X&&X.doIntersect(S)){e._pickingInfo.pickObj=X;break}}}else{if(a._multiPartMap)for(B=0;B<a._multiPartMap.multiParts.length;B++)k=a._multiPartMap.multiParts[B],D={target:k._xmlNode,button:L,mouseup:s>>>8>0,layerX:t,layerY:i,pickedId:-1,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D);P=e._pickingInfo.shadowObjectId!=-1,e._pickingInfo.shadowObjectId=-1,P&&a._xmlNode&&(a._xmlNode["on"+V]||a._xmlNode.hasAttribute("on"+V)||a._listeners[V])&&(D={target:a._xmlNode,type:V,button:L,mouseup:s>>>8>0,layerX:t,layerY:i,shadowObjectId:e._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},a.callEvtHandler("on"+V,D)),N>0?(e._pickingInfo.pickPos=E,e._pickingInfo.pickNorm=w,e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[N]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null)}}var j=x3dom.Utils.stopMeasure("picking");return this.x3dElem.runtime.addMeasurement("PICKING",j),!0},e.prototype.pickRect=function(e,t,i,s,o){var r=this.ctx3d,a=e?e._scene:null;if(!(r&&a&&a._webgl&&a.drawableCollection))return!1;var n=e._last_mat_view.inverse().e3(),d=a._lastMax.subtract(a._lastMin).length(),l=t<=s?t:s,h=i>=o?i:o,u=(1+Math.abs(s-t))*a._webgl.pickScale,f=(1+Math.abs(o-i))*a._webgl.pickScale;this.renderPickingPass(r,a,e._last_mat_view,e._last_mat_scene,n,d,0,l,h,u<1?1:u,f<1?1:f);var c,_=[];for(c=0;a._webgl.fboPick.pixelData&&c<a._webgl.fboPick.pixelData.length;c+=4){var m=a._webgl.fboPick.pixelData[c+3]+256*a._webgl.fboPick.pixelData[c+2];m>0&&_.push(m)}_.sort();var p=function(e){for(var t=[],i=e.length,s=0;s<i;s++){for(var o=s+1;o<i;o++)e[s]===e[o]&&(o=++s);t.push(e[s])}return t}(_);_=p;var x,g,v=[],y=x3dom.nodeTypes.Shape.objectID+2;for(c=0;c<_.length;c++)if(m=_[c],m>=y){if(m-=y,a._multiPartMap){var b,T,S,M,C,F,E;for(b=0;b<a._multiPartMap.multiParts.length;b++)T=a._multiPartMap.multiParts[b],S=T._inlineNamespace.defMap.MultiMaterial_ColorMap,M=T._inlineNamespace.defMap.MultiMaterial_EmissiveMap,C=T._inlineNamespace.defMap.MultiMaterial_SpecularMap,F=T._inlineNamespace.defMap.MultiMaterial_VisibilityMap,m>=T._minId&&m<=T._maxId&&(E=T._idMap.mapping[m-T._minId].name,g=new x3dom.Parts(T,[m],S,M,C,F),x={partID:E,part:g},v.push(x))}}else g=x3dom.nodeTypes.Shape.idMap.nodeID[m],g=g&&g._xmlNode?g._xmlNode:null,g&&v.push(g);return v},e.prototype.renderScene=function(e){var t=this.ctx3d,i=e._scene;if(null!==t&&null!==i){var s,o,r=e._doc._nodeBag.renderTextures,a=r.length,n=null,d=t.UNSIGNED_BYTE,l=t.UNSIGNED_BYTE,h=!1;x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE&&(d=t.FLOAT,l=t.FLOAT,x3dom.caps.FPL_TEXTURES||(h=!0));var u,f,c,_,m,p,x,g,v,y=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];if(i.updateVolume(),i._webgl){var b=Math.round(this.canvas.width*i._webgl.pickScale),T=Math.round(this.canvas.height*i._webgl.pickScale);for(i._webgl._currFboWidth===b&&i._webgl._currFboHeight===T||(i._webgl._currFboWidth=b,i._webgl._currFboHeight=T,i._webgl.fboPick=x3dom.Utils.initFBO(t,b,T,i._webgl.fboPick.type,!1,!0),i._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+b+", "+T+")")),o=0;o<a;o++)s=r[o],s._webgl&&s._webgl.fbo&&s._webgl.fbo.width==s._vf.dimensions[0]&&s._webgl.fbo.height==s._vf.dimensions[1]||(s.invalidateGLObject(),s._cleanupGLObjects?s._cleanupGLObjects():s._cleanupGLObjects=function(e){e||t.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&t.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&t.deleteRenderbuffer(this._webgl.fbo.rbo),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},n=s._cf.textureProperties.node,g=s.requirePingPong()?t.UNSIGNED_BYTE:d,s._webgl={},s._webgl.fbo=x3dom.Utils.initFBO(t,s._vf.dimensions[0],s._vf.dimensions[1],g,n&&n._vf.generateMipMaps,s._vf.depthMap||!s.requirePingPong()),s.requirePingPong()&&(v=s._vf.dimensions[0]+"x"+s._vf.dimensions[1],void 0===i._webgl.refinement[v]&&(i._webgl.refinement[v]=x3dom.Utils.initFBO(t,s._vf.dimensions[0],s._vf.dimensions[1],g,!1,!1)),s._webgl.texture=null),x3dom.debug.logInfo("Init/resize RenderedTexture_"+o+" to size "+s._vf.dimensions[0]+" x "+s._vf.dimensions[1]));for(u=e.getShadowedLights(),m=u.length,c=0;c<m;c++)if(p=u[c]._vf.shadowMapSize,f=x3dom.isa(u[c],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(u[c]._vf.shadowCascades,6)),"undefined"==typeof i._webgl.fboShadow[c]||i._webgl.fboShadow[c].length!=f||i._webgl.fboShadow[c][0].height!=p)for(i._webgl.fboShadow[c]=[],_=0;_<f;_++)i._webgl.fboShadow[c][_]=x3dom.Utils.initFBO(t,p,p,l,!1,!0);for(c=0;c<m;c++){for(p=i._webgl.fboShadow[c][0].height,x=!1,_=0;_<i._webgl.fboBlur.length;_++)p==i._webgl.fboBlur[_].height&&(x=!0);x||(i._webgl.fboBlur[i._webgl.fboBlur.length]=x3dom.Utils.initFBO(t,p,p,l,!1,!0))}((x3dom.SSAO.isEnabled(i)||i._webgl.fboShadow.length>0)&&"undefined"==typeof i._webgl.fboScene||i._webgl.fboScene&&(this.canvas.width!=i._webgl.fboScene.width||this.canvas.height!=i._webgl.fboScene.height))&&(i._webgl.fboScene=x3dom.Utils.initFBO(t,this.canvas.width,this.canvas.height,l,!1,!0))}else{for(i._webgl={},this.setupFgnds(t,i),i._webgl.pickScale=.5,i._webgl._currFboWidth=Math.round(this.canvas.width*i._webgl.pickScale),i._webgl._currFboHeight=Math.round(this.canvas.height*i._webgl.pickScale),i._webgl.fboPick=x3dom.Utils.initFBO(t,i._webgl._currFboWidth,i._webgl._currFboHeight,t.UNSIGNED_BYTE,!1,!0),i._webgl.fboPick.pixelData=null,i._webgl.normalShader=this.cache.getShader(t,x3dom.shader.NORMAL),i._webgl.fboShadow=[],u=e.getShadowedLights(),m=u.length,c=0;c<m;c++)for(p=u[c]._vf.shadowMapSize,f=x3dom.isa(u[c],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(u[c]._vf.shadowCascades,6)),i._webgl.fboShadow[c]=[],_=0;_<f;_++)i._webgl.fboShadow[c][_]=x3dom.Utils.initFBO(t,p,p,l,!1,!0);for((i._webgl.fboShadow.length>0||x3dom.SSAO.isEnabled(i))&&(i._webgl.fboScene=x3dom.Utils.initFBO(t,this.canvas.width,this.canvas.height,l,!1,!0)),i._webgl.fboBlur=[],c=0;c<m;c++){for(p=i._webgl.fboShadow[c][0].height,x=!1,_=0;_<i._webgl.fboBlur.length;_++)p==i._webgl.fboBlur[_].height&&(x=!0);x||(i._webgl.fboBlur[i._webgl.fboBlur.length]=x3dom.Utils.initFBO(t,p,p,l,!1,!0))}for(i._webgl.ppBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i._webgl.ppBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(y),t.STATIC_DRAW),i._webgl.refinement={stamps:new Array(2),positionBuffer:t.createBuffer()},t.bindBuffer(t.ARRAY_BUFFER,i._webgl.refinement.positionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(y),t.STATIC_DRAW),o=0;o<a;o++)s=r[o],n=s._cf.textureProperties.node,g=s.requirePingPong()?t.UNSIGNED_BYTE:d,s._webgl={},s._webgl.fbo=x3dom.Utils.initFBO(t,s._vf.dimensions[0],s._vf.dimensions[1],g,n&&n._vf.generateMipMaps,s._vf.depthMap||!s.requirePingPong()),s._cleanupGLObjects=function(e){e||t.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&t.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&t.deleteFramebuffer(this._webgl.fbo.rbo),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},s.requirePingPong()&&(v=s._vf.dimensions[0]+"x"+s._vf.dimensions[1],void 0===i._webgl.refinement[v]&&(i._webgl.refinement[v]=x3dom.Utils.initFBO(t,s._vf.dimensions[0],s._vf.dimensions[1],g,!1,!1)),s._webgl.texture=null);e._last_mat_view=x3dom.fields.SFMatrix4f.identity(),e._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),e._last_mat_scene=x3dom.fields.SFMatrix4f.identity(),this._calledViewpointChangedHandler=!1}var S=i.getEnvironment();S.checkSanity();var M=i.getBackground();this.setupScene(t,M),this.numFaces=0,this.numCoords=0,this.numDrawCalls=0;var C=e.getProjectionMatrix(),F=e.getViewMatrix();if(!this._calledViewpointChangedHandler||!e._last_mat_view.equals(F)){var E=i.getViewpoint(),w="viewpointChanged";try{if(E._xmlNode&&(E._xmlNode["on"+w]||E._xmlNode.hasAttribute("on"+w)||E._listeners[w])){var A=E.getCurrentTransform();A=A.inverse().mult(F);var N=A.inverse(),R=new x3dom.fields.Quaternion(0,0,1,0);R.setValue(N);var I=N.e3(),P={target:E._xmlNode,type:w,matrix:A,position:I,orientation:R.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};E.callEvtHandler("on"+w,P),this._calledViewpointChangedHandler=!0}}catch(D){x3dom.debug.logException(D)}}e._last_mat_view=F,e._last_mat_proj=C;var V=C.mult(F);if(e._last_mat_scene=V,i.drawableCollection=null,!i.drawableCollection){var L={viewArea:e,sortTrans:S._vf.sortTrans,viewMatrix:F,projMatrix:C,sceneMatrix:V,frustumCulling:!0,smallFeatureThreshold:S._smallFeatureThreshold,context:this,gl:t};i.drawableCollection=new x3dom.DrawableCollection(L),x3dom.Utils.startMeasure("traverse"),i.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),i.drawableCollection,!0,!1,0,[]);var O=x3dom.Utils.stopMeasure("traverse");this.x3dElem.runtime.addMeasurement("TRAVERSE",O)}x3dom.Utils.startMeasure("sorting"),i.drawableCollection.sort();var B=x3dom.Utils.stopMeasure("sorting");this.x3dElem.runtime.addMeasurement("SORT",B);var k,G=e.getLights(),U=G.length,X=[],z=[],j=0;x3dom.Utils.startMeasure("shadow");for(var H=0;H<U;H++)if(G[H]._vf.shadowIntensity>0){var W=e.getLightMatrix()[H];ee=i._webgl.fboShadow[j];var Y=Math.max(0,Math.min(1,G[H]._vf.shadowOffset));if(x3dom.isa(G[H],x3dom.nodeTypes.PointLight))for(k=e.getWCtoLCMatricesPointLight(W,G[H],C),c=0;c<6;c++)this.renderShadowPass(t,e,k[c],F,ee[c],Y,!1);else{var q=Math.max(1,Math.min(G[H]._vf.shadowCascades,6));for(k=e.getWCtoLCMatricesCascaded(W,G[H],C),c=0;c<q;c++)this.renderShadowPass(t,e,k[c],F,ee[c],Y,!1)}j++,X[X.length]=k,z[z.length]=W}if(j>0||x3dom.SSAO.isEnabled(i)){this.renderShadowPass(t,e,V,F,i._webgl.fboScene,0,!0);var Q=x3dom.Utils.stopMeasure("shadow");this.x3dElem.runtime.addMeasurement("SHADOW",Q)}else this.x3dElem.runtime.removeMeasurement("SHADOW");for(k=e.getWCtoLCMatrix(e.getLightMatrix()[0]),o=0;o<a;o++)this.renderRTPass(t,e,r[o]);for(x3dom.Utils.startMeasure("render"),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),M._webgl.render(t,F,C),x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,m=i.drawableCollection.length,S._vf.smallFeatureCulling&&S._lowPriorityThreshold<1&&e.isMovingOrAnimating()&&(m=Math.floor(m*S._lowPriorityThreshold),!m&&i.drawableCollection.length&&(m=1)),this.stateManager.unsetProgram(),c=0;c<m;c++){var K=i.drawableCollection.get(c);this.renderShape(K,e,G,U,F,V,k,C,t)}if(j>0&&this.renderShadows(t,e,u,X,z,F,C,V),this.stateManager.disable(t.BLEND),this.stateManager.disable(t.DEPTH_TEST),e._numRenderedNodes=m,x3dom.SSAO.isEnabled(i)&&x3dom.SSAO.renderSSAO(this.stateManager,t,i,this.canvas),void 0!==e._visDbgBuf&&e._visDbgBuf){var Z=i._vf.pickMode.toLowerCase();0!=Z.indexOf("idbuf")&&"color"!=Z&&"texcoord"!=Z||(this.stateManager.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,i._webgl.fboPick.tex)),(j>0||x3dom.SSAO.isEnabled(i))&&(this.stateManager.viewport(this.canvas.width/4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,i._webgl.fboScene.tex));var $=3,J=2;for(c=0;c<j;c++){var ee=i._webgl.fboShadow[c];for(_=0;_<ee.length;_++)this.stateManager.viewport(J*this.canvas.width/4,$*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,ee[_].tex),J<2?J++:(J=0,$--)}for(o=0;o<a;o++)s=r[o],s._webgl.fbo.fbo&&(this.stateManager.viewport(o*this.canvas.width/8,5*this.canvas.height/8,this.canvas.width/8,this.canvas.height/8),i._fgnd._webgl.render(t,s._webgl.fbo.tex))}t.finish();var te=x3dom.Utils.stopMeasure("render");this.x3dElem.runtime.addMeasurement("RENDER",te),this.x3dElem.runtime.addMeasurement("DRAW",m?te/m:0),this.x3dElem.runtime.addInfo("#NODES:",i.drawableCollection.numberOfNodes),this.x3dElem.runtime.addInfo("#SHAPES:",e._numRenderedNodes),this.x3dElem.runtime.addInfo("#DRAWS:",this.numDrawCalls),this.x3dElem.runtime.addInfo("#POINTS:",this.numCoords),this.x3dElem.runtime.addInfo("#TRIS:",this.numFaces)}},e.prototype.renderPingPongPass=function(e,t,i){var s=t._scene,o=i._vf.dimensions[0]+"x"+i._vf.dimensions[1],r=s._webgl.refinement[o];if(0!=i._currLoadLevel||s._webgl.refinement.stamps[0]&&s._webgl.refinement.stamps[1]||(s._webgl.refinement.stamps[0]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp0),!1,!1,!1,!1),s._webgl.refinement.stamps[1]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp1),!1,!1,!1,!1)),i._currLoadLevel<i._loadLevel){i._currLoadLevel++,i._webgl.texture&&e.deleteTexture(i._webgl.texture);var a=i._vf.url[0]+"/"+i._currLoadLevel+"."+i._vf.format;i._webgl.texture=x3dom.Utils.createTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(a),!1,!1,!1,!1),i._vf.iterations%2===0?i._currLoadLevel%2!==0?i._repeat.x*=2:i._repeat.y*=2:i._currLoadLevel%2===0?i._repeat.x*=2:i._repeat.y*=2}if(i._webgl.texture.ready&&s._webgl.refinement.stamps[0].ready&&s._webgl.refinement.stamps[1].ready){this.stateManager.bindFramebuffer(e.FRAMEBUFFER,r.fbo),this.stateManager.viewport(0,0,r.width,r.height),this.stateManager.disable(e.BLEND),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var n=this.cache.getShader(e,x3dom.shader.TEXTURE_REFINEMENT);this.stateManager.useProgram(n),e.bindBuffer(e.ARRAY_BUFFER,s._webgl.refinement.positionBuffer),e.vertexAttribPointer(n.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(n.position),n.stamp=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,s._webgl.refinement.stamps[(i._currLoadLevel+1)%2]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),i._currLoadLevel>1&&(n.lastTex=1,e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),n.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,i._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),n.mode=i._currLoadLevel-1,n.repeat=i._repeat.toGL(),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),n.mode=0,n.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,r.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(n.position),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),i._vf.autoRefinement&&i.nextLevel(),i._currLoadLevel==i._vf.maxLevel&&i._currLoadLevel++,i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),i.requirePingPong()||(e.deleteTexture(i._webgl.texture),delete i._webgl.texture,i._cleanupGLObjects(!0)),i._renderedImage++}},e.prototype.renderRTPass=function(e,t,i){if(x3dom.isa(i,x3dom.nodeTypes.RefinementTexture))return void(i.requirePingPong()&&this.renderPingPongPass(e,t,i));switch(i._vf.update.toUpperCase()){case"NONE":return;case"NEXT_FRAME_ONLY":if(!i._needRenderUpdate)return;i._needRenderUpdate=!1;break;case"ALWAYS":}var s,o,r=t._scene,a=null,n=i.getViewMatrix(),d=i.getProjectionMatrix(),l=d.mult(n),h=t.getLightMatrix()[0],u=t.getWCtoLCMatrix(h),f=i._cf.excludeNodes.nodes.length,c=new Array(f);for(s=0;s<f;s++){var _=i._cf.excludeNodes.nodes[s]._vf.render;void 0===_?c[s]=-1:_===!0?c[s]=1:c[s]=0,i._cf.excludeNodes.nodes[s]._vf.render=!1}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),this.stateManager.viewport(0,0,i._webgl.fbo.width,i._webgl.fbo.height),null===i._cf.background.node?(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)):i._cf.background.node===r.getBackground()?(a=r.getBackground(),a._webgl.render(e,n,d)):(a=i._cf.background.node,this.setupScene(e,a),a._webgl.render(e,n,d)),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),this.stateManager.enable(e.BLEND);var m,p=t.getLights(),x=p.length,g=i._cf.scene.node;if(g&&g!==r){var v=r.getEnvironment(),y={viewArea:t,sortTrans:v._vf.sortTrans,viewMatrix:n,projMatrix:d,sceneMatrix:l,frustumCulling:!1,smallFeatureThreshold:1,context:this,gl:e};if(g.numberOfNodes=0,g.drawableCollection=new x3dom.DrawableCollection(y),g.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),g.drawableCollection,!0,!1,0,[]),g.drawableCollection.sort(),o=g.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,g,r._webgl.normalShader,n,l);else for(this.stateManager.unsetProgram(),s=0;s<o;s++)m=g.drawableCollection.get(s),m.shape._vf.render&&this.renderShape(m,t,p,x,n,l,u,d,e)}else if(o=r.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,r,r._webgl.normalShader,n,l);else for(this.stateManager.unsetProgram(),s=0;s<o;s++)m=r.drawableCollection.get(s),this.renderShape(m,t,p,x,n,l,u,d,e);for(this.stateManager.disable(e.BLEND),this.stateManager.disable(e.DEPTH_TEST),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),s=0;s<f;s++)0!==c[s]&&(i._cf.excludeNodes.nodes[s]._vf.render=!0)},e.prototype.renderNormals=function(e,t,i,s,o){if(i&&t){this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),this.stateManager.useProgram(i);for(var r=x3dom.fields.SFVec3f.NullVector.toGL(),a=x3dom.fields.SFVec3f.OneVector.toGL(),n=0,d=t.drawableCollection.length;n<d;n++){var l=t.drawableCollection.get(n),h=l.transform,u=l.shape,f=u._webgl;if(f&&u&&u._vf.render){var c=u._cf.geometry.node,_=c._mesh,m=s.mult(h).inverse();i.normalMatrix=m.transpose().toGL(),i.modelViewProjectionMatrix=o.mult(h).toGL(),i.imageGeometry=f.imageGeometry,f.coordType!=e.FLOAT?(0!=f.popGeometry||4==_._numPosComponents&&x3dom.Utils.isUnsignedType(c._vf.coordType)?i.bgCenter=c.getMin().toGL():i.bgCenter=c._vf.position.toGL(),i.bgSize=c._vf.size.toGL(),i.bgPrecisionMax=c.getPrecisionMax("coordType")):(i.bgCenter=r,i.bgSize=a,i.bgPrecisionMax=1),f.normalType!=e.FLOAT?i.bgPrecisionNorMax=c.getPrecisionMax("normalType"):i.bgPrecisionNorMax=1,u.isSolid()?(this.stateManager.enable(e.CULL_FACE),u.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);for(var p=0,x=f.positions.length;p<x;p++){var g,v,y,b=6*p;if(void 0!==i.position&&f.buffers[b+1]&&f.indexes[p]){if(f.buffers[b]&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.buffers[b]),e.bindBuffer(e.ARRAY_BUFFER,f.buffers[b+1]),e.vertexAttribPointer(i.position,_._numPosComponents,f.coordType,!1,u._coordStrideOffset[0],u._coordStrideOffset[1]),e.enableVertexAttribArray(i.position),void 0!==i.normal&&f.buffers[b+2]&&(e.bindBuffer(e.ARRAY_BUFFER,f.buffers[b+2]),e.vertexAttribPointer(i.normal,_._numNormComponents,f.normalType,!1,u._normalStrideOffset[0],u._normalStrideOffset[1]),e.enableVertexAttribArray(i.normal)),f.binaryGeometry>0||f.popGeometry>0)for(g=0,y=0,v=c._vf.vertexCount.length;g<v;g++)e.drawElements(f.primType[g],c._vf.vertexCount[g],f.indexType,x3dom.Utils.getByteAwareOffset(y,f.indexType,e)),y+=c._vf.vertexCount[g];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for(g=0,y=0,v=c._vf.vertexCount.length;g<v;g++)e.drawArrays(f.primType[g],y,c._vf.vertexCount[g]),y+=c._vf.vertexCount[g];else if(c.hasIndexOffset()){var T=u.tessellationProperties();for(g=0,v=T.length;g<v;g++)e.drawElements(f.primType,T[g].count,f.indexType,T[g].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,e))}else 0==f.indexes[p].length?e.drawArrays(f.primType,0,f.positions[p].length/3):e.drawElements(f.primType,f.indexes[p].length,f.indexType,0);e.disableVertexAttribArray(i.position),void 0!==i.normal&&e.disableVertexAttribArray(i.normal)}}}}}},e.prototype.shutdown=function(e){var t=this.ctx3d,i=e._scene;if(null!=t&&i){var s=i.getBackground();void 0!==s._webgl.position&&(t.deleteBuffer(s._webgl.buffers[1]),t.deleteBuffer(s._webgl.buffers[0]));var o=i._fgnd;void 0!==o._webgl.position&&(t.deleteBuffer(o._webgl.buffers[1]),t.deleteBuffer(o._webgl.buffers[0]));for(var r=i.drawableCollection?i.drawableCollection.length:0,a=0;a<r;a++){var n=i.drawableCollection.get(a).shape;n._cleanupGLObjects&&n._cleanupGLObjects(!0)}this.cache.Release(t)}},e.prototype.renderShadows=function(e,t,i,s,o,r,a,n){var d=t._scene,l=x3dom.caps.MAX_TEXTURE_IMAGE_UNITS;if(!(l<7)){var h,u,f,c,_,m=1,p=[0];for(f=0;f<i.length;f++){var x=i[f]._vf.shadowFilterSize;for(h=d._webgl.fboShadow[f],u=h.length,c=0;c<u;c++)this.blurTex(e,d,h[c],x);m+=6,m>l&&(p[p.length]=f,m=7)}p[p.length]=i.length;var g=p.length-1,v=a.inverse(),y=n.inverse();this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.DST_COLOR,e.ZERO);for(var b=0;b<g;b++){var T=p[b],S=p[b+1],M=[];for(_=T;_<S;_++)M[M.length]=i[_];var C=this.cache.getShadowRenderingShader(e,M);this.stateManager.useProgram(C),e.bindBuffer(e.ARRAY_BUFFER,d._webgl.ppBuffer),e.vertexAttribPointer(C.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(C.position),C.sceneMap=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,d._webgl.fboScene.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),C.inverseProj=v.toGL(),C.inverseViewProj=y.toGL();for(var F,E,w=0,A=0,N=M.length;A<N;A++){for(E=o[A+T],F=s[A+T],h=d._webgl.fboShadow[A+T],u=F.length,f=0;f<u;f++)e.activeTexture(e.TEXTURE1+w),e.bindTexture(e.TEXTURE_2D,h[f].tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),C["light"+A+"_"+f+"_ShadowMap"]=w+1,C["light"+A+"_"+f+"_Matrix"]=F[f].toGL(),w++;if(C["light"+A+"_ViewMatrix"]=E.toGL(),!x3dom.isa(M[A],x3dom.nodeTypes.PointLight))for(c=0;c<u;c++){var R=Math.max(1,Math.min(M[A]._vf.shadowCascades,6)),I=Math.max(0,Math.min(M[A]._vf.shadowSplitFactor,1)),P=Math.max(0,Math.min(M[A]._vf.shadowSplitOffset,1)),D=t.getShadowSplitDepths(R,I,P,!1,a);C["light"+A+"_"+c+"_Split"]=D[c+1]}var V=r.mult(M[A].getCurrentTransform());x3dom.isa(M[A],x3dom.nodeTypes.DirectionalLight)?(C["light"+A+"_Type"]=0,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=V.multMatrixVec(M[A]._vf.direction).toGL(),C["light"+A+"_Attenuation"]=[1,1,1],C["light"+A+"_Location"]=[1,1,1],C["light"+A+"_Radius"]=0,C["light"+A+"_BeamWidth"]=0,C["light"+A+"_CutOffAngle"]=0,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowCascades"]=M[A]._vf.shadowCascades,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset))):x3dom.isa(M[A],x3dom.nodeTypes.PointLight)?(C["light"+A+"_Type"]=1,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=[1,1,1],C["light"+A+"_Attenuation"]=M[A]._vf.attenuation.toGL(),C["light"+A+"_Location"]=V.multMatrixPnt(M[A]._vf.location).toGL(),C["light"+A+"_Radius"]=M[A]._vf.radius,C["light"+A+"_BeamWidth"]=0,C["light"+A+"_CutOffAngle"]=0,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset))):x3dom.isa(M[A],x3dom.nodeTypes.SpotLight)&&(C["light"+A+"_Type"]=2,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=V.multMatrixVec(M[A]._vf.direction).toGL(),C["light"+A+"_Attenuation"]=M[A]._vf.attenuation.toGL(),C["light"+A+"_Location"]=V.multMatrixPnt(M[A]._vf.location).toGL(),C["light"+A+"_Radius"]=M[A]._vf.radius,C["light"+A+"_BeamWidth"]=M[A]._vf.beamWidth,
C["light"+A+"_CutOffAngle"]=M[A]._vf.cutOffAngle,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowCascades"]=M[A]._vf.shadowCascades,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset)))}e.drawArrays(e.TRIANGLES,0,6);var L=w+1;for(_=0;_<L;_++)e.activeTexture(e.TEXTURE0+_),e.bindTexture(e.TEXTURE_2D,null);e.disableVertexAttribArray(C.position)}this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}},e.prototype.blurTex=function(e,t,i,s){if(!(s<=0)){s=s<5?3:s<7?5:7;for(var o=i.width,r=i.height,a=null,n=0,d=t._webgl.fboBlur.length;n<d;n++)if(r==t._webgl.fboBlur[n].height){a=t._webgl.fboBlur[n];break}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,a.fbo),this.stateManager.viewport(0,0,o,r),this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.ONE,e.ZERO),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var l=this.cache.getShader(e,x3dom.shader.BLUR);this.stateManager.useProgram(l),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.ppBuffer),e.vertexAttribPointer(l.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(l.position),l.pixelSizeHor=1/o,l.pixelSizeVert=1/r,l.filterSize=s,l.horizontal=!0,l.texture=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i.fbo),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),l.horizontal=!1,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(l.position),e.flush(),this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height)}},t}(),x3dom.bridge={setFlashReady:function(e,t){var i=x3dom.canvases[t];i.isFlashReady=!0,x3dom.debug.logInfo("Flash is ready for rendering ("+e+")")},onMouseDown:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onMousePress(o.gl,e,t,i),o.doc.needRender=!0},onMouseUp:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onMouseRelease(o.gl,e,t,i),o.doc.needRender=!0},onMouseOver:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onMouseOver(o.gl,e,t,i),o.doc.needRender=!0},onMouseOut:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onMouseOut(o.gl,e,t,i),o.doc.needRender=!0},onDoubleClick:function(e,t,i){var s=x3dom.canvases[i];s.doc.onDoubleClick(s.gl,e,t),s.doc.needRender=!0,x3dom.debug.logInfo("dblClick")},onMouseDrag:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onDrag(o.gl,e,t,i),o.doc.needRender=!0},onMouseMove:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onMove(o.gl,e,t,i),o.doc.needRender=!0},onMouseWheel:function(e,t,i,s){var o=x3dom.canvases[s];o.doc.onDrag(o.gl,e,t,i),o.doc.needRender=!0},onKeyDown:function(e,t){var i=x3dom.canvases[t],s=i.x3dElem.getAttribute("keysEnabled");s&&"true"!==s.toLowerCase()||i.doc.onKeyPress(e),i.doc.needRender=!0},setBBox:function(e,t,i){x3dom.nodeTypes.Shape.idMap.nodeID[e]},setShapeDirty:function(e){var t=x3dom.nodeTypes.Shape.idMap.nodeID[e];t.setAllDirty()}},x3dom.gfx_flash=function(){function e(e,t,i){this.object=e,this.name=t,this.isAlreadySet=!1,this.renderType=i}function t(t,i){return x3dom.Utils.maxIndexableCoords=65535,new e(t,"flash",i)}return e.prototype.getName=function(){return this.name},e.prototype.renderScene=function(e){var t=e._scene,i=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN(),o=t.getVolume();o.getBounds(i,s),t._lastMin=i,t._lastMax=s,e._last_mat_view=x3dom.fields.SFMatrix4f.identity(),e._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),e._last_mat_scene=x3dom.fields.SFMatrix4f.identity();var r=t.getViewpoint();r._vf.zNear!=-1&&r._vf.zFar!=-1||(r._vf.zFar=2e4,r._vf.zNear=.1);var a=e.getViewMatrix(),n=e.getProjectionMatrix(),d=n.mult(a);this.setupScene(t,e);var l=t.getBackground();this.setupBackground(l);var h=t.getFog();this.setupFog(h),t.drawableCollection=null;var u=t.getEnvironment(),f={viewArea:e,sortTrans:u._vf.sortTrans,viewMatrix:a,projMatrix:n,sceneMatrix:d,frustumCulling:!1,smallFeatureThreshold:!1,context:null,gl:null};t.drawableCollection=new x3dom.DrawableCollection(f),t.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),t.drawableCollection,!0,!1,0,[]),t.drawableCollection.concat();var c=t.drawableCollection.length;if(c>0)for(var _=[],m=0;m<c;m++){var p=t.drawableCollection.get(m),x=p.transform,g=p.shape;void 0!=_[g._objectID]?_[g._objectID]++:_[g._objectID]=0,this.setupShape(g,x,_[g._objectID])}this.object.renderScene()},e.prototype.setupScene=function(e,t){var i=t.getViewMatrix();if(!t._last_mat_view.equals(i)){var s=t._scene.getViewpoint(),o="viewpointChanged";try{if(s._xmlNode&&(s._xmlNode["on"+o]||s._xmlNode.hasAttribute("on"+o)||s._listeners[o])){var r=s.getCurrentTransform();r=r.inverse().mult(i);var a=r.inverse(),n=new x3dom.fields.Quaternion(0,0,1,0),d=a.e3(),l={target:s._xmlNode,type:o,matrix:r,position:d,orientation:n.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};s.callEvtHandler(o,l)}}catch(h){x3dom.debug.logException(h)}}t._last_mat_view=i;var u=e.getViewpoint(),f=t.getProjectionMatrix();this.object.setViewpoint({fov:u._vf.fov,zFar:u._vf.zFar,zNear:u._vf.zNear,viewMatrix:i.toGL(),projectionMatrix:f.toGL()});var c=e.getNavigationInfo();if(c._vf.headlight&&this.object.setHeadLight({id:-1,on:1,color:[1,1,1],intensity:1,ambientIntensity:0,direction:[0,0,-1]}),"deferred"==this.renderType)for(var _=t.getLights(),m=0;m<_.length;m++)if(_[m]._dirty){if(x3dom.isa(_[m],x3dom.nodeTypes.DirectionalLight))this.object.setDirectionalLight({id:_[m]._lightID,on:_[m]._vf.on,color:_[m]._vf.color.toGL(),intensity:_[m]._vf.intensity,ambientIntensity:_[m]._vf.ambientIntensity,direction:_[m]._vf.direction.toGL()});else if(x3dom.isa(_[m],x3dom.nodeTypes.PointLight)){i.mult(_[m].getCurrentTransform());this.object.setPointLight({id:_[m]._lightID,on:_[m]._vf.on,color:_[m]._vf.color.toGL(),intensity:_[m]._vf.intensity,ambientIntensity:_[m]._vf.ambientIntensity,attenuation:_[m]._vf.attenuation.toGL(),location:_[m]._vf.location.toGL(),radius:_[m]._vf.radius})}else x3dom.isa(_[m],x3dom.nodeTypes.SpotLight);_[m]._dirty=!1}},e.prototype.setupBackground=function(e){e._dirty&&(this.object.setBackground({texURLs:e.getTexUrl(),skyAngle:e._vf.skyAngle,skyColor:e.getSkyColor().toGL(),groundAngle:e._vf.groundAngle,groundColor:e.getGroundColor().toGL(),transparency:e.getTransparency()}),e._dirty=!1)},e.prototype.setupFog=function(e){return!e||!e._vf||e._vf.visibilityRange<=0?void this.object.setFog({color:null,visibilityRange:-1,fogType:-1}):void this.object.setFog({color:e._vf.color.toGL(),visibilityRange:e._vf.visibilityRange,fogType:"LINEAR"===e._vf.fogType?0:1})},e.prototype.setupShape=function(e,t,i){x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.PointSet)?x3dom.debug.logError("Flash backend doesn't support PointSets yet"):x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)?x3dom.debug.logError("Flash backend doesn't support LineSets yet"):x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.Text)?this.setupText(e,t,i):this.setupIndexedFaceSet(e,t,i)},e.prototype.setupIndexedFaceSet=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){var s=x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.ImageGeometry),o=x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.BinaryGeometry),r=e._cf.appearance.node,a=r?e._cf.appearance.node._vf.sortType:"auto",n=r?e._cf.appearance.node._vf.sortKey:0;if(s?this.object.setMeshProperties({id:e._objectID,type:"ImageGeometry",sortType:a,sortKey:n,solid:e.isSolid(),bboxMin:e._cf.geometry.node.getMin().toGL(),bboxMax:e._cf.geometry.node.getMax().toGL(),bboxCenter:e._cf.geometry.node.getCenter().toGL(),primType:e._cf.geometry.node._vf.primType,vertexCount:e._cf.geometry.node._vf.vertexCount}):o?this.object.setMeshProperties({id:e._objectID,type:"BinaryGeometry",sortType:a,sortKey:n,solid:e.isSolid(),bgCenter:e._cf.geometry.node._vf.position.toGL(),bgSize:e._cf.geometry.node._vf.size.toGL(),bboxCenter:e._cf.geometry.node.getCenter().toGL(),primType:e._cf.geometry.node._vf.primType,vertexCount:e._cf.geometry.node._vf.vertexCount}):this.object.setMeshProperties({id:e._objectID,type:"Default",sortType:a,sortKey:n,solid:e.isSolid()}),e._dirty.indexes===!0){if(s);else if(o)this.object.setMeshIndices({id:e._objectID,idx:0,indices:e._nameSpace.getURL(e._cf.geometry.node._vf.index)});else{e._cf.geometry.node._mesh._multiIndIndices&&e._cf.geometry.node._mesh._multiIndIndices.length&&e._cf.geometry.node._mesh.splitMesh(3,!0);for(var d=0;d<e._cf.geometry.node._mesh._indices.length;d++)this.object.setMeshIndices({id:e._objectID,idx:d,indices:e._cf.geometry.node._mesh._indices[d]})}e._dirty.indexes=!1}if(e._dirty.positions===!0){if(s)this.object.setMeshVertices({id:e._objectID,idx:0,coordinateTexture0:e._cf.geometry.node.getCoordinateTextureURL(0),coordinateTexture1:e._cf.geometry.node.getCoordinateTextureURL(1)});else if(o)this.object.setMeshVertices({id:e._objectID,idx:0,interleaved:e._cf.geometry.node._hasStrideOffset,vertices:e._nameSpace.getURL(e._cf.geometry.node._vf.coord),normals:e._nameSpace.getURL(e._cf.geometry.node._vf.normal),texCoords:e._nameSpace.getURL(e._cf.geometry.node._vf.texCoord),colors:e._nameSpace.getURL(e._cf.geometry.node._vf.color),numColorComponents:e._cf.geometry.node._mesh._numColComponents,numNormalComponents:e._cf.geometry.node._mesh._numNormComponents,vertexType:e._cf.geometry.node._vf.coordType,normalType:e._cf.geometry.node._vf.normalType,texCoordType:e._cf.geometry.node._vf.texCoordType,colorType:e._cf.geometry.node._vf.colorType,vertexStrideOffset:e._coordStrideOffset,normalStrideOffset:e._normalStrideOffset,texCoordStrideOffset:e._texCoordStrideOffset,colorStrideOffset:e._colorStrideOffset});else for(var d=0;d<e._cf.geometry.node._mesh._positions.length;d++)this.object.setMeshVertices({id:e._objectID,idx:d,vertices:e._cf.geometry.node._mesh._positions[d]});e._dirty.positions=!1}if(e._dirty.normals===!0){if(s)this.object.setMeshNormals({id:e._objectID,idx:0,normalTexture:e._cf.geometry.node.getNormalTextureURL()});else if(o)e._cf.geometry.node._hasStrideOffset||this.object.setMeshNormals({id:e._objectID,idx:0,normals:e._nameSpace.getURL(e._cf.geometry.node._vf.normal)});else if(e._cf.geometry.node._mesh._normals[0].length)for(var d=0;d<e._cf.geometry.node._mesh._normals.length;d++)this.object.setMeshNormals({id:e._objectID,idx:d,normals:e._cf.geometry.node._mesh._normals[d]});e._dirty.normals=!1}if(e._dirty.colors===!0){if(s)this.object.setMeshColors({id:e._objectID,idx:0,colorTexture:e._cf.geometry.node.getColorTextureURL(),components:e._cf.geometry.node._mesh._numColComponents});else if(o)e._cf.geometry.node._hasStrideOffset||this.object.setMeshColors({id:e._objectID,idx:0,colors:e._nameSpace.getURL(e._cf.geometry.node._vf.color),components:e._cf.geometry.node._mesh._numColComponents});else if(e._cf.geometry.node._mesh._colors[0].length)for(var d=0;d<e._cf.geometry.node._mesh._colors.length;d++)this.object.setMeshColors({id:e._objectID,idx:d,colors:e._cf.geometry.node._mesh._colors[d],components:e._cf.geometry.node._mesh._numColComponents});e._dirty.colors=!1}if(e._dirty.texcoords===!0){if(s)this.object.setMeshTexCoords({id:e._objectID,idx:0,texCoordTexture:e._cf.geometry.node.getTexCoordTextureURL()});else if(o)e._cf.geometry.node._hasStrideOffset||this.object.setMeshTexCoords({id:e._objectID,idx:0,texCoords:e._nameSpace.getURL(e._cf.geometry.node._vf.texCoord)});else if(e._cf.geometry.node._mesh._texCoords[0].length)for(var d=0;d<e._cf.geometry.node._mesh._texCoords.length;d++)this.object.setMeshTexCoords({id:e._objectID,idx:d,texCoords:e._cf.geometry.node._mesh._texCoords[d]});e._dirty.texcoords=!1}if(e._dirty.material===!0){if(r){var l=e._cf.appearance.node._cf.material.node;l&&this.object.setMeshMaterial({id:e._objectID,ambientIntensity:l._vf.ambientIntensity,diffuseColor:l._vf.diffuseColor.toGL(),emissiveColor:l._vf.emissiveColor.toGL(),shininess:l._vf.shininess,specularColor:l._vf.specularColor.toGL(),transparency:l._vf.transparency})}e._dirty.material=!1}if(e._dirty.texture===!0){if(r){var h=null;r._cf.textureTransform.node&&(h=r.texTransformMatrix().toGL());var u=e._cf.appearance.node._cf.texture.node;u?x3dom.isa(u,x3dom.nodeTypes.PixelTexture)?this.object.setPixelTexture({id:e._objectID,width:u._vf.image.width,height:u._vf.image.height,comp:u._vf.image.comp,pixels:u._vf.image.toGL()}):x3dom.isa(u,x3dom.nodeTypes.ComposedCubeMapTexture)?this.object.setCubeTexture({id:e._objectID,texURLs:u.getTexUrl()}):u._isCanvas&&u._canvas?this.object.setCanvasTexture({id:e._objectID,width:u._canvas.width,height:u._canvas.height,dataURL:u._canvas.toDataURL()}):x3dom.isa(u,x3dom.nodeTypes.MultiTexture)?x3dom.debug.logError("Flash backend doesn't support MultiTextures yet"):x3dom.isa(u,x3dom.nodeTypes.MovieTexture)?x3dom.debug.logError("Flash backend doesn't support MovieTextures yet"):this.object.setMeshTexture({id:e._objectID,origChannelCount:u._vf.origChannelCount,repeatS:u._vf.repeatS,repeatT:u._vf.repeatT,url:u._vf.url[0],transform:h}):this.object.removeTexture({id:e._objectID})}e._dirty.texture=!1}if(void 0!==e._cf.geometry.node._cf.texCoord&&null!==e._cf.geometry.node._cf.texCoord.node&&!x3dom.isa(e._cf.geometry.node._cf.texCoord.node,x3dom.nodeTypes.X3DTextureNode)&&e._cf.geometry.node._cf.texCoord.node._vf.mode){var f=e._cf.geometry.node._cf.texCoord.node._vf.mode;"sphere"==f.toLowerCase()?this.object.setSphereMapping({id:e._objectID,sphereMapping:1}):this.object.setSphereMapping({id:e._objectID,sphereMapping:0})}else this.object.setSphereMapping({id:e._objectID,sphereMapping:0})}},e.prototype.setupText=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){var s=e._cf.appearance.node,o=s?e._cf.appearance.node._vf.sortType:"auto",r=s?e._cf.appearance.node._vf.sortKey:0;if(e._dirty.text===!0){var a=e._cf.geometry.node._cf.fontStyle.node;null===a?this.object.setMeshProperties({id:e._objectID,type:"Text",sortType:o,sortKey:r,solid:e.isSolid(),text:e._cf.geometry.node._vf.string,fontFamily:["SERIF"],fontStyle:"PLAIN",fontAlign:"BEGIN",fontSize:32,fontSpacing:1,fontHorizontal:!0,fontLanguage:"",fontLeftToRight:!0,fontTopToBottom:!0}):this.object.setMeshProperties({id:e._objectID,type:"Text",sortType:o,sortKey:r,solid:e.isSolid(),text:e._cf.geometry.node._vf.string,fontFamily:a._vf.family.toString(),fontStyle:a._vf.style.toString(),fontAlign:a._vf.justify.toString(),fontSize:a._vf.size,fontSpacing:a._vf.spacing,fontHorizontal:a._vf.horizontal,fontLanguage:a._vf.language,fontLeftToRight:a._vf.leftToRight,fontTopToBottom:a._vf.topToBottom}),e._dirty.text=!1}if(e._dirty.material===!0){if(s){var n=e._cf.appearance.node._cf.material.node;n&&this.object.setMeshMaterial({id:e._objectID,ambientIntensity:n._vf.ambientIntensity,diffuseColor:n._vf.diffuseColor.toGL(),emissiveColor:n._vf.emissiveColor.toGL(),shininess:n._vf.shininess,specularColor:n._vf.specularColor.toGL(),transparency:n._vf.transparency})}e._dirty.material=!1}}},e.prototype.pickValue=function(e,t,i,s,o){var r=e._scene;if(null===this.object||null===r||void 0===r.drawableCollection||!r.drawableCollection||"box"===r._vf.pickMode.toLowerCase())return!1;var a="color"===r._vf.pickMode.toLowerCase()?1:"texcoord"===r._vf.pickMode.toLowerCase()?2:0,n=this.object.pickValue({pickMode:a});return n.objID>0?(e._pickingInfo.pickPos=new x3dom.fields.SFVec3f(n.pickPosX,n.pickPosY,n.pickPosZ),e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[n.objID]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null),!0},e.prototype.shutdown=function(e){},t}(),x3dom.NodeNameSpace=function(e,t){this.name=e,this.doc=t,this.baseURL="",this.defMap={},this.parent=null,this.childSpaces=[]},x3dom.NodeNameSpace.prototype.addNode=function(e,t){this.defMap[t]=e,e._nameSpace=this},x3dom.NodeNameSpace.prototype.removeNode=function(e){var t=e?this.defMap[e]:null;t&&(delete this.defMap[e],t._nameSpace=null)},x3dom.NodeNameSpace.prototype.getNamedNode=function(e){return this.defMap[e]},x3dom.NodeNameSpace.prototype.getNamedElement=function(e){var t=this.defMap[e];return t?t._xmlNode:null},x3dom.NodeNameSpace.prototype.addSpace=function(e){this.childSpaces.push(e),e.parent=this},x3dom.NodeNameSpace.prototype.removeSpace=function(e){e.parent=null;for(var t=0;t<this.childSpaces.length;t++)this.childSpaces[t]==e&&this.childSpaces.splice(t,1)},x3dom.NodeNameSpace.prototype.setBaseURL=function(e){var t=e.lastIndexOf("/");this.baseURL=t>=0?e.substr(0,t+1):"",x3dom.debug.logInfo("setBaseURL: "+this.baseURL)},x3dom.NodeNameSpace.prototype.getURL=function(e){return void 0!==e&&e.length?"/"===e[0]||e.indexOf(":")>=0?e:this.baseURL+e:""},x3dom.hasElementAttribute=function(e){var t=this.__hasAttribute(e);return!t&&e&&(t=this.__hasAttribute(e.toLowerCase())),t},x3dom.getElementAttribute=function(e){var t=this.__getAttribute(e);return!t&&""!=t&&e&&(t=this.__getAttribute(e.toLowerCase())),t||!this._x3domNode?t:this._x3domNode._vf[e]},x3dom.setElementAttribute=function(e,t){this.__setAttribute(e,t);var i=this._x3domNode;i&&(i.updateField(e,t),i._nameSpace.doc.needRender=!0)},x3dom.getFieldValue=function(e){var t=this._x3domNode;if(t&&void 0!==t._vf[e]){var i=t._vf[e];return i instanceof Object&&"copy"in i?t._vf[e].copy():t._vf[e]}return null},x3dom.setFieldValue=function(e,t){var i=this._x3domNode;i&&void 0!==i._vf[e]&&(t instanceof Object&&"copy"in t?i._vf[e]=t.copy():i._vf[e]=t,i.fieldChanged(e),i._nameSpace.doc.needRender=!0)},x3dom.requestFieldRef=function(e){var t=this._x3domNode;return t&&t._vf[e]?t._vf[e]:null},x3dom.releaseFieldRef=function(e){var t=this._x3domNode;t&&t._vf[e]&&(t.fieldChanged(e),t._nameSpace.doc.needRender=!0)},x3dom.NodeNameSpace.prototype.setupTree=function(e){var t=null;if(x3dom.isX3DElement(e)){if(e._x3domNode)return x3dom.debug.logWarning("Tree is already initialized"),null;if(void 0===e.tagName||e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.addEventListener=function(e,t,i){this._x3domNode._listeners[e]||(this._x3domNode._listeners[e]=[]),this._x3domNode._listeners[e].push(t),this.__addEventListener(e,t,i)},e.__removeEventListener=e.removeEventListener,e.removeEventListener=function(e,t,i){var s=this._x3domNode._listeners[e];if(s)for(var o=0;o<s.length;o++)s[o]==t&&s.splice(o,1);this.__removeEventListener(e,t,i)}),e.hasAttribute("USE")||e.hasAttribute("use")){if(e.hasAttribute("USE")||e.setAttribute("USE",e.getAttribute("use")),t=this.defMap[e.getAttribute("USE")],!t){var i=e.getAttribute("USE").split("__");if(i.length>=2){for(var s=this;s;)s.name==i[0]&&(t=s.defMap[i[1]]),s=t?null:s.parent;t||(t=null,x3dom.debug.logWarning("Could not USE: "+e.getAttribute("USE")))}}return t&&(e._x3domNode=t),t}if("route"===e.localName.toLowerCase()){var o=e,r=o.getAttribute("fromNode")||o.getAttribute("fromnode"),a=o.getAttribute("toNode")||o.getAttribute("tonode"),n=this.defMap[r],d=this.defMap[a];return n&&d?(r=o.getAttribute("fromField")||o.getAttribute("fromfield"),a=o.getAttribute("toField")||o.getAttribute("tofield"),n.setupRoute(r,d,a),o._nodeNameSpace=this):x3dom.debug.logWarning("Broken route - can't find all DEFs for "+r+" -> "+a),null}e.requestFieldRef=x3dom.requestFieldRef,e.releaseFieldRef=x3dom.releaseFieldRef,e.getFieldValue=x3dom.getFieldValue,e.setFieldValue=x3dom.setFieldValue;var l=x3dom.nodeTypesLC[e.localName.toLowerCase()];if(void 0!==l){x3dom.userAgentFeature.supportsDOMAttrModified===!1&&e instanceof Element&&(e.setAttribute&&!e.__setAttribute&&(e.__setAttribute=e.setAttribute,e.setAttribute=x3dom.setElementAttribute),e.getAttribute&&!e.__getAttribute&&(e.__getAttribute=e.getAttribute,e.getAttribute=x3dom.getElementAttribute),e.hasAttribute&&!e.__hasAttribute&&(e.__hasAttribute=e.hasAttribute,e.hasAttribute=x3dom.hasElementAttribute));var h={doc:this.doc,xmlNode:e,nameSpace:this};t=new l(h),e.hasAttribute("DEF")?(t._DEF=e.getAttribute("DEF"),this.defMap[t._DEF]=t):e.hasAttribute("id")&&(t._DEF=e.getAttribute("id"),this.defMap[t._DEF]=t),void 0===e.highlight&&(e.highlight=function(e,t){var i=x3dom.fields.SFColor.parse(t);this._x3domNode.highlight(e,i),this._x3domNode._nameSpace.doc.needRender=!0}),t._xmlNode=e,e._x3domNode=t;var u=this;return Array.forEach(e.childNodes,function(e){var i=u.setupTree(e);i&&t.addChild(i,e.getAttribute("containerField"))}),t.nodeChanged(),t}x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;.")}else e.localName&&(x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;."),t=null);return t},x3dom.registerNodeType("X3DNode","Core",defineClass(null,function(e){this._xmlNode=null,this._DEF=null,this._nameSpace=e&&e.nameSpace?e.nameSpace:null,this._vf={},this._vfFieldTypes={},this._cf={},this._cfFieldTypes={},this._fieldWatchers={},this._routes={},this._listeners={},this._parentNodes=[],this._childNodes=[],this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)},{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(e,t){if(e){var i=null;if(t)i=this._cf[t];else for(var s in this._cf)if(this._cf.hasOwnProperty(s)){var o=this._cf[s];if(x3dom.isa(e,o.type)){i=o;break}}if(i&&i.addLink(e))return e._parentNodes.push(this),this._childNodes.push(e),e.parentAdded(this),!0}return!1},removeChild:function(e){if(e)for(var t in this._cf)if(this._cf.hasOwnProperty(t)){var i=this._cf[t];if(i.rmLink(e)){for(var s=e._parentNodes.length-1;s>=0;s--)e._parentNodes[s]===this&&(e._parentNodes.splice(s,1),e.parentRemoved(this));for(var o=this._childNodes.length-1;o>=0;o--)if(this._childNodes[o]===e)return e.onRemove(),this._childNodes.splice(o,1),!0}}return!1},onRemove:function(){},parentAdded:function(e){},parentRemoved:function(e){for(var t=0,i=this._childNodes.length;t<i;t++)this._childNodes[t]&&this._childNodes[t].parentRemoved(this)},getCurrentTransform:function(){return this._parentNodes.length>=1?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(e){return e},getVolume:function(){return null},invalidateVolume:function(){},invalidateCache:function(){},volumeValid:function(){return!1},collectDrawableObjects:function(e,t,i,s,o,r){},highlight:function(e,t){this._vf.hasOwnProperty("diffuseColor")&&(e?(void 0===this._actDiffuseColor&&(this._actDiffuseColor=new x3dom.fields.SFColor,this._highlightOn=!1),this._highlightOn||(this._actDiffuseColor.setValues(this._vf.diffuseColor),this._highlightOn=!0),this._vf.diffuseColor.setValues(t)):void 0!==this._actDiffuseColor&&(this._vf.diffuseColor.setValues(this._actDiffuseColor),this._highlightOn=!1,delete this._actDiffuseColor));for(var i=0,s=this._childNodes.length;i<s;i++)this._childNodes[i]&&this._childNodes[i].highlight(e,t)},findX3DDoc:function(){return this._nameSpace.doc},doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},postMessage:function(e,t){this._vf[e]=t;var i=this._fieldWatchers[e],s=this;i&&Array.forEach(i,function(e){e.call(s,t)});var o={target:s._xmlNode,type:"outputchange",fieldName:e,value:t};this.callEvtHandler("onoutputchange",o)},updateField:function(e,t){var i=this._vf[e];if(void 0===i){for(var s in this._vf)if(s.toLowerCase()==e){e=s,i=this._vf[e];break}var o="set_";if(void 0===i&&0==e.indexOf(o)){var r=e.substr(o.length,e.length-1);void 0!==this._vf[r]&&(e=r,i=this._vf[e])}void 0===i&&(i=null,this._vf[e]=i)}if(null!==i){try{this._vf[e].setValueByStr(t)}catch(a){try{switch((typeof this._vf[e]).toString()){case"number":"number"==typeof t?this._vf[e]=t:this._vf[e]=+t;break;case"boolean":"boolean"==typeof t?this._vf[e]=t:this._vf[e]="true"==t.toLowerCase();break;case"string":this._vf[e]=t}}catch(n){x3dom.debug.logError("updateField: setValueByStr() NYI for "+typeof i)}}this.fieldChanged(e)}},setupRoute:function(e,t,i){var s,o,r="set_",a="_changed";this._vf[e]||(s=e.indexOf(r),0===s?(o=e.substr(r.length,e.length-1),this._vf[o]&&(e=o)):(s=e.indexOf(a),s>0&&(o=e.substr(0,e.length-a.length),this._vf[o]&&(e=o)))),t._vf[i]||(s=i.indexOf(r),0===s?(o=i.substr(r.length,i.length-1),t._vf[o]&&(i=o)):(s=i.indexOf(a),s>0&&(o=i.substr(0,i.length-a.length),t._vf[o]&&(i=o))));var n=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[n]||(this._fieldWatchers[e]||(this._fieldWatchers[e]=[]),this._fieldWatchers[e].push(function(e){t.postMessage(i,e)}),t._fieldWatchers[i]||(t._fieldWatchers[i]=[]),t._fieldWatchers[i].push(function(e){t._vf[i]=e,t.fieldChanged(i)}),this._routes[n]={from:this._fieldWatchers[e].length-1,to:t._fieldWatchers[i].length-1})},removeRoute:function(e,t,i){var s,o,r="set_",a="_changed";this._vf[e]||(s=e.indexOf(r),0===s?(o=e.substr(r.length,e.length-1),this._vf[o]&&(e=o)):(s=e.indexOf(a),s>0&&(o=e.substr(0,e.length-a.length),this._vf[o]&&(e=o)))),t._vf[i]||(s=i.indexOf(r),0===s?(o=i.substr(r.length,i.length-1),t._vf[o]&&(i=o)):(s=i.indexOf(a),s>0&&(o=i.substr(0,i.length-a.length),t._vf[o]&&(i=o))));var n=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[n]&&(this._fieldWatchers[e].splice(this._routes[n].from,1),t._fieldWatchers[i].splice(this._routes[n].to,1),delete this._routes[n])},fieldChanged:function(e){},nodeChanged:function(){},callEvtHandler:function(e,t){var i=this;if(!i._xmlNode)return t.cancelBubble;try{var s=i._xmlNode[e];if(t.target=i._xmlNode,"function"==typeof s)s.call(i._xmlNode,t);else{var o=i._xmlNode.getAttribute(e),r=new Function("event",o);r.call(i._xmlNode,t)}var a=i._listeners[t.type];if(a)for(var n=0;n<a.length;n++)a[n].call(i._xmlNode,t)}catch(d){x3dom.debug.logException(d)}return t.cancelBubble},initSetter:function(e,t){if(e&&t){var i=t.toLowerCase();if(e.__defineSetter__&&e.__defineGetter__?(e.__defineSetter__(t,function(i){e.setAttribute(t,i)}),e.__defineGetter__(t,function(){return e.getAttribute(t)}),i!=t&&(e.__defineSetter__(i,function(i){e.setAttribute(t,i)}),e.__defineGetter__(i,function(){return e.getAttribute(t)}))):Object.defineProperty(e,t,{set:function(i){e.setAttribute(t,i)},get:function(){return e.getAttribute(t)},configurable:!0,enumerable:!0}),this._vf[t]&&!e.attributes[t]&&!e.attributes[t.toLowerCase()]){var s="";try{s=this._vf[t].toGL?this._vf[t].toGL().toString():this._vf[t].toString()}catch(o){s=this._vf[t].toString()}s||(s=""),e.setAttribute(t,s)}}},addField_SFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?parseInt(e.xmlNode.getAttribute(t),10):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFInt32"},addField_SFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFFloat"},addField_SFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFDouble"},addField_SFTime:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFTime"},addField_SFBool:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?"true"===e.xmlNode.getAttribute(t).toLowerCase():i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFBool"},addField_SFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFString"},addField_SFColor:function(e,t,i,s,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColor(i,s,o),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColor"},addField_SFColorRGBA:function(e,t,i,s,o,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColorRGBA(i,s,o,r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColorRGBA"},addField_SFVec2f:function(e,t,i,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec2f(i,s),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec2f"},addField_SFVec3f:function(e,t,i,s,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec3f(i,s,o),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec3f"},addField_SFVec4f:function(e,t,i,s,o,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec4f(i,s,o,r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec4f"},addField_SFVec3d:function(e,t,i,s,o){this.addField_SFVec3f(e,t,i,s,o),this._vfFieldTypes[t]="SFVec3d"},addField_SFRotation:function(e,t,i,s,o,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.Quaternion.parseAxisAngle(e.xmlNode.getAttribute(t)):x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(i,s,o),r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFRotation"},addField_SFMatrix4f:function(e,t,i,s,o,r,a,n,d,l,h,u,f,c,_,m,p,x){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFMatrix4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFMatrix4f(i,s,o,r,a,n,d,l,h,u,f,c,_,m,p,x),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFMatrix4f"},addField_SFImage:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFImage.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFImage(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFImage"},addField_MFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFString.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFString(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFString"},addField_MFBoolean:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFBoolean.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFBoolean(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFBoolean"},addField_MFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFInt32.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFInt32(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFInt32"},addField_MFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFFloat"},addField_MFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFDouble"},addField_MFColor:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColor(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColor"},addField_MFColorRGBA:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColorRGBA(i),
e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColorRGBA"},addField_MFVec2f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec2f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec2f"},addField_MFVec3f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec3f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec3f"},addField_MFVec3d:function(e,t,i){this.addField_MFVec3f(e,t,i),this._vfFieldTypes[t]="MFVec3d"},addField_MFRotation:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFRotation.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFRotation(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFRotation"},addField_SFNode:function(e,t){this._cf[e]=new x3dom.fields.SFNode(t),this._cfFieldTypes[e]="SFNode"},addField_MFNode:function(e,t){this._cf[e]=new x3dom.fields.MFNode(t),this._cfFieldTypes[e]="MFNode"}})),x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"reference","")})),x3dom.registerNodeType("MetadataBoolean","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataBoolean.superClass.call(this,e),this.addField_MFBoolean(e,"value",[])})),x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataDouble.superClass.call(this,e),this.addField_MFDouble(e,"value",[])})),x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataFloat.superClass.call(this,e),this.addField_MFFloat(e,"value",[])})),x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataInteger.superClass.call(this,e),this.addField_MFInt32(e,"value",[])})),x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataSet.superClass.call(this,e),this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)})),x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataString.superClass.call(this,e),this.addField_MFString(e,"value",[])})),x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Field.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"type",""),this.addField_SFString(e,"value","")},{fieldChanged:function(e){var t=this;"value"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged(t._vf.name)})}})),x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DChildNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,e),this.addField_SFBool(e,"bind",!1),this.addField_SFString(e,"description",""),this.addField_SFBool(e,"isActive",!1),this._autoGen=!(!e||!e.autoGen),this._autoGen&&(this._vf.description="default"+this.constructor.superClass._typeName),this._stack=null},{bind:function(e){this._stack?e?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in "+this.typeName()+"Bindable")},activate:function(e){this.postMessage("isActive",!0),x3dom.debug.logInfo("activate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},deactivate:function(e){this.postMessage("isActive",!1),x3dom.debug.logInfo("deactivate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},fieldChanged:function(e){e.indexOf("bind")>=0&&this.bind(this._vf.bind)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this)}})),x3dom.registerNodeType("X3DInfoNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DInfoNode.superClass.call(this,e)})),x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DInfoNode,function(e){x3dom.nodeTypes.WorldInfo.superClass.call(this,e),this.addField_MFString(e,"info",[]),this.addField_SFString(e,"title",""),x3dom.debug.logInfo(this._vf.info),x3dom.debug.logInfo(this._vf.title)})),x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0)})),x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Param.superClass.call(this,e),x3dom.debug.logWarning('DEPRECATED: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')})),x3dom.registerNodeType("X3DBoundedObject","Grouping",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DBoundedObject.superClass.call(this,e),this.addField_SFBool(e,"render",!0),this.addField_SFVec3f(e,"bboxCenter",0,0,0),this.addField_SFVec3f(e,"bboxSize",-1,-1,-1),this._graph={boundedNode:this,localMatrix:x3dom.fields.SFMatrix4f.identity(),globalMatrix:null,volume:new x3dom.fields.BoxVolume,worldVolume:new x3dom.fields.BoxVolume,center:new x3dom.fields.SFVec3f(0,0,0),coverage:-1,needCulling:!0}},{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&this.invalidateVolume()},nodeChanged:function(){this.invalidateVolume()},parentAdded:function(e){this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var t=0,i=this._childNodes.length;t<i;t++){var s=this._childNodes[t];if(s&&s._vf.render===!0){var o=s.getVolume();o&&o.isValid()&&e.extendBounds(o.min,o.max)}}return e},invalidateVolume:function(){var e=this._graph;e.volume.invalidate(),e.worldVolume.invalidate(),e.globalMatrix=null;for(var t=0,i=this._parentNodes.length;t<i;t++){var s=this._parentNodes[t];s&&s.volumeValid()&&s.invalidateVolume()}},invalidateCache:function(){var e=this._graph;e.worldVolume.invalidate(),e.globalMatrix=null},cacheInvalid:function(){return null==this._graph.globalMatrix||!this._graph.worldVolume.isValid()},volumeValid:function(){return this._graph.volume.isValid()},graphState:function(){return this._graph},forceUpdateCoverage:function(){return!1}})),x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DBoundedObject,function(e){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,e),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)},{collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),!(o<0)){var a,n;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),n=this._graph.globalMatrix):n=this.transformMatrix(e);var d=this._childNodes.length;if(x3dom.nodeTypes.ClipPlane.count>0){for(var l=[],h=0;h<d;h++)(a=this._childNodes[h])&&x3dom.isa(a,x3dom.nodeTypes.ClipPlane)&&a._vf.on&&a._vf.enabled&&l.push({plane:a,trafo:n});r=l.concat(r)}for(var u=0;u<d;u++)(a=this._childNodes[u])&&a.collectDrawableObjects(n,t,i,s,o,r)}}})),x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Switch.superClass.call(this,e),this.addField_SFInt32(e,"whichChoice",-1)},{fieldChanged:function(e){"whichChoice"==e&&this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render&&this._vf.whichChoice>=0&&this._vf.whichChoice<this._childNodes.length){var t=this._childNodes[this._vf.whichChoice],i=t&&t._vf.render===!0?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length||(o=t.cull(e,this.graphState(),i,o))<0)){var a,n;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),n=this._graph.globalMatrix):n=this.transformMatrix(e),(a=this._childNodes[this._vf.whichChoice])&&a.collectDrawableObjects(n,t,i,s,o,r)}},doIntersect:function(e){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return!1;var t=this._childNodes[this._vf.whichChoice];return!!t&&t.doIntersect(e)}})),x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,e),e?e.doc._nodeBag.trans.push(this):x3dom.debug.logWarning("X3DTransformNode: No runtime context found!"),this._trafo=null,this._needCssStyleUpdates=!0},{tick:function(e){var t=this._xmlNode;if(t&&(t.ontransform||t.hasAttribute("ontransform")||this._listeners.transform)){var i=this.getCurrentTransform(),s={target:t,type:"transform",worldX:i._03,worldY:i._13,worldZ:i._23,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};this.callEvtHandler("ontransform",s)}if(this._needCssStyleUpdates&&t){var o=x3dom.getStyle(t,"-webkit-transform")||x3dom.getStyle(t,"-moz-transform")||x3dom.getStyle(t,"-ms-transform")||x3dom.getStyle(t,"transform");if(o&&"none"!=o)return this._trafo.setValueByStr(o),this.invalidateVolume(),!0;this._needCssStyleUpdates=!1}return!1},transformMatrix:function(e){return e.mult(this._trafo)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){this._graph.localMatrix=this._trafo;for(var t=0,i=this._childNodes.length;t<i;t++){var s=this._childNodes[t];if(s&&s._vf.render===!0){var o=s.getVolume();o&&o.isValid()&&e.extendBounds(o.min,o.max)}}e.isValid()&&e.transform(this._trafo)}return e},doIntersect:function(e){var t=!1,i=this._trafo.inverse(),s=new x3dom.fields.SFVec3f(e.pos.x,e.pos.y,e.pos.z),o=new x3dom.fields.SFVec3f(e.dir.x,e.dir.y,e.dir.z);e.pos=i.multMatrixPnt(e.pos),e.dir=i.multMatrixVec(e.dir),e.hitObject&&(e.dist*=e.dir.length());for(var r=0;r<this._childNodes.length;r++)this._childNodes[r]&&(t=this._childNodes[r].doIntersect(e)||t);return e.pos.setValues(s),e.dir.setValues(o),t&&(e.hitPoint=this._trafo.multMatrixPnt(e.hitPoint),e.dist*=e.dir.length()),t},parentRemoved:function(e){var t,i;if(0==this._parentNodes.length){var s=this.findX3DDoc();for(t=0,i=s._nodeBag.trans.length;t<i;t++)s._nodeBag.trans[t]===this&&s._nodeBag.trans.splice(t,1)}for(t=0,i=this._childNodes.length;t<i;t++)this._childNodes[t]&&this._childNodes[t].parentRemoved(this)}})),x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.Transform.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0),this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))},{fieldChanged:function(e){"center"==e||"translation"==e||"rotation"==e||"scale"==e||"scaleOrientation"==e?(this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate())),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.MatrixTransform.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix.transpose()},{fieldChanged:function(e){"matrix"==e?(this._trafo=this._vf.matrix.transpose(),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Group.superClass.call(this,e)})),x3dom.registerNodeType("Block","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Block.superClass.call(this,e),this.addField_MFString(e,"nameSpaceName",[])})),x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.StaticGroup.superClass.call(this,e),x3dom.debug.logWarning("StaticGroup erroneously also bakes parent transforms, if happens use Group node!"),this.addField_SFBool(e,"debug",!1),this.addField_SFBool(e,"showDebugBoxVolumes",!1),this.addField_SFString(e,"bvhType","jsBIH"),this.addField_SFInt32(e,"maxObjectsPerNode",1),this.addField_SFInt32(e,"maxDepth",-1),this.addField_SFFloat(e,"minRelativeBBoxSize",.01),this.needBvhRebuild=!0,this.drawableCollection=null,this.bvh=null},{getMaxDepth:function(){return this._vf.maxDepth==-1?"jsBIH"==this._vf.bvhType?50:4:this._vf.maxDepth},collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),!(o<0)){var a,n;if(i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),n=this._graph.globalMatrix):n=this.transformMatrix(e),this.needBvhRebuild){var d={viewArea:t.viewarea,sortTrans:t.sortTrans,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,sceneMatrix:t.sceneMatrix,frustumCulling:!1,smallFeatureThreshold:0,context:t.context};this.drawableCollection=new x3dom.DrawableCollection(d);var l,h=this._childNodes.length;for(l=0;l<h;l++)(a=this._childNodes[l])&&a.collectDrawableObjects(n,this.drawableCollection,i,s,o,r);this.drawableCollection.concat();var u=this._nameSpace.doc._scene,f=new x3dom.bvh.Settings(this._vf.debug,this._vf.showDebugBoxVolumes,this._vf.bvhType,this._vf.maxObjectsPerNode,this.getMaxDepth(),this._vf.minRelativeBBoxSize);for(this.bvh="jsBIH"==this._vf.bvhType?new x3dom.bvh.BIH(u,f):new x3dom.bvh.Culler(this.drawableCollection,u,f),(this._vf.debug||this._vf.showDebugBoxVolumes)&&(this.bvh=new x3dom.bvh.DebugDecorator(this.bvh,u,f)),h=this.drawableCollection.length,l=0;l<h;l++)this.bvh.addDrawable(this.drawableCollection.get(l));this.bvh.compile(),this._vf.debug&&this.bvh.showCompileStats(),this.needBvhRebuild=!1}x3dom.Utils.startMeasure("bvhTraverse"),this.bvh.collectDrawables(t);var c=x3dom.Utils.stopMeasure("bvhTraverse");this._nameSpace.doc.ctx.x3dElem.runtime.addMeasurement("BVH",c),this.bvh.showTraverseStats(this._nameSpace.doc.ctx.x3dElem.runtime)}}})),x3dom.registerNodeType("RemoteSelectionGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.RemoteSelectionGroup.superClass.call(this,e),this.addField_MFString(e,"url",["ws://localhost:35668/cstreams/0"]),this.addField_MFString(e,"label",[]),this.addField_SFInt32(e,"maxRenderedIds",-1),this.addField_SFBool(e,"reconnect",!0),this.addField_SFFloat(e,"scaleRenderedIdsOnMove",1),this.addField_SFBool(e,"enableCulling",!0),this.addField_MFString(e,"invisibleNodes",[]),this._idList=[],this._websocket=null,this._nameObjMap={},this._createTime=[],this._visibleList=[],e?this.initializeSocket():x3dom.debug.logWarning("RemoteSelectionGroup: No runtime context found!")},{initializeSocket:function(){var e=this;if("WebSocket"in window){var t="ws://localhost:35668/cstreams/0";this._vf.url.length&&this._vf.url[0].length&&(t=this._vf.url[0]),this._websocket=new WebSocket(t),this._websocket._lastMsg=null,this._websocket._lastData="",this._websocket.onopen=function(t){x3dom.debug.logInfo("WS Connected");var i=e._nameSpace.doc._viewarea.getViewMatrix();this._lastMsg=i.toGL().toString(),i=e._nameSpace.doc._viewarea.getProjectionMatrix(),this._lastMsg+=","+i.toGL().toString(),this.send(this._lastMsg),x3dom.debug.logInfo("WS Sent: "+this._lastMsg),this._lastMsg="",this._lastData=""},this._websocket.onclose=function(t){x3dom.debug.logInfo("WS Disconnected"),e._vf.reconnect&&window.setTimeout(function(){e.initializeSocket()},2e3)},this._websocket.onmessage=function(t){if(e._vf.maxRenderedIds<0)e._idList=x3dom.fields.MFString.parse(t.data);else if(e._vf.maxRenderedIds>0){e._idList=[];for(var i=x3dom.fields.MFString.parse(t.data),s=Math.min(i.length,Math.abs(e._vf.maxRenderedIds)),o=0;o<s;++o)e._idList[o]=i[o]}0!=e._vf.maxRenderedIds&&this._lastData!=t.data&&(this._lastData=t.data,e._nameSpace.doc.needRender=!0,e.invalidateVolume())},this._websocket.onerror=function(e){x3dom.debug.logError(e.data)},this._websocket.updateCamera=function(){var t=e._nameSpace.doc._viewarea.getViewMatrix(),i=t.toGL().toString();t=e._nameSpace.doc._viewarea.getProjectionMatrix(),i+=","+t.toGL().toString(),null!=this._lastMsg&&this._lastMsg!=i&&(this._lastMsg=i,this.send(i))}}else x3dom.debug.logError("Browser has no WebSocket support!")},nodeChanged:function(){var e=this._vf.label.length;this._nameObjMap={},this._createTime=new Array(e),this._visibleList=new Array(e);for(var t=0;t<e;++t){var i=this._childNodes[t];i&&x3dom.isa(i,x3dom.nodeTypes.X3DShapeNode)?(this._nameObjMap[this._vf.label[t]]={shape:i,pos:t},this._visibleList[t]=!0):(this._visibleList[t]=!1,x3dom.debug.logError("Invalid children: "+this._vf.label[t])),this._createTime[t]=0}this.invalidateVolume(),x3dom.debug.logInfo("RemoteSelectionGroup has "+e+" entries.")},fieldChanged:function(e){if("url"==e)this._websocket&&(this._websocket.close(),this._websocket=null),this.initializeSocket();else if("invisibleNodes"==e){for(var t=0,i=this._vf.label.length;t<i;++t){var s=this._childNodes[t];if(s&&x3dom.isa(s,x3dom.nodeTypes.X3DShapeNode)){this._visibleList[t]=!0;for(var o=0,r=this._vf.invisibleNodes.length;o<r;++o){var a=this._vf.invisibleNodes[o],n=a.lastIndexOf("*"),d=!1;if(n>0&&(a=a.substring(0,n),d=!0),!(a.length<=1)&&(d&&0==this._vf.label[t].indexOf(a)||this._vf.label[t]==a)){this._visibleList[t]=!1;break}}}else this._visibleList[t]=!1}this.invalidateVolume()}else"render"==e&&this.invalidateVolume()},getNumRenderedObjects:function(e,t){var i=e;if(this._vf.maxRenderedIds>0){var s=Math.max(this._vf.maxRenderedIds,16),o=1;t&&(o=Math.min(this._vf.scaleRenderedIdsOnMove,1)),s=Math.max(Math.round(o*s),0),i=Math.min(i,s)}return i},collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),!(o<=0)){var a,n,d=this._nameSpace.doc._viewarea,l=d.isMovingOrAnimating(),h=(new Date).getTime(),u=1e4,f=this._childNodes.length;if(this._vf.enableCulling){if(this._websocket&&this._websocket.updateCamera(),this._vf.label.length){for(n=this.getNumRenderedObjects(this._idList.length,l),a=0;a<n;a++){var c=this._nameObjMap[this._idList[a]];c&&c.shape?(c.shape.collectDrawableObjects(e,t,i,s,o,r),this._createTime[c.pos]=h):x3dom.debug.logError("Invalid label: "+this._idList[a])}for(a=0;a<this._childNodes.length;a++)this._childNodes[a]&&!l&&this._createTime[a]>0&&h-this._createTime[a]>u&&this._childNodes[a]._cleanupGLObjects&&(this._childNodes[a]._cleanupGLObjects(!0),this._createTime[a]=0)}}else{n=this.getNumRenderedObjects(f,l);var _=0;for(a=0;a<f;a++){var m=this._childNodes[a];if(m){var p=!0;this._visibleList[a]&&_<n&&m.collectDrawableObjects(e,t,i,s,o,r)&&(this._createTime[a]=h,_++,p=!1),p&&!l&&this._createTime[a]>0&&h-this._createTime[a]>u&&m._cleanupGLObjects&&(m._cleanupGLObjects(!0),this._createTime[a]=0)}}}}}})),x3dom.registerNodeType("Scene","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Scene.superClass.call(this,e),this.addField_SFString(e,"pickMode","idBuf"),this.addField_SFBool(e,"doPickPass",!0),this.addField_SFString(e,"shadowObjectIdMapping",""),this._lastMin=new x3dom.fields.SFVec3f(0,0,0),this._lastMax=new x3dom.fields.SFVec3f(1,1,1),this._shadowIdMap=null,this.loadMapping(),this._multiPartMap=null},{fieldChanged:function(e){"shadowObjectIdMapping"==e&&this.loadMapping()},updateVolume:function(){var e=this.getVolume();e.isValid()&&(this._lastMin=x3dom.fields.SFVec3f.copy(e.min),this._lastMax=x3dom.fields.SFVec3f.copy(e.max))},loadMapping:function(){if(this._shadowIdMap=null,0!=this._vf.shadowObjectIdMapping.length){var that=this,xhr=new XMLHttpRequest;xhr.open("GET",this._nameSpace.getURL(this._vf.shadowObjectIdMapping),!0),xhr.send(),xhr.onload=function(){that._shadowIdMap=eval("("+xhr.response+")"),that._shadowIdMap&&that._shadowIdMap.mapping?x3dom.debug.assert(that._shadowIdMap.maxID<=that._shadowIdMap.mapping.length,"Too few ID map entries in "+that._vf.shadowObjectIdMapping+", length of mapping array is only "+that._shadowIdMap.mapping.length+" instead of "+that._shadowIdMap.ids.length+"!"):x3dom.debug.logWarning("Invalid ID map: "+that._vf.shadowObjectIdMapping)}}}})),x3dom.BindableStack=function(e,t,i,s){this._doc=e,this._type=t,this._defaultType=i,this._defaultRoot=null,this._getter=s,this._bindBag=[],this._bindStack=[]},x3dom.BindableStack.prototype.top=function(){return this._bindStack.length>0?this._bindStack[this._bindStack.length-1]:null},x3dom.BindableStack.prototype.push=function(e){var t=this.top();t!==e&&(t&&t.deactivate(),this._bindStack.push(e),e.activate(t))},x3dom.BindableStack.prototype.replaceTop=function(e){var t=this.top();t!==e&&t&&(t.deactivate(),this._bindStack[this._bindStack.length-1]=e,e.activate(t))},x3dom.BindableStack.prototype.pop=function(e){var t;return e&&(t=this.top(),e!==t)?null:(t=this._bindStack.pop(),t&&t.deactivate(),t)},x3dom.BindableStack.prototype.switchTo=function(e){var t=this.getActive(),i=this._bindBag.length,s=0,o=0,r=-1;if(!(i<=1)){switch(e){case"first":s=this._bindBag[0];break;case"last":s=this._bindBag[i-1];break;default:for(o=0;o<i;o++)if(this._bindBag[o]==t){r=o;break}if(r>=0)for(o=r;!s&&(o="next"==e?o<i-1?o+1:0:o>0?o-1:i-1,o!=r);)this._bindBag[o]._vf.description.length>=0&&(s=this._bindBag[o])}s?this.replaceTop(s):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}},x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length)if(this._defaultRoot){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var e=new this._defaultType({doc:this._doc,nameSpace:this._defaultRoot._nameSpace,autoGen:!0});this._defaultRoot.addChild(e),e.nodeChanged()}else x3dom.debug.logError("stack without defaultRoot");else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]),this._bindBag[0].activate()}return this._bindStack[this._bindStack.length-1]},x3dom.BindableBag=function(e){this._stacks=[],this.addType("X3DViewpointNode","Viewpoint","getViewpoint",e),this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",e),this.addType("X3DBackgroundNode","Background","getBackground",e),this.addType("X3DFogNode","Fog","getFog",e),this.addType("X3DEnvironmentNode","Environment","getEnvironment",e)},x3dom.BindableBag.prototype.addType=function(e,t,i,s){var o=x3dom.nodeTypes[e],r=x3dom.nodeTypes[t];if(o&&r){var a=new x3dom.BindableStack(s,o,r,i);this._stacks.push(a)}else x3dom.debug.logWarning("Invalid Bindable type/defaultType: "+e+"/"+r)},x3dom.BindableBag.prototype.setRefNode=function(e){Array.forEach(this._stacks,function(t){t._defaultRoot=e,e[t._getter]=function(){return t.getActive()}})},x3dom.BindableBag.prototype.addBindable=function(e){for(var t=0,i=this._stacks.length;t<i;t++){var s=this._stacks[t];if(x3dom.isa(e,s._type)){x3dom.debug.logInfo("register "+e.typeName()+"Bindable "+e._DEF+"/"+e._vf.description),s._bindBag.push(e);var o=s.top();if(o&&o._autoGen){s.replaceTop(e);for(var r=0,a=s._bindBag.length;r<a;r++)if(s._bindBag[r]===o){s._bindBag.splice(r,1);break}s._defaultRoot.removeChild(o)}return s}}return x3dom.debug.logError(e.typeName()+" is not a valid bindable"),null},x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"solid",!0),this.addField_SFBool(e,"ccw",!0),this.addField_SFBool(e,"useGeoCache",!0),this.addField_SFBool(e,"lit",!0),this._mesh=new x3dom.Mesh(this)},{getVolume:function(){return this._mesh.getVolume()},invalidateVolume:function(){this._mesh.invalidate()},getCenter:function(){return this._mesh.getCenter()},getDiameter:function(){return this._mesh.getDiameter()},doIntersect:function(e){return this._mesh.doIntersect(e)},forceUpdateCoverage:function(){return!1},hasIndexOffset:function(){return!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null},parentAdded:function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._cleanupGLObjects&&e._cleanupGLObjects(!0),e.setAllDirty(),e.invalidateVolume())},needLighting:function(){var e=this._mesh._primType.indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Mesh.superClass.call(this,e),this.addField_SFString(e,"primType","triangle"),this.addField_MFInt32(e,"index",[]),this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)},{nodeChanged:function(){var e,t=(new Date).getTime(),i=this._cf.vertexAttributes.nodes.length;for(e=0;e<i;e++){var s=this._cf.vertexAttributes.nodes[e]._vf.name;switch(s.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[s]={},this._mesh._dynamicFields[s].numComponents=this._cf.vertexAttributes.nodes[e]._vf.numComponents,this._mesh._dynamicFields[s].value=this._cf.vertexAttributes.nodes[e]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL(),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var o=(new Date).getTime()-t;x3dom.debug.logWarning("Mesh load time: "+o+" ms")}})),x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.PointSet.superClass.call(this,e),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="POINTS"},{nodeChanged:function(){var e=(new Date).getTime(),t=this._cf.coord.node;x3dom.debug.assert(t,"PointSet without coord node!");var i=t.getPoints(),s=3,o=this._cf.color.node,r=new x3dom.fields.MFColor;o&&(r=o._vf.color,x3dom.debug.assert(i.length==r.length,"Size of color and coord array differs!"),x3dom.isa(o,x3dom.nodeTypes.ColorRGBA)&&(s=4)),this._mesh._numColComponents=s,this._mesh._lit=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=i.toGL(),this._mesh._colors[0]=r.toGL(),this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t=null;"coord"==e?(t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFString(e,"normalUpdateMode","fast"),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)},{handleAttribs:function(){var e,t=this._cf.attrib.nodes.length;for(e=0;e<t;e++){var i=this._cf.attrib.nodes[e]._vf.name;switch(i.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[i]={},this._mesh._dynamicFields[i].numComponents=this._cf.attrib.nodes[e]._vf.numComponents,this._mesh._dynamicFields[i].value=this._cf.attrib.nodes[e]._vf.value.toGL()}}}})),x3dom.registerNodeType("LineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.LineSet.superClass.call(this,e),this.addField_MFInt32(e,"vertexCount",[]),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0},{nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e);var t=e.getPoints();this._mesh._positions[0]=t.toGL();var i=this._cf.color.node;if(i){var s=i._vf.color;this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=3,x3dom.isa(i,x3dom.nodeTypes.ColorRGBA)&&(this._mesh._numColComponents=4)}var o=0;this._mesh._indices[0]=[];for(var r=0,a=this._vf.vertexCount.length;r<a;r++){var n=this._vf.vertexCount[r];if(n<2){x3dom.debug.logError("LineSet.vertexCount must not be smaller than 2!");break}for(var d=n-2;d>=0;d--)this._mesh._indices[0].push(o++,o),0==d&&o++}},fieldChanged:function(e){if("coord"==e){var t=this._cf.coord.node.getPoints();this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("color"==e){var i=this._cf.color.node._vf.color;this._mesh._colors[0]=i.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}}})),x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0},{_buildGeometry:function(){var e=(new Date).getTime(),t=this._vf.coordIndex,i=this._vf.colorIndex,s=!1,o=!1,r=this._vf.colorPerVertex;i.length==t.length&&(o=!0);var a,n,d=this._cf.coord.node;x3dom.debug.assert(d),a=d.getPoints();var l=3,h=this._cf.color.node;h?(s=!0,n=h._vf.color,x3dom.isa(h,x3dom.nodeTypes.ColorRGBA)&&(l=4)):s=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._colors[0]=[];var u,f,c,_,m,p,x,g;if(s&&o||a.length>x3dom.Utils.maxIndexableCoords){for(f=0,c=0,_=0,u=0;u<t.length;++u)if(!(t[u]>a.length-1))if(t[u]!==-1)switch(o&&x3dom.debug.assert(i[u]!=-1),f){case 0:m=+t[u],x=o&&r?+i[u]:m,f=1;break;case 1:p=+t[u],
g=o&&r?+i[u]:o&&!r?+i[_]:p,this._mesh._indices[0].push(c++,c++),this._mesh._positions[0].push(a[m].x),this._mesh._positions[0].push(a[m].y),this._mesh._positions[0].push(a[m].z),this._mesh._positions[0].push(a[p].x),this._mesh._positions[0].push(a[p].y),this._mesh._positions[0].push(a[p].z),s&&(r||(x=g),this._mesh._colors[0].push(n[x].r),this._mesh._colors[0].push(n[x].g),this._mesh._colors[0].push(n[x].b),this._mesh._colors[0].push(n[g].r),this._mesh._colors[0].push(n[g].g),this._mesh._colors[0].push(n[g].b)),f=2,_++;break;case 2:m=p,x=g,p=+t[u],g=o&&r?+i[u]:o&&!r?+i[_]:p,this._mesh._indices[0].push(c++,c++),this._mesh._positions[0].push(a[m].x),this._mesh._positions[0].push(a[m].y),this._mesh._positions[0].push(a[m].z),this._mesh._positions[0].push(a[p].x),this._mesh._positions[0].push(a[p].y),this._mesh._positions[0].push(a[p].z),s&&(r||(x=g),this._mesh._colors[0].push(n[x].r),this._mesh._colors[0].push(n[x].g),this._mesh._colors[0].push(n[x].b),this._mesh._colors[0].push(n[g].r),this._mesh._colors[0].push(n[g].g),this._mesh._colors[0].push(n[g].b)),_++}else f=0;a.length>x3dom.Utils.maxIndexableCoords&&this._mesh.splitMesh(2)}else{var v=t.length;for(f=0,u=0;u<v;++u)if(t[u]!=-1)switch(f){case 0:m=+t[u],f=1;break;case 1:p=+t[u],f=2,this._mesh._indices[0].push(m,p);break;case 2:m=p,p=+t[u],this._mesh._indices[0].push(m,p)}else f=0;this._mesh._positions[0]=a.toGL(),s&&(this._mesh._colors[0]=n.toGL(),this._mesh._numColComponents=l)}for(this.invalidateVolume(),this._mesh._numCoords=0,u=0;u<this._mesh._indices.length;u++)this._mesh._numCoords+=this._mesh._positions[u].length/3;(new Date).getTime()-e},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})):"coordIndex"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0,e.invalidateVolume()})):"colorIndex"==e&&(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0,e.invalidateVolume()}))}})),x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])},{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,s,o,r=this._vf.colorPerVertex,a=this._vf.normalPerVertex,n=this._vf.index,d=!1,l=!1,h=!1,u=this._cf.coord.node;x3dom.debug.assert(u),t=u._vf.point;var f=this._cf.normal.node;f?(d=!0,i=f._vf.vector):d=!1;var c="",_=2,m=this._cf.texCoord.node;x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]),m?m._vf.point?(l=!0,s=m._vf.point,x3dom.isa(m,x3dom.nodeTypes.TextureCoordinate3D)&&(_=3)):m._vf.mode&&(c=m._vf.mode):l=!1;var p=3,x=this._cf.color.node;x?(h=!0,o=x._vf.color,x3dom.isa(x,x3dom.nodeTypes.ColorRGBA)&&(p=4)):h=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var g,v,y,b,T,S,M,C,F,E,w,A,N,R,I,P,D;t.length%3>0;)t.push(t.length-1);if(T=t.length,!a||!r||T>x3dom.Utils.maxIndexableCoords){for(v=0,y=0,b=0,this._mesh._multiIndIndices=[],this._mesh._posSize=t.length,g=0;g<n.length;++g)switch(g>0&&g%3===0&&(v=0,b++),v){case 0:S=+n[g],a?F=S:a||(F=b),A=S,r?I=S:r||(I=b),v=1;break;case 1:M=+n[g],a?E=M:a||(E=b),N=M,r?P=M:r||(P=b),v=2;break;case 2:C=+n[g],a?w=C:a||(w=b),R=C,r?D=C:r||(D=b),v=3,this._mesh._indices[0].push(y++,y++,y++),this._mesh._positions[0].push(t[S].x),this._mesh._positions[0].push(t[S].y),this._mesh._positions[0].push(t[S].z),this._mesh._positions[0].push(t[M].x),this._mesh._positions[0].push(t[M].y),this._mesh._positions[0].push(t[M].z),this._mesh._positions[0].push(t[C].x),this._mesh._positions[0].push(t[C].y),this._mesh._positions[0].push(t[C].z),d?(this._mesh._normals[0].push(i[F].x),this._mesh._normals[0].push(i[F].y),this._mesh._normals[0].push(i[F].z),this._mesh._normals[0].push(i[E].x),this._mesh._normals[0].push(i[E].y),this._mesh._normals[0].push(i[E].z),this._mesh._normals[0].push(i[w].x),this._mesh._normals[0].push(i[w].y),this._mesh._normals[0].push(i[w].z)):this._mesh._multiIndIndices.push(S,M,C),h&&(this._mesh._colors[0].push(o[I].r),this._mesh._colors[0].push(o[I].g),this._mesh._colors[0].push(o[I].b),4===p&&this._mesh._colors[0].push(o[I].a),this._mesh._colors[0].push(o[P].r),this._mesh._colors[0].push(o[P].g),this._mesh._colors[0].push(o[P].b),4===p&&this._mesh._colors[0].push(o[P].a),this._mesh._colors[0].push(o[D].r),this._mesh._colors[0].push(o[D].g),this._mesh._colors[0].push(o[D].b),4===p&&this._mesh._colors[0].push(o[D].a)),l&&(this._mesh._texCoords[0].push(s[A].x),this._mesh._texCoords[0].push(s[A].y),3===_&&this._mesh._texCoords[0].push(s[A].z),this._mesh._texCoords[0].push(s[N].x),this._mesh._texCoords[0].push(s[N].y),3===_&&this._mesh._texCoords[0].push(s[N].z),this._mesh._texCoords[0].push(s[R].x),this._mesh._texCoords[0].push(s[R].y),3===_&&this._mesh._texCoords[0].push(s[R].z))}d||this._mesh.calcNormals(a?Math.PI:0),l||this._mesh.calcTexCoords(c),this._mesh.splitMesh()}else{for(b=0,g=0;g<n.length;g++)g>0&&g%3===0&&b++,this._mesh._indices[0].push(n[g]),!a&&d&&(this._mesh._normals[0].push(i[b].x),this._mesh._normals[0].push(i[b].y),this._mesh._normals[0].push(i[b].z)),!r&&h&&(this._mesh._colors[0].push(o[b].r),this._mesh._colors[0].push(o[b].g),this._mesh._colors[0].push(o[b].b),4===p&&this._mesh._colors[0].push(o[b].a));this._mesh._positions[0]=t.toGL(),d?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(a?Math.PI:0),l?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=_):this._mesh.calcTexCoords(c),h&&r&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=p)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,g=0;g<this._mesh._indices.length;g++)this._mesh._numFaces+=this._mesh._indices[g].length/3,this._mesh._numCoords+=this._mesh._positions[g].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t=this._cf.coord.node._vf.point;if(t.length>x3dom.Utils.maxIndexableCoords)return void x3dom.debug.logWarning("IndexedTriangleSet: fieldChanged with too many coordinates not yet implemented!");if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()});else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var i=0,s=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(s=4),this._mesh._colors[0]=[];for(var o=this._vf.index,r=0;r<o.length;++r)r>0&&r%3===0&&i++,this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b),4===s&&this._mesh._colors[0].push(t[i].a)}Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){var o=this._vf.index;this._mesh._normals[0]=[];for(var i=0,r=0;r<o.length;++r)r>0&&r%3===0&&i++,this._mesh._normals[0].push(t[i].x),this._mesh._normals[0].push(t[i].y),this._mesh._normals[0].push(t[i].z)}Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var a=this._cf.texCoord.node;x3dom.isa(a,x3dom.nodeTypes.MultiTextureCoordinate)&&a._cf.texCoord.nodes.length&&(a=a._cf.texCoord.nodes[0]),t=a._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}}})),x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[]),this._hasIndexOffset=!1,this._indexOffset=null},{hasIndexOffset:function(){return this._hasIndexOffset},nodeChanged:function(){this.handleAttribs();var e,t,i,s,o=!1,r=!1,a=!1,n=this._vf.colorPerVertex,d=this._vf.normalPerVertex,l=this._vf.index,h=this._cf.coord.node;x3dom.debug.assert(h),e=h._vf.point;var u=this._cf.normal.node;u?(o=!0,t=u._vf.vector):o=!1;var f="",c=2,_=this._cf.texCoord.node;x3dom.isa(_,x3dom.nodeTypes.MultiTextureCoordinate)&&_._cf.texCoord.nodes.length&&(_=_._cf.texCoord.nodes[0]),_?_._vf.point?(r=!0,i=_._vf.point,x3dom.isa(_,x3dom.nodeTypes.TextureCoordinate3D)&&(c=3)):_._vf.mode&&(f=_._vf.mode):r=!1,this._mesh._numTexComponents=c;var m=3,p=this._cf.color.node;p?(a=!0,s=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):a=!1,this._mesh._numColComponents=m,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[],this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0;var x=0,g=0;if(o&&e.length<=x3dom.Utils.maxIndexableCoords){this._hasIndexOffset=!0,this._indexOffset=[],this._mesh._primType="TRIANGLESTRIP";var v=[0];for(D=0;D<l.length;D++)l[D]==-1?(x++,v.push(this._mesh._indices[0].length)):(this._mesh._indices[0].push(+l[D]),d||(this._mesh._normals[0].push(t[x].x),this._mesh._normals[0].push(t[x].y),this._mesh._normals[0].push(t[x].z)),n||(this._mesh._colors[0].push(s[x].r),this._mesh._colors[0].push(s[x].g),this._mesh._colors[0].push(s[x].b),4===m&&this._mesh._colors[0].push(s[x].a)));for(this._mesh._positions[0]=e.toGL(),d&&(this._mesh._normals[0]=t.toGL()),r?(this._mesh._texCoords[0]=i.toGL(),this._mesh._numTexComponents=c):x3dom.debug.logWarning("IndexedTriangleStripSet: no texCoords given and won't calculate!"),a&&(n&&(this._mesh._colors[0]=s.toGL()),this._mesh._numColComponents=m),D=1;D<v.length;D++){var y=v[D]-v[D-1];this._indexOffset.push({count:y,offset:2*v[D-1]}),this._mesh._numFaces+=y-2}this._mesh._numCoords=this._mesh._positions[0].length/3}else{this._hasIndexOffset=!1;for(var b,T,S,M,C,F,E,w,A,N,R,I,P=!1,D=1;D<l.length-2;++D)l[D+1]!=-1?(P?(b=l[D],T=l[D-1],S=l[D+1]):(b=l[D-1],T=l[D],S=l[D+1]),P=!P,d?(M=b,C=T,F=S):d||(M=C=F=x),E=b,w=T,A=S,n?(N=b,R=T,I=S):n||(N=R=I=x),this._mesh._indices[0].push(g++,g++,g++),this._mesh._positions[0].push(e[b].x),this._mesh._positions[0].push(e[b].y),this._mesh._positions[0].push(e[b].z),this._mesh._positions[0].push(e[T].x),this._mesh._positions[0].push(e[T].y),this._mesh._positions[0].push(e[T].z),this._mesh._positions[0].push(e[S].x),this._mesh._positions[0].push(e[S].y),this._mesh._positions[0].push(e[S].z),o&&(this._mesh._normals[0].push(t[M].x),this._mesh._normals[0].push(t[M].y),this._mesh._normals[0].push(t[M].z),this._mesh._normals[0].push(t[C].x),this._mesh._normals[0].push(t[C].y),this._mesh._normals[0].push(t[C].z),this._mesh._normals[0].push(t[F].x),this._mesh._normals[0].push(t[F].y),this._mesh._normals[0].push(t[F].z)),a&&(this._mesh._colors[0].push(s[N].r),this._mesh._colors[0].push(s[N].g),this._mesh._colors[0].push(s[N].b),4===m&&this._mesh._colors[0].push(s[N].a),this._mesh._colors[0].push(s[R].r),this._mesh._colors[0].push(s[R].g),this._mesh._colors[0].push(s[R].b),4===m&&this._mesh._colors[0].push(s[R].a),this._mesh._colors[0].push(s[I].r),this._mesh._colors[0].push(s[I].g),this._mesh._colors[0].push(s[I].b),4===m&&this._mesh._colors[0].push(s[I].a)),r&&(this._mesh._texCoords[0].push(i[E].x),this._mesh._texCoords[0].push(i[E].y),3===c&&this._mesh._texCoords[0].push(i[E].z),this._mesh._texCoords[0].push(i[w].x),this._mesh._texCoords[0].push(i[w].y),3===c&&this._mesh._texCoords[0].push(i[w].z),this._mesh._texCoords[0].push(i[A].x),this._mesh._texCoords[0].push(i[A].y),3===c&&this._mesh._texCoords[0].push(i[A].z))):(D+=2,x++);for(o||this._mesh.calcNormals(Math.PI),r||this._mesh.calcTexCoords(f),this._mesh.splitMesh(),this.invalidateVolume(),D=0;D<this._mesh._indices.length;D++)this._mesh._numFaces+=this._mesh._indices[D].length/3,this._mesh._numCoords+=this._mesh._positions[D].length/3}},fieldChanged:function(e){if("coord"!=e&&"normal"!=e&&"texCoord"!=e&&"color"!=e)return void x3dom.debug.logWarning("IndexedTriangleStripSet: fieldChanged for "+e+" not yet implemented!");var t=this._cf.coord.node._vf.point;if(null===this._cf.normal.node||t.length>x3dom.Utils.maxIndexableCoords){if("coord"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var i,s,o,r,a=!1,n=!1,d=!1,l=this._vf.colorPerVertex,h=this._vf.normalPerVertex,u=this._vf.index,f=this._cf.coord.node;x3dom.debug.assert(f),i=f._vf.point;var c=this._cf.normal.node;c?(a=!0,s=c._vf.vector):a=!1;var _="",m=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(n=!0,o=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3)):p._vf.mode&&(_=p._vf.mode):n=!1,this._mesh._numTexComponents=m;var x=3,g=this._cf.color.node;g?(d=!0,r=g._vf.color,x3dom.isa(g,x3dom.nodeTypes.ColorRGBA)&&(x=4)):d=!1,this._mesh._numColComponents=x,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var v,y,b,T,S,M,C,F,E,w,A,N,R=0,I=0,P=!1;if(a||n||d){for(var D=1;D<u.length-2;++D)u[D+1]!=-1?(P?(v=u[D],y=u[D-1],b=u[D+1]):(v=u[D-1],y=u[D],b=u[D+1]),P=!P,h?(T=v,S=y,M=b):h||(T=S=M=R),C=v,F=y,E=b,l?(w=v,A=y,N=b):l||(w=A=N=R),this._mesh._indices[0].push(I++,I++,I++),this._mesh._positions[0].push(i[v].x),this._mesh._positions[0].push(i[v].y),this._mesh._positions[0].push(i[v].z),this._mesh._positions[0].push(i[y].x),this._mesh._positions[0].push(i[y].y),this._mesh._positions[0].push(i[y].z),this._mesh._positions[0].push(i[b].x),this._mesh._positions[0].push(i[b].y),this._mesh._positions[0].push(i[b].z),a&&(this._mesh._normals[0].push(s[T].x),this._mesh._normals[0].push(s[T].y),this._mesh._normals[0].push(s[T].z),this._mesh._normals[0].push(s[S].x),this._mesh._normals[0].push(s[S].y),this._mesh._normals[0].push(s[S].z),this._mesh._normals[0].push(s[M].x),this._mesh._normals[0].push(s[M].y),this._mesh._normals[0].push(s[M].z)),d&&(this._mesh._colors[0].push(r[w].r),this._mesh._colors[0].push(r[w].g),this._mesh._colors[0].push(r[w].b),4===x&&this._mesh._colors[0].push(r[w].a),this._mesh._colors[0].push(r[A].r),this._mesh._colors[0].push(r[A].g),this._mesh._colors[0].push(r[A].b),4===x&&this._mesh._colors[0].push(r[A].a),this._mesh._colors[0].push(r[N].r),this._mesh._colors[0].push(r[N].g),this._mesh._colors[0].push(r[N].b),4===x&&this._mesh._colors[0].push(r[N].a)),n&&(this._mesh._texCoords[0].push(o[C].x),this._mesh._texCoords[0].push(o[C].y),3===m&&this._mesh._texCoords[0].push(o[C].z),this._mesh._texCoords[0].push(o[F].x),this._mesh._texCoords[0].push(o[F].y),3===m&&this._mesh._texCoords[0].push(o[F].z),this._mesh._texCoords[0].push(o[E].x),this._mesh._texCoords[0].push(o[E].y),3===m&&this._mesh._texCoords[0].push(o[E].z))):(D+=2,R++);a||this._mesh.calcNormals(Math.PI),n||this._mesh.calcTexCoords(_),this._mesh.splitMesh()}else{for(var P=!1,D=1;D<u.length;++D)u[D+1]!=-1?(P?(this._mesh._indices[0].push(u[D]),this._mesh._indices[0].push(u[D-1]),this._mesh._indices[0].push(u[D+1])):(this._mesh._indices[0].push(u[D-1]),this._mesh._indices[0].push(u[D]),this._mesh._indices[0].push(u[D+1])),P=!P):D+=2;this._mesh._positions[0]=i.toGL(),a?this._mesh._normals[0]=s.toGL():this._mesh.calcNormals(Math.PI),n?(this._mesh._texCoords[0]=o.toGL(),this._mesh._numTexComponents=m):this._mesh.calcTexCoords(_),d&&(this._mesh._colors[0]=r.toGL(),this._mesh._numColComponents=x)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,D=0;D<this._mesh._indices.length;D++)this._mesh._numFaces+=this._mesh._indices[D].length/3,this._mesh._numCoords+=this._mesh._positions[D].length/3;Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}else if("color"==e){var V=this._cf.color.node._vf.color,R=0,w=A=N=0,x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)u[D+1]!=-1?(this._vf.colorPerVertex?(P?(w=u[D],A=u[D-1],N=u[D+1]):(w=u[D-1],A=u[D],N=u[D+1]),P=!P):this._vf.colorPerVertex||(w=A=N=R),this._mesh._colors[0].push(V[w].r),this._mesh._colors[0].push(V[w].g),this._mesh._colors[0].push(V[w].b),4===x&&this._mesh._colors[0].push(V[w].a),this._mesh._colors[0].push(V[A].r),this._mesh._colors[0].push(V[A].g),this._mesh._colors[0].push(V[A].b),4===x&&this._mesh._colors[0].push(V[A].a),this._mesh._colors[0].push(V[N].r),this._mesh._colors[0].push(V[N].g),this._mesh._colors[0].push(V[N].b),4===x&&this._mesh._colors[0].push(V[N].a)):(D+=2,R++);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){var L=this._cf.normal.node._vf.vector,R=0,T=S=M=0;this._mesh._normals[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)u[D+1]!=-1?(this._vf.normalPerVertex?(P?(T=u[D],S=u[D-1],M=u[D+1]):(T=u[D-1],S=u[D],M=u[D+1]),P=!P):this._vf.normalPerVertex||(T=S=M=R),this._mesh._normals[0].push(L[T].x),this._mesh._normals[0].push(L[T].y),this._mesh._normals[0].push(L[T].z),this._mesh._normals[0].push(L[S].x),this._mesh._normals[0].push(L[S].y),this._mesh._normals[0].push(L[S].z),this._mesh._normals[0].push(L[M].x),this._mesh._normals[0].push(L[M].y),this._mesh._normals[0].push(L[M].z)):(D+=2,R++);Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]);var O=p._vf.point,C=F=E=0,m=2;x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3),this._mesh._texCoords[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)u[D+1]!=-1?(P?(C=u[D],F=u[D-1],E=u[D+1]):(C=u[D-1],F=u[D],E=u[D+1]),P=!P,this._mesh._texCoords[0].push(O[C].x),this._mesh._texCoords[0].push(O[C].y),3===m&&this._mesh._texCoords[0].push(O[C].z),this._mesh._texCoords[0].push(O[F].x),this._mesh._texCoords[0].push(O[F].y),3===m&&this._mesh._texCoords[0].tex(V[F].z),this._mesh._texCoords[0].push(O[E].x),this._mesh._texCoords[0].push(O[E].y),3===m&&this._mesh._texCoords[0].push(O[E].z)):D+=2;Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}}else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()});else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var R=0,x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];var u=this._vf.index;for(D=0;D<u.length;++D)u[D]!=-1?(this._mesh._colors[0].push(t[R].r),this._mesh._colors[0].push(t[R].g),this._mesh._colors[0].push(t[R].b),4===x&&this._mesh._colors[0].push(t[R].a)):R++}Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){var u=this._vf.index;this._mesh._normals[0]=[];var R=0;for(D=0;D<u.length;++D)u[D]!=-1?(this._mesh._normals[0].push(t[R].x),this._mesh._normals[0].push(t[R].y),this._mesh._normals[0].push(t[R].z)):R++}Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),t=p._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}}})),x3dom.registerNodeType("TriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.TriangleSet.superClass.call(this,e)},{_buildGeometry:function(){var e,t,i,s,o=this._vf.colorPerVertex,r=this._vf.normalPerVertex,a=!1,n=!1,d=!1,l=this._cf.coord.node;if(x3dom.debug.assert(l),!l||l._vf.point.length<3)return void(this._vf.render=!1);e=l._vf.point;var h=this._cf.normal.node;h?(a=!0,t=h._vf.vector):a=!1;var u="",f=2,c=this._cf.texCoord.node;x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c?c._vf.point?(n=!0,i=c._vf.point,x3dom.isa(c,x3dom.nodeTypes.TextureCoordinate3D)&&(f=3)):c._vf.mode&&(u=c._vf.mode):n=!1;var _=3,m=this._cf.color.node;for(m?(d=!0,s=m._vf.color,x3dom.isa(m,x3dom.nodeTypes.ColorRGBA)&&(_=4)):d=!1;e.length%3>0;)e.pop();this._mesh._indices[0]=new Array(e.length),this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var p,x=e.length/3,g=0;for(p=0;p<x;p++)this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,!r&&a&&(this._mesh._normals[0].push(t[p].x),this._mesh._normals[0].push(t[p].y),this._mesh._normals[0].push(t[p].z)),!o&&d&&(this._mesh._colors[0].push(s[p].r),this._mesh._colors[0].push(s[p].g),this._mesh._colors[0].push(s[p].b),4===_&&this._mesh._colors[0].push(s[p].a));this._mesh._positions[0]=e.toGL(),a?this._mesh._normals[0]=t.toGL():this._mesh.calcNormals(r?Math.PI:0),n?(this._mesh._texCoords[0]=i.toGL(),this._mesh._numTexComponents=f):this._mesh.calcTexCoords(u),d&&o&&(this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=_),this._mesh._numFaces=x,this._mesh._numCoords=e.length,this.invalidateVolume()},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})):"normal"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})):"texCoord"==e&&(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0}))}})),x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,e)},{fieldChanged:function(e){"coord"!==e&&"point"!==e||Array.forEach(this._parentNodes,function(e){e.fieldChanged("coord")})},parentAdded:function(e){e._mesh&&e._cf.coord.node!==this&&e.fieldChanged("coord")}})),x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(e){x3dom.nodeTypes.Coordinate.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])},{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.Normal.superClass.call(this,e),this.addField_MFVec3f(e,"vector",[])},{fieldChanged:function(e){"normal"!==e&&"vector"!==e||Array.forEach(this._parentNodes,function(e){e.fieldChanged("normal")})},parentAdded:function(e){e._mesh&&e._cf.normal.node!==this&&e.fieldChanged("normal")}})),x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DColorNode.superClass.call(this,e)},{fieldChanged:function(e){"color"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("color")})},parentAdded:function(e){e._mesh&&e._cf.color.node!==this&&e.fieldChanged("color")}})),x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.Color.superClass.call(this,e),this.addField_MFColor(e,"color",[])})),x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.ColorRGBA.superClass.call(this,e),this.addField_MFColorRGBA(e,"color",[])})),x3dom.registerNodeType("ParticleSet","Rendering",defineClass(x3dom.nodeTypes.PointSet,function(e){x3dom.nodeTypes.ParticleSet.superClass.call(this,e),this.addField_SFString(e,"mode","ViewDirQuads"),this.addField_SFString(e,"drawOrder","Any"),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_MFVec3f(e,"size",[]),this.addField_MFInt32(e,"index",[]),this.addField_MFFloat(e,"textureZ",[]),this._mesh._primType="POINTS"},{drawOrder:function(){return this._vf.drawOrder.toLowerCase()},nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e,"ParticleSet without coord node!");var t=e.getPoints(),i=3,s=this._cf.color.node,o=new x3dom.fields.MFColor;s&&(o=s._vf.color,x3dom.debug.assert(t.length==o.length,"Size of color and coord array differs!"),x3dom.isa(s,x3dom.nodeTypes.ColorRGBA)&&(i=4));var r=this._cf.normal.node,a=new x3dom.fields.MFVec3f;r&&(a=r._vf.vector);var n=[];if("any"!=this.drawOrder()&&(n=this._vf.index.toGL(),0==n.length)){var d,l=t.length;for(n=new Array(l),d=0;d<l;d++)n[d]=d}this._mesh._numColComponents=i,this._mesh._lit=!1,this._mesh._indices[0]=n,this._mesh._positions[0]=t.toGL(),this._mesh._colors[0]=o.toGL(),this._mesh._normals[0]=a.toGL(),this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){var t=null;if("index"==e)this._mesh._indices[0]=this._vf.index.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0});else if("size"==e)Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0});else if("coord"==e){t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL();var i=[];if("any"!=this.drawOrder()&&(i=this._vf.index.toGL(),0==i.length)){var s,o=t.length;for(i=new Array(o),s=0;s<o;s++)i[s]=s}this._mesh._indices[0]=i,this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()})}else"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("ClipPlane","Rendering",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.ClipPlane.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFVec4f(e,"plane",0,1,0,0),this.addField_SFFloat(e,"cappingStrength",0),this.addField_SFColor(e,"cappingColor",1,1,1),this.addField_SFBool(e,"on",!0)},{fieldChanged:function(e){},nodeChanged:function(){x3dom.nodeTypes.ClipPlane.count++},onRemove:function(){x3dom.nodeTypes.ClipPlane.count--},parentAdded:function(e){},parentRemoved:function(e){}})),x3dom.nodeTypes.ClipPlane.count=0,x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,e)})),x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,function(e){x3dom.nodeTypes.Appearance.superClass.call(this,e),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode),this.addField_SFNode("lineProperties",x3dom.nodeTypes.LineProperties),this.addField_SFNode("colorMaskMode",x3dom.nodeTypes.ColorMaskMode),this.addField_SFNode("blendMode",x3dom.nodeTypes.BlendMode),this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode),this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode),this.addField_SFString(e,"sortType","auto"),this.addField_SFInt32(e,"sortKey",0),this.addField_SFFloat(e,"alphaClipThreshold",.1),this._shader=null},{fieldChanged:function(e){"alphaClipThreshold"==e&&Array.forEach(this._parentNodes,function(e){e.setAppDirty()})},nodeChanged:function(){!this._cf.material.node,this._cf.shaders.nodes.length?this._shader=this._cf.shaders.nodes[0]:this._shader&&(this._shader=null),Array.forEach(this._parentNodes,function(e){e.setAppDirty()}),this.checkSortType()},checkSortType:function(){"auto"==this._vf.sortType&&(this._cf.material.node&&(this._cf.material.node._vf.transparency>0||this._cf.material.node._vf.backTransparency&&this._cf.material.node._vf.backTransparency>0)?this._vf.sortType="transparent":this._cf.texture.node&&this._cf.texture.node._vf.url.length&&this._cf.texture.node._vf.url[0].toLowerCase().indexOf(".png")>=0?this._vf.sortType="transparent":this._vf.sortType="opaque")},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()},parentAdded:function(e){this!=x3dom.nodeTypes.Appearance._defaultNode&&e.setAppDirty()}})),x3dom.nodeTypes.Appearance.defaultNode=function(){return x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged()),x3dom.nodeTypes.Appearance._defaultNode},x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,e)})),x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.BlendMode.superClass.call(this,e),this.addField_SFString(e,"srcFactor","src_alpha"),this.addField_SFString(e,"destFactor","one_minus_src_alpha"),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"colorTransparency",0),this.addField_SFString(e,"alphaFunc","none"),this.addField_SFFloat(e,"alphaFuncValue",0),this.addField_SFString(e,"equation","none")})),x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.DepthMode.superClass.call(this,e),this.addField_SFBool(e,"enableDepthTest",!0),this.addField_SFString(e,"depthFunc","none"),this.addField_SFBool(e,"readOnly",!1),this.addField_SFFloat(e,"zNearRange",-1),this.addField_SFFloat(e,"zFarRange",-1)})),x3dom.registerNodeType("ColorMaskMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.ColorMaskMode.superClass.call(this,e),this.addField_SFBool(e,"maskR",!0),this.addField_SFBool(e,"maskG",!0),this.addField_SFBool(e,"maskB",!0),this.addField_SFBool(e,"maskA",!0)})),x3dom.registerNodeType("LineProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.LineProperties.superClass.call(this,e),this.addField_SFBool(e,"applied",!0),this.addField_SFInt32(e,"linetype",1),this.addField_SFFloat(e,"linewidthScaleFactor",0)})),x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,e)})),x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(e){x3dom.nodeTypes.Material.superClass.call(this,e),this.addField_SFFloat(e,"ambientIntensity",.2),this.addField_SFColor(e,"diffuseColor",.8,.8,.8),this.addField_SFColor(e,"emissiveColor",0,0,0),this.addField_SFFloat(e,"shininess",.2),this.addField_SFColor(e,"specularColor",0,0,0),this.addField_SFFloat(e,"transparency",0)},{fieldChanged:function(e){"ambientIntensity"!=e&&"diffuseColor"!=e&&"emissiveColor"!=e&&"shininess"!=e&&"specularColor"!=e&&"transparency"!=e||Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.material=!0}),e.checkSortType()})}})),x3dom.nodeTypes.Material.defaultNode=function(){return x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged()),x3dom.nodeTypes.Material._defaultNode},x3dom.registerNodeType("TwoSidedMaterial","Shape",defineClass(x3dom.nodeTypes.Material,function(e){x3dom.nodeTypes.TwoSidedMaterial.superClass.call(this,e),this.addField_SFFloat(e,"backAmbientIntensity",.2),this.addField_SFColor(e,"backDiffuseColor",.8,.8,.8),this.addField_SFColor(e,"backEmissiveColor",0,0,0),this.addField_SFFloat(e,"backShininess",.2),this.addField_SFColor(e,"backSpecularColor",0,0,0),
this.addField_SFFloat(e,"backTransparency",0),this.addField_SFBool(e,"separateBackColor",!1)},{fieldChanged:function(e){"ambientIntensity"!=e&&"diffuseColor"!=e&&"emissiveColor"!=e&&"shininess"!=e&&"specularColor"!=e&&"transparency"!=e&&"backAmbientIntensity"!=e&&"backDiffuseColor"!=e&&"backEmissiveColor"!=e&&"backShininess"!=e&&"backSpecularColor"!=e&&"backTransparency"!=e&&"separateBackColor"!=e||Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.material=!0}),e.checkSortType()})}})),x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DBoundedObject,function(e){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,e),this.addField_SFBool(e,"isPickable",!0),this.addField_SFInt32(e,"idOffset",0),this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode),this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode),this._objectID=0,this._shaderProperties=null,this._clipPlanes=[],this._cleanupGLObjects=null,this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,specialAttribs:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0,ids:!0},this._coordStrideOffset=[0,0],this._normalStrideOffset=[0,0],this._texCoordStrideOffset=[0,0],this._colorStrideOffset=[0,0],this._idStrideOffset=[0,0],this._tessellationProperties=[]},{collectDrawableObjects:function(e,t,i,s,o,r){var a=this.graphState();return i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!(!this._cf.geometry.node||t.cull(e,a,i,o)<=0)&&(i&&!this._graph.globalMatrix&&(this._graph.globalMatrix=e),this._clipPlanes.length!=r.length&&(this._dirty.shader=!0),this._clipPlanes=r,t.addShape(this,e,a),!0)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var t=this._cf.geometry.node,i=t?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},getCenter:function(){var e=this._cf.geometry.node;return e?e.getCenter():new x3dom.fields.SFVec3f(0,0,0)},getDiameter:function(){var e=this._cf.geometry.node;return e?e.getDiameter():0},doIntersect:function(e){return this._cf.geometry.node.doIntersect(e)},forceUpdateCoverage:function(){var e=this._cf.geometry.node;return!!e&&e.forceUpdateCoverage()},tessellationProperties:function(){var e=this._cf.geometry.node;return e&&e._indexOffset?e._indexOffset:this._tessellationProperties},isLit:function(){return this._cf.geometry.node._vf.lit},isSolid:function(){var e=this._cf.appearance.node&&this._cf.appearance.node._cf.material.node&&x3dom.isa(this._cf.appearance.node._cf.material.node,x3dom.nodeTypes.TwoSidedMaterial);return this._cf.geometry.node._vf.solid&&!e},isCCW:function(){return this._cf.geometry.node._vf.ccw},parentRemoved:function(e){for(var t=0,i=this._childNodes.length;t<i;t++){var s=this._childNodes[t];s&&s.parentRemoved(this)}e&&e.invalidateVolume(),this._parentNodes.length>0&&this.invalidateVolume(),this._cleanupGLObjects&&this._cleanupGLObjects()},unsetDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1,this._dirty.texture=!1,this._dirty.material=!1,this._dirty.text=!1,this._dirty.shader=!1},unsetGeoDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1},setAllDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this._dirty.texture=!0,this._dirty.material=!0,this._dirty.text=!0,this._dirty.shader=!0,this.invalidateVolume()},setAppDirty:function(){this._dirty.texture=!0,this._dirty.material=!0,this._dirty.shader=!0},setGeoDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this.invalidateVolume()},getShaderProperties:function(e){return(null==this._shaderProperties||1==this._dirty.shader||void 0!==this._webgl&&this._webgl.dirtyLighting!=x3dom.Utils.checkDirtyLighting(e)||1==x3dom.Utils.checkDirtyEnvironment(e,this._shaderProperties))&&(this._shaderProperties=x3dom.Utils.generateProperties(e,this),this._dirty.shader=!1,void 0!==this._webgl&&(this._webgl.dirtyLighting=x3dom.Utils.checkDirtyLighting(e))),this._shaderProperties},getTextures:function(){var e=[],t=this._cf.appearance.node;if(t){var i=t._cf.texture.node;i&&(x3dom.isa(i,x3dom.nodeTypes.MultiTexture)?e=e.concat(i.getTextures()):e.push(i));var s=t._cf.shaders.nodes[0];s&&x3dom.isa(s,x3dom.nodeTypes.CommonSurfaceShader)&&(e=e.concat(s.getTextures()))}var o=this._cf.geometry.node;return o&&(x3dom.isa(o,x3dom.nodeTypes.ImageGeometry)?e=e.concat(o.getTextures()):x3dom.isa(o,x3dom.nodeTypes.Text)&&(e=e.concat(o))),e}})),x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,function(e){x3dom.nodeTypes.Shape.superClass.call(this,e)},{nodeChanged:function(){!this._cf.appearance.node,this._cf.geometry.node?this._objectID||(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):this._DEF&&x3dom.debug.logError("No geometry given in Shape/"+this._DEF),this.invalidateVolume()}})),x3dom.nodeTypes.Shape.shaderPartID=0,x3dom.nodeTypes.Shape.objectID=0,x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(e){for(var t in this.nodeID)if(this.nodeID.hasOwnProperty(t)){var i=this.nodeID[t];i._objectID&&e._objectID&&i._objectID===e._objectID&&(delete this.nodeID[t],x3dom.debug.logInfo("Unreg "+i._objectID))}}},x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DLightNode.superClass.call(this,e),e?e.doc._nodeBag.lights.push(this):x3dom.debug.logWarning("X3DLightNode: No runtime context found!"),this._lightID=0,this._dirty=!0,this.addField_SFFloat(e,"ambientIntensity",0),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"intensity",1),this.addField_SFBool(e,"global",!1),this.addField_SFBool(e,"on",!0),this.addField_SFFloat(e,"shadowIntensity",0),this.addField_SFInt32(e,"shadowMapSize",1024),this.addField_SFInt32(e,"shadowFilterSize",0),this.addField_SFFloat(e,"shadowOffset",0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1)},{getViewMatrix:function(e){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(this._dirty=!0)},parentRemoved:function(e){if(1===this._parentNodes.length&&this._parentNodes[0]==e)for(var t=this.findX3DDoc(),i=0,s=t._nodeBag.lights.length;i<s;i++)t._nodeBag.lights[i]===this&&t._nodeBag.lights.splice(i,1)},onRemove:function(){console.log("remove")}})),x3dom.nodeTypes.X3DLightNode.lightID=0,x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.DirectionalLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1)},{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,(-1)),t);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.PointLight.superClass.call(this,e),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this._vf.global=!0},{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixPnt(this._vf.location),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,(-1)),e);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.SpotLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this.addField_SFFloat(e,"beamWidth",1.5707963),this.addField_SFFloat(e,"cutOffAngle",1.5707963),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1),this._vf.global=!0},{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixPnt(this._vf.location),i=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),s=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,(-1)),i);return s.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,e),e?e.doc._nodeBag.followers.push(this):x3dom.debug.logWarning("X3DFollowerNode: No runtime context found!"),this.addField_SFBool(e,"isActive",!1),this._eps=x3dom.fields.Eps},{parentRemoved:function(e){if(0===this._parentNodes.length)for(var t=this.findX3DDoc(),i=0,s=t._nodeBag.followers.length;i<s;i++)t._nodeBag.followers[i]===this&&t._nodeBag.followers.splice(i,1)},tick:function(e){return!1},stepResponse:function(e){return e<=0?0:e>=this._vf.duration?1:this.stepResponseCore(e/this._vf.duration)},stepResponseCore:function(e){return.5-.5*Math.cos(e*Math.PI)}})),x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,e),this.addField_SFTime(e,"duration",1),this._initDone=!1,this._stepTime=0,this._currTime=0,this._bufferEndTime=0,this._numSupports=60})),x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,e),this.addField_SFTime(e,"tau",.3),this.addField_SFFloat(e,"tolerance",-1),this.addField_SFInt32(e,"order",3),this._eps=this._vf.tolerance<0?this._eps:this._vf.tolerance,this._lastTick=0})),x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ColorChaser.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFColor,this._previousValue=new x3dom.fields.SFColor(0,0,0),this._value=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var r=this._buffer.length-2;r>=0;r--)s=this._buffer[r].subtract(this._buffer[r+1]),o=s.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(i=Math.floor(o),o-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ColorDamper.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._value0=new x3dom.fields.SFColor(0,0,0),this._value1=new x3dom.fields.SFColor(0,0,0),this._value2=new x3dom.fields.SFColor(0,0,0),this._value3=new x3dom.fields.SFColor(0,0,0),this._value4=new x3dom.fields.SFColor(0,0,0),this._value5=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},distance:function(e,t){var i=e.subtract(t);return Math.sqrt(i.r*i.r+i.g*i.g+i.b*i.b)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFColor(this._value3.r,this._value3.g,this._value3.b),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);var s=this.distance(this._value1,this._value0);if(this._vf.order>1){var o=this.distance(this._value2,this._value1);o>s&&(s=o)}if(this._vf.order>2){var r=this.distance(this._value3,this._value2);r>s&&(s=r)}if(this._vf.order>3){var a=this.distance(this._value4,this._value3);a>s&&(s=a)}if(this._vf.order>4){var n=this.distance(this._value5,this._value4);n>s&&(s=n)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.OrientationChaser.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._numSupports=30,this._buffer=new x3dom.fields.MFRotation,this._previousValue=new x3dom.fields.Quaternion(0,1,0,0),this._value=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.Quaternion.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.Quaternion.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._previousValue=x3dom.fields.Quaternion.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.Quaternion.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.Quaternion.copy(this._previousValue),s=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]);i=i.slerp(i.multiply(s),this.stepResponse((this._buffer.length-1+t)*this._stepTime));for(var o=this._buffer.length-2;o>=0;o--)s=this._buffer[o+1].inverse().multiply(this._buffer[o]),i=i.slerp(i.multiply(s),this.stepResponse((o+t)*this._stepTime));return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(i=i.normalize(i),this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(i=Math.floor(o),o-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.Quaternion.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.Quaternion.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._vf.destination.slerp(this._buffer[i],s)}else for(this._previousValue=x3dom.fields.Quaternion.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.Quaternion.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.OrientationDamper.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._value0=new x3dom.fields.Quaternion(0,1,0,0),this._value1=new x3dom.fields.Quaternion(0,1,0,0),this._value2=new x3dom.fields.Quaternion(0,1,0,0),this._value3=new x3dom.fields.Quaternion(0,1,0,0),this._value4=new x3dom.fields.Quaternion(0,1,0,0),this._value5=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.slerp(this._value1,i):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w),this._value2=this._vf.order>1&&this._vf.tau?this._value1.slerp(this._value2,i):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w),this._value3=this._vf.order>2&&this._vf.tau?this._value2.slerp(this._value3,i):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w),this._value4=this._vf.order>3&&this._vf.tau?this._value3.slerp(this._value4,i):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w),this._value5=this._vf.order>4&&this._vf.tau?this._value4.slerp(this._value5,i):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);var s=Math.abs(this._value1.inverse().multiply(this._value0).angle());if(this._vf.order>1){var o=Math.abs(this._value2.inverse().multiply(this._value1).angle());o>s&&(s=o)}if(this._vf.order>2){var r=Math.abs(this._value3.inverse().multiply(this._value2).angle());r>s&&(s=r)}if(this._vf.order>3){var a=Math.abs(this._value4.inverse().multiply(this._value3).angle());a>s&&(s=a)}if(this._vf.order>4){var n=Math.abs(this._value5.inverse().multiply(this._value4).angle());n>s&&(s=n)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFVec3f,this._previousValue=new x3dom.fields.SFVec3f(0,0,0),this._value=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec3f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec3f.copy(this._previousValue),s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var r=this._buffer.length-2;r>=0;r--)s=this._buffer[r].subtract(this._buffer[r+1]),o=s.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(i=Math.floor(o),o-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec3f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=x3dom.fields.SFVec3f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._buffer=new x3dom.fields.MFVec2f,this._previousValue=new x3dom.fields.SFVec2f(0,0),this._value=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec2f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec2f.copy(this._previousValue),s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var r=this._buffer.length-2;r>=0;r--)s=this._buffer[r].subtract(this._buffer[r+1]),o=s.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(i=Math.floor(o),o-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec2f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=x3dom.fields.SFVec2f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._value0=new x3dom.fields.SFVec3f(0,0,0),this._value1=new x3dom.fields.SFVec3f(0,0,0),this._value2=new x3dom.fields.SFVec3f(0,0,0),this._value3=new x3dom.fields.SFVec3f(0,0,0),this._value4=new x3dom.fields.SFVec3f(0,0,0),this._value5=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);var s=this._value1.subtract(this._value0).length();if(this._vf.order>1){var o=this._value2.subtract(this._value1).length();o>s&&(s=o)}if(this._vf.order>2){var r=this._value3.subtract(this._value2).length();r>s&&(s=r)}if(this._vf.order>3){var a=this._value4.subtract(this._value3).length();a>s&&(s=a)}if(this._vf.order>4){var n=this._value5.subtract(this._value4).length();n>s&&(s=n)}return s<=this._eps?(this._value1.setValues(this._value0),
this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._value0=new x3dom.fields.SFVec2f(0,0),this._value1=new x3dom.fields.SFVec2f(0,0),this._value2=new x3dom.fields.SFVec2f(0,0),this._value3=new x3dom.fields.SFVec2f(0,0),this._value4=new x3dom.fields.SFVec2f(0,0),this._value5=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);var s=this._value1.subtract(this._value0).length();if(this._vf.order>1){var o=this._value2.subtract(this._value1).length();o>s&&(s=o)}if(this._vf.order>2){var r=this._value3.subtract(this._value2).length();r>s&&(s=r)}if(this._vf.order>3){var a=this._value4.subtract(this._value3).length();a>s&&(s=a)}if(this._vf.order>4){var n=this._value5.subtract(this._value4).length();n>s&&(s=n)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ScalarChaser.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._buffer=[],this._previousValue=0,this._value=0,this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue=this._vf.value;for(var t=1;t<this._buffer.length;t++)this._buffer[t]=this._vf.value;this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=Math.abs(this._buffer[0]-this._buffer[1])>this._eps;this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,s=this._buffer[this._buffer.length-1]-this._previousValue,o=s*this.stepResponse((this._buffer.length-1+t)*this._stepTime);i+=o;for(var r=this._buffer.length-2;r>=0;r--)s=this._buffer[r]-this._buffer[r+1],o=s*this.stepResponse((r+t)*this._stepTime),i+=o;return Math.abs(i-this._value)>this._eps?(this._value=i,this.postMessage("value",this._value)):this.postMessage("isActive",!1),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(i=Math.floor(o),o-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i]*s+this._vf.destination*(1-s)}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ScalarDamper.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._value0=0,this._value1=0,this._value2=0,this._value3=0,this._value4=0,this._value5=0,this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?Math.abs(this._value0-this._vf.destination)>this._eps&&(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1=this._vf.value,this._value2=this._vf.value,this._value3=this._vf.value,this._value4=this._vf.value,this._value5=this._vf.value,this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination,this._value1=this._vf.initialValue,this._value2=this._vf.initialValue,this._value3=this._vf.initialValue,this._value4=this._vf.initialValue,this._value5=this._vf.initialValue,this._lastTick=0;var e=Math.abs(this._value0-this._value1)>this._eps;this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0+i*(this._value1-this._value0):this._value0,this._value2=this._vf.order>1&&this._vf.tau?this._value1+i*(this._value2-this._value1):this._value1,this._value3=this._vf.order>2&&this._vf.tau?this._value2+i*(this._value3-this._value2):this._value2,this._value4=this._vf.order>3&&this._vf.tau?this._value3+i*(this._value4-this._value3):this._value3,this._value5=this._vf.order>4&&this._vf.tau?this._value4+i*(this._value5-this._value4):this._value4;var s=Math.abs(this._value1-this._value0);if(this._vf.order>1){var o=Math.abs(this._value2-this._value1);o>s&&(s=o)}if(this._vf.order>2){var r=Math.abs(this._value3-this._value2);r>s&&(s=r)}if(this._vf.order>3){var a=Math.abs(this._value4-this._value3);a>s&&(s=a)}if(this._vf.order>4){var n=Math.abs(this._value5-this._value4);n>s&&(s=n)}return s<=this._eps?(this._value1=this._value0,this._value2=this._value0,this._value3=this._value0,this._value4=this._value0,this._value5=this._value0,this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,e),this.addField_MFVec3f(e,"initialDestination",[]),this.addField_MFVec3f(e,"initialValue",[]),this.addField_MFVec3f(e,"value",[]),this.addField_MFVec3f(e,"destination",[]),x3dom.debug.logWarning("CoordinateDamper NYI")})),x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,e),this.addField_MFVec2f(e,"initialDestination",[]),this.addField_MFVec2f(e,"initialValue",[]),this.addField_MFVec2f(e,"value",[]),this.addField_MFVec2f(e,"destination",[]),x3dom.debug.logWarning("TexCoordDamper2D NYI")})),x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,e),this.addField_MFFloat(e,"key",[]),this.addField_SFFloat(e,"set_fraction",0)},{linearInterp:function(e,t){if(e<=this._vf.key[0])return this._vf.keyValue[0];if(e>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.key.length-1];for(var i=0;i<this._vf.key.length-1;++i)if(this._vf.key[i]<e&&e<=this._vf.key[i+1])return t(this._vf.keyValue[i],this._vf.keyValue[i+1],(e-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]));return this._vf.keyValue[0]}})),x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,e),this.addField_MFRotation(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.slerp(t,i)});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.NormalInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i)).normalize()});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,e),this.addField_MFColor(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,e),this.addField_MFFloat(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return(1-i)*e+i*t});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){if(x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),e&&e.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];for(var t=x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")),i=this._vf.key.length>0?this._vf.key.length:1,s=t.length/i,o=0;o<i;o++){for(var r=new x3dom.fields.MFVec3f,a=0;a<s;a++)r.push(t[o*s+a]);this._vf.keyValue.push(r)}}},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){for(var s=new x3dom.fields.MFVec3f,o=0;o<e.length;o++)s.push(e[o].multiply(1-i).add(t[o].multiply(i)));return s});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("SplinePositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.SplinePositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),this.addField_MFVec3f(e,"keyVelocity",[]),this.addField_SFBool(e,"closed",!1),this.addField_SFBool(e,"normalizeVelocity",!1),this.dtot=0,this.T0=[],this.T1=[],this.checkSanity=function(){var e=this._vf.key.length==this._vf.keyValue.length&&(this._vf.key.length==this._vf.keyVelocity.length||2==this._vf.keyVelocity.length&&this._vf.key.length>=2||0==this._vf.keyVelocity.length);e||x3dom.debug.logWarning("SplinePositionInterpolator Node: 'key' , 'keyValue' and/or 'keyVelocity' fields have inappropriate sizes")},this.calcDtot=function(){this.dtot=0;for(var e=0;e<this._vf.key.length-1;e++)this.dtot+=Math.abs(this._vf.key[e]-this._vf.key[e+1])},this.calcAdjustedKeyVelocity=function(){var e,t,i,s,o=this._vf.key.length;if(this._vf.keyVelocity.length==o)for(e=0;e<o;e++)t=this._vf.keyVelocity[e],this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==o-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=0==e||e==o-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s);else if(2==this._vf.keyVelocity.length&&o>2)for(e=0;e<o;e++)t=0==e?this._vf.keyVelocity[0]:e==o-1?this._vf.keyVelocity[1]:this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==o-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=0==e||e==o-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s);else{var r=this._vf.closed&&this._vf.keyValue[0].equals(this._vf.keyValue[o-1],1e-5);for(e=0;e<o;e++)0!=e&&e!=o-1||r?(0!=e&&e!=o-1||!r?(t=this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),i=2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1])):(t=this._vf.keyValue[1].subtract(this._vf.keyValue[o-2]).multiply(.5),0==e?(i=2*(this._vf.key[0]-this._vf.key[o-2])/(this._vf.key[1]-this._vf.key[o-2]),s=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[1]-this._vf.key[o-2])):(i=2*(this._vf.key[o-1]-this._vf.key[o-2])/(this._vf.key[1]-this._vf.key[o-2]),s=2*(this._vf.key[1]-this._vf.key[o-1])/(this._vf.key[1]-this._vf.key[o-2])),i=2*(this._vf.key[o-1]-this._vf.key[o-2])/(this._vf.key[o-2]-this._vf.key[1]),s=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[o-2]-this._vf.key[1])),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s)):(this.T0[e]=new x3dom.fields.SFVec3f(0,0,0),this.T1[e]=new x3dom.fields.SFVec3f(0,0,0))}},this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity()},{fieldChanged:function(e){switch(e){case"key":case"keyValue":case"keyVelocity":this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity();break;case"closed":case"normalizeVelocity":this.calcAdjustedKeyVelocity();break;case"set_fraction":var t;this._vf.key.length>0&&(this._vf.set_fraction<=this._vf.key[0]?t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[0]):this._vf.set_fraction>=this._vf.key[this._vf.key.length-1]&&(t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[this._vf.key.length-1])));for(var i=0;i<this._vf.key.length-1;i++)if(this._vf.key[i]<this._vf.set_fraction&&this._vf.set_fraction<=this._vf.key[i+1]){var s=(this._vf.set_fraction-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]),o=new x3dom.fields.SFVec4f(2*s*s*s-3*s*s+1,-2*s*s*s+3*s*s,s*s*s-2*s*s+s,s*s*s-s*s);t=new x3dom.fields.SFVec3f(o.x*this._vf.keyValue[i].x+o.y*this._vf.keyValue[i+1].x+o.z*this.T0[i].x+o.w*this.T1[i+1].x,o.x*this._vf.keyValue[i].y+o.y*this._vf.keyValue[i+1].y+o.z*this.T0[i].y+o.w*this.T1[i+1].y,o.x*this._vf.keyValue[i].z+o.y*this._vf.keyValue[i+1].z+o.z*this.T0[i].z+o.w*this.T1[i+1].z);break}void 0!==t?this.postMessage("value_changed",t):x3dom.debug.logWarning("SplinePositionInterpolator Node: value_changed is undefined!")}}})),x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,function(e){x3dom.nodeTypes.TimeSensor.superClass.call(this,e),e?e.doc._nodeBag.timer.push(this):x3dom.debug.logWarning("TimeSensor: No runtime context found!"),this.addField_SFTime(e,"cycleInterval",1),this.addField_SFBool(e,"loop",!1),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0),this.addField_SFTime(e,"pauseTime",0),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"cycleTime",0),this.addField_SFTime(e,"elapsedTime",0),this.addField_SFFloat(e,"fraction_changed",0),this.addField_SFBool(e,"isActive",!1),this.addField_SFBool(e,"isPaused",!1),this.addField_SFTime(e,"time",0),this.addField_SFBool(e,"first",!0),this.addField_SFFloat(e,"firstCycle",0),this._prevCycle=-1,this._lastTime=0,this._cycleStopTime=0,this._activatedTime=0,this._vf.startTime>0&&this._updateCycleStopTime(),this._backupStartTime=this._vf.startTime,this._backupStopTime=this._vf.stopTime,this._backupCycleInterval=this._vf.cycleInterval},{tick:function(e){if(!this._vf.enabled)return this._lastTime=e,!1;var t=this._vf.cycleInterval>0&&e>=this._vf.startTime&&(e<this._vf.stopTime||this._vf.stopTime<=this._vf.startTime)&&(1==this._vf.loop||0==this._vf.loop&&e<this._cycleStopTime);if(t&&!this._vf.isActive&&(this.postMessage("isActive",!0),this._activatedTime=e),t||this._vf.isActive){this.postMessage("elapsedTime",e-this._activatedTime);var i=e>=this._vf.pauseTime&&this._vf.pauseTime>this._vf.resumeTime;if(i&&!this._vf.isPaused?(this.postMessage("isPaused",!0),this.postMessage("pauseTime",e)):!i&&this._vf.isPaused&&(this.postMessage("isPaused",!1),this.postMessage("resumeTime",e)),!i){var s=this._getCycleAt(e),o=Math.floor(s),r=this._vf.startTime+o*this._vf.cycleInterval,a=0;this._vf.stopTime>this._vf.startTime&&this._lastTime<this._vf.stopTime&&e>=this._vf.stopTime?a=this._vf.stopTime:this._lastTime<r&&e>=r&&(a=r),a>0&&(e=a,s=this._getCycleAt(e),o=Math.floor(s));var n=s-o;n<x3dom.fields.Eps&&(n=this._lastTime<this._vf.startTime?0:1,this.postMessage("cycleTime",e)),this.postMessage("fraction_changed",n),this.postMessage("time",e)}}return!t&&this._vf.isActive&&this.postMessage("isActive",!1),this._lastTime=e,!0},fieldChanged:function(e){if("enabled"==e)!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1);else if("startTime"==e){if(this._vf.isActive)return void(this._vf.startTime=this._backupStartTime);this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()}else if("stopTime"==e){if(this._vf.isActive&&this._vf.stopTime<=this._vf.startTime)return void(this._vf.stopTime=this._backupStopTime);this._backupStopTime=this._vf.stopTime}else if("cycleInterval"==e){if(this._vf.isActive)return void(this._vf.cycleInterval=this._backupCycleInterval);this._backupCycleInterval=this._vf.cycleInterval}else"loop"==e&&this._updateCycleStopTime()},parentRemoved:function(e){if(0===this._parentNodes.length)for(var t=this.findX3DDoc(),i=0,s=t._nodeBag.timer.length;i<s;i++)t._nodeBag.timer[i]===this&&t._nodeBag.timer.splice(i,1)},_getCycleAt:function(e){return Math.max(0,e-this._vf.startTime)/this._vf.cycleInterval},_updateCycleStopTime:function(){if(0==this._vf.loop){var e=(new Date).getTime()/1e3,t=Math.floor(this._getCycleAt(e))+1;this._cycleStopTime=this._vf.startTime+t*this._vf.cycleInterval}else this._cycleStopTime=0}})),x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,e),this.addField_SFBool(e,"loop",!1)})),x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Anchor.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_MFString(e,"parameter",[]),this.addField_SFString(e,"description","")},{doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},handleTouch:function(){var e=this._vf.url.length?this._vf.url[0]:"",t=e.search("#"),i="";t>=0&&(i=e.slice(t+1));var s=this._vf.parameter.length?this._vf.parameter[0]:"",o=s.search("target="),r="";o>=0&&(r=s.slice(o+7)),x3dom.debug.logInfo("Anchor url="+e+", target="+r+", #viewpoint="+i),0!=r.length||"_self"!=r?window.open(this._nameSpace.getURL(e),r):window.location=this._nameSpace.getURL(e)}})),x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Inline.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"load",!0),this.addField_MFString(e,"nameSpaceName",[]),this.addField_SFBool(e,"mapDEFToID",!1),this.initDone=!1,this.count=0,this.numRetries=x3dom.nodeTypes.Inline.MaximumRetries},{fieldChanged:function(e){if("url"==e){for(var t=0;t<this._childNodes.length;t++)this.removeChild(this._childNodes[t]);if(0!=this._vf.nameSpaceName.length){var i=this._xmlNode;if(i&&i.hasChildNodes())for(;i.childNodes.length>=1;)i.removeChild(i.firstChild)}this.loadInline()}else"render"==e&&this.invalidateVolume()},nodeChanged:function(){this.initDone||(this.initDone=!0,this.loadInline())},fireEvents:function(e){if(this._xmlNode&&(this._xmlNode["on"+e]||this._xmlNode.hasAttribute("on"+e)||this._listeners[e])){var t={target:this._xmlNode,type:e,error:"error"==e?"XMLHttpRequest Error":"",cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};try{var i=this._xmlNode["on"+e];if("function"==typeof i)i.call(this._xmlNode,t);else{var s=this._xmlNode.getAttribute("on"+e),o=new Function("event",s);o.call(this._xmlNode,t)}var r=this._listeners[e];if(r)for(var a=0;a<r.length;a++)r[a].call(this._xmlNode,t)}catch(n){x3dom.debug.logException(n)}}},loadInline:function(){var e=this,t=new window.XMLHttpRequest;if(t.overrideMimeType&&t.overrideMimeType("text/xml"),t.onreadystatechange=function(){if(4!=t.readyState)return t;if(t.status===x3dom.nodeTypes.Inline.AwaitTranscoding){if(e.count<e.numRetries){e.count++;var i=+t.getResponseHeader("Refresh")||5;return x3dom.debug.logInfo("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): Next request in "+i+" seconds"),window.setTimeout(function(){e._nameSpace.doc.downloadCount-=1,e.loadInline()},1e3*i),t}return x3dom.debug.logError("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): No Retries left"),e._nameSpace.doc.downloadCount-=1,e.count=0,t}if(200!==t.status&&0!==t.status)return e.fireEvents("error"),x3dom.debug.logError("XHR status: "+t.status+" - XMLHttpRequest requires web server running!"),e._nameSpace.doc.downloadCount-=1,e.count=0,t;200!=t.status&&0!=t.status||(e.count=0),x3dom.debug.logInfo("Inline: downloading "+e._vf.url[0]+" done.");var s=null,o=null,r=null,a=null;if(a="Microsoft Internet Explorer"!=navigator.appName?t.responseXML:(new DOMParser).parseFromString(t.responseText,"text/xml"),void 0!==a&&null!==a?s=a.getElementsByTagName("Scene")[0]||a.getElementsByTagName("scene")[0]:e.fireEvents("error"),s){var n=0!=e._vf.nameSpaceName.length?e._vf.nameSpaceName.toString().replace(" ",""):"";r=new x3dom.NodeNameSpace(n,e._nameSpace.doc);var d=e._vf.url.length?e._vf.url[0]:"";"/"===d[0]||d.indexOf(":")>=0?r.setBaseURL(d):r.setBaseURL(e._nameSpace.baseURL+d),o=r.setupTree(s),e._nameSpace.addSpace(r),0!=e._vf.nameSpaceName.length&&Array.forEach(s.childNodes,function(t){t instanceof Element&&(setNamespace(e._vf.nameSpaceName,t,e._vf.mapDEFToID),e._xmlNode.appendChild(t))})}else a&&a.localName?x3dom.debug.logError("No Scene in "+a.localName):x3dom.debug.logError("No Scene in resource");var l=x3dom.getGlobal();for(e._childNodes.length>0&&e._childNodes[0]&&e._childNodes[0]._nameSpace&&e._nameSpace.removeSpace(e._childNodes[0]._nameSpace);0!==e._childNodes.length;)l._remover=e.removeChild(e._childNodes[0]);if(delete l._remover,o){e.addChild(o),e.invalidateVolume(),e._nameSpace.doc.downloadCount-=1,e._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+e._vf.url[0]+" to scene.");var h=e._nameSpace.doc._scene;h&&(h.invalidateVolume(),window.setTimeout(function(){e.invalidateVolume(),h.updateVolume(),e._nameSpace.doc.needRender=!0},1e3)),e.fireEvents("load")}return o=null,r=null,s=null,a=null,t},this._vf.url.length&&this._vf.url[0].length){var i=this._nameSpace.getURL(this._vf.url[0]);t.open("GET",i,!0),this._nameSpace.doc.downloadCount+=1;try{t.send(null)}catch(s){this.fireEvents("error"),x3dom.debug.logError(this._vf.url[0]+": "+s)}}}})),x3dom.nodeTypes.Inline.AwaitTranscoding=202,x3dom.nodeTypes.Inline.MaximumRetries=15,x3dom.registerNodeType("MultiPart","Networking",defineClass(x3dom.nodeTypes.Inline,function(e){x3dom.nodeTypes.MultiPart.superClass.call(this,e),this.addField_MFString(e,"urlIDMap",[]),this.addField_SFBool(e,"isPickable",!0),this.addField_SFString(e,"sortType","auto"),this.addField_SFBool(e,"solid",!1),this.addField_SFInt32(e,"sortKey",0),this.addField_SFString(e,"initialVisibility","auto"),this._idMap=null,this._inlineNamespace=null,this._highlightedParts=[],this._minId=0,this._maxId=0,this._lastId=-1,this._lastClickedId=-1,this._lastButton=0,this._identifierToPartId=[],this._identifierToAppId=[],this._visiblePartsPerShape=[],this._partVolume=[],this._partVisibility=[],this._originalColor=[],this._materials=[]},{fieldChanged:function(e){if("url"==e){if(0!=this._vf.nameSpaceName.length){var t=this._xmlNode;if(t&&t.hasChildNodes())for(;t.childNodes.length>=1;)t.removeChild(t.firstChild)}this.loadInline()}else"render"==e&&this.invalidateVolume()},nodeChanged:function(){this.initDone||(this.initDone=!0,this.loadIDMap())},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var t=0;t<this._partVisibility.length;t++)if(this._partVisibility[t]){var i=this._partVolume[t];i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},handleEvents:function(e){if(this._inlineNamespace){var t=this._inlineNamespace.defMap.MultiMaterial_ColorMap,i=this._inlineNamespace.defMap.MultiMaterial_EmissiveMap,s=this._inlineNamespace.defMap.MultiMaterial_SpecularMap,o=this._inlineNamespace.defMap.MultiMaterial_VisibilityMap;e.pickedId==-1&&0!=e.button?(this._lastClickedId=-1,this._lastButton=e.button):e.pickedId==-1&&0==e.button&&(this._lastClickedId=-1,this._lastButton=0),e.pickedId!=-1?(e.part=new x3dom.Parts(this,[e.pickedId-this._minId],t,i,s,o),e.partID=this._idMap.mapping[e.pickedId-this._minId].name,e.type="mousemove",this.callEvtHandler("onmousemove",e),e.type="mouseover",this.callEvtHandler("onmouseover",e),!e.mouseup&&e.button&&e.button!=this._lastButton&&(e.type="mousedown",this._lastButton=e.button,this._lastClickedId==-1&&(this._lastClickedId=e.pickedId),this.callEvtHandler("onmousedown",e)),(e.mouseup||0!=this._lastButton&&0==e.button)&&(e.type="mouseup",this.callEvtHandler("onmouseup",e),this._lastButton=0,e.pickedId==this._lastClickedId&&(this._lastClickedId=-1,e.type="click",this.callEvtHandler("onclick",e)),this._lastClickedId=-1),e.pickedId!=this._lastId&&(this._lastId!=-1&&(e.part=new x3dom.Parts(this,[this._lastId-this._minId],t,i,s,o),e.partID=this._idMap.mapping[this._lastId-this._minId].name,e.type="mouseleave",this.callEvtHandler("onmouseleave",e)),e.part=new x3dom.Parts(this,[e.pickedId-this._minId],t,i,s,o),e.partID=this._idMap.mapping[e.pickedId-this._minId].name,e.type="mouseenter",this.callEvtHandler("onmouseenter",e),this._lastId=e.pickedId),this._lastId=e.pickedId):this._lastId!=-1&&(e.part=new x3dom.Parts(this,[this._lastId-this._minId],t,i,s,o),e.partID=this._idMap.mapping[this._lastId-this._minId].name,e.type="mouseout",this.callEvtHandler("onmouseout",e),e.type="mouseleave",this.callEvtHandler("onmouseleave",e),this._lastId=-1)}},loadIDMap:function(){if(this._vf.urlIDMap.length&&this._vf.urlIDMap[0].length){var e,t=this,i=this._nameSpace.getURL(this._vf.urlIDMap[0]),s=new XMLHttpRequest;s.open("GET",i,!0),s.onload=function(){for(t._idMap=JSON.parse(this.responseText),null==t._nameSpace.doc._scene._multiPartMap&&(t._nameSpace.doc._scene._multiPartMap={numberOfIds:0,multiParts:[]}),t._minId=t._nameSpace.doc._scene._multiPartMap.numberOfIds,t._maxId=t._minId+t._idMap.numberOfIDs-1,t._nameSpace.doc._scene._multiPartMap.numberOfIds+=t._idMap.numberOfIDs,t._nameSpace.doc._scene._multiPartMap.multiParts.push(t),e=0;e<t._idMap.mapping.length;e++)if(t._identifierToPartId[t._idMap.mapping[e].name]||(t._identifierToPartId[t._idMap.mapping[e].name]=[]),t._identifierToPartId[t._idMap.mapping[e].appearance]||(t._identifierToPartId[t._idMap.mapping[e].appearance]=[]),t._identifierToPartId[t._idMap.mapping[e].name].push(e),t._identifierToPartId[t._idMap.mapping[e].appearance].push(e),!t._partVolume[e]){var i=x3dom.fields.SFVec3f.parse(t._idMap.mapping[e].min),s=x3dom.fields.SFVec3f.parse(t._idMap.mapping[e].max);t._partVolume[e]=new x3dom.fields.BoxVolume(i,s)}for(e=0;e<t._idMap.appearance.length;e++)t._identifierToAppId[t._idMap.appearance[e].name]=e;t.loadInline()},s.send(null)}},createMaterialData:function(){var e,t,i,s,o,r,a,n,d,l,h,u,f="",c="",_="",m="",p="",x="",g=Math.ceil(Math.sqrt(this._idMap.numberOfIDs));g=x3dom.Utils.nextHighestPowerOfTwo(g);for(var v=2*g,y=g+" "+v+" 4",b=g+" "+v+" 4",T=g+" "+v+" 4",S=0;S<g*g;S++)if(S<this._idMap.mapping.length){var M=this._idMap.mapping[S].appearance,C=this._identifierToAppId[M];r=this._idMap.appearance[C].material.ambientIntensity?this._idMap.appearance[C].material.ambientIntensity:"0.2",u=this._idMap.appearance[C].material.backAmbientIntensity?this._idMap.appearance[C].material.backAmbientIntensity:r,e=this._idMap.appearance[C].material.diffuseColor?this._idMap.appearance[C].material.diffuseColor:"0.8 0.8 0.8",a=this._idMap.appearance[C].material.backDiffuseColor?this._idMap.appearance[C].material.backDiffuseColor:e,o=this._idMap.appearance[C].material.emissiveColor?this._idMap.appearance[C].material.emissiveColor:"0.0 0.0 0.0",h=this._idMap.appearance[C].material.backEmissiveColor?this._idMap.appearance[C].material.backEmissiveColor:o,s=this._idMap.appearance[C].material.shininess?this._idMap.appearance[C].material.shininess:"0.2",l=this._idMap.appearance[C].material.backShininess?this._idMap.appearance[C].material.backShininess:s,i=this._idMap.appearance[C].material.specularColor?this._idMap.appearance[C].material.specularColor:"0 0 0",d=this._idMap.appearance[C].material.backSpecularColor?this._idMap.appearance[C].material.backSpecularColor:i,t=this._idMap.appearance[C].material.transparency?this._idMap.appearance[C].material.transparency:0,n=this._idMap.appearance[C].material.backTransparency?this._idMap.appearance[C].material.backTransparency:t,f+=" "+x3dom.fields.SFColorRGBA.parse(e+" "+(1-t)).toUint(),c+=" "+x3dom.fields.SFColorRGBA.parse(i+" "+s).toUint(),_+=" "+x3dom.fields.SFColorRGBA.parse(o+" "+r).toUint(),m+=" "+x3dom.fields.SFColorRGBA.parse(a+" "+(1-n)).toUint(),
p+=" "+x3dom.fields.SFColorRGBA.parse(d+" "+l).toUint(),x+=" "+x3dom.fields.SFColorRGBA.parse(h+" "+u).toUint(),this._originalColor[S]=f,this._materials[S]=new x3dom.MultiMaterial({ambientIntensity:r,diffuseColor:x3dom.fields.SFColor.parse(e),emissiveColor:x3dom.fields.SFColor.parse(o),shininess:s,specularColor:x3dom.fields.SFColor.parse(i),transparency:t,backAmbientIntensity:u,backDiffuseColor:x3dom.fields.SFColor.parse(a),backEmissiveColor:x3dom.fields.SFColor.parse(h),backShininess:l,backSpecularColor:x3dom.fields.SFColor.parse(d),backTransparency:n})}else f+=" 255",c+=" 255",_+=" 255",m+=" 255",p+=" 255",x+=" 255";return y+=f+m,b+=c+p,T+=_+x,{diffuseTransparency:y,specularShininess:b,emissiveAmbientIntensity:T}},createVisibilityData:function(){var e,t,i=Math.ceil(Math.sqrt(this._idMap.numberOfIDs));i=x3dom.Utils.nextHighestPowerOfTwo(i);var s=i+" "+i+" 1";for(e=0;e<i*i;e++)if(e<this._idMap.mapping.length){if("auto"==this._vf.initialVisibility)for(s+=" 255",this._partVisibility[e]||(this._partVisibility[e]=!0),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].val++,this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++;else if("visible"==this._vf.initialVisibility)for(s+=" 255",this._partVisibility[e]||(this._partVisibility[e]=!0),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].val++,this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++;else if("invisible"==this._vf.initialVisibility)for(s+=" 0",this._partVisibility[e]||(this._partVisibility[e]=!1),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++}else s+=" 0";return s},replaceMaterials:function(e){var t,i,s,o,r,a=!0;if(e&&e.hasChildNodes()){s=this.createMaterialData(),o=this.createVisibilityData();for(var n=e.getElementsByTagName("Shape"),d=0;d<n.length;d++){i=n[d].getAttribute("DEF")||n[d].getAttribute("def"),i&&this._visiblePartsPerShape[i]&&0==this._visiblePartsPerShape[i].val&&n[d].setAttribute("render","false"),n[d].setAttribute("idOffset",this._minId),n[d].setAttribute("isPickable",this._vf.isPickable);var l=n[d].getElementsByTagName("BinaryGeometry");if(l&&l.length)for(var h=0;h<l.length;h++)l[h].setAttribute("solid",this._vf.solid);var u=n[d].getElementsByTagName("Appearance");if(u.length)for(var f=0;f<u.length;f++){u[f].removeAttribute("DEF"),u[f].removeAttribute("USE"),u[f].setAttribute("sortType",this._vf.sortType),u[f].setAttribute("sortKey",this._vf.sortKey);var c=u[f].getElementsByTagName("Material");if(c.length){if(a){a=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var _=document.createElement("PixelTexture");_.setAttribute("containerField","multiDiffuseAlphaTexture"),_.setAttribute("id","MultiMaterial_ColorMap"),_.setAttribute("image",s.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",s.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",s.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",o),t.appendChild(_),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");u[f].replaceChild(t,c[0])}else{if(a){a=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var _=document.createElement("PixelTexture");_.setAttribute("containerField","multiDiffuseAlphaTexture"),_.setAttribute("id","MultiMaterial_ColorMap"),_.setAttribute("image",s.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",s.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",s.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",o),t.appendChild(_),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");u[f].appendChild(t)}}else{if(r=document.createElement("Appearance"),a){a=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var _=document.createElement("PixelTexture");_.setAttribute("containerField","multiDiffuseAlphaTexture"),_.setAttribute("id","MultiMaterial_ColorMap"),_.setAttribute("image",s.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",s.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",s.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",o),t.appendChild(_),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");r.appendChild(t),l[h].appendChild(r)}}}},appendAPI:function(){var e=this;this._xmlNode.getIdList=function(){var t,i=[];for(t=0;t<e._idMap.mapping.length;t++)i.push(e._idMap.mapping[t].name);return i},this._xmlNode.getAppearanceIdList=function(){var t,i=[];for(t=0;t<e._idMap.appearance.length;t++)i.push(e._idMap.appearance[t].name);return i},this._xmlNode.getParts=function(t){var i,s,o=[];if(void 0==t)for(s=0;s<e._idMap.mapping.length;s++)o.push(s);else if(t instanceof Array)for(i=0;i<t.length;i++)e._identifierToPartId[t[i]]&&(o=o.concat(e._identifierToPartId[t[i]]));else if(t instanceof RegExp)for(var r in e._identifierToPartId)r.match(t)&&(o=o.concat(e._identifierToPartId[r]));var a=e._inlineNamespace.defMap.MultiMaterial_ColorMap,n=e._inlineNamespace.defMap.MultiMaterial_EmissiveMap,d=e._inlineNamespace.defMap.MultiMaterial_SpecularMap,l=e._inlineNamespace.defMap.MultiMaterial_VisibilityMap;return 0==o.length?null:new x3dom.Parts(e,o,a,n,d,l)}},loadInline:function(){var e=this,t=new window.XMLHttpRequest;if(t.overrideMimeType&&t.overrideMimeType("text/xml"),t.onreadystatechange=function(){if(4!=t.readyState)return t;if(t.status===x3dom.nodeTypes.Inline.AwaitTranscoding){if(e.count<e.numRetries){e.count++;var i=+t.getResponseHeader("Refresh")||5;return x3dom.debug.logInfo("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): Next request in "+i+" seconds"),window.setTimeout(function(){e._nameSpace.doc.downloadCount-=1,e.loadInline()},1e3*i),t}return x3dom.debug.logError("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): No Retries left"),e._nameSpace.doc.downloadCount-=1,e.count=0,t}if(200!==t.status&&0!==t.status)return e.fireEvents("error"),x3dom.debug.logError("XHR status: "+t.status+" - XMLHttpRequest requires web server running!"),e._nameSpace.doc.downloadCount-=1,e.count=0,t;200!=t.status&&0!=t.status||(e.count=0),x3dom.debug.logInfo("Inline: downloading "+e._vf.url[0]+" done.");var s=null,o=null,r=null;if(r="Microsoft Internet Explorer"!=navigator.appName?t.responseXML:(new DOMParser).parseFromString(t.responseText,"text/xml"),void 0!==r&&null!==r?s=r.getElementsByTagName("Scene")[0]||r.getElementsByTagName("scene")[0]:e.fireEvents("error"),s){var a="ns"+e._nameSpace.childSpaces.length,n=0!=e._vf.nameSpaceName.length?e._vf.nameSpaceName.toString().replace(" ",""):a;e._inlineNamespace=new x3dom.NodeNameSpace(n,e._nameSpace.doc);var d=e._vf.url.length?e._vf.url[0]:"";"/"===d[0]||d.indexOf(":")>=0?e._inlineNamespace.setBaseURL(d):e._inlineNamespace.setBaseURL(e._nameSpace.baseURL+d),e.replaceMaterials(s),o=e._inlineNamespace.setupTree(s),e._nameSpace.addSpace(e._inlineNamespace),0!=e._vf.nameSpaceName.length&&Array.forEach(s.childNodes,function(t){t instanceof Element&&(setNamespace(e._vf.nameSpaceName,t,e._vf.mapDEFToID),e._xmlNode.appendChild(t))})}else r&&r.localName?x3dom.debug.logError("No Scene in "+r.localName):x3dom.debug.logError("No Scene in resource");var l=x3dom.getGlobal();for(e._childNodes.length>0&&e._childNodes[0]&&e._childNodes[0]._nameSpace&&e._nameSpace.removeSpace(e._childNodes[0]._nameSpace);0!==e._childNodes.length;)l._remover=e.removeChild(e._childNodes[0]);if(delete l._remover,o){e.addChild(o),e.invalidateVolume(),e._nameSpace.doc.downloadCount-=1,e._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+e._vf.url[0]+" to scene.");var h=e._nameSpace.doc._scene;h&&(h.invalidateVolume(),window.setTimeout(function(){e.invalidateVolume(),h.updateVolume(),e._nameSpace.doc.needRender=!0},1e3)),e.appendAPI(),e.fireEvents("load")}return o=null,s=null,r=null,t},this._vf.url.length&&this._vf.url[0].length){var i=this._nameSpace.getURL(this._vf.url[0]);t.open("GET",i,!0),this._nameSpace.doc.downloadCount+=1;try{t.send(null)}catch(s){this.fireEvents("error"),x3dom.debug.logError(this._vf.url[0]+": "+s)}}}})),x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,e);var t=e&&e.autoGen?1:0;this.addField_SFString(e,"crossOrigin",""),this.addField_MFColor(e,"groundColor",[]),this.addField_MFFloat(e,"groundAngle",[]),this.addField_MFColor(e,"skyColor",[new x3dom.fields.SFColor(0,0,0)]),this.addField_MFFloat(e,"skyAngle",[]),this.addField_SFFloat(e,"transparency",t),this._dirty=!0},{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}})),x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DFogNode.superClass.call(this,e),this.addField_SFColor(e,"color",1,1,1),this.addField_SFString(e,"fogType","LINEAR"),this.addField_SFFloat(e,"visibilityRange",0)},{})),x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,function(e){x3dom.nodeTypes.Fog.superClass.call(this,e)},{})),x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,function(e){x3dom.nodeTypes.Background.superClass.call(this,e),this.addField_MFString(e,"backUrl",[]),this.addField_MFString(e,"bottomUrl",[]),this.addField_MFString(e,"frontUrl",[]),this.addField_MFString(e,"leftUrl",[]),this.addField_MFString(e,"rightUrl",[]),this.addField_MFString(e,"topUrl",[])},{fieldChanged:function(e){e.indexOf("Url")>0||"transparency"==e||e.search("sky")>=0||e.search("ground")>=0?this._dirty=!0:e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}})),x3dom.registerNodeType("X3DEnvironmentNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DEnvironmentNode.superClass.call(this,e)})),x3dom.registerNodeType("Environment","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DEnvironmentNode,function(e){x3dom.nodeTypes.Environment.superClass.call(this,e),this.addField_SFBool(e,"sortTrans",!0),this.addField_SFBool(e,"shadowExcludeTransparentObjects",!1),this.addField_SFString(e,"gammaCorrectionDefault","linear"),this.addField_SFBool(e,"frustumCulling",!0),this.addField_SFBool(e,"smallFeatureCulling",!1),this.addField_SFFloat(e,"smallFeatureThreshold",1),this.addField_SFBool(e,"occlusionCulling",!1),this.addField_SFFloat(e,"occlusionVisibilityThreshold",0),this.addField_SFBool(e,"lowPriorityCulling",!1),this.addField_SFFloat(e,"lowPriorityThreshold",1),this.addField_SFBool(e,"tessellationDetailCulling",!1),this.addField_SFFloat(e,"tessellationErrorThreshold",0),this.addField_SFBool(e,"enableARC",!1),this.addField_SFFloat(e,"minFrameRate",1),this.addField_SFFloat(e,"maxFrameRate",62.5),this.addField_SFFloat(e,"userDataFactor",-1),this.addField_SFFloat(e,"smallFeatureFactor",-1),this.addField_SFFloat(e,"occlusionVisibilityFactor",-1),this.addField_SFFloat(e,"lowPriorityFactor",-1),this.addField_SFFloat(e,"tessellationErrorFactor",-1),this.addField_SFBool(e,"SSAO",!1),this.addField_SFFloat(e,"SSAOradius",.7),this.addField_SFFloat(e,"SSAOamount",.3),this.addField_SFInt32(e,"SSAOrandomTextureSize",4),this.addField_SFInt32(e,"SSAOblurDepthTreshold",1),this._validGammaCorrectionTypes=["none","fastlinear","linear"],this.checkSanity()},{checkSanity:function(){var e=function(e,t,i,s){return e&&t==s?i:e||t==s?t:s};this._smallFeatureThreshold=e(this._vf.smallFeatureCulling,this._vf.smallFeatureThreshold,10,0),this._lowPriorityThreshold=e(this._vf.lowPriorityCulling,this._vf.lowPriorityThreshold,.5,1),this._occlusionVisibilityThreshold=e(this._vf.occlusionCulling,this._vf.occlusionVisibilityThreshold,1,0),this._tessellationErrorThreshold=e(this._vf.tessellationDetailCulling,this._vf.tessellationErrorThreshold,1,0);var t=function(e,t){return e=e.toLowerCase(),t._validGammaCorrectionTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" gammaCorrectionDefault may only be linear (default), fastLinear, or none"),t._validGammaCorrectionTypes[0])};this._vf.gammaCorrectionDefault=t(this._vf.gammaCorrectionDefault,this)}})),x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){if(x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,e),e&&e.xmlNode){var t=e.xmlNode;t.resetView||t.getFieldOfView||t.getNear||t.getFar||(t.resetView=function(){var e=this._x3domNode;e.resetView(),e._nameSpace.doc.needRender=!0},t.getFieldOfView=function(){return this._x3domNode.getFieldOfView()},t.getNear=function(){return this._x3domNode.getNear()},t.getFar=function(){return this._x3domNode.getFar()})}},{activate:function(e){var t=this._nameSpace.doc._viewarea;e&&t.animateTo(this,e._autoGen?null:e),t._needNavigationMatrixUpdate=!0,x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,e)},deactivate:function(e){x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,e)},getTransformation:function(){return this.getCurrentTransform()},getCenterOfRotation:function(){return new x3dom.fields.SFVec3f(0,0,0)},setCenterOfRotation:function(e){this._vf.centerOfRotation.setValues(e)},getFieldOfView:function(){return 1.57079633},setView:function(e){var t=this.getCurrentTransform();this._viewMatrix=e.mult(t)},setViewAbsolute:function(e){this._viewMatrix=e},setProjectionMatrix:function(e){},resetView:function(){},getNear:function(){return.1},getFar:function(){return 1e4},getImgPlaneHeightAtDistOne:function(){return 2},getViewMatrix:function(){return null},getProjectionMatrix:function(e){return null}})),x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.Viewpoint.superClass.call(this,e),this.addField_SFFloat(e,"fieldOfView",.785398),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1),this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._projMatrix=null,this._lastAspect=1,this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)},{fieldChanged:function(e){"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},setProjectionMatrix:function(e){this._projMatrix=e},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(e){var t=this._vf.fieldOfView,i=this._vf.zFar,s=this._vf.zNear;if(s<=0||i<=0){var o=.8,r=1.2,a=this._nameSpace.doc._viewarea,n=a._scene,d=x3dom.fields.SFVec3f.copy(n._lastMin),l=x3dom.fields.SFVec3f.copy(n._lastMax),h=l.subtract(d),u=h.length()/2,f=a.getViewMatrix().inverse(),c=f.e3(),_=new x3dom.fields.SFVec3f(0,0,0),m=new x3dom.fields.SFVec3f(1,1,1),p=new x3dom.fields.Quaternion(0,0,1,0),x=new x3dom.fields.Quaternion(0,0,1,0);f.getTransform(_,p,m,x);var g=m.x,v=m.x;v<m.y&&(v=m.y),g>m.y&&(g=m.y),v<m.z&&(v=m.z),g>m.z&&(g=m.z),v>1?o/=v:g>x3dom.fields.Eps&&g<1&&(r/=g);var y=d.add(h.multiply(.5)),b=c.subtract(y).length();u?(s=b>u?(b-u)*o:0,i=(b+u)*r):(s=.1,i=1e5);var T=i/this._zRatio;s=Math.max(s,Math.max(x3dom.fields.Eps,T)),i>this._vf.zNear&&this._vf.zNear>0&&(s=this._vf.zNear),this._vf.zFar>s&&(i=this._vf.zFar),i<=s&&(i=s+1)}if(null==this._projMatrix)this._projMatrix=x3dom.fields.SFMatrix4f.perspective(t,e,s,i);else if(this._zNear!=s||this._zFar!=i){var S=s-i;this._projMatrix._22=(s+i)/S,this._projMatrix._23=2*s*i/S}else this._lastAspect!=e&&(this._projMatrix._00=1/Math.tan(t/2)/e,this._lastAspect=e);return this._zNear=s,this._zFar=i,this._projMatrix}})),x3dom.registerNodeType("OrthoViewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.OrthoViewpoint.superClass.call(this,e),this.addField_MFFloat(e,"fieldOfView",[-1,-1,1,1]),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",.1),this.addField_SFFloat(e,"zFar",1e4),this._viewMatrix=null,this._projMatrix=null,this._lastAspect=1,this.resetView()},{fieldChanged:function(e){"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this.resetView()):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getViewMatrix:function(){return this._viewMatrix},resetView:function(){var e=x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f((this._vf.fieldOfView[0]+this._vf.fieldOfView[2])/2,(this._vf.fieldOfView[1]+this._vf.fieldOfView[3])/2,0));this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()),this._viewMatrix=this._viewMatrix.mult(e).inverse(),this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._vf.zNear},getFar:function(){return this._vf.zFar},getProjectionMatrix:function(e){if(null==this._projMatrix||this._lastAspect!=e){var t=this.getNear(),i=this.getFar(),s=this._vf.fieldOfView[0],o=this._vf.fieldOfView[1],r=this._vf.fieldOfView[2],a=this._vf.fieldOfView[3];this._projMatrix=x3dom.fields.SFMatrix4f.ortho(s,r,o,a,t,i,e)}return this._lastAspect=e,this._projMatrix}})),x3dom.registerNodeType("Viewfrustum","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.Viewfrustum.superClass.call(this,e),this.addField_SFMatrix4f(e,"modelview",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.addField_SFMatrix4f(e,"projection",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._viewMatrix=this._vf.modelview.transpose().inverse(),this._projMatrix=this._vf.projection.transpose(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},{fieldChanged:function(e){"modelview"==e?this.resetView():"projection"==e?this._projMatrix=this._vf.projection.transpose():e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._centerOfRotation)},setCenterOfRotation:function(e){this._centerOfRotation.setValues(e)},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return 2*Math.atan(1/this._projMatrix._11)},getImgPlaneHeightAtDistOne:function(){return 2/this._projMatrix._11},resetView:function(){this._viewMatrix=this._vf.modelview.transpose().inverse(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},getProjectionMatrix:function(e){return this._projMatrix}})),x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,e)})),x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,function(e){x3dom.nodeTypes.NavigationInfo.superClass.call(this,e),this.addField_SFBool(e,"headlight",!0),this.addField_MFString(e,"type",["EXAMINE","ANY"]),this.addField_MFFloat(e,"typeParams",[-.4,60,.05,2.8]),this.addField_SFString(e,"explorationMode","all"),this.addField_MFFloat(e,"avatarSize",[.25,1.6,.75]),this.addField_SFFloat(e,"visibilityLimit",0),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"transitionTime",1),this.addField_MFString(e,"transitionType",["LINEAR"]),this._validTypes=["none","examine","turntable","fly","freefly","lookat","lookaround","walk","game","helicopter","any"],this._heliUpdated=!1;var t=this.checkType(this.getType());x3dom.debug.logInfo("NavType: "+t)},{fieldChanged:function(e){if("typeParams"==e)this._heliUpdated=!1;else if("type"==e){var t=this.checkType(this.getType());switch(t){case"game":this._nameSpace.doc._viewarea.initMouseState();break;case"helicopter":this._heliUpdated=!1;break;case"turntable":this._nameSpace.doc._viewarea.initMouseState(),this._nameSpace.doc._viewarea.initTurnTable(this)}this._vf.type[0]=t,x3dom.debug.logInfo("Switch to "+t+" mode.")}},setType:function(e,t){var i=this.checkType(e.toLowerCase()),s=this.checkType(this.getType());switch(i){case"game":s!==i&&(t?t.initMouseState():this._nameSpace.doc._viewarea.initMouseState());break;case"helicopter":s!==i&&(this._heliUpdated=!1);break;case"turntable":s!==i&&(t?(t.initMouseState(),t.initTurnTable(this)):(this._nameSpace.doc._viewarea.initMouseState(),this._nameSpace.doc._viewarea.initTurnTable(this)))}this._vf.type[0]=i,x3dom.debug.logInfo("Switch to "+i+" mode.")},getType:function(){var e=this._vf.type[0].toLowerCase();return e.length<=1?e="none":"any"==e&&(e="examine"),e},getTypeParams:function(){var e=this._vf.typeParams.length,t=e>=1?this._vf.typeParams[0]:-.4,i=e>=2?this._vf.typeParams[1]:60,s=e>=3?this._vf.typeParams[2]:x3dom.fields.Eps,o=e>=4?this._vf.typeParams[3]:Math.PI-x3dom.fields.Eps,r=[t,i,s,o];return e>=5&&r.push(this._vf.typeParams[4]),r},setTypeParams:function(e){for(var t=0;t<e.length;t++)this._vf.typeParams[t]=e[t]},checkType:function(e){return this._validTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" is no valid navigation type, use one of "+this._validTypes.toString()),"examine")},getExplorationMode:function(){switch(this._vf.explorationMode.toLowerCase()){case"all":return 7;case"rotate":return 1;case"zoom":return 2;case"pan":return 4;case"none":return 0;default:return 7}}})),x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Billboard.superClass.call(this,e),this.addField_SFVec3f(e,"axisOfRotation",0,1,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0),this._eyeLook=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),!(o<0)){i=!1;var a=this.getVolume(),n=x3dom.fields.SFVec3f.MAX(),d=x3dom.fields.SFVec3f.MIN();a.getBounds(n,d);var l=t.viewMatrix,h=new x3dom.fields.SFVec3f(0,0,0);h=l.inverse().multMatrixPnt(h);var u=l.mult(e);this._eye=e.inverse().multMatrixPnt(h),this._eyeViewUp=new x3dom.fields.SFVec3f(u._10,u._11,u._12),this._eyeLook=new x3dom.fields.SFVec3f(u._20,u._21,u._22);var f=x3dom.fields.SFMatrix4f.identity(),c=d.add(n).multiply(.5),_=this._eye.subtract(c);if(this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var m=x3dom.fields.Quaternion.rotateFromTo(_,new x3dom.fields.SFVec3f(0,0,1));f=m.toMatrix().transpose();var p=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),x=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize();if(!this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var g=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,x),v=g.toMatrix().transpose().multMatrixVec(p),y=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,v);f=g.toMatrix().transpose().mult(f),f=y.toMatrix().transpose().mult(f)}}else{var b=this._vf.axisOfRotation.cross(_).normalize();this._eye.z<0&&(b=b.multiply(-1));var T=Math.asin(b.dot(new x3dom.fields.SFVec3f(0,0,1)));this._eye.z<0&&(T+=Math.PI),f=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+T*-1)}for(var S=this.transformMatrix(e.mult(f)),M=0,C=this._childNodes.length;M<C;M++){var F=this._childNodes[M];F&&F.collectDrawableObjects(S,t,i,s,o,r)}}}})),x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Collision.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode),this.addField_SFTime(e,"collideTime",0),this.addField_SFBool(e,"isActive",!0)},{collectDrawableObjects:function(e,t,i,s,o,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),!(o<0)){var a,n;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),n=this._graph.globalMatrix):n=this.transformMatrix(e);for(var d=0,l=this._childNodes.length;d<l;d++)(a=this._childNodes[d])&&a!==this._cf.proxy.node&&a.collectDrawableObjects(n,t,i,s,o,r)}}})),x3dom.registerNodeType("X3DLODNode","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.X3DLODNode.superClass.call(this,e),this.addField_SFBool(e,"forceTransitions",!1),this.addField_SFVec3f(e,"center",0,0,0),this._eye=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(e,t,i,s,o,r){i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o),o<0||(i=!1,this.visitChildren(e,t,i,s,o,r))},visitChildren:function(e,t,i,s,o,r){}})),x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(e){x3dom.nodeTypes.LOD.superClass.call(this,e),this.addField_MFFloat(e,"range",[]),this._lastRangePos=-1},{visitChildren:function(e,t,i,s,o,r){var a=0,n=this._childNodes.length,d=t.viewMatrix,l=new x3dom.fields.SFVec3f(0,0,0);l=d.inverse().multMatrixPnt(l),this._eye=e.inverse().multMatrixPnt(l);for(var h=this._vf.center.subtract(this._eye).length();a<this._vf.range.length&&h>this._vf.range[a];)a++;a&&a>=n&&(a=n-1),this._lastRangePos=a;var u=this._childNodes[a];if(n&&u){var f=this.transformMatrix(e);u.collectDrawableObjects(f,t,i,s,o,r)}},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var t,i;if(this._lastRangePos>=0)t=this._childNodes[this._lastRangePos],i=t&&t._vf.render===!0?t.getVolume():null,i&&i.isValid()&&e.extendBounds(i.min,i.max);else for(var s=0,o=this._childNodes.length;s<o;s++)(t=this._childNodes[s])&&t._vf.render===!0&&(i=t.getVolume(),i&&i.isValid()&&e.extendBounds(i.min,i.max))}return e},nodeChanged:function(){this.invalidateVolume()},fieldChanged:function(e){"render"!=e&&"center"!=e&&"range"!=e||this.invalidateVolume()}})),x3dom.registerNodeType("DynamicLOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(e){x3dom.nodeTypes.DynamicLOD.superClass.call(this,e),this.addField_SFFloat(e,"subScale",.5),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFNode("root",x3dom.nodeTypes.X3DShapeNode),this.addField_SFString(e,"urlHead","http://r"),this.addField_SFString(e,"urlCenter",".ortho.tiles.virtualearth.net/tiles/h"),this.addField_SFString(e,"urlTail",".png?g=-1"),this.rootGeometry=new x3dom.nodeTypes.Plane(e),this.level=0,this.quadrant=4,this.cell=""},{nodeChanged:function(){var e=this._cf.root.node;null!=e&&null==e._cf.geometry.node&&(this.rootGeometry._vf.size.setValues(this._vf.size),this.rootGeometry._vf.subdivision.setValues(this._vf.subdivision),this.rootGeometry._vf.center.setValues(this._vf.center),this.rootGeometry.fieldChanged("subdivision"),this._cf.root.node.addChild(this.rootGeometry),this.rootGeometry.nodeChanged(),this._cf.root.node.nodeChanged(),this._nameSpace.doc.needRender=!0)},visitChildren:function(e,t,i,s,o,r){var a=this._cf.root.node;if(null!=a){var n=t.viewMatrix,d=new x3dom.fields.SFVec3f(0,0,0);d=n.inverse().multMatrixPnt(d),this._eye=e.inverse().multMatrixPnt(d);var l,h=this._vf.center.subtract(this._eye).length();if(h>x3dom.fields.Eps&&h*this._vf.subScale<=this._vf.size.length())if(this._childNodes.length<=1){var u=new Array(new x3dom.fields.SFVec3f(-.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(-.25*this._vf.size.x,-.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,-.25*this._vf.size.y,0));for(l=0;l<4;l++){var f=new x3dom.nodeTypes.DynamicLOD;f._nameSpace=this._nameSpace,f._eye.setValues(this._eye),f.level=this.level+1,f.quadrant=l,f.cell=this.cell+l,f._vf.urlHead=this._vf.urlHead,f._vf.urlCenter=this._vf.urlCenter,f._vf.urlTail=this._vf.urlTail,f._vf.center=this._vf.center.add(u[l]),f._vf.size=this._vf.size.multiply(.5),f._vf.subdivision.setValues(this._vf.subdivision);var c=new x3dom.nodeTypes.Appearance,_=new x3dom.nodeTypes.ImageTexture;_._nameSpace=this._nameSpace,_._vf.url[0]=this._vf.urlHead+f.quadrant+this._vf.urlCenter+f.cell+this._vf.urlTail,c.addChild(_),_.nodeChanged();var m=new x3dom.nodeTypes.Shape;m._nameSpace=this._nameSpace,m.addChild(c),c.nodeChanged(),f.addChild(m,"root"),m.nodeChanged(),this.addChild(f),f.nodeChanged()}}else for(l=1;l<this._childNodes.length;l++)this._childNodes[l].collectDrawableObjects(e,t,i,s,o,r);else a.collectDrawableObjects(e,t,i,s,o,r)}},getVolume:function(){var e=this._graph.volume;return e.isValid()||(e.min.setValues(this._vf.center),e.min.x-=.5*this._vf.size.x,
e.min.y-=.5*this._vf.size.y,e.min.z-=x3dom.fields.Eps,e.max.setValues(this._vf.center),e.max.x+=.5*this._vf.size.x,e.max.y+=.5*this._vf.size.y,e.max.z+=x3dom.fields.Eps),e}})),x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,e)})),x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,function(e){x3dom.nodeTypes.FontStyle.superClass.call(this,e),this.addField_MFString(e,"family",["SERIF"]),this.addField_SFBool(e,"horizontal",!0),this.addField_MFString(e,"justify",["MIDDLE","MIDDLE"]),this.addField_SFString(e,"language",""),this.addField_SFBool(e,"leftToRight",!0),this.addField_SFFloat(e,"size",1),this.addField_SFFloat(e,"spacing",1),this.addField_SFString(e,"style","PLAIN"),this.addField_SFBool(e,"topToBottom",!0),this.addField_SFFloat(e,"quality",2)},{fieldChanged:function(e){"family"!=e&&"horizontal"!=e&&"justify"!=e&&"language"!=e&&"leftToRight"!=e&&"size"!=e&&"spacing"!=e&&"style"!=e&&"topToBottom"!=e||Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e.setAllDirty()})})}})),x3dom.nodeTypes.FontStyle.defaultNode=function(){return x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged()),x3dom.nodeTypes.FontStyle._defaultNode},x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Text.superClass.call(this,e),this.addField_MFString(e,"string",[]),this.addField_MFFloat(e,"length",[]),this.addField_SFFloat(e,"maxExtent",0),this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode),this._mesh._positions[0]=[],this._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1],this._mesh._texCoords[0]=[0,0,1,0,1,1,0,1],this._mesh._colors[0]=[],this._mesh._indices[0]=[0,1,2,2,3,0],this._mesh._invalidate=!0,this._mesh._numFaces=2,this._mesh._numCoords=4},{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode()),this.invalidateVolume()},fieldChanged:function(e){"string"!=e&&"length"!=e&&"maxExtent"!=e||(this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e.setAllDirty()}))}})),x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,e)})),x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,function(e){x3dom.nodeTypes.Sound.superClass.call(this,e),this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)},{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{Array.forEach(this._xmlNode.childNodes,function(e){if(1===e.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+e.nodeName+"&gt; tag."),"audio"===e.localName.toLowerCase())){var t=e.getAttribute("loop");t=!!t&&"loop"===t.toLowerCase();var i=e.cloneNode(!1);e.parentNode.removeChild(e),e=null,"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(i);var s=function(){i.play()},o=function(){t&&i.play()};i.addEventListener("canplaythrough",s,!0),i.addEventListener("ended",o,!0)}})}catch(e){x3dom.debug.logException(e)}}}})),x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,function(e){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,e)})),x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,function(e){x3dom.nodeTypes.AudioClip.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"enabled",!1),this.addField_SFBool(e,"loop",!1),this._audio=document.createElement("audio"),"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio),this._sources=[]},{nodeChanged:function(){this._createSources=function(){this._sources=[];for(var e=0;e<this._vf.url.length;e++){var t=this._nameSpace.getURL(this._vf.url[e]);x3dom.debug.logInfo("Adding sound file: "+t);var i=document.createElement("source");i.setAttribute("src",t),this._sources.push(i),this._audio.appendChild(i)}};var e=this;this._startAudio=function(){e._audio.loop=e._vf.loop?"loop":"",e._vf.enabled===!0&&e._audio.play()},this._stopAudio=function(){e._audio.pause()},this._audioEnded=function(){e._vf.enabled===!0&&e._vf.loop===!0&&e._startAudio()};var t=function(e){x3dom.debug.logWarning("MediaEvent error:"+e)};this._audio.addEventListener("canplaythrough",this._startAudio,!0),this._audio.addEventListener("ended",this._audioEnded,!0),this._audio.addEventListener("error",t,!0),this._audio.addEventListener("pause",this._audioEnded,!0),this._createSources()},fieldChanged:function(e){if("enabled"===e)this._vf.enabled===!0?this._startAudio():this._stopAudio();else if("loop"===e);else if("url"===e){for(this._stopAudio();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(var t=0;t<this._vf.url.length;t++){var i=this._nameSpace.getURL(this._vf.url[t]);x3dom.debug.logInfo("Adding sound file: "+i);var s=document.createElement("source");s.setAttribute("src",i),this._audio.appendChild(s)}}},shutdown:function(){if(this._audio){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);document.body.removeChild(this._audio),this._audio=null}}})),x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,e)})),x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransform.superClass.call(this,e),this.addField_SFVec2f(e,"center",0,0),this.addField_SFFloat(e,"rotation",0),this.addField_SFVec2f(e,"scale",1,1),this.addField_SFVec2f(e,"translation",0,0);var t=new x3dom.fields.SFVec3f((-this._vf.center.x),(-this._vf.center.y),1),i=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),s=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),o=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(t).mult(x3dom.fields.SFMatrix4f.scale(o)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(i.add(s)))},{fieldChanged:function(e){if("center"==e||"rotation"==e||"scale"==e||"translation"==e){var t=new x3dom.fields.SFVec3f((-this._vf.center.x),(-this._vf.center.y),1),i=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),s=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),o=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(t).mult(x3dom.fields.SFMatrix4f.scale(o)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(i.add(s)))}},texTransformMatrix:function(){return this._trafo}})),x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.TextureProperties.superClass.call(this,e),this.addField_SFFloat(e,"anisotropicDegree",1),this.addField_SFColorRGBA(e,"borderColor",0,0,0,0),this.addField_SFInt32(e,"borderWidth",0),this.addField_SFString(e,"boundaryModeS","REPEAT"),this.addField_SFString(e,"boundaryModeT","REPEAT"),this.addField_SFString(e,"boundaryModeR","REPEAT"),this.addField_SFString(e,"magnificationFilter","FASTEST"),this.addField_SFString(e,"minificationFilter","FASTEST"),this.addField_SFString(e,"textureCompression","FASTEST"),this.addField_SFFloat(e,"texturePriority",0),this.addField_SFBool(e,"generateMipMaps",!1)},{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})}),this._nameSpace.doc.needRender=!0)}})),x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,e),this.addField_SFInt32(e,"origChannelCount",0),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"repeatS",!0),this.addField_SFBool(e,"repeatT",!0),this.addField_SFBool(e,"scale",!0),this.addField_SFString(e,"crossOrigin",""),this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties),this._needPerFrameUpdate=!1,this._isCanvas=!1,this._type="diffuseMap",this._blending=1==this._vf.origChannelCount||2==this._vf.origChannelCount},{invalidateGLObject:function(){Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.texture=!0)})})})}),this._nameSpace.doc.needRender=!0},parentAdded:function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.Shape)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})},parentRemoved:function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.Shape)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})},fieldChanged:function(e){if("url"==e||"origChannelCount"==e||"repeatS"==e||"repeatT"==e||"scale"==e||"crossOrigin"==e){var t=this;Array.forEach(this._parentNodes,function(e){if(x3dom.isa(e,x3dom.nodeTypes.X3DAppearanceNode))e.nodeChanged(),Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0});else if(x3dom.isa(e,x3dom.nodeTypes.MultiTexture))Array.forEach(e._parentNodes,function(e){e.nodeChanged(),Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})});else if(x3dom.isa(e,x3dom.nodeTypes.ImageGeometry)){var i=null;t._xmlNode&&t._xmlNode.hasAttribute("containerField")&&(i=t._xmlNode.getAttribute("containerField"),e._dirty[i]=!0)}else if(void 0!==x3dom.nodeTypes.X3DVolumeDataNode)if(x3dom.isa(e,x3dom.nodeTypes.X3DVolumeRenderStyleNode)){if(t._xmlNode&&t._xmlNode.hasAttribute("containerField"))if(e._volumeDataParent)e._volumeDataParent._dirty.texture=!0;else{for(var s=e._parentNodes[0];!x3dom.isa(s,x3dom.nodeTypes.X3DVolumeDataNode)&&x3dom.isa(s,x3dom.nodeTypes.X3DNode);)s=s._parentNodes[0];x3dom.isa(s,x3dom.nodeTypes.X3DNode)&&(s._dirty.texture=!0)}}else x3dom.isa(e,x3dom.nodeTypes.X3DVolumeDataNode)&&t._xmlNode&&t._xmlNode.hasAttribute("containerField")&&(e._dirty.texture=!0)})}},getTexture:function(e){return 0===e?this:null},size:function(){return 1}})),x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.MultiTexture.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)},{getTexture:function(e){return e>=0&&e<this._cf.texture.nodes.length?this._cf.texture.nodes[e]:null},getTextures:function(){return this._cf.texture.nodes},size:function(){return this._cf.texture.nodes.length}})),x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.Texture.superClass.call(this,e),this.addField_SFBool(e,"hideChildren",!0),this._video=null,this._intervalID=0,this._canvas=null},{nodeChanged:function(){if(!this._vf.url.length&&this._xmlNode){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var e=this;try{Array.forEach(this._xmlNode.childNodes,function(t){if(1===t.nodeType){var i=t.getAttribute("src");if(i){if(e._vf.url.push(i),x3dom.debug.logInfo(e._vf.url[e._vf.url.length-1]),"video"===t.localName.toLowerCase()){e._needPerFrameUpdate=!0,e._video=document.createElement("video"),e._video.setAttribute("preload","auto"),e._video.setAttribute("muted","muted");var s=document.getElementsByTagName("body")[0];s.appendChild(e._video),e._video.style.display="none",e._video.style.visibility="hidden"}}else"canvas"===t.localName.toLowerCase()&&(e._needPerFrameUpdate=!0,e._isCanvas=!0,e._canvas=t);t.style&&e._vf.hideChildren&&(t.style.display="none",t.style.visibility="hidden"),x3dom.debug.logInfo("### Found &lt;"+t.nodeName+"&gt; tag.")}})}catch(t){x3dom.debug.logException(t)}}},shutdown:function(){if(this._video){for(this._video.pause();this._video.hasChildNodes();)this._video.removeChild(this._video.firstChild);document.body.removeChild(this._video),this._video=null}}})),x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.RenderedTexture.superClass.call(this,e),e?e.doc._nodeBag.renderTextures.push(this):x3dom.debug.logWarning("RenderedTexture: No runtime context found!"),this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode),this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode),this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode),this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode),this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode),this.addField_MFInt32(e,"dimensions",[128,128,4]),this.addField_SFString(e,"update","NONE"),this.addField_SFBool(e,"showNormals",!1),this.addField_SFString(e,"stereoMode","NONE"),this.addField_SFFloat(e,"interpupillaryDistance",.064),this.addField_SFBool(e,"depthMap",!1),this.addField_SFBool(e,"oculusRiftVersion",1),this.hScreenSize=1==this._vf.oculusRiftVersion?.14976:.12576,this.vScreenSize=1==this._vf.oculusRiftVersion?.09356:.07074,this.vScreenCenter=this.vScreenSize/2,this.eyeToScreenDistance=.041,this.lensSeparationDistance=.0635,this.distortionK=[1,.22,.24,0],this.lensCenter=.151976495726,x3dom.debug.assert(this._vf.dimensions.length>=3,"RenderedTexture.dimensions requires at least 3 entries."),this._clearParents=!0,this._needRenderUpdate=!0,this.checkDepthTextureSupport=function(){this._vf.depthMap&&null===x3dom.caps.DEPTH_TEXTURE&&x3dom.debug.logWarning("RenderedTexture Node: depth texture extension not supported")},this.checkDepthTextureSupport()},{nodeChanged:function(){this._clearParents=!0,this._needRenderUpdate=!0},fieldChanged:function(e){switch(e){case"excludeNodes":this._clearParents=!0;break;case"update":"NEXT_FRAME_ONLY"!=this._vf.update.toUpperCase()&&"ALWAYS"!=this._vf.update.toUpperCase()||(this._needRenderUpdate=!0);break;case"depthMap":this.checkDepthTextureSupport(),this._x3domTexture.updateTexture(),this._needRenderUpdate=!0}},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var e=this;Array.forEach(this._cf.excludeNodes.nodes,function(t){for(var i=0,s=t._parentNodes.length;i<s;i++)t._parentNodes[i]===e&&(t._parentNodes.splice(i,1),t.parentRemoved(e))}),this._clearParents=!1}var t=this._cf.scene.node,i=this._nameSpace.doc._scene,s=i.getViewpoint(),o=this._cf.viewpoint.node,r=null;if(null===o||o===s)r=this._nameSpace.doc._viewarea.getViewMatrix();else if(t&&t!==i)r=o.getViewMatrix();else{var a=o.getCurrentTransform();r=o.getViewMatrix().mult(a.inverse())}var n=this._vf.stereoMode.toUpperCase();if("NONE"!=n){var d=this._vf.interpupillaryDistance/2;"RIGHT_EYE"==n&&(d=-d);var l=new x3dom.fields.SFMatrix4f(1,0,0,d,0,1,0,0,0,0,1,0,0,0,0,1);r=l.mult(r)}return r},getProjectionMatrix:function(){var e,t=this._nameSpace.doc,i=t._scene.getViewpoint(),s=this._cf.viewpoint.node,o=null,r=this._vf.dimensions[0],a=this._vf.dimensions[1],n=this._vf.stereoMode.toUpperCase(),d="NONE"!=n;if(null===s||s===i?(o=x3dom.fields.SFMatrix4f.copy(t._viewarea.getProjectionMatrix()),d?(e=2*Math.atan(this.vScreenSize/(2*this.eyeToScreenDistance)),e=1/Math.tan(e/2)):e=1/Math.tan(i._vf.fieldOfView/2),o._00=e/(r/a),o._11=e):o=s.getProjectionMatrix(r/a),d){var l=this.lensCenter;"RIGHT_EYE"==n&&(l=-l);var h=new x3dom.fields.SFMatrix4f(1,0,0,l,0,1,0,0,0,0,1,0,0,0,0,1);o=h.mult(o)}return o},getWCtoCCMatrix:function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},parentRemoved:function(e){if(0===this._parentNodes.length)for(var t=this.findX3DDoc(),i=0,s=t._nodeBag.renderTextures.length;i<s;i++)t._nodeBag.renderTextures[i]===this&&t._nodeBag.renderTextures.splice(i,1);this._cf.scene.node&&this._cf.scene.node.parentRemoved(this)},requirePingPong:function(){return!1}})),x3dom.registerNodeType("RefinementTexture","Texturing",defineClass(x3dom.nodeTypes.RenderedTexture,function(e){if(x3dom.nodeTypes.RefinementTexture.superClass.call(this,e),this.addField_SFString(e,"stamp0","gpuii/stamps/0.gif"),this.addField_SFString(e,"stamp1","gpuii/stamps/1.gif"),this.addField_SFBool(e,"autoRefinement",!0),this.addField_SFString(e,"format","jpg"),this.addField_SFInt32(e,"iterations",7),this.addField_SFInt32(e,"maxLevel",this._vf.iterations),this._vf.iterations%2===0){var t=this._vf.stamp0;this._vf.stamp0=this._vf.stamp1,this._vf.stamp1=t}this._vf.iterations=this._vf.iterations>11?11:this._vf.iterations,this._vf.iterations=this._vf.iterations<3?3:this._vf.iterations,this._vf.maxLevel=this._vf.maxLevel>11?11:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel<3?3:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel>this._vf.iterations?this._vf.iterations:this._vf.maxLevel;var i=[{x:4,y:8},{x:8,y:8},{x:8,y:16},{x:16,y:16},{x:16,y:32},{x:32,y:32},{x:32,y:64},{x:64,y:64},{x:64,y:128}];this._repeat=new x3dom.fields.SFVec2f(this._vf.dimensions[0]/i[this._vf.iterations-3].x,this._vf.dimensions[1]/i[this._vf.iterations-3].y),this._renderedImage=0,this._currLoadLevel=0,this._loadLevel=1},{nextLevel:function(){this._loadLevel<this._vf.maxLevel&&(this._loadLevel++,this._nameSpace.doc.needRender=!0)},requirePingPong:function(){return this._currLoadLevel<=this._vf.maxLevel&&this._renderedImage<this._loadLevel}})),x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.PixelTexture.superClass.call(this,e),this.addField_SFImage(e,"image",0,0,0)},{fieldChanged:function(e){"image"==e&&this.invalidateGLObject()},getWidth:function(){return this._vf.image.width},getHeight:function(){return this._vf.image.height},getComponents:function(){return this._vf.image.comp},setPixel:function(e,t,i,s){s=void 0==s||s,this._x3domTexture?(this._x3domTexture.setPixel(e,t,[255*i.r,255*i.g,255*i.b,255*i.a],s),this._vf.image.setPixel(e,t,i)):(this._vf.image.setPixel(e,t,i),s&&this.invalidateGLObject())},getPixel:function(e,t){return this._vf.image.getPixel(e,t)},setPixels:function(e,t){t=void 0==t||t,this._vf.image.setPixels(e),t&&this.invalidateGLObject()},getPixels:function(){return this._vf.image.getPixels()}})),x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.ImageTexture.superClass.call(this,e)})),x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.MovieTexture.superClass.call(this,e),this.addField_SFBool(e,"loop",!1),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"pauseTime",0),this.addField_SFFloat(e,"pitch",1),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0)})),x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,e)},{fieldChanged:function(e){"texCoord"!==e&&"point"!==e&&"parameter"!==e&&"mode"!==e||Array.forEach(this._parentNodes,function(e){e.fieldChanged("texCoord")})},parentAdded:function(e){e._mesh&&e._cf.texCoord.node!==this&&e.fieldChanged("texCoord")}})),x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,e),this.addField_MFVec2f(e,"point",[])})),x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,e),this.addField_SFString(e,"mode","SPHERE"),this.addField_MFFloat(e,"parameter",[])})),x3dom.registerNodeType("MultiTextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.MultiTextureCoordinate.superClass.call(this,e),this.addField_MFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)})),x3dom.registerNodeType("ImageTextureAtlas","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.ImageTextureAtlas.superClass.call(this,e),this.addField_SFInt32(e,"numberOfSlices",0),this.addField_SFInt32(e,"slicesOverX",0),this.addField_SFInt32(e,"slicesOverY",0)})),x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,e)},{getTexUrl:function(){return[]},getTexSize:function(){return-1}})),x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,e),this.addField_SFNode("back",x3dom.nodeTypes.Texture),this.addField_SFNode("front",x3dom.nodeTypes.Texture),this.addField_SFNode("bottom",x3dom.nodeTypes.Texture),this.addField_SFNode("top",x3dom.nodeTypes.Texture),this.addField_SFNode("left",x3dom.nodeTypes.Texture),this.addField_SFNode("right",x3dom.nodeTypes.Texture),this._type="environmentMap"},{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}})),x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,e),this.addField_SFInt32(e,"size",128),this.addField_SFString(e,"update","NONE"),this._type="cubeMap",x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")},{getTexSize:function(){return this._vf.size}})),x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,function(e){x3dom.nodeTypes.Uniform.superClass.call(this,e)})),x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,e),this.addField_SFInt32(e,"textureCoordinatesId",0),this.addField_SFString(e,"channelMask","DEFAULT"),this.addField_SFBool(e,"isSRGB",!1),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)})),x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,e),this.addField_SFString(e,"language","")})),x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,e),this.addField_SFInt32(e,"tangentTextureCoordinatesId",-1),this.addField_SFInt32(e,"binormalTextureCoordinatesId",-1),this.addField_SFVec3f(e,"emissiveFactor",0,0,0),this.addField_SFInt32(e,"emissiveTextureId",-1),this.addField_SFInt32(e,"emissiveTextureCoordinatesId",0),this.addField_SFString(e,"emissiveTextureChannelMask","rgb"),this.addField_SFVec3f(e,"ambientFactor",.2,.2,.2),this.addField_SFInt32(e,"ambientTextureId",-1),this.addField_SFInt32(e,"ambientTextureCoordinatesId",0),this.addField_SFString(e,"ambientTextureChannelMask","rgb"),this.addField_SFVec3f(e,"diffuseFactor",.8,.8,.8),this.addField_SFInt32(e,"diffuseTextureId",-1),this.addField_SFInt32(e,"diffuseTextureCoordinatesId",0),this.addField_SFString(e,"diffuseTextureChannelMask","rgb"),this.addField_SFVec3f(e,"specularFactor",0,0,0),this.addField_SFInt32(e,"specularTextureId",-1),this.addField_SFInt32(e,"specularTextureCoordinatesId",0),this.addField_SFString(e,"specularTextureChannelMask","rgb"),this.addField_SFFloat(e,"shininessFactor",.2),this.addField_SFInt32(e,"shininessTextureId",-1),this.addField_SFInt32(e,"shininessTextureCoordinatesId",0),this.addField_SFString(e,"shininessTextureChannelMask","a"),this.addField_SFString(e,"normalFormat","UNORM"),this.addField_SFString(e,"normalSpace","TANGENT"),this.addField_SFInt32(e,"normalTextureId",-1),this.addField_SFInt32(e,"normalTextureCoordinatesId",0),this.addField_SFString(e,"normalTextureChannelMask","rgb"),this.addField_SFVec3f(e,"reflectionFactor",0,0,0),this.addField_SFInt32(e,"reflectionTextureId",-1),this.addField_SFInt32(e,"reflectionTextureCoordinatesId",0),this.addField_SFString(e,"reflectionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"transmissionFactor",0,0,0),this.addField_SFInt32(e,"transmissionTextureId",-1),this.addField_SFInt32(e,"transmissionTextureCoordinatesId",0),this.addField_SFString(e,"transmissionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"environmentFactor",1,1,1),this.addField_SFInt32(e,"environmentTextureId",-1),this.addField_SFInt32(e,"environmentTextureCoordinatesId",0),this.addField_SFString(e,"environmentTextureChannelMask","rgb"),this.addField_SFFloat(e,"relativeIndexOfRefraction",1),this.addField_SFFloat(e,"fresnelBlend",0),this.addField_SFString(e,"displacementAxis","y"),this.addField_SFFloat(e,"displacementFactor",255),this.addField_SFInt32(e,"displacementTextureId",-1),this.addField_SFInt32(e,"displacementTextureCoordinatesId",0),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("displacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseDisplacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiDiffuseAlphaTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiSpecularShininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiEmissiveAmbientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiVisibilityTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFVec3f(e,"normalScale",2,2,2),this.addField_SFVec3f(e,"normalBias",-1,-1,-1),this.addField_SFFloat(e,"alphaFactor",1),this.addField_SFBool(e,"invertAlphaTexture",!1),this.addField_SFInt32(e,"alphaTextureId",-1),this.addField_SFInt32(e,"alphaTextureCoordinatesId",0),this.addField_SFString(e,"alphaTextureChannelMask","a"),this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode),this._dirty={}},{getDiffuseMap:function(){return this._cf.diffuseTexture.node?x3dom.isa(this._cf.diffuseTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseTexture.node._cf.texture.node._type="diffuseMap",this._cf.diffuseTexture.node._cf.texture.node):(this._cf.diffuseTexture.node._type="diffuseMap",this._cf.diffuseTexture.node):null},getEnvironmentMap:function(){return this._cf.environmentTexture.node?x3dom.isa(this._cf.environmentTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.environmentTexture.node._cf.texture.node._type="environmentMap",this._cf.environmentTexture.node._cf.texture.node):(this._cf.environmentTexture.node._type="environmentMap",this._cf.environmentTexture.node):null},getNormalMap:function(){return this._cf.normalTexture.node?x3dom.isa(this._cf.normalTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.normalTexture.node._cf.texture.node._type="normalMap",this._cf.normalTexture.node._cf.texture.node):(this._cf.normalTexture.node._type="normalMap",this._cf.normalTexture.node):null},getAmbientMap:function(){return this._cf.ambientTexture.node?x3dom.isa(this._cf.ambientTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.ambientTexture.node._cf.texture.node._type="ambientMap",this._cf.ambientTexture.node._cf.texture.node):(this._cf.ambientTexture.node._type="ambientMap",this._cf.ambientTexture.node):null},getSpecularMap:function(){return this._cf.specularTexture.node?x3dom.isa(this._cf.specularTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.specularTexture.node._cf.texture.node._type="specularMap",this._cf.specularTexture.node._cf.texture.node):(this._cf.specularTexture.node._type="specularMap",this._cf.specularTexture.node):null},getShininessMap:function(){return this._cf.shininessTexture.node?x3dom.isa(this._cf.shininessTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.shininessTexture.node._cf.texture.node._type="shininessMap",this._cf.shininessTexture.node._cf.texture.node):(this._cf.shininessTexture.node._type="shininessMap",this._cf.shininessTexture.node):null},getAlphaMap:function(){return this._cf.alphaTexture.node?x3dom.isa(this._cf.alphaTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.alphaTexture.node._cf.texture.node._type="alphaMap",this._cf.alphaTexture.node._cf.texture.node):(this._cf.alphaTexture.node._type="alphaMap",this._cf.alphaTexture.node):null},getDisplacementMap:function(){return this._cf.displacementTexture.node?x3dom.isa(this._cf.displacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.displacementTexture.node._cf.texture.node._type="displacementMap",this._cf.displacementTexture.node._cf.texture.node):(this._cf.displacementTexture.node._type="displacementMap",this._cf.displacementTexture.node):null},getDiffuseDisplacementMap:function(){return this._cf.diffuseDisplacementTexture.node?x3dom.isa(this._cf.diffuseDisplacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseDisplacementTexture.node._cf.texture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node._cf.texture.node):(this._cf.diffuseDisplacementTexture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node):null},getMultiDiffuseAlphaMap:function(){return this._cf.multiDiffuseAlphaTexture.node?x3dom.isa(this._cf.multiDiffuseAlphaTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiDiffuseAlphaTexture.node._cf.texture.node._type="multiDiffuseAlphaMap",this._cf.multiDiffuseAlphaTexture.node._cf.texture.node):(this._cf.multiDiffuseAlphaTexture.node._type="multiDiffuseAlphaMap",this._cf.multiDiffuseAlphaTexture.node):null},getMultiEmissiveAmbientMap:function(){return this._cf.multiEmissiveAmbientTexture.node?x3dom.isa(this._cf.multiEmissiveAmbientTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiEmissiveAmbientTexture.node._cf.texture.node._type="multiEmissiveAmbientMap",this._cf.multiEmissiveAmbientTexture.node._cf.texture.node):(this._cf.multiEmissiveAmbientTexture.node._type="multiEmissiveAmbientMap",this._cf.multiEmissiveAmbientTexture.node):null},getMultiSpecularShininessMap:function(){return this._cf.multiSpecularShininessTexture.node?x3dom.isa(this._cf.multiSpecularShininessTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiSpecularShininessTexture.node._cf.texture.node._type="multiSpecularShininessMap",this._cf.multiSpecularShininessTexture.node._cf.texture.node):(this._cf.multiSpecularShininessTexture.node._type="multiSpecularShininessMap",this._cf.multiSpecularShininessTexture.node):null},getMultiVisibilityMap:function(){return this._cf.multiVisibilityTexture.node?x3dom.isa(this._cf.multiVisibilityTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiVisibilityTexture.node._cf.texture.node._type="multiVisibilityMap",
this._cf.multiVisibilityTexture.node._cf.texture.node):(this._cf.multiVisibilityTexture.node._type="multiVisibilityMap",this._cf.multiVisibilityTexture.node):null},getTextures:function(){var e=[],t=this.getDiffuseMap();t&&e.push(t);var i=this.getNormalMap();i&&e.push(i);var s=this.getSpecularMap();s&&e.push(s);var o=this.getShininessMap();o&&e.push(o);var r=this.getEnvironmentMap();r&&e.push(r);var a=this.getDisplacementMap();a&&e.push(a);var n=this.getDiffuseDisplacementMap();n&&e.push(n);var d=this.getMultiDiffuseAlphaMap();d&&e.push(d);var l=this.getMultiEmissiveAmbientMap();l&&e.push(l);var h=this.getMultiSpecularShininessMap();h&&e.push(h);var u=this.getMultiVisibilityMap();return u&&e.push(u),e},needTexcoords:function(){return!!(this.getDiffuseMap()||this.getNormalMap()||this.getSpecularMap()||this.getShininessMap()||this.getDisplacementMap()||this.getDiffuseDisplacementMap()||this.getEnvironmentMap())}})),x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.ComposedShader.superClass.call(this,e),this.addField_MFNode("fields",x3dom.nodeTypes.Field),this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart),this._vertex=null,this._fragment=null,this._id=null,x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown||(x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n(see also <a href='http://x3dom.org/x3dom/doc/help/composedShader.html'>http://x3dom.org/x3dom/doc/help/composedShader.html</a>)\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n"),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!0)},{nodeChanged:function(){var e,t=this._cf.parts.nodes.length;for(e=0;e<t;e++)"vertex"==this._cf.parts.nodes[e]._vf.type.toLowerCase()?(this._vertex=this._cf.parts.nodes[e],this._id=this._cf.parts.nodes[e]._id):"fragment"==this._cf.parts.nodes[e]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[e],this._id+=" - "+this._cf.parts.nodes[e]._id);var i={};for(t=this._cf.fields.nodes.length,e=0;e<t;e++){var s=this._cf.fields.nodes[e]._vf.name;i.xmlNode=this._cf.fields.nodes[e]._xmlNode;var o=!1;void 0!==i.xmlNode&&null!==i.xmlNode||(i.xmlNode=document.createElement("field"),o=!0),i.xmlNode.setAttribute(s,this._cf.fields.nodes[e]._vf.value);var r="this.addField_"+this._cf.fields.nodes[e]._vf.type+"(ctx, name);",a=new Function("ctx","name",r);a.call(this,i,s),o&&(i.xmlNode=null)}Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._cleanupGLObjects&&e._cleanupGLObjects(),e.setAllDirty()})})},fieldChanged:function(e){var t,i=this._cf.fields.nodes.length;for(t=0;t<i;t++){var s=this._cf.fields.nodes[t]._vf.name;if(s===e){var o=this._cf.fields.nodes[t]._vf.value;try{this._vf[s].setValueByStr(o)}catch(r){try{switch((typeof this._vf[s]).toString()){case"number":this._vf[s]=+o;break;case"boolean":this._vf[s]="true"===o.toLowerCase();break;case"string":this._vf[s]=o}}catch(a){x3dom.debug.logError("setValueByStr() NYI for "+typeof this._vf[s])}}break}}"url"===s&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.shader=!0})})},parentAdded:function(e){e.nodeChanged()}})),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!1,x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.ShaderPart.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFString(e,"type","VERTEX"),this._id=e&&e.xmlNode&&""!=e.xmlNode.id?e.xmlNode.id:++x3dom.nodeTypes.Shape.shaderPartID,x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase(),"Unknown shader part type!")},{nodeChanged:function(){var e={};if(e.xmlNode=this._xmlNode,void 0!==e.xmlNode&&null!==e.xmlNode){var t=this;if(t._vf.url.length&&t._vf.url[0].indexOf("\n")==-1){var i=new XMLHttpRequest;i.open("GET",t._nameSpace.getURL(t._vf.url[0]),!1),i.onload=function(){t._vf.url=new x3dom.fields.MFString([]),t._vf.url.push(i.response)},i.onerror=function(){x3dom.debug.logError("Could not load file '"+t._vf.url[0]+"'.")},i.send(null)}else{t._vf.url.length&&(t._vf.url=new x3dom.fields.MFString([]));try{t._vf.url.push(e.xmlNode.childNodes[1].nodeValue),e.xmlNode.removeChild(e.xmlNode.childNodes[1])}catch(s){Array.forEach(e.xmlNode.childNodes,function(e){3===e.nodeType?t._vf.url.push(e.nodeValue):4===e.nodeType&&t._vf.url.push(e.data),e.parentNode.removeChild(e)})}}}Array.forEach(this._parentNodes,function(e){e.nodeChanged()})},fieldChanged:function(e){"url"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("url")})},parentAdded:function(e){e.nodeChanged()}})),x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,e),this.addField_SFString(e,"name","")})),x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,function(e){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,e),this.addField_SFInt32(e,"numComponents",4),this.addField_MFFloat(e,"value",[])})),x3dom.registerNodeType("X3DSpatialGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.X3DSpatialGeometryNode.superClass.call(this,e)})),x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Plane.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFVec3f(e,"center",0,0,0),this.addField_MFString(e,"primType",["TRIANGLES"]),this._vf.primType.length&&(this._mesh._primType=this._vf.primType[0]);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y,r="Plane_"+t+"-"+i+"-"+s+"-"+o+"-"+this._vf.center.x+"-"+this._vf.center.y+"-"+this._vf.center.z;if(e&&this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{var a=0,n=0,d=t/s,l=i/o;for(t/=2,i/=2,n=0;n<=o;n++)for(a=0;a<=s;a++)this._mesh._positions[0].push(this._vf.center.x+a*d-t),this._mesh._positions[0].push(this._vf.center.y+n*l-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(a/s),this._mesh._texCoords[0].push(n/o);for(n=1;n<=o;n++)for(a=0;a<s;a++)this._mesh._indices[0].push((n-1)*(s+1)+a),this._mesh._indices[0].push((n-1)*(s+1)+a+1),this._mesh._indices[0].push(n*(s+1)+a),this._mesh._indices[0].push(n*(s+1)+a),this._mesh._indices[0].push((n-1)*(s+1)+a+1),this._mesh._indices[0].push(n*(s+1)+a+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}},{fieldChanged:function(e){if("size"==e||"center"==e){this._mesh._positions[0]=[];var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y,r=0,a=0,n=t/s,d=i/o;for(t/=2,i/=2,a=0;a<=o;a++)for(r=0;r<=s;r++)this._mesh._positions[0].push(this._vf.center.x+r*n-t),this._mesh._positions[0].push(this._vf.center.y+a*d-i),this._mesh._positions[0].push(this._vf.center.z);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y,r=0,a=0,n=t/s,d=i/o;for(t/=2,i/=2,a=0;a<=o;a++)for(r=0;r<=s;r++)this._mesh._positions[0].push(this._vf.center.x+r*n-t),this._mesh._positions[0].push(this._vf.center.y+a*d-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(r/s),this._mesh._texCoords[0].push(a/o);for(a=1;a<=o;a++)for(r=0;r<s;r++)this._mesh._indices[0].push((a-1)*(s+1)+r),this._mesh._indices[0].push((a-1)*(s+1)+r+1),this._mesh._indices[0].push(a*(s+1)+r),this._mesh._indices[0].push(a*(s+1)+r),this._mesh._indices[0].push((a-1)*(s+1)+r+1),this._mesh._indices[0].push(a*(s+1)+r+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Box.superClass.call(this,e),this.addField_SFVec3f(e,"size",2,2,2),this.addField_SFBool(e,"hasHelperColors",!1);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.size.z,o="Box_"+t+"-"+i+"-"+s;this._vf.useGeoCache&&void 0!==x3dom.geoCache[o]?this._mesh=x3dom.geoCache[o]:(t/=2,i/=2,s/=2,this._mesh._positions[0]=[-t,-i,-s,-t,i,-s,t,i,-s,t,-i,-s,-t,-i,s,-t,i,s,t,i,s,t,-i,s,-t,-i,-s,-t,-i,s,-t,i,s,-t,i,-s,t,-i,-s,t,-i,s,t,i,s,t,i,-s,-t,i,-s,-t,i,s,t,i,s,t,i,-s,-t,-i,-s,-t,-i,s,t,-i,s,t,-i,-s],this._mesh._normals[0]=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._vf.hasHelperColors&&(this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]),this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[o]=this._mesh)},{fieldChanged:function(e){if("size"===e){var t=this._vf.size.x/2,i=this._vf.size.y/2,s=this._vf.size.z/2;this._mesh._positions[0]=[-t,-i,-s,-t,i,-s,t,i,-s,t,-i,-s,-t,-i,s,-t,i,s,t,i,s,t,-i,s,-t,-i,-s,-t,-i,s,-t,i,s,-t,i,-s,t,-i,-s,t,-i,s,t,i,s,t,i,-s,-t,i,-s,-t,i,s,t,i,s,t,i,-s,-t,-i,-s,-t,-i,s,t,-i,s,t,-i,-s],this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else"hasHelperColors"===e&&(this._vf.hasHelperColors?this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]:this._mesh._colors[0]=[],Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Sphere.superClass.call(this,e),this.addField_SFFloat(e,"radius",e?1:1e4),this.addField_SFVec2f(e,"subdivision",24,24);var t=1,i=this._vf.radius,s=this._vf.subdivision.x,o=this._vf.subdivision.y,r="Sphere_"+i+"-"+s+"-"+o;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{if(e&&(t=e.doc.properties.getProperty("PrimitiveQuality","Medium")),x3dom.Utils.isNumber(t))t=parseFloat(t);else switch(t.toLowerCase()){case"low":t=.3;break;case"medium":t=.5;break;case"high":t=1}this._quality=t;var a,n,d,l,h,u,f,c,_,m,p,x,g,v=Math.floor(s*t),y=Math.floor(o*t);for(a=0;a<=v;a++)for(d=a*Math.PI/v,l=Math.sin(d),h=Math.cos(d),n=0;n<=y;n++)u=2*n*Math.PI/y,f=Math.sin(u),c=Math.cos(u),_=-c*l,m=-h,p=-f*l,x=.25-n/y,g=a/v,this._mesh._positions[0].push(i*_),this._mesh._positions[0].push(i*m),this._mesh._positions[0].push(i*p),this._mesh._normals[0].push(_),this._mesh._normals[0].push(m),this._mesh._normals[0].push(p),this._mesh._texCoords[0].push(x),this._mesh._texCoords[0].push(g);var b,T;for(a=0;a<v;a++)for(n=0;n<y;n++)b=a*(y+1)+n,T=b+y+1,this._mesh._indices[0].push(b),this._mesh._indices[0].push(T),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(T),this._mesh._indices[0].push(T+1),this._mesh._indices[0].push(b+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}},{fieldChanged:function(e){if("radius"===e){this._mesh._positions[0]=[];var t,i,s,o,r,a,n,d,l,h,u,f=this._vf.radius,c=this._vf.subdivision.x,_=this._vf.subdivision.y,m=this._quality,p=Math.floor(c*m),x=Math.floor(_*m);for(t=0;t<=p;t++)for(s=t*Math.PI/p,o=Math.sin(s),r=Math.cos(s),i=0;i<=x;i++)a=2*i*Math.PI/x,n=Math.sin(a),d=Math.cos(a),l=-d*o,h=-r,u=-n*o,this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*u);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,s,o,r,a,n,d,l,h,u,g,v,f=this._vf.radius,c=this._vf.subdivision.x,_=this._vf.subdivision.y,m=this._quality,p=Math.floor(c*m),x=Math.floor(_*m);for(t=0;t<=p;t++)for(s=t*Math.PI/p,o=Math.sin(s),r=Math.cos(s),i=0;i<=x;i++)a=2*i*Math.PI/x,n=Math.sin(a),d=Math.cos(a),l=-d*o,h=-r,u=-n*o,g=.25-i/x,v=t/p,this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*u),this._mesh._normals[0].push(l),this._mesh._normals[0].push(h),this._mesh._normals[0].push(u),this._mesh._texCoords[0].push(g),this._mesh._texCoords[0].push(v);var y,b;for(t=0;t<p;t++)for(i=0;i<x;i++)y=t*(x+1)+i,b=y+x+1,this._mesh._indices[0].push(y),this._mesh._indices[0].push(b),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(b),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(y+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Torus.superClass.call(this,e);var t=2*Math.PI;this.addField_SFFloat(e,"innerRadius",.5),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFFloat(e,"angle",t),this.addField_SFBool(e,"caps",!0),this.addField_SFVec2f(e,"subdivision",24,24),this.addField_SFBool(e,"insideOutsideRadius",!1),this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t),this._origCCW=this._vf.ccw;var i=this._vf.innerRadius,s=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>s){var o=i;i=s,s=o}var r=(s-i)/2;s=i+r,i=r,this._vf.ccw=!this._origCCW}var a=this._vf.subdivision.x,n=this._vf.subdivision.y;a=Math.max(3,Math.round(this._vf.angle/t*a));var d="Torus_"+i+"_"+s+"_"+this._vf.angle+"_"+this._vf.subdivision+"-"+this._vf.caps;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{var l,h,u,f,c,_,m,p,x,g=this._vf.angle/a,v=t/n;for(l=0,u=0;l<=a;l++,u+=g)for(c=Math.cos(u),_=Math.sin(u),h=0,f=0;h<=n;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*x,i*p,-_*x),this._mesh._normals[0].push(c*m,p,-_*m)):(this._mesh._positions[0].push(c*x,-_*x,i*p),this._mesh._normals[0].push(c*m,-_*m,p)),this._mesh._texCoords[0].push(-l/a,h/n);for(l=0;l<n;l++)for(h=0;h<a;h++)this._mesh._indices[0].push(h*(n+1)+l),this._mesh._indices[0].push(h*(n+1)+l+1),this._mesh._indices[0].push((h+1)*(n+1)+l),this._mesh._indices[0].push(h*(n+1)+l+1),this._mesh._indices[0].push((h+1)*(n+1)+l+1),this._mesh._indices[0].push((h+1)*(n+1)+l);if(this._vf.angle<t&&1==this._vf.caps){var y=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),h=0,f=0;h<=n;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(x,p*i,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(x,0,p*i),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+m),.5*(1-p)),h>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h),this._mesh._indices[0].push(y+h-1)),h==n&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(y+h));c=Math.cos(this._vf.angle),_=Math.sin(this._vf.angle),y=this._mesh._positions[0].length/3;var b=-_,T=-c;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*s,0,-_*s),this._mesh._normals[0].push(b,0,T)):(this._mesh._positions[0].push(c*s,-_*s,0),this._mesh._normals[0].push(b,T,0)),this._mesh._texCoords[0].push(.5,.5),h=0,f=0;h<=n;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*x,p*i,-_*x),this._mesh._normals[0].push(b,0,T)):(this._mesh._positions[0].push(c*x,-_*x,p*i),this._mesh._normals[0].push(b,T,0)),this._mesh._texCoords[0].push(1-.5*(1+m),.5*(1-p)),h>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h-1),this._mesh._indices[0].push(y+h)),h==n&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h),this._mesh._indices[0].push(y+1))}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(e){if("innerRadius"==e||"outerRadius"==e||"subdivision"==e||"angle"==e||"insideOutsideRadius"==e||"caps"==e){var t=2*Math.PI;this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t);var i=this._vf.innerRadius,s=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>s){var o=i;i=s,s=o}var r=(s-i)/2;s=i+r,i=r,this._vf.ccw=!this._origCCW}else this._vf.ccw=this._origCCW;var a=this._vf.subdivision.x,n=this._vf.subdivision.y;a=Math.max(3,Math.round(this._vf.angle/t*a));var d,l,h,u,f,c,_,m,p,x=this._vf.angle/a,g=t/n;for(this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[],d=0,h=0;d<=a;d++,h+=x)for(f=Math.cos(h),c=Math.sin(h),l=0,u=0;l<=n;l++,u+=g)_=Math.cos(u),m=Math.sin(u),p=s+i*_,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*p,i*m,-c*p),this._mesh._normals[0].push(f*_,m,-c*_)):(this._mesh._positions[0].push(f*p,-c*p,i*m),this._mesh._normals[0].push(f*_,-c*_,m)),this._mesh._texCoords[0].push(-d/a,l/n);for(d=0;d<n;d++)for(l=0;l<a;l++)this._mesh._indices[0].push(l*(n+1)+d),this._mesh._indices[0].push(l*(n+1)+d+1),this._mesh._indices[0].push((l+1)*(n+1)+d),this._mesh._indices[0].push(l*(n+1)+d+1),this._mesh._indices[0].push((l+1)*(n+1)+d+1),this._mesh._indices[0].push((l+1)*(n+1)+d);if(this._vf.angle<t&&1==this._vf.caps){var v=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;l<=n;l++,u+=g)_=Math.cos(u),m=Math.sin(u),p=s+i*_,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(p,m*i,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(p,0,m*i),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+_),.5*(1-m)),l>0&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l),this._mesh._indices[0].push(v+l-1)),l==n&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+1),this._mesh._indices[0].push(v+l));f=Math.cos(this._vf.angle),c=Math.sin(this._vf.angle),v=this._mesh._positions[0].length/3;var y=-c,b=-f;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*s,0,-c*s),this._mesh._normals[0].push(y,0,b)):(this._mesh._positions[0].push(f*s,-c*s,0),this._mesh._normals[0].push(y,b,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;l<=n;l++,u+=g)_=Math.cos(u),m=Math.sin(u),p=s+i*_,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*p,m*i,-c*p),this._mesh._normals[0].push(y,0,b)):(this._mesh._positions[0].push(f*p,-c*p,m*i),this._mesh._normals[0].push(y,b,0)),this._mesh._texCoords[0].push(1-.5*(1+_),.5*(1-m)),l>0&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l-1),this._mesh._indices[0].push(v+l)),l==n&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l),this._mesh._indices[0].push(v+1))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Cone.superClass.call(this,e),this.addField_SFFloat(e,"bottomRadius",1),this.addField_SFFloat(e,"topRadius",0),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"side",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32);var t="Cone_"+this._vf.bottomRadius+"_"+this._vf.height+"_"+this._vf.top+"_"+this._vf.bottom+"_"+this._vf.side+"_"+this._vf.topRadius+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[t])this._mesh=x3dom.geoCache[t];else{var i,s,o,r,a,n=this._vf.bottomRadius,d=this._vf.height,l=this._vf.topRadius,h=this._vf.subdivision,u=2*Math.PI/h,f=(n-l)/d,c=1/Math.sqrt(1+f*f),_=0,m=0;if(this._vf.side&&d>0){var p=0,x=0;for(_=0,m=0;_<=h;_++)i=_*u,s=Math.sin(i),o=-Math.cos(i),l>x3dom.fields.Eps&&(p=s*l,x=o*l),this._mesh._positions[0].push(p,d/2,x),this._mesh._normals[0].push(s/c,f/c,o/c),this._mesh._texCoords[0].push(1-_/h,1),this._mesh._positions[0].push(s*n,-d/2,o*n),this._mesh._normals[0].push(s/c,f/c,o/c),this._mesh._texCoords[0].push(1-_/h,0),_>0&&(this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+3),m+=2)}if(this._vf.bottom&&n>0){for(a=this._mesh._positions[0].length/3,_=h-1;_>=0;_--)i=_*u,s=n*Math.sin(i),o=-n*Math.cos(i),this._mesh._positions[0].push(s,-d/2,o),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(s/n/2+.5,o/n/2+.5);for(r=a+1,_=2;_<h;_++)this._mesh._indices[0].push(r),this._mesh._indices[0].push(a),r=a+_,this._mesh._indices[0].push(r)}if(this._vf.top&&l>x3dom.fields.Eps){for(a=this._mesh._positions[0].length/3,_=h-1;_>=0;_--)i=_*u,s=l*Math.sin(i),o=-l*Math.cos(i),this._mesh._positions[0].push(s,d/2,o),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(s/l/2+.5,1-o/l/2+.5);for(r=a+1,_=2;_<h;_++)this._mesh._indices[0].push(a),this._mesh._indices[0].push(r),r=a+_,this._mesh._indices[0].push(r)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[t]=this._mesh}},{fieldChanged:function(e){if("bottomRadius"==e||"topRadius"==e||"height"==e||"subdivision"==e||"bottom"==e||"top"==e||"side"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,s,o,r,a=this._vf.bottomRadius,n=this._vf.height,d=this._vf.topRadius,l=this._vf.subdivision,h=2*Math.PI/l,u=(a-d)/n,f=1/Math.sqrt(1+u*u),c=0,_=0;if(this._vf.side&&n>0){var m=0,p=0;for(c=0,_=0;c<=l;c++)t=c*h,i=Math.sin(t),s=-Math.cos(t),d>x3dom.fields.Eps&&(m=i*d,p=s*d),this._mesh._positions[0].push(m,n/2,p),this._mesh._normals[0].push(i/f,u/f,s/f),this._mesh._texCoords[0].push(1-c/l,1),this._mesh._positions[0].push(i*a,-n/2,s*a),this._mesh._normals[0].push(i/f,u/f,s/f),this._mesh._texCoords[0].push(1-c/l,0),c>0&&(this._mesh._indices[0].push(_),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+3),_+=2)}if(this._vf.bottom&&a>0){for(r=this._mesh._positions[0].length/3,c=l-1;c>=0;c--)t=c*h,i=a*Math.sin(t),s=-a*Math.cos(t),this._mesh._positions[0].push(i,-n/2,s),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/a/2+.5,s/a/2+.5);for(o=r+1,c=2;c<l;c++)this._mesh._indices[0].push(o),this._mesh._indices[0].push(r),o=r+c,this._mesh._indices[0].push(o)}if(this._vf.top&&d>x3dom.fields.Eps){for(r=this._mesh._positions[0].length/3,c=l-1;c>=0;c--)t=c*h,i=d*Math.sin(t),s=-d*Math.cos(t),this._mesh._positions[0].push(i,n/2,s),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(i/d/2+.5,1-s/d/2+.5);for(o=r+1,c=2;c<l;c++)this._mesh._indices[0].push(r),this._mesh._indices[0].push(o),o=r+c,this._mesh._indices[0].push(o)}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Cylinder.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32),this.addField_SFBool(e,"side",!0);var t=this._vf.subdivision,i="Cylinder_"+this._vf.radius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.top+"_"+this._vf.side+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[i])this._mesh=x3dom.geoCache[i];else{var s,o,r,a,n,d=this._vf.radius,l=this._vf.height/2,h=2*Math.PI/t;if(this._vf.side)for(a=0,n=0;a<=t;a++)s=a*h,o=Math.sin(s),r=-Math.cos(s),this._mesh._positions[0].push(o*d,-l,r*d),this._mesh._normals[0].push(o,0,r),this._mesh._texCoords[0].push(1-a/t,0),this._mesh._positions[0].push(o*d,l,r*d),this._mesh._normals[0].push(o,0,r),this._mesh._texCoords[0].push(1-a/t,1),a>0&&(this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+3),n+=2);if(d>0){var u,f=this._mesh._positions[0].length/3;if(this._vf.top){for(a=t-1;a>=0;a--)s=a*h,o=d*Math.sin(s),r=-d*Math.cos(s),this._mesh._positions[0].push(o,l,r),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(o/d/2+.5,-r/d/2+.5);for(u=f+1,a=2;a<t;a++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(u),u=f+a,this._mesh._indices[0].push(u);f=this._mesh._positions[0].length/3}if(this._vf.bottom){for(a=t-1;a>=0;a--)s=a*h,o=d*Math.sin(s),r=-d*Math.cos(s),this._mesh._positions[0].push(o,-l,r),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(o/d/2+.5,r/d/2+.5);for(u=f+1,a=2;a<t;a++)this._mesh._indices[0].push(u),this._mesh._indices[0].push(f),u=f+a,this._mesh._indices[0].push(u)}}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}},{fieldChanged:function(e){if("radius"===e||"height"===e){this._mesh._positions[0]=[];var t,i,s,o,r=this._vf.radius,a=this._vf.height/2,n=this._vf.subdivision,d=2*Math.PI/n;if(this._vf.side)for(o=0;o<=n;o++)t=o*d,i=Math.sin(t),s=-Math.cos(t),this._mesh._positions[0].push(i*r,-a,s*r),this._mesh._positions[0].push(i*r,a,s*r);if(r>0){var l,h=this._mesh._positions[0].length/3;if(this._vf.top)for(o=n-1;o>=0;o--)t=o*d,i=r*Math.sin(t),s=-r*Math.cos(t),this._mesh._positions[0].push(i,a,s)}if(this._vf.bottom)for(o=n-1;o>=0;o--)t=o*d,i=r*Math.sin(t),s=-r*Math.cos(t),this._mesh._positions[0].push(i,-a,s);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"===e||"bottom"===e||"top"===e||"side"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,s,o,r=this._vf.radius,a=this._vf.height/2,n=this._vf.subdivision,d=2*Math.PI/n,u=0;if(this._vf.side)for(o=0,u=0;o<=n;o++)t=o*d,i=Math.sin(t),s=-Math.cos(t),this._mesh._positions[0].push(i*r,-a,s*r),this._mesh._normals[0].push(i,0,s),this._mesh._texCoords[0].push(1-o/n,0),this._mesh._positions[0].push(i*r,a,s*r),this._mesh._normals[0].push(i,0,s),this._mesh._texCoords[0].push(1-o/n,1),o>0&&(this._mesh._indices[0].push(u+0),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+3),u+=2);if(r>0){var l,h=this._mesh._positions[0].length/3;if(this._vf.top){for(o=n-1;o>=0;o--)t=o*d,i=r*Math.sin(t),s=-r*Math.cos(t),this._mesh._positions[0].push(i,a,s),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(i/r/2+.5,-s/r/2+.5);for(l=h+1,o=2;o<n;o++)this._mesh._indices[0].push(h),this._mesh._indices[0].push(l),l=h+o,this._mesh._indices[0].push(l);h=this._mesh._positions[0].length/3}if(this._vf.bottom){for(o=n-1;o>=0;o--)t=o*d,i=r*Math.sin(t),s=-r*Math.cos(t),this._mesh._positions[0].push(i,-a,s),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/r/2+.5,s/r/2+.5);for(l=h+1,o=2;o<n;o++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(h),l=h+o,this._mesh._indices[0].push(l)}}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("ExternalGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.ExternalGeometry.superClass.call(this,e),this.addField_MFString(e,"url",[]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._currentURLIdx=0},{updateRenderData:function(e,t,i,s,o){var r,a=this;0==this._vf.url.length||this._currentURLIdx>=this._vf.url.length||x3dom.BinaryContainerLoader.outOfMemory||(e._webgl.internalDownloadCount=1,e._nameSpace.doc.downloadCount=1,r=new XMLHttpRequest,r.open("GET",e._nameSpace.getURL(this._vf.url[this._currentURLIdx]),!0),r.responseType="arraybuffer",r.send(null),r.onerror=function(){x3dom.debug.logError('Unable to load SRC data from URL "'+a._vf.url[a._currentURLIdx]+'"')},r.onload=function(){e._webgl.internalDownloadCount=0,e._nameSpace.doc.downloadCount=0;var n,d,l,h,u,f,c=new Uint32Array(r.response,0,12);if((200==r.status||0==r.status)&&c.length>=3)if(n=c[2],l=n+12,d=r.response.byteLength-l,n>0&&d>=0){h=new Uint8Array(r.response,12,n),u=new Uint8Array(r.response,l,d);try{f=JSON.parse(String.fromCharCode.apply(null,h))}catch(_){return void x3dom.debug.logError("Unable to parse SRC header: "+_)}a._updateRenderDataFromSRC(e,t,i,f,u)}else a._currentURLIdx+1<a._vf.url.length?(x3dom.debug.logWarning('Invalid SRC data, loaded from URL "'+a._vf.url[a._currentURLIdx]+'", trying next specified URL'),++a._currentURLIdx,a.updateRenderData(e,t,i,s,o)):x3dom.debug.logError('Invalid SRC data, loaded from URL "'+a._vf.url[a._currentURLIdx]+'", no other URLs left to try.');else a._currentURLIdx+1<a._vf.url.length?(x3dom.debug.logWarning('Invalid SRC data, loaded from URL "'+a._vf.url[a._currentURLIdx]+'", trying next specified URL'),++a._currentURLIdx,a.updateRenderData(e,t,i,s,o)):x3dom.debug.logError('Invalid SRC data, loaded from URL "'+a._vf.url[a._currentURLIdx]+'", no other URLs left to try.')})},_updateRenderDataFromSRC:function(e,t,i,s,o){var r,a,n,d,l,h,u,f,c,_,m,p,x=0,g=1,v=2,y=3,b=4,T=5,S=6,M=s.accessors.indexViews,C=s.accessors.attributeViews,F=s.meshes,E={},w={};for(r in M)a=M[r],w[a.bufferView]=!0;this._createGLBuffersFromSRCChunks(i,s.bufferChunks,s.bufferViews,o,w,E);for(r in M)a=M[r],a.componentType!=i.UNSIGNED_SHORT&&x3dom.debug.logWarning("SRC index componentType "+a.componentType+" is not UNSIGNED_SHORT. Ignoring given value and assuming UNSIGNED_SHORT indices."),
e._webgl.indexType=i.UNSIGNED_SHORT;m=0,p=0,e._webgl.primType=[],e._webgl.indexOffset=[],e._webgl.drawCount=[],this._mesh._numCoords=0,this._mesh._numFaces=0;for(_ in F){c=F[_],r=c.indices,""!=r?(e._webgl.externalGeometry=1,a=M[r],e._webgl.indexOffset[m]=a.byteOffset,e._webgl.drawCount[m]=a.count,e._webgl.buffers[x+p]=E[a.bufferView],this._mesh._numFaces+=a.count/3):e._webgl.externalGeometry=-1,e._webgl.primType[m]=c.primitive,n=c.attributes;for(d in n){switch(l=C[n[d]],d){case"position":h="coord",u="Pos",e._webgl.buffers[g+p]=E[l.bufferView],""==c.indices&&(e._webgl.drawCount[m]=l.count,this._mesh._numFaces+=l.count/3),this._mesh._numCoords+=l.count;break;case"normal":h="normal",u="Norm",e._webgl.buffers[v+p]=E[l.bufferView];break;case"texcoord":h="texCoord",u="Tex",e._webgl.buffers[y+p]=E[l.bufferView];break;case"color":h="color",u="Col",e._webgl.buffers[b+p]=E[l.bufferView];break;case"id":h="id",u="Id",e._webgl.buffers[T+p]=E[l.bufferView],e._cf.geometry.node._vf.idsPerVertex=!0}e["_"+h+"StrideOffset"][0]=l.byteStride,e["_"+h+"StrideOffset"][1]=l.byteOffset,e._webgl[h+"Type"]=l.componentType,f=x3dom.nodeTypes.ExternalGeometry._findNumComponentsForSRCAccessorType(l.type),this._mesh["_num"+u+"Components"]=f}++m,p+=S}e._dirty.shader=!0,e._nameSpace.doc.needRender=!0,x3dom.BinaryContainerLoader.checkError(i)},_createGLBuffersFromSRCChunks:function(e,t,i,s,o,r){var a,n,d,l,h,u,f,c;for(var _ in i)if(l="undefined"!=typeof o[_]?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,n=i[_],d=n.chunks,1==d.length)h=t[d[0]],f=new Uint8Array(s.buffer,s.byteOffset+h.byteOffset,h.byteLength),u=e.createBuffer(),e.bindBuffer(l,u),e.bufferData(l,f,e.STATIC_DRAW),r[_]=u;else{for(u=e.createBuffer(),e.bindBuffer(l,u),e.bufferData(l,n.byteLength,e.STATIC_DRAW),c=0,a=0;a<d.length;++a)h=t[d[a]],f=new Uint8Array(s.buffer,s.byteOffset+h.byteOffset,h.byteLength),e.bufferSubData(l,c,f),c+=h.byteLength;r[_]=u}},getVolume:function(){var e,t=this._mesh._vol;return t.isValid()||(e=this._parentNodes[0],"undefined"!=typeof e._vf.bboxCenter&&"undefined"!=typeof e._vf.bboxSize&&t.setBoundsByCenterSize(e._vf.bboxCenter,e._vf.bboxSize)),t}})),x3dom.nodeTypes.ExternalGeometry._findNumComponentsForSRCAccessorType=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;default:return 0}},x3dom.registerNodeType("X3DBinaryContainerGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.X3DBinaryContainerGeometryNode.superClass.call(this,e),this.addField_SFVec3f(e,"position",0,0,0),this.addField_SFVec3f(e,"size",1,1,1),this.addField_MFInt32(e,"vertexCount",[0]),this.addField_MFString(e,"primType",["TRIANGLES"]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._diameter=this._vf.size.length()},{getMin:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.min},getMax:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.max},getVolume:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e},invalidateVolume:function(){},getCenter:function(){return this._vf.position},getDiameter:function(){return this._diameter},needLighting:function(){var e=this._vf.primType.length&&this._vf.primType[0].indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("BinaryGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){x3dom.nodeTypes.BinaryGeometry.superClass.call(this,e),this.addField_SFString(e,"index",""),this.addField_SFString(e,"coord",""),this.addField_SFString(e,"normal",""),this.addField_SFString(e,"texCoord",""),this.addField_SFString(e,"color",""),this.addField_SFString(e,"tangent",""),this.addField_SFString(e,"binormal",""),this.addField_SFString(e,"indexType","Uint16"),this.addField_SFString(e,"coordType","Float32"),this.addField_SFString(e,"normalType","Float32"),this.addField_SFString(e,"texCoordType","Float32"),this.addField_SFString(e,"colorType","Float32"),this.addField_SFString(e,"tangentType","Float32"),this.addField_SFString(e,"binormalType","Float32"),this.addField_SFBool(e,"normalAsSphericalCoordinates",!1),this.addField_SFBool(e,"rgbaColors",!1),this.addField_SFInt32(e,"numTexCoordComponents",2),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFBool(e,"idsPerVertex",!1),this.addField_SFBool(e,"compressed",!1),this._hasStrideOffset=!1,this._mesh._numPosComponents=this._vf.normalAsSphericalCoordinates?4:3,this._mesh._numTexComponents=this._vf.numTexCoordComponents,this._mesh._numColComponents=this._vf.rgbaColors?4:3,this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3,this._vertexCountSum=0;for(var t=0;t<this._vf.vertexCount.length;++t)this._vertexCountSum+=this._vf.vertexCount[t]},{parentAdded:function(e){var t,i,s,o;t=this._vf.coord.lastIndexOf("#"),i=this._vf.coord.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.coord.substring(++t,i),o=+this._vf.coord.substring(i),e._coordStrideOffset=[o,s],this._hasStrideOffset=!0,s/8-Math.floor(s/8)==0&&(this._mesh._numPosComponents=4)):i>=0&&(o=+this._vf.coord.substring(i),e._coordStrideOffset=[o,0],o/8-Math.floor(o/8)==0&&(this._mesh._numPosComponents=4)),t=this._vf.normal.lastIndexOf("#"),i=this._vf.normal.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.normal.substring(++t,i),o=+this._vf.normal.substring(i),e._normalStrideOffset=[o,s]):i>=0&&(o=+this._vf.normal.substring(i),e._normalStrideOffset=[o,0]),t=this._vf.texCoord.lastIndexOf("#"),i=this._vf.texCoord.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.texCoord.substring(++t,i),o=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[o,s]):i>=0&&(o=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[o,0]),t=this._vf.color.lastIndexOf("#"),i=this._vf.color.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.color.substring(++t,i),o=+this._vf.color.substring(i),e._colorStrideOffset=[o,s]):i>=0&&(o=+this._vf.color.substring(i),e._colorStrideOffset=[o,0]),"Uint16"==this._vf.indexType||x3dom.caps.INDEX_UINT||x3dom.debug.logWarning("Index type "+this._vf.indexType+" problematic")},doIntersect:function(e){var t=this.getMin(),i=this.getMax(),s=e.intersect(t,i);return!!(s&&e.enter<e.dist)&&(e.dist=e.enter,e.hitObject=this,e.hitPoint=e.pos.add(e.dir.multiply(e.enter)),!0)},getPrecisionMax:function(e){switch(this._vf[e]){case"Int8":return 127;case"Uint8":return 255;case"Int16":return 32767;case"Uint16":return 65535;case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("PopGeometryLevel","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.PopGeometryLevel.superClass.call(this,e),this.addField_SFString(e,"src",""),this.addField_SFInt32(e,"numIndices",0),this.addField_SFInt32(e,"vertexDataBufferOffset",0)},{getSrc:function(){return this._vf.src},getNumIndices:function(){return this._vf.numIndices},getVertexDataBufferOffset:function(){return this._vf.vertexDataBufferOffset}})),x3dom.registerNodeType("PopGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){x3dom.nodeTypes.PopGeometry.superClass.call(this,e),this.addField_SFVec3f(e,"tightSize",1,1,1),this.addField_SFVec3f(e,"maxBBSize",1,1,1),this.addField_SFVec3f(e,"bbMinModF",0,0,0),this.addField_SFVec3f(e,"bbMaxModF",1,1,1),this.addField_SFVec3f(e,"bbMin",0,0,0),this.addField_SFVec3f(e,"bbShiftVec",0,0,0),this._vf.bbMinModF.x>this._vf.bbMaxModF.x&&(this._vf.bbShiftVec.x=1),this._vf.bbMinModF.y>this._vf.bbMaxModF.y&&(this._vf.bbShiftVec.y=1),this._vf.bbMinModF.z>this._vf.bbMaxModF.z&&(this._vf.bbShiftVec.z=1),this.addField_MFNode("levels",x3dom.nodeTypes.PopGeometryLevel),this.addField_SFInt32(e,"attributeStride",0),this.addField_SFInt32(e,"positionOffset",0),this.addField_SFInt32(e,"normalOffset",0),this.addField_SFInt32(e,"texcoordOffset",0),this.addField_SFInt32(e,"colorOffset",0),this.addField_SFInt32(e,"numAnchorVertices",0),this.addField_SFInt32(e,"positionPrecision",2),this.addField_SFInt32(e,"normalPrecision",1),this.addField_SFInt32(e,"texcoordPrecision",2),this.addField_SFInt32(e,"colorPrecision",1),this.addField_SFInt32(e,"minPrecisionLevel",-1),this.addField_SFInt32(e,"maxPrecisionLevel",-1),this.addField_SFFloat(e,"precisionFactor",1),this.addField_SFString(e,"coordType","Uint16"),this.addField_SFString(e,"normalType","Uint8"),this.addField_SFString(e,"texCoordType","Uint16"),this.addField_SFString(e,"colorType","Uint8"),this.addField_SFInt32(e,"vertexBufferSize",0),this.addField_SFBool(e,"indexedRendering",!0),this.addField_SFBool(e,"sphericalNormals",!1),this.addField_MFInt32(e,"originalVertexCount",[0]);for(var t=0;t<this._vf.vertexCount.length;++t)this._vf.originalVertexCount[t]=this._vf.vertexCount[t];this._vf.maxBBSize=x3dom.fields.SFVec3f.copy(this._vf.size),this._vf.size=this._vf.tightSize,this._diameter=this._vf.size.length(),this._bbMinBySize=[Math.floor(this._vf.bbMin.x/this._vf.maxBBSize.x),Math.floor(this._vf.bbMin.y/this._vf.maxBBSize.y),Math.floor(this._vf.bbMin.z/this._vf.maxBBSize.z)],this._volRadius=this._vf.size.length()/2,this._volLargestRadius=this._vf.maxBBSize.length()/2,this._mesh._numPosComponents=this._vf.sphericalNormals?4:3,this._mesh._numNormComponents=this._vf.sphericalNormals?2:3,this._mesh._numTexComponents=2,this._mesh._numColComponents=3,x3dom.nodeTypes.PopGeometry.numTotalVerts+=this.getVertexCount(),x3dom.nodeTypes.PopGeometry.numTotalTris+=(this.hasIndex()?this.getTotalNumberOfIndices():this.getVertexCount())/3},{forceUpdateCoverage:function(){return!0},getBBoxShiftVec:function(){return this._vf.bbShiftVec},getBBoxSize:function(){return this._vf.size},hasIndex:function(){return this._vf.indexedRendering},getTotalNumberOfIndices:function(){if(this._vf.indexedRendering){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e}return 0},getVertexCount:function(){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e},adaptVertexCount:function(e){for(var t=0,i=0;i<this._vf.originalVertexCount.length;++i){if(!(this._vf.originalVertexCount[i]+t<=e)){this._vf.vertexCount[i]=e-t;break}this._vf.vertexCount[i]=this._vf.originalVertexCount[i],t+=this._vf.originalVertexCount[i]}},hasNormal:function(){return 0!=this._vf.normalOffset&&!this._vf.sphericalNormals},hasTexCoord:function(){return 0!=this._vf.texcoordOffset},hasColor:function(){return 0!=this._vf.colorOffset},getPositionPrecision:function(){return this._vf.positionPrecision},getNormalPrecision:function(){return this._vf.normalPrecision},getTexCoordPrecision:function(){return this._vf.texcoordPrecision},getColorPrecision:function(){return this._vf.colorPrecision},getAttributeStride:function(){return this._vf.attributeStride},getPositionOffset:function(){return this._vf.positionOffset},getNormalOffset:function(){return this._vf.normalOffset},getTexCoordOffset:function(){return this._vf.texcoordOffset},getColorOffset:function(){return this._vf.colorOffset},getBufferTypeStringFromByteCount:function(e){switch(e){case 1:return"Uint8";case 2:return"Uint16";default:return 0}},getDataURLs:function(){for(var e=[],t=0;t<this._cf.levels.nodes.length;++t)e.push(this._cf.levels.nodes[t].getSrc());return e},getNumIndicesByLevel:function(e){return this._cf.levels.nodes[e].getNumIndices()},getNumLevels:function(e){return this._cf.levels.nodes.length},getVertexDataBufferOffset:function(e){return this._cf.levels.nodes[e].getVertexDataBufferOffset()},getPrecisionMax:function(e){switch(this._vf[e]){case"Uint8":return 255;case"Uint16":return 65535;default:return 1}}})),x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor=1,x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove=1,x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,x3dom.nodeTypes.PopGeometry.numTotalVerts=0,x3dom.nodeTypes.PopGeometry.numTotalTris=0,x3dom.nodeTypes.PopGeometry.powLUT=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1],x3dom.registerNodeType("ImageGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){if(x3dom.nodeTypes.ImageGeometry.superClass.call(this,e),this.addField_SFVec2f(e,"implicitMeshSize",256,256),this.addField_SFInt32(e,"numColorComponents",3),this.addField_SFInt32(e,"numTexCoordComponents",2),this.addField_SFNode("index",x3dom.nodeTypes.X3DTextureNode),this.addField_MFNode("coord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normal",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DTextureNode),this._mesh._numColComponents=this._vf.numColorComponents,this._mesh._numTexComponents=this._vf.numTexCoordComponents,0==this._vf.implicitMeshSize.y&&(this._vf.implicitMeshSize.y=this._vf.implicitMeshSize.x),"webgl"==x3dom.caps.BACKEND&&x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS>0){var t="ImageGeometry_"+this._vf.implicitMeshSize.x+"_"+this._vf.implicitMeshSize.y;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[t])this._mesh=x3dom.geoCache[t];else{for(var i=0;i<this._vf.implicitMeshSize.y;i++)for(var s=0;s<this._vf.implicitMeshSize.x;s++)this._mesh._positions[0].push(s/this._vf.implicitMeshSize.x,i/this._vf.implicitMeshSize.y,0);this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[t]=this._mesh}}this._vol=new x3dom.fields.BoxVolume,this._dirty={coord:!0,normal:!0,texCoord:!0,color:!0,index:!0}},{setGeoDirty:function(){this._dirty.coord=!0,this._dirty.normal=!0,this._dirty.texCoords=!0,this._dirty.color=!0,this._dirty.index=!0},unsetGeoDirty:function(){this._dirty.coord=!1,this._dirty.normal=!1,this._dirty.texCoords=!1,this._dirty.color=!1,this._dirty.index=!1},nodeChanged:function(){Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e._dirty.normals=!0,e._dirty.texcoords=!0,e._dirty.colors=!0}),this._vol.invalidate()},fieldChanged:function(e){"index"==e||"coord"==e||"normal"==e||"texCoord"==e||"color"==e?(this._dirty[e]=!0,this._vol.invalidate()):"implicitMeshSize"==e&&this._vol.invalidate()},getMin:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.min},getMax:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.max},getVolume:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e},numCoordinateTextures:function(){return this._cf.coord.nodes.length},getIndexTexture:function(){return this._cf.index.node?(this._cf.index.node._type="IG_index",this._cf.index.node):null},getIndexTextureURL:function(){return this._cf.index.node?this._cf.index.node._vf.url:null},getCoordinateTexture:function(e){return this._cf.coord.nodes[e]?(this._cf.coord.nodes[e]._type="IG_coords"+e,this._cf.coord.nodes[e]):null},getCoordinateTextureURL:function(e){return this._cf.coord.nodes[e]?this._cf.coord.nodes[e]._vf.url:null},getCoordinateTextureURLs:function(){for(var e=[],t=0;t<this._cf.coord.nodes.length;t++)e.push(this._cf.coord.nodes[t]._vf.url);return e},getNormalTexture:function(){return this._cf.normal.node?(this._cf.normal.node._type="IG_normals",this._cf.normal.node):null},getNormalTextureURL:function(){return this._cf.normal.node?this._cf.normal.node._vf.url:null},getTexCoordTexture:function(){return this._cf.texCoord.node?(this._cf.texCoord.node._type="IG_texCoords",this._cf.texCoord.node):null},getTexCoordTextureURL:function(){return this._cf.texCoord.node?this._cf.texCoord.node._vf.url:null},getColorTexture:function(){return this._cf.color.node?(this._cf.color.node._type="IG_colors",this._cf.color.node):null},getColorTextureURL:function(){return this._cf.color.node?this._cf.color.node._vf.url:null},getTextures:function(){var e=[],t=this.getIndexTexture();for(t&&e.push(t),i=0;i<this.numCoordinateTextures();i++){var s=this.getCoordinateTexture(i);s&&e.push(s)}var o=this.getNormalTexture();o&&e.push(o);var r=this.getTexCoordTexture();r&&e.push(r);var a=this.getColorTexture();return a&&e.push(a),e}})),x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,e),this.addField_SFFloat(e,"creaseAngle",0),this.addField_SFBool(e,"convex",!0),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"normalIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this.addField_MFInt32(e,"texCoordIndex",[])},{nodeChanged:function(){(new Date).getTime();this.handleAttribs();var e=this._vf.coordIndex;e.length&&e[e.length-1]!=-1&&e.push(-1);var t=this._vf.normalIndex,i=this._vf.texCoordIndex,s=this._vf.colorIndex,o=!1,r=!1,a=!1,n=!1,d=!1,l=!1,h=this._vf.colorPerVertex,u=this._vf.normalPerVertex;t.length>0&&(r=!0),i.length>0&&(n=!0),s.length>0&&(l=!0);var f,c,_,m,p=this._cf.coord.node;x3dom.debug.assert(p),f=p.getPoints();var x=this._cf.normal.node;x?(o=!0,c=x._vf.vector):o=!1;var g="",v=2,y=this._cf.texCoord.node;x3dom.isa(y,x3dom.nodeTypes.MultiTextureCoordinate)&&y._cf.texCoord.nodes.length&&(y=y._cf.texCoord.nodes[0]),y?y._vf.point?(a=!0,_=y._vf.point,x3dom.isa(y,x3dom.nodeTypes.TextureCoordinate3D)&&(v=3)):y._vf.mode&&(g=y._vf.mode):a=!1,this._mesh._numTexComponents=v;var b=3,T=this._cf.color.node;T?(d=!0,m=T._vf.color,x3dom.isa(T,x3dom.nodeTypes.ColorRGBA)&&(b=4)):d=!1,this._mesh._numColComponents=b,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var S,M,C,F,E,w,A,N,R,I,P,D,V,L,O,B,k;if(this._vf.creaseAngle<=x3dom.fields.Eps||f.length>x3dom.Utils.maxIndexableCoords||o&&r||a&&n||d&&l){if(this._vf.creaseAngle<=x3dom.fields.Eps&&x3dom.debug.logWarning("Fallback to inefficient multi-index mode since creaseAngle=0."),this._vf.convex)for(C=0,F=0,E=0,this._mesh._multiIndIndices=[],this._mesh._posSize=f.length,S=0;S<e.length;++S)if(e[S]!=-1)switch(r&&x3dom.debug.assert(t[S]!=-1),n&&x3dom.debug.assert(i[S]!=-1),l&&x3dom.debug.assert(s[S]!=-1),C){case 0:w=+e[S],R=r&&u?+t[S]:r&&!u?+t[E]:u?w:E,D=n?+i[S]:w,O=l&&h?+s[S]:l&&!h?+s[E]:h?w:E,C=1;break;case 1:A=+e[S],I=r&&u?+t[S]:r&&!u?+t[E]:u?A:E,V=n?+i[S]:A,B=l&&h?+s[S]:l&&!h?+s[E]:h?A:E,C=2;break;case 2:N=+e[S],P=r&&u?+t[S]:r&&!u?+t[E]:u?N:E,L=n?+i[S]:N,k=l&&h?+s[S]:l&&!h?+s[E]:h?N:E,C=3,this._mesh._positions[0].push(f[w].x),this._mesh._positions[0].push(f[w].y),this._mesh._positions[0].push(f[w].z),this._mesh._positions[0].push(f[A].x),this._mesh._positions[0].push(f[A].y),this._mesh._positions[0].push(f[A].z),this._mesh._positions[0].push(f[N].x),this._mesh._positions[0].push(f[N].y),this._mesh._positions[0].push(f[N].z),o&&(this._mesh._normals[0].push(c[R].x),this._mesh._normals[0].push(c[R].y),this._mesh._normals[0].push(c[R].z),this._mesh._normals[0].push(c[I].x),this._mesh._normals[0].push(c[I].y),this._mesh._normals[0].push(c[I].z),this._mesh._normals[0].push(c[P].x),this._mesh._normals[0].push(c[P].y),this._mesh._normals[0].push(c[P].z)),this._mesh._multiIndIndices.push(w,A,N),d&&(this._mesh._colors[0].push(m[O].r),this._mesh._colors[0].push(m[O].g),this._mesh._colors[0].push(m[O].b),4===b&&this._mesh._colors[0].push(m[O].a),this._mesh._colors[0].push(m[B].r),this._mesh._colors[0].push(m[B].g),this._mesh._colors[0].push(m[B].b),4===b&&this._mesh._colors[0].push(m[B].a),this._mesh._colors[0].push(m[k].r),this._mesh._colors[0].push(m[k].g),this._mesh._colors[0].push(m[k].b),4===b&&this._mesh._colors[0].push(m[k].a)),a&&(this._mesh._texCoords[0].push(_[D].x),this._mesh._texCoords[0].push(_[D].y),3===v&&this._mesh._texCoords[0].push(_[D].z),this._mesh._texCoords[0].push(_[V].x),this._mesh._texCoords[0].push(_[V].y),3===v&&this._mesh._texCoords[0].push(_[V].z),this._mesh._texCoords[0].push(_[L].x),this._mesh._texCoords[0].push(_[L].y),3===v&&this._mesh._texCoords[0].push(_[L].z));break;case 3:A=N,V=L,u&&(I=P),h&&(B=k),N=+e[S],r&&u?P=+t[S]:r&&!u||(P=u?N:E),L=n?+i[S]:N,l&&h?k=+s[S]:l&&!h||(k=h?N:E),this._mesh._positions[0].push(f[w].x),this._mesh._positions[0].push(f[w].y),this._mesh._positions[0].push(f[w].z),this._mesh._positions[0].push(f[A].x),this._mesh._positions[0].push(f[A].y),this._mesh._positions[0].push(f[A].z),this._mesh._positions[0].push(f[N].x),this._mesh._positions[0].push(f[N].y),this._mesh._positions[0].push(f[N].z),o&&(this._mesh._normals[0].push(c[R].x),this._mesh._normals[0].push(c[R].y),this._mesh._normals[0].push(c[R].z),this._mesh._normals[0].push(c[I].x),this._mesh._normals[0].push(c[I].y),this._mesh._normals[0].push(c[I].z),this._mesh._normals[0].push(c[P].x),this._mesh._normals[0].push(c[P].y),this._mesh._normals[0].push(c[P].z)),this._mesh._multiIndIndices.push(w,A,N),d&&(this._mesh._colors[0].push(m[O].r),this._mesh._colors[0].push(m[O].g),this._mesh._colors[0].push(m[O].b),4===b&&this._mesh._colors[0].push(m[O].a),this._mesh._colors[0].push(m[B].r),this._mesh._colors[0].push(m[B].g),this._mesh._colors[0].push(m[B].b),4===b&&this._mesh._colors[0].push(m[B].a),this._mesh._colors[0].push(m[k].r),this._mesh._colors[0].push(m[k].g),this._mesh._colors[0].push(m[k].b),4===b&&this._mesh._colors[0].push(m[k].a)),a&&(this._mesh._texCoords[0].push(_[D].x),this._mesh._texCoords[0].push(_[D].y),3===v&&this._mesh._texCoords[0].push(_[D].z),this._mesh._texCoords[0].push(_[V].x),this._mesh._texCoords[0].push(_[V].y),3===v&&this._mesh._texCoords[0].push(_[V].z),this._mesh._texCoords[0].push(_[L].x),this._mesh._texCoords[0].push(_[L].y),3===v&&this._mesh._texCoords[0].push(_[L].z))}else C=0,E++;else{var G=new x3dom.DoublyLinkedList,U={};for(F=0,E=0,S=0;S<e.length;++S)if(e[S]!=-1)o&&(r&&u?U.normals=c[t[S]]:r&&!u?U.normals=c[t[E]]:U.normals=c[e[S]]),d&&(l&&h?U.colors=m[s[S]]:l&&!h?U.colors=m[s[E]]:h?U.colors=m[e[S]]:U.colors=m[E]),a&&(n?U.texCoords=_[i[S]]:U.texCoords=_[e[S]]),G.appendNode(new x3dom.DoublyLinkedList.ListNode(f[e[S]],e[S],U.normals,U.colors,U.texCoords));else{var X=x3dom.EarClipping.getMultiIndexes(G);for(M=0;M<X.indices.length;M++)this._mesh._indices[0].push(F),F++,this._mesh._positions[0].push(X.point[M].x,X.point[M].y,X.point[M].z),o&&this._mesh._normals[0].push(X.normals[M].x,X.normals[M].y,X.normals[M].z),d&&(this._mesh._colors[0].push(X.colors[M].r,X.colors[M].g,X.colors[M].b),4===b&&this._mesh._colors[0].push(X.colors[M].a)),a&&(this._mesh._texCoords[0].push(X.texCoords[M].x,X.texCoords[M].y),3===v&&this._mesh._texCoords[0].push(X.texCoords[M].z));G=new x3dom.DoublyLinkedList,E++}this._mesh.splitMesh()}o||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),a||this._mesh.calcTexCoords(g)}else{if(C=0,this._vf.convex)for(S=0;S<e.length;++S)if(e[S]!=-1)switch(C){case 0:R=+e[S],C=1;break;case 1:I=+e[S],C=2;break;case 2:P=+e[S],C=3,this._mesh._indices[0].push(R,I,P);break;case 3:I=P,P=+e[S],this._mesh._indices[0].push(R,I,P)}else C=0;else for(G=new x3dom.DoublyLinkedList,S=0;S<e.length;++S)if(e[S]!=-1)G.appendNode(new x3dom.DoublyLinkedList.ListNode(f[e[S]],e[S]));else{var z=x3dom.EarClipping.getIndexes(G);for(M=0;M<z.length;M++)this._mesh._indices[0].push(z[M]);G=new x3dom.DoublyLinkedList}this._mesh._positions[0]=f.toGL(),o?this._mesh._normals[0]=c.toGL():this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),a?(this._mesh._texCoords[0]=_.toGL(),this._mesh._numTexComponents=v):this._mesh.calcTexCoords(g),d&&(this._mesh._colors[0]=m.toGL(),this._mesh._numColComponents=b)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,S=0;S<this._mesh._positions.length;S++){var j=this._mesh._indices[S].length,H=this._mesh._positions[S].length/3;this._mesh._numCoords+=H,j>0?this._mesh._numFaces+=j/3:this._mesh._numFaces+=H/3}},fieldChanged:function(e){if("coord"!=e&&"normal"!=e&&"texCoord"!=e&&"color"!=e&&"coordIndex"!=e)return void x3dom.debug.logWarning("IndexedFaceSet: fieldChanged for "+e+" not yet implemented!");var t=this._cf.coord.node._vf.point,i=t.length,s=this._cf.texCoord.node;if(x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),(this._vf.creaseAngle<=x3dom.fields.Eps||i>x3dom.Utils.maxIndexableCoords||this._vf.normalIndex.length>0&&this._cf.normal.node||this._vf.texCoordIndex.length>0&&s||this._vf.colorIndex.length>0&&this._cf.color.node)&&this._mesh._multiIndIndices){var o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();if(i=this._mesh._multiIndIndices.length,this._mesh._positions[0]=[],this._mesh._indices[0]=[],"coord"==e&&i){for(o&&(this._mesh._normals[0]=[]),L=0;L<i;L+=3){var r=this._mesh._multiIndIndices[L],a=this._mesh._multiIndIndices[L+1],n=this._mesh._multiIndIndices[L+2],d=t[r],l=t[a],h=t[n];if(this._mesh._positions[0].push(d.x,d.y,d.z),this._mesh._positions[0].push(l.x,l.y,l.z),this._mesh._positions[0].push(h.x,h.y,h.z),o){var u=d.subtract(l),f=l.subtract(h),c=u.cross(f).normalize();this._vf.ccw||(c=c.negate()),this._mesh._normals[0].push(c.x,c.y,c.z),this._mesh._normals[0].push(c.x,c.y,c.z),this._mesh._normals[0].push(c.x,c.y,c.z)}}return this.invalidateVolume(),void Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,o&&(e._dirty.normals=!0)})}this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var _=this._vf.coordIndex,m=this._vf.normalIndex,p=this._vf.texCoordIndex,x=this._vf.colorIndex,g=!1,v=!1,y=!1,b=!1,T=!1,S=!1,M=this._vf.colorPerVertex,C=this._vf.normalPerVertex;m.length>0&&(v=!0),p.length>0&&(b=!0),x.length>0&&(S=!0);var F,E,w,A,N=this._cf.coord.node;x3dom.debug.assert(N),F=N.getPoints();var R=this._cf.normal.node;R?(g=!0,E=R._vf.vector):g=!1;var I="",P=2;s=this._cf.texCoord.node,x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),s?s._vf.point?(y=!0,w=s._vf.point,x3dom.isa(s,x3dom.nodeTypes.TextureCoordinate3D)&&(P=3)):s._vf.mode&&(I=s._vf.mode):y=!1,this._mesh._numTexComponents=P;var D=3,V=this._cf.color.node;V?(T=!0,A=V._vf.color,x3dom.isa(V,x3dom.nodeTypes.ColorRGBA)&&(D=4)):T=!1,this._mesh._numColComponents=D;var L,O,B,k,G,U,X,z,j,H,W,Y,q,Q,K,Z,$;if(this._vf.convex)for(B=0,k=0,G=0,this._mesh._multiIndIndices=[],this._mesh._posSize=F.length,L=0;L<_.length;++L)if(_[L]!=-1)switch(v&&x3dom.debug.assert(m[L]!=-1),b&&x3dom.debug.assert(p[L]!=-1),S&&x3dom.debug.assert(x[L]!=-1),B){case 0:U=+_[L],j=v&&C?+m[L]:v&&!C?+m[G]:C?U:G,Y=b?+p[L]:U,K=S&&M?+x[L]:S&&!M?+x[G]:M?U:G,B=1;break;case 1:X=+_[L],H=v&&C?+m[L]:v&&!C?+m[G]:C?X:G,q=b?+p[L]:X,Z=S&&M?+x[L]:S&&!M?+x[G]:M?X:G,B=2;break;case 2:z=+_[L],W=v&&C?+m[L]:v&&!C?+m[G]:C?z:G,Q=b?+p[L]:z,$=S&&M?+x[L]:S&&!M?+x[G]:M?z:G,B=3,this._mesh._positions[0].push(F[U].x),this._mesh._positions[0].push(F[U].y),this._mesh._positions[0].push(F[U].z),this._mesh._positions[0].push(F[X].x),this._mesh._positions[0].push(F[X].y),this._mesh._positions[0].push(F[X].z),this._mesh._positions[0].push(F[z].x),this._mesh._positions[0].push(F[z].y),this._mesh._positions[0].push(F[z].z),g&&(this._mesh._normals[0].push(E[j].x),this._mesh._normals[0].push(E[j].y),this._mesh._normals[0].push(E[j].z),this._mesh._normals[0].push(E[H].x),this._mesh._normals[0].push(E[H].y),this._mesh._normals[0].push(E[H].z),this._mesh._normals[0].push(E[W].x),this._mesh._normals[0].push(E[W].y),this._mesh._normals[0].push(E[W].z)),this._mesh._multiIndIndices.push(U,X,z),T&&(this._mesh._colors[0].push(A[K].r),this._mesh._colors[0].push(A[K].g),this._mesh._colors[0].push(A[K].b),4===D&&this._mesh._colors[0].push(A[K].a),this._mesh._colors[0].push(A[Z].r),this._mesh._colors[0].push(A[Z].g),this._mesh._colors[0].push(A[Z].b),4===D&&this._mesh._colors[0].push(A[Z].a),this._mesh._colors[0].push(A[$].r),this._mesh._colors[0].push(A[$].g),this._mesh._colors[0].push(A[$].b),4===D&&this._mesh._colors[0].push(A[$].a)),y&&(this._mesh._texCoords[0].push(w[Y].x),this._mesh._texCoords[0].push(w[Y].y),3===P&&this._mesh._texCoords[0].push(w[Y].z),this._mesh._texCoords[0].push(w[q].x),this._mesh._texCoords[0].push(w[q].y),3===P&&this._mesh._texCoords[0].push(w[q].z),this._mesh._texCoords[0].push(w[Q].x),this._mesh._texCoords[0].push(w[Q].y),3===P&&this._mesh._texCoords[0].push(w[Q].z));break;case 3:X=z,q=Q,C&&(H=W),M&&(Z=$),z=+_[L],v&&C?W=+m[L]:v&&!C||(W=C?z:G),Q=b?+p[L]:z,S&&M?$=+x[L]:S&&!M||($=M?z:G),this._mesh._positions[0].push(F[U].x),this._mesh._positions[0].push(F[U].y),this._mesh._positions[0].push(F[U].z),this._mesh._positions[0].push(F[X].x),this._mesh._positions[0].push(F[X].y),this._mesh._positions[0].push(F[X].z),this._mesh._positions[0].push(F[z].x),this._mesh._positions[0].push(F[z].y),this._mesh._positions[0].push(F[z].z),g&&(this._mesh._normals[0].push(E[j].x),this._mesh._normals[0].push(E[j].y),this._mesh._normals[0].push(E[j].z),this._mesh._normals[0].push(E[H].x),this._mesh._normals[0].push(E[H].y),this._mesh._normals[0].push(E[H].z),this._mesh._normals[0].push(E[W].x),this._mesh._normals[0].push(E[W].y),this._mesh._normals[0].push(E[W].z)),this._mesh._multiIndIndices.push(U,X,z),T&&(this._mesh._colors[0].push(A[K].r),this._mesh._colors[0].push(A[K].g),this._mesh._colors[0].push(A[K].b),4===D&&this._mesh._colors[0].push(A[K].a),this._mesh._colors[0].push(A[Z].r),this._mesh._colors[0].push(A[Z].g),this._mesh._colors[0].push(A[Z].b),4===D&&this._mesh._colors[0].push(A[Z].a),this._mesh._colors[0].push(A[$].r),this._mesh._colors[0].push(A[$].g),this._mesh._colors[0].push(A[$].b),4===D&&this._mesh._colors[0].push(A[$].a)),y&&(this._mesh._texCoords[0].push(w[Y].x),this._mesh._texCoords[0].push(w[Y].y),3===P&&this._mesh._texCoords[0].push(w[Y].z),this._mesh._texCoords[0].push(w[q].x),this._mesh._texCoords[0].push(w[q].y),3===P&&this._mesh._texCoords[0].push(w[q].z),this._mesh._texCoords[0].push(w[Q].x),this._mesh._texCoords[0].push(w[Q].y),3===P&&this._mesh._texCoords[0].push(w[Q].z))}else B=0,G++;else{var J=new x3dom.DoublyLinkedList,ee={};for(k=0,G=0,L=0;L<_.length;++L)if(_[L]!=-1)g&&(v&&C?ee.normals=E[m[L]]:v&&!C?ee.normals=E[m[G]]:ee.normals=E[_[L]]),T&&(S&&M?ee.colors=A[x[L]]:S&&!M?ee.colors=A[x[G]]:ee.colors=A[_[L]]),y&&(b?ee.texCoords=w[p[L]]:ee.texCoords=w[_[L]]),J.appendNode(new x3dom.DoublyLinkedList.ListNode(F[_[L]],_[L],ee.normals,ee.colors,ee.texCoords));else{var te=x3dom.EarClipping.getMultiIndexes(J);for(O=0;O<te.indices.length;O++)this._mesh._indices[0].push(k),k++,this._mesh._positions[0].push(te.point[O].x,te.point[O].y,te.point[O].z),g&&this._mesh._normals[0].push(te.normals[O].x,te.normals[O].y,te.normals[O].z),T&&(this._mesh._colors[0].push(te.colors[O].r,te.colors[O].g,te.colors[O].b),4===D&&this._mesh._colors[0].push(te.colors[O].a)),y&&(this._mesh._texCoords[0].push(te.texCoords[O].x,te.texCoords[O].y),3===P&&this._mesh._texCoords[0].push(te.texCoords[O].z));J=new x3dom.DoublyLinkedList,G++}this._mesh.splitMesh()}for(g||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),y||this._mesh.calcTexCoords(I),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,L=0;L<this._mesh._positions.length;L++){var ie=this._mesh._indices[L].length,se=this._mesh._positions[L].length/3;this._mesh._numCoords+=se,ie>0?this._mesh._numFaces+=ie/3:this._mesh._numFaces+=se/3}Array.forEach(this._parentNodes,function(e){e.setGeoDirty()})}else if("coord"==e){var o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();this._mesh._positions[0]=t.toGL(),o&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,o&&(e._dirty.normals=!0),e.invalidateVolume()})}else if("color"==e)t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0});else if("normal"==e)t=this._cf.normal.node._vf.vector,this._mesh._normals[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0});else if("texCoord"==e)s=this._cf.texCoord.node,x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),
t=s._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0});else if("coordIndex"==e){for(o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),_=this._vf.coordIndex,B=0,i=_.length,this._mesh._indices[0]=[],L=0;L<i;++L)if(_[L]==-1)B=0;else switch(B){case 0:U=+_[L],B=1;break;case 1:X=+_[L],B=2;break;case 2:z=+_[L],B=3,this._mesh._indices[0].push(U,X,z);break;case 3:X=z,z=+_[L],this._mesh._indices[0].push(U,X,z)}o&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0,o&&(e._dirty.normals=!0)})}}})),x3dom.registerNodeType("X3DTexture3DNode","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.X3DTexture3DNode.superClass.call(this,e)})),x3dom.registerNodeType("ComposedTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.ComposedTexture3D.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTexture3DNode)})),x3dom.registerNodeType("ImageTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.ImageTexture3D.superClass.call(this,e)})),x3dom.registerNodeType("PixelTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.PixelTexture3D.superClass.call(this,e)})),x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])})),x3dom.registerNodeType("TextureTransform3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransform3D.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0)})),x3dom.registerNodeType("TextureTransformMatrix3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransformMatrix3D.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)})),x3dom.registerNodeType("X3DPointingDeviceSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DSensorNode,function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.superClass.call(this,e)},{pointerPressedOverSibling:function(e){this._vf.enabled&&(this._vf.isActive=!0,this.postMessage("isActive",!0))},pointerMoved:function(e){},pointerMovedOver:function(e){this._vf.enabled&&this.postMessage("isOver",!0)},pointerMovedOut:function(e){this._vf.enabled&&this.postMessage("isOver",!1)},pointerReleased:function(){this._vf.enabled&&(this._vf.isActive=!1,this.postMessage("isActive",!1))}})),x3dom.registerNodeType("X3DDragSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,function(e){x3dom.nodeTypes.X3DDragSensorNode.superClass.call(this,e),this.addField_SFBool(e,"autoOffset",!0),this._lastX=-1,this._lastY=-1},{pointerPressedOverSibling:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerPressedOverSibling.call(this,e),this._lastX=e.layerX,this._lastY=e.layerY,this._startDragging(e.viewarea,e.layerX,e.layerX,e.worldX,e.worldY,e.worldZ)},pointerMoved:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerMoved.call(this,e),this._vf.isActive&&this._vf.enabled&&this._process2DDrag(e.layerX,e.layerY,e.layerX-this._lastX,e.layerY-this._lastY)},pointerReleased:function(){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerReleased.call(this),this._stopDragging()},_startDragging:function(e,t,i,s,o,r){},_process2DDrag:function(e,t,i,s){},_stopDragging:function(){}})),x3dom.registerNodeType("X3DTouchSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,function(e){x3dom.nodeTypes.X3DTouchSensorNode.superClass.call(this,e)},{})),x3dom.registerNodeType("TouchSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DTouchSensorNode,function(e){x3dom.nodeTypes.TouchSensor.superClass.call(this,e)},{})),x3dom.registerNodeType("PlaneSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.PlaneSensor.superClass.call(this,e),this.addField_SFRotation(e,"axisRotation",0,0,1,0),this.addField_SFVec2f(e,"minPosition",0,0),this.addField_SFVec2f(e,"maxPosition",-1,-1),this.addField_SFVec3f(e,"offset",0,0,0),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._worldToLocalMatrix=null,this._initialPlaneIntersection=null,this._planeNormal=null,this._viewArea=null,this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0)},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,s,o,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,r),this._viewArea=e,this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0).add(this._vf.offset),this._worldToLocalMatrix=this.getCurrentTransform().inverse(),this._initialPlaneIntersection=this._worldToLocalMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,r)),this._planeNormal=new x3dom.fields.SFVec3f(0,0,1)},_process2DDrag:function(e,t,i,s){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s);var o,r,a;if(this._initialPlaneIntersection){var n=this._viewArea.calcViewRay(e,t);n.pos=this._worldToLocalMatrix.multMatrixPnt(n.pos),n.dir=this._worldToLocalMatrix.multMatrixVec(n.dir.normalize()),o=n.intersectPlane(this._initialPlaneIntersection,this._planeNormal),o||(o=n.intersectPlane(this._initialPlaneIntersection,this._planeNormal.negate())),o&&(this._currentTranslation=o.subtract(this._initialPlaneIntersection),this._currentTranslation=this._currentTranslation.add(this._vf.offset),r=this._vf.minPosition,a=this._vf.maxPosition,r.x<=a.x&&(this._currentTranslation.x=Math.min(this._currentTranslation.x,a.x),this._currentTranslation.x=Math.max(this._currentTranslation.x,r.x)),r.y<=a.y&&(this._currentTranslation.y=Math.min(this._currentTranslation.y,a.y),this._currentTranslation.y=Math.max(this._currentTranslation.y,r.y)),this.postMessage("translation_changed",x3dom.fields.SFVec3f.copy(this._currentTranslation)))}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=x3dom.fields.SFVec3f.copy(this._currentTranslation),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.registerNodeType("SphereSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.SphereSensor.superClass.call(this,e),this.addField_SFRotation(e,"offset",0,1,0,0),this._currentRotation=null,this._rotationMatrix=this._vf.offset.toMatrix()},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,s,o,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,r),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._localOrigin=new x3dom.fields.SFVec3f(0,0,0),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var a=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,r));this._initialSphereIntersectionVector=a.subtract(this._localOrigin),this._sphereRadius=this._initialSphereIntersectionVector.length(),this._initialSphereIntersectionVector=this._initialSphereIntersectionVector.normalize()},_process2DDrag:function(e,t,i,s){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s);var o=this._viewArea.calcViewRay(e,t);o.pos=this._inverseToWorldMatrix.multMatrixPnt(o.pos),o.dir=this._inverseToWorldMatrix.multMatrixVec(o.dir);var r,a,n=o.dir.dot(o.dir),d=2*o.dir.dot(o.pos.subtract(this._localOrigin)),l=o.pos.dot(o.pos)-2*this._localOrigin.dot(o.pos)+this._localOrigin.dot(this._localOrigin)-this._sphereRadius*this._sphereRadius,h=d*d-4*n*l;if(h>=0&&(r=(-d+Math.sqrt(h))/(2*n),a=(-d-Math.sqrt(h))/(2*n),r=Math.min(r,a),r>=1)){var u=o.pos.add(o.dir.multiply(r)),f=u.subtract(this._localOrigin).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialSphereIntersectionVector,f),this._currentRotation=this._currentRotation.multiply(this._vf.offset),this.postMessage("rotation_changed",this._currentRotation)}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation,this.postMessage("offset_changed",this._vf.offset)),this._currentRotation=new x3dom.fields.Quaternion}})),x3dom.registerNodeType("CylinderSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.CylinderSensor.superClass.call(this,e),this.addField_SFFloat(e,"offset",0),this.addField_SFRotation(e,"axisRotation",0,1,0,0),this.addField_SFFloat(e,"diskAngle",.262),this.addField_SFFloat(e,"minAngle",0),this.addField_SFFloat(e,"maxAngle",-1),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._inverseToWorldMatrix=null,this._initialCylinderIntersectionVector=null,this._viewArea=null,this._cylinderRadius=0,this._yAxisLine=null,this._cylinderMode=!0,this._currentRotationAngle=0},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,s,o,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,r),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._yAxisLine=new x3dom.fields.Line(new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,1,0)),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var a=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,r)),n=this._yAxisLine.closestPoint(a);this._initialCylinderIntersectionVector=a.subtract(n),this._cylinderRadius=this._initialCylinderIntersectionVector.length(),this._initialCylinderIntersectionVector=this._initialCylinderIntersectionVector.normalize()},_process2DDrag:function(e,t,i,s){if(x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s),this._cylinderMode){var o=this._viewArea.calcViewRay(e,t);o.pos=this._inverseToWorldMatrix.multMatrixPnt(o.pos),o.dir=this._inverseToWorldMatrix.multMatrixVec(o.dir);var r,a,n=o.dir.subtract(this._yAxisLine.dir.multiply(o.dir.dot(this._yAxisLine.dir))),d=o.pos.subtract(this._yAxisLine.pos).add(this._yAxisLine.dir.multiply(this._yAxisLine.dir.dot(this._yAxisLine.pos.subtract(o.pos)))),l=2*n.dot(d)/n.dot(n),h=(d.dot(d)-this._cylinderRadius*this._cylinderRadius)/n.dot(n),u=l*l*.25-h;if(u>=0&&(u=Math.sqrt(u),r=.5*-l+u,a=.5*-l-u,r=Math.min(r,a),r>0)){var f=o.pos.add(o.dir.multiply(r)),c=this._yAxisLine.closestPoint(f),_=f.subtract(c).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialCylinderIntersectionVector,_);var m=x3dom.fields.Quaternion.axisAngle(this._yAxisLine.dir,this._vf.offset);this._currentRotation=this._currentRotation.multiply(m),this.postMessage("rotation_changed",this._currentRotation)}}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation.angle(),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.versionInfo={version:"1.7.1",revision:"8e1212d8d0595f107de05865c61b4b45ecff00e0",date:"Fri Dec 18 19:07:57 2015 +0100"}},1076:function(e,t,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var o=i(35),r=i(s),a=(i(55),function(e){return{view:e.view}}),n={};t.Game=(0,o.connect)(a,n)(r.Game)}});